<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-12-16 Thu 17:36 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>&lrm;</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="whiothes" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&amp;dn=gpl-3.0.txt GPL-v3-or-Later
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orga6453ab">Advanced Programming in the Unix Environment <code>[76%]</code></a>
<ul>
<li><a href="#org9a72ce7"><span class="done DONE">DONE</span> Chapter 1. UNIX System Overview <code>[12/12]</code></a>
<ul>
<li><a href="#org9a350c3"><span class="done DONE">DONE</span> 1.1 Introduction</a></li>
<li><a href="#org88c4df0"><span class="done DONE">DONE</span> 1.2 UNIX Architecture</a></li>
<li><a href="#org7a4e3c7"><span class="done DONE">DONE</span> 1.3 Logging in</a></li>
<li><a href="#orge9dadf9"><span class="done DONE">DONE</span> 1.4 Files and Directories</a></li>
<li><a href="#org8c758d4"><span class="done DONE">DONE</span> 1.5 Input and Output - File Descriptors</a></li>
<li><a href="#org8db9575"><span class="done DONE">DONE</span> 1.6 Programs and Processes</a></li>
<li><a href="#org04026b6"><span class="done DONE">DONE</span> 1.7 Error Handling</a></li>
<li><a href="#org7074674"><span class="done DONE">DONE</span> 1.8 User identification</a></li>
<li><a href="#orgc37441c"><span class="done DONE">DONE</span> 1.9 Signals</a></li>
<li><a href="#org3bd36b9"><span class="done DONE">DONE</span> 1.10 Time Values</a></li>
<li><a href="#orgeb6db64"><span class="done DONE">DONE</span> 1.11 System calls and Library Functions</a></li>
<li><a href="#org3889160"><span class="done DONE">DONE</span> 1.12 Summary</a></li>
</ul>
</li>
<li><a href="#org8456245"><span class="done DONE">DONE</span> Chapter 2. UNIX Standardization and Implementations <code>[10/10]</code></a>
<ul>
<li><a href="#org91ee467"><span class="done DONE">DONE</span> 2.1 Introduction</a></li>
<li><a href="#orgd167eb2"><span class="done DONE">DONE</span> 2.2 UNIX Standardization</a></li>
<li><a href="#org8d4dda1"><span class="done DONE">DONE</span> 2.3 UNIX System Implementations</a></li>
<li><a href="#org6987d96"><span class="done DONE">DONE</span> 2.4 Relationship of Standards and Implementations</a></li>
<li><a href="#org8ba6278"><span class="done DONE">DONE</span> 2.5 Limits</a></li>
<li><a href="#org28b4bc7"><span class="done DONE">DONE</span> 2.6 Options</a></li>
<li><a href="#org312d338"><span class="done DONE">DONE</span> 2.7 Features Test Macros</a></li>
<li><a href="#org55c0076"><span class="done DONE">DONE</span> 2.8 Primitive System Data Types</a></li>
<li><a href="#org441a6fe"><span class="done DONE">DONE</span> 2.9 Differences Between Standards</a></li>
<li><a href="#org1fdd66b"><span class="done DONE">DONE</span> 2.10 Summary</a></li>
</ul>
</li>
<li><a href="#org197bd38"><span class="done DONE">DONE</span> Chapter 3. File I/O <code>[17/17]</code></a>
<ul>
<li><a href="#org79261ef"><span class="done DONE">DONE</span> 3.1 Introduction</a></li>
<li><a href="#org9f9e469"><span class="done DONE">DONE</span> 3.2 File Descriptors</a></li>
<li><a href="#org3d324de"><span class="done DONE">DONE</span> 3.3 <code>open</code> and <code>openat</code> Functions</a></li>
<li><a href="#org4473961"><span class="done DONE">DONE</span> 3.4 <code>creat</code> Function</a></li>
<li><a href="#org01f2b87"><span class="done DONE">DONE</span> 3.5 <code>close</code> Function</a></li>
<li><a href="#org454472e"><span class="done DONE">DONE</span> 3.6 <code>lseek</code> Function</a></li>
<li><a href="#orge856bb5"><span class="done DONE">DONE</span> 3.7 <code>read</code> Function</a></li>
<li><a href="#orgf11393d"><span class="done DONE">DONE</span> 3.8 <code>write</code> Function</a></li>
<li><a href="#orgc6689e5"><span class="done DONE">DONE</span> 3.9 I/O Efficiency</a></li>
<li><a href="#org4f23934"><span class="done DONE">DONE</span> 3.10 File Sharing</a></li>
<li><a href="#orgbf2d2d3"><span class="done DONE">DONE</span> 3.11 Atomic Operations</a></li>
<li><a href="#orgb3e9083"><span class="done DONE">DONE</span> 3.12 <code>dup</code> and <code>dup2</code> Functions</a></li>
<li><a href="#org47d56ee"><span class="done DONE">DONE</span> 3.13 <code>sync</code>, <code>fsync</code> and <code>fdatasync</code> Functions</a></li>
<li><a href="#org5c447b2"><span class="done DONE">DONE</span> 3.14 <code>fcntl</code> Function</a></li>
<li><a href="#org1271aaf"><span class="done DONE">DONE</span> 3.15 <code>ioctl</code> Function</a></li>
<li><a href="#orga6c1e72"><span class="done DONE">DONE</span> 3.16 <code>/dev/fd</code></a></li>
<li><a href="#org7b9cb39"><span class="done DONE">DONE</span> 3.17 Summary</a></li>
</ul>
</li>
<li><a href="#org80f2c83"><span class="done DONE">DONE</span> Chapter 4. System Data Files and Information <code>[26/26]</code></a>
<ul>
<li><a href="#org3630ca7"><span class="done DONE">DONE</span> 4.1 Introduction</a></li>
<li><a href="#org6085f86"><span class="done DONE">DONE</span> 4.2 <code>stat</code>, <code>fstat</code>, <code>fstatat</code>, and <code>lstat</code> Functions</a></li>
<li><a href="#org38828c2"><span class="done DONE">DONE</span> 4.3 File Types</a></li>
<li><a href="#orgcb9ffc2"><span class="done DONE">DONE</span> 4.4 Set-User-ID and Set-Group-ID</a></li>
<li><a href="#orgcb05e31"><span class="done DONE">DONE</span> 4.5 File Access Permissions</a></li>
<li><a href="#orge7d2a45"><span class="done DONE">DONE</span> 4.6 Ownership of New Files and Directories</a></li>
<li><a href="#org35c8475"><span class="done DONE">DONE</span> 4.7 <code>access</code> and <code>faccessat</code> Functions</a></li>
<li><a href="#orgacfb718"><span class="done DONE">DONE</span> 4.8 <code>umask</code> Function</a></li>
<li><a href="#orgdeef164"><span class="done DONE">DONE</span> 4.9 <code>chmod</code>, <code>fchmod</code>, and <code>fchmodat</code> Functions</a></li>
<li><a href="#org43bc2f6"><span class="done DONE">DONE</span> 4.10 Sticky Bit</a></li>
<li><a href="#orge7498b3"><span class="done DONE">DONE</span> 4.11 <code>chown</code>, <code>fchown</code>, <code>fchownat</code>, and <code>lchown</code> Functions</a></li>
<li><a href="#orgc1f9f5a"><span class="done DONE">DONE</span> 4.12 File Size</a></li>
<li><a href="#orgc8d6b03"><span class="done DONE">DONE</span> 4.13 File Truncation</a></li>
<li><a href="#org6159cb8"><span class="done DONE">DONE</span> 4.14 File Systems</a></li>
<li><a href="#orgf56fe68"><span class="done DONE">DONE</span> 4.15 <code>link</code>, <code>linkat</code>, <code>unlink</code>, <code>unlinkat</code>, and <code>remove</code> Functions</a></li>
<li><a href="#orgcdc7dad"><span class="done DONE">DONE</span> 4.16 <code>rename</code> and <code>renameat</code> Functions</a></li>
<li><a href="#org98383b7"><span class="done DONE">DONE</span> 4.17 Symbolic Links</a></li>
<li><a href="#org5760eb0"><span class="done DONE">DONE</span> 4.18 Creating and Reading Symbolic Links</a></li>
<li><a href="#org09fdee7"><span class="done DONE">DONE</span> 4.19 File Times</a></li>
<li><a href="#orge969b66"><span class="done DONE">DONE</span> 4.20 <code>futimens</code>, <code>utimensat</code>, and <code>utimes</code> Functions</a></li>
<li><a href="#org41ffcec"><span class="done DONE">DONE</span> 4.21 <code>mkdir</code>, <code>mkdirat</code>, and <code>rmdir</code> Functions</a></li>
<li><a href="#org6506b6b"><span class="done DONE">DONE</span> 4.22 Reading Directories</a></li>
<li><a href="#orga4403b0"><span class="done DONE">DONE</span> 4.23 <code>chidr</code>, <code>fchdir</code> and <code>getcwd</code> Functions</a></li>
<li><a href="#org21b8fa9"><span class="done DONE">DONE</span> 4.24 Device Special Files</a></li>
<li><a href="#org9456282"><span class="done DONE">DONE</span> 4.25 Summary of File Access Permission Bits</a></li>
<li><a href="#org45fb184"><span class="done DONE">DONE</span> 4.26 Summary</a></li>
</ul>
</li>
<li><a href="#orgcc74a38"><span class="done DONE">DONE</span> Chapter 5. Standard I/O Library <code>[16/16]</code></a>
<ul>
<li><a href="#org25ca748"><span class="done DONE">DONE</span> 5.1 Introduction</a></li>
<li><a href="#org9bc3748"><span class="done DONE">DONE</span> 5.2 Streams and FILE Objects</a></li>
<li><a href="#org8236a2b"><span class="done DONE">DONE</span> 5.3 Standard Input, Standard Output and Standard Error</a></li>
<li><a href="#orgc66e0fd"><span class="done DONE">DONE</span> 5.4 Buffering</a></li>
<li><a href="#org665951e"><span class="done DONE">DONE</span> 5.5 Opening a Stream</a></li>
<li><a href="#orga5e45a2"><span class="done DONE">DONE</span> 5.6 Reading and Writing a Stream</a></li>
<li><a href="#orgfe07c15"><span class="done DONE">DONE</span> 5.9 Line-at-a-Time I/O</a></li>
<li><a href="#org9dd8342"><span class="done DONE">DONE</span> 5.10 Standard I/O Efficiency</a></li>
<li><a href="#org44b672c"><span class="done DONE">DONE</span> 5.11 Binary I/O</a></li>
<li><a href="#org4486daa"><span class="done DONE">DONE</span> 5.12 Positioning a Stream</a></li>
<li><a href="#orgb55ec70"><span class="done DONE">DONE</span> 5.13 Formated I/O</a></li>
<li><a href="#orga6cd9a5"><span class="done DONE">DONE</span> 5.14 Implementation Details</a></li>
<li><a href="#orgafd1626"><span class="done DONE">DONE</span> 5.15 Temporary Files</a></li>
<li><a href="#org6663806"><span class="done DONE">DONE</span> 5.16 Memory Streams</a></li>
<li><a href="#org52efd99"><span class="done DONE">DONE</span> 5.17 Alternatives to Standard I/O</a></li>
<li><a href="#org82b128c"><span class="done DONE">DONE</span> 5.18 Summary</a></li>
</ul>
</li>
<li><a href="#org17c2f01"><span class="done DONE">DONE</span> Chapter 6. System Data Files and Information <code>[11/11]</code></a>
<ul>
<li><a href="#orgb3fa8c1"><span class="done DONE">DONE</span> 6.1 introduction</a></li>
<li><a href="#org3a729f8"><span class="done DONE">DONE</span> 6.2 Password File</a></li>
<li><a href="#org5ba9f1d"><span class="done DONE">DONE</span> 6.3 Shadow Passwords</a></li>
<li><a href="#org5ba3802"><span class="done DONE">DONE</span> 6.4 Group File</a></li>
<li><a href="#org3dd4022"><span class="done DONE">DONE</span> 6.5 Supplementary Group Ids</a></li>
<li><a href="#org35a4c6c"><span class="done DONE">DONE</span> 6.6 Implementation Differences</a></li>
<li><a href="#orgf6be85e"><span class="done DONE">DONE</span> 6.7 Other Data Files</a></li>
<li><a href="#org039007f"><span class="done DONE">DONE</span> 6.8 Login Accounting</a></li>
<li><a href="#org34c8860"><span class="done DONE">DONE</span> 6.9 System Identification</a></li>
<li><a href="#orgc7bcf9e"><span class="done DONE">DONE</span> 6.10 Time and Date Routines</a></li>
<li><a href="#org62c31da"><span class="done DONE">DONE</span> 6.11 Summary</a></li>
</ul>
</li>
<li><a href="#org171f893"><span class="done DONE">DONE</span> Chapter 7. Process Environment <code>[11/11]</code></a>
<ul>
<li><a href="#orgce16650"><span class="done DONE">DONE</span> 7.1 Introduction</a></li>
<li><a href="#org0ba5cbd"><span class="done DONE">DONE</span> 7.2 main Function</a></li>
<li><a href="#org32eda32"><span class="done DONE">DONE</span> 7.3 Process Termination</a></li>
<li><a href="#org0b413f0"><span class="done DONE">DONE</span> 7.5 Environment List</a></li>
<li><a href="#orge3849ae"><span class="done DONE">DONE</span> 7.6 Memory Layout of a C Program</a></li>
<li><a href="#org2b6d972"><span class="done DONE">DONE</span> 7.7 Shared Libraries</a></li>
<li><a href="#org1100b1b"><span class="done DONE">DONE</span> 7.8 Memory Allocation</a></li>
<li><a href="#org6345ffd"><span class="done DONE">DONE</span> 7.9 Environment Variable</a></li>
<li><a href="#orge6f8dc1"><span class="done DONE">DONE</span> 7.10 <code>setjmp</code> and <code>longjmp</code> Functions</a></li>
<li><a href="#org532778a"><span class="done DONE">DONE</span> <code>getrlimit</code> and <code>setrlimit</code> Functions</a></li>
<li><a href="#org4e509ce"><span class="done DONE">DONE</span> Summary</a></li>
</ul>
</li>
<li><a href="#orgb02e2f1"><span class="done DONE">DONE</span> Chapter 8. Process Control <code>[18/18]</code></a>
<ul>
<li><a href="#orgd43487c"><span class="done DONE">DONE</span> 8.1 Introduction</a></li>
<li><a href="#org5927cb9"><span class="done DONE">DONE</span> 8.2 Process Identifiers</a></li>
<li><a href="#orgd81e9a7"><span class="done DONE">DONE</span> 8.3 <code>fork</code> Function</a></li>
<li><a href="#orgc5d3e4e"><span class="done DONE">DONE</span> 8.4 <code>vfork</code> Function</a></li>
<li><a href="#org5503d40"><span class="done DONE">DONE</span> 8.5 <code>exit</code> Function</a></li>
<li><a href="#org675aa9f"><span class="done DONE">DONE</span> 8.6 <code>wait</code> and <code>waitpid</code> Functions</a></li>
<li><a href="#orga2f6b02"><span class="done DONE">DONE</span> 8.7 <code>waitid</code> Function</a></li>
<li><a href="#orgef17a7b"><span class="done DONE">DONE</span> 8.8 <code>wait3</code> and <code>wait4</code> Functions</a></li>
<li><a href="#org506858a"><span class="done DONE">DONE</span> 8.9 Race Conditions</a></li>
<li><a href="#orgacf2e88"><span class="done DONE">DONE</span> 8.10 <code>exec</code> Functions</a></li>
<li><a href="#orgf60ab30"><span class="done DONE">DONE</span> 8.11 Changing User IDs and Group IDs</a></li>
<li><a href="#orgaa9f752"><span class="done DONE">DONE</span> 8.12 Interpreter Files</a></li>
<li><a href="#org215e1bb"><span class="done DONE">DONE</span> 8.13 <code>system</code> Function</a></li>
<li><a href="#org7491235"><span class="done DONE">DONE</span> 8.14 Process Accounting</a></li>
<li><a href="#org9eedd88"><span class="done DONE">DONE</span> 8.15 User Identification</a></li>
<li><a href="#orge609e41"><span class="done DONE">DONE</span> 8.16 Process Scheduling</a></li>
<li><a href="#org078da78"><span class="done DONE">DONE</span> 8.17 Process Times</a></li>
<li><a href="#org883f24f"><span class="done DONE">DONE</span> 8.18 Summary</a></li>
</ul>
</li>
<li><a href="#org3d47b11"><span class="done DONE">DONE</span> Chapter 9. Process Relationships <code>[12/12]</code></a>
<ul>
<li><a href="#orgb794aeb"><span class="done DONE">DONE</span> 9.1 Introduction</a></li>
<li><a href="#org2399575"><span class="done DONE">DONE</span> 9.2 Terminal Logins</a></li>
<li><a href="#orge058d69"><span class="done DONE">DONE</span> 9.3 Network Logins</a></li>
<li><a href="#org362d15a"><span class="done DONE">DONE</span> 9.4 Process Groups</a></li>
<li><a href="#org5e64133"><span class="done DONE">DONE</span> 9.5 Sessions</a></li>
<li><a href="#org1e6d214"><span class="done DONE">DONE</span> 9.6 Controlling Terminal</a></li>
<li><a href="#orge174c6b"><span class="done DONE">DONE</span> 9.7 <code>tcgetpgrp</code>, <code>tcsetpgrp</code>, and <code>tcgetsid</code> Functions</a></li>
<li><a href="#orge927023"><span class="done DONE">DONE</span> 9.8 Job Control</a></li>
<li><a href="#orgd0f4cab"><span class="done DONE">DONE</span> 9.9 Shell Execution Programs</a></li>
<li><a href="#org5ea14a2"><span class="done DONE">DONE</span> 9.10 Orphaned Process Groups</a></li>
<li><a href="#orgb5fad65"><span class="done DONE">DONE</span> 9.11 FreeBSD Implementation</a></li>
<li><a href="#orgcee5c4b"><span class="done DONE">DONE</span> 9.12 Summary</a></li>
</ul>
</li>
<li><a href="#org83a7183"><span class="done DONE">DONE</span> Chapter 10. Signals <code>[23/23]</code></a>
<ul>
<li><a href="#org16b9dcb"><span class="done DONE">DONE</span> 10.1 Introduction</a></li>
<li><a href="#org4f65cf9"><span class="done DONE">DONE</span> 10.2 Signal Concepts</a></li>
<li><a href="#org53115df"><span class="done DONE">DONE</span> 10.3 <code>signal</code> Function</a></li>
<li><a href="#org170ec9b"><span class="done DONE">DONE</span> 10.4 Unreliable Signals</a></li>
<li><a href="#org82b41fb"><span class="done DONE">DONE</span> 10.5 Interrupted System Calls</a></li>
<li><a href="#org3bcc88d"><span class="done DONE">DONE</span> 10.6 Reentrant Functions</a></li>
<li><a href="#orga40cabd"><span class="done DONE">DONE</span> 10.7 <code>SIGCLD</code> Semantics</a></li>
<li><a href="#orgb6c0195"><span class="done DONE">DONE</span> 10.8 Reliable-Signal Terminology and Semantics</a></li>
<li><a href="#orgc06cb9f"><span class="done DONE">DONE</span> 10.9 <code>kill</code> and <code>raise</code> Functions</a></li>
<li><a href="#orgc3914c7"><span class="done DONE">DONE</span> 10.10 <code>alarm</code> and <code>pause</code> Functions</a></li>
<li><a href="#org60e4b93"><span class="done DONE">DONE</span> 10.11 Signal Sets</a></li>
<li><a href="#org7c51d44"><span class="done DONE">DONE</span> 10.12 <code>sigprocmask</code> Function</a></li>
<li><a href="#org89b0287"><span class="done DONE">DONE</span> 10.13 <code>sigpending</code> Function</a></li>
<li><a href="#org1fce263"><span class="done DONE">DONE</span> 10.14 <code>sigaction</code> Function</a></li>
<li><a href="#orgd64281d"><span class="done DONE">DONE</span> 10.15 <code>sigsetjmp</code> and <code>siglongjmp</code> Functions</a></li>
<li><a href="#orgd1af33b"><span class="done DONE">DONE</span> 10.16 <code>sigsuspend</code> Function</a></li>
<li><a href="#org93398c1"><span class="done DONE">DONE</span> 10.17 <code>abort</code> Function</a></li>
<li><a href="#orgb8ab86c"><span class="done DONE">DONE</span> 10.18 <code>system</code> Function</a></li>
<li><a href="#org5bfd396"><span class="done DONE">DONE</span> 10.19 <code>sleep</code>, <code>nanaosleep</code>, and <code>clock_nanosleep</code> Functions</a></li>
<li><a href="#org42c5fa3"><span class="done DONE">DONE</span> 10.20 <code>sigqueue</code> Function</a></li>
<li><a href="#org6a11967"><span class="done DONE">DONE</span> 10.21 Job-Control Signals</a></li>
<li><a href="#orgc31fbb3"><span class="done DONE">DONE</span> 10.22 Signal Names and Numbers</a></li>
<li><a href="#orgc9671f4"><span class="done DONE">DONE</span> 10.23 Summary</a></li>
</ul>
</li>
<li><a href="#org62b8cc4"><span class="done DONE">DONE</span> Chapter 11. Threads <code>[7/7]</code></a>
<ul>
<li><a href="#orga54e664"><span class="done DONE">DONE</span> 11.1 Introduction</a></li>
<li><a href="#orgab89991"><span class="done DONE">DONE</span> 11.2 Thread Concepts</a></li>
<li><a href="#org90fd1f2"><span class="done DONE">DONE</span> 11.3 Thread Identification</a></li>
<li><a href="#org2c4ec82"><span class="done DONE">DONE</span> 11.4 Thread Creation</a></li>
<li><a href="#org56ee833"><span class="done DONE">DONE</span> 11.5 Thread Termination</a></li>
<li><a href="#org4a64f5a"><span class="done DONE">DONE</span> 11.6 Thread Synchronization <code>[8/8]</code></a></li>
<li><a href="#orga45038d"><span class="done DONE">DONE</span> 11.7 Summary</a></li>
</ul>
</li>
<li><a href="#org1fc0cca"><span class="done DONE">DONE</span> Chapter 12. Thread Control <code>[11/11]</code></a>
<ul>
<li><a href="#org7040819"><span class="done DONE">DONE</span> 12.1 Introduction</a></li>
<li><a href="#org361dd8a"><span class="done DONE">DONE</span> 12.2 Thread Limits</a></li>
<li><a href="#orgc0f7c7b"><span class="done DONE">DONE</span> 12.3 Thread Attributes</a></li>
<li><a href="#org762a0d8"><span class="done DONE">DONE</span> 12.4 Synchronization Attributes <code>[4/4]</code></a></li>
<li><a href="#org2c2e344"><span class="done DONE">DONE</span> 12.5 Reentrancy</a></li>
<li><a href="#orgeafa146"><span class="done DONE">DONE</span> 12.6 Thread-Specific Data</a></li>
<li><a href="#org251542e"><span class="done DONE">DONE</span> 12.7 Cancel Options</a></li>
<li><a href="#org135236c"><span class="done DONE">DONE</span> 12.8 Threads and Signals</a></li>
<li><a href="#orgbfc013c"><span class="done DONE">DONE</span> 12.9 Threads and fork</a></li>
<li><a href="#org35b95fb"><span class="done DONE">DONE</span> 12.10 Threads and I/O</a></li>
<li><a href="#org4550453"><span class="done DONE">DONE</span> 12.11 Summary</a></li>
</ul>
</li>
<li><a href="#orgfef4460"><span class="done DONE">DONE</span> Chapter 13. Daemon Processes <code>[8/8]</code></a>
<ul>
<li><a href="#org86063a8"><span class="done DONE">DONE</span> 13.1 Introduction</a></li>
<li><a href="#org3afc8ae"><span class="done DONE">DONE</span> 13.2 Daemon Characteristics</a></li>
<li><a href="#org0d6e4d6"><span class="done DONE">DONE</span> 13.3 Coding Rules</a></li>
<li><a href="#org9f32caf"><span class="done DONE">DONE</span> 13.4 Error Logging</a></li>
<li><a href="#org3860ed0"><span class="done DONE">DONE</span> 13.5 Single-Instance Daemons</a></li>
<li><a href="#org90939e5"><span class="done DONE">DONE</span> 13.6 Daemon Conventions</a></li>
<li><a href="#org392fc48"><span class="done DONE">DONE</span> 13.7 Client-Server Model</a></li>
<li><a href="#org5451179"><span class="done DONE">DONE</span> 13.8 Summary</a></li>
</ul>
</li>
<li><a href="#orgf88b4e5"><span class="done DONE">DONE</span> Chapter 14. Advanced I/O <code>[9/9]</code></a>
<ul>
<li><a href="#orgf797944"><span class="done DONE">DONE</span> 14.1 Introduction</a></li>
<li><a href="#org1b4ac0c"><span class="done DONE">DONE</span> 14.2 Nonblocking I/O</a></li>
<li><a href="#orgaeea125"><span class="done DONE">DONE</span> 14.3 Record Locking</a></li>
<li><a href="#orgd4d91f2"><span class="done DONE">DONE</span> 14.4 I/O Multiplexing <code>[2/2]</code></a></li>
<li><a href="#org51e0335"><span class="done DONE">DONE</span> 14.5 Asynchronous I/O <code>[3/3]</code></a></li>
<li><a href="#org5e48300"><span class="done DONE">DONE</span> 14.6 <code>readv</code> and <code>writev</code> Functions</a></li>
<li><a href="#org9970b43"><span class="done DONE">DONE</span> 14.7 <code>readn</code> and <code>writen</code> Functions</a></li>
<li><a href="#org1675acd"><span class="done DONE">DONE</span> 14.8 Memory-Mapped I/O</a></li>
<li><a href="#orga782c1c"><span class="done DONE">DONE</span> 14.9 Summary</a></li>
</ul>
</li>
<li><a href="#orgea8ee03"><span class="done DONE">DONE</span> Chapter 15. Interprocess Communication <code>[12/12]</code></a>
<ul>
<li><a href="#orgec103dc"><span class="done DONE">DONE</span> 15.1 Introduction</a></li>
<li><a href="#org18ea212"><span class="done DONE">DONE</span> 15.2 Pipes</a></li>
<li><a href="#org03a8937"><span class="done DONE">DONE</span> 15.3 <code>popen</code> and <code>pclose</code> Functions</a></li>
<li><a href="#orge6f53c8"><span class="done DONE">DONE</span> 15.4 Coprocesses</a></li>
<li><a href="#org44e9a90"><span class="done DONE">DONE</span> 15.5 FIFOs</a></li>
<li><a href="#org1281744"><span class="done DONE">DONE</span> 15.6 XSI IPC <code>[4/4]</code></a></li>
<li><a href="#org6425c9b"><span class="done DONE">DONE</span> 15.7 Message Queues</a></li>
<li><a href="#orgac96d8d"><span class="done DONE">DONE</span> 15.8 Semaphores</a></li>
<li><a href="#orge08048d"><span class="done DONE">DONE</span> 15.9 Shared Memory</a></li>
<li><a href="#org379ea6c"><span class="done DONE">DONE</span> 15.10 POSIX Semaphores</a></li>
<li><a href="#org1a47e50"><span class="done DONE">DONE</span> 15.11 Client-Server Properties</a></li>
<li><a href="#orgae01e72"><span class="done DONE">DONE</span> 15.12 Summary</a></li>
</ul>
</li>
<li><a href="#org8c16c77"><span class="done DONE">DONE</span> Chapter 16. Network IPC: Sockets <code>[9/9]</code></a>
<ul>
<li><a href="#orge366d64"><span class="done DONE">DONE</span> 16.1 Introduction</a></li>
<li><a href="#orgb297d64"><span class="done DONE">DONE</span> 16.2 Socket Descriptors</a></li>
<li><a href="#orgf14455e"><span class="done DONE">DONE</span> 16.3 Addressing <code>[4/4]</code></a></li>
<li><a href="#orgc5f0d75"><span class="done DONE">DONE</span> 16.4 Connection Establishment</a></li>
<li><a href="#org4a9bdde"><span class="done DONE">DONE</span> 16.5 Data Transfer</a></li>
<li><a href="#org64ada3f"><span class="done DONE">DONE</span> 16.6 Socket Options</a></li>
<li><a href="#orgcab5af7"><span class="done DONE">DONE</span> 16.7 Out-of-Band Data</a></li>
<li><a href="#org5cb94fa"><span class="done DONE">DONE</span> 16.8 Nonblocking and Asynchronous I/O</a></li>
<li><a href="#orge58cf2a"><span class="done DONE">DONE</span> 16.9 Summary</a></li>
</ul>
</li>
<li><a href="#org70c72ba"><span class="todo TODO">TODO</span> Chapter 17. Advanced IPC <code>[3/7]</code></a>
<ul>
<li><a href="#org3ec8f15"><span class="done DONE">DONE</span> 17.1 Introduction</a></li>
<li><a href="#orga84e8c2"><span class="done DONE">DONE</span> 17.2 UNIX Domain Sockets</a></li>
<li><a href="#org8344e04"><span class="done DONE">DONE</span> 17.3 Unique Connections</a></li>
<li><a href="#org38c0476"><span class="todo TODO">TODO</span> 17.4 Passing File Descriptors</a></li>
<li><a href="#org86e71c4"><span class="todo TODO">TODO</span> 17.5 An Open Server, Version 1</a></li>
<li><a href="#org2eb2454"><span class="todo TODO">TODO</span> 17.6 An Open Server, Version 2</a></li>
<li><a href="#org890b236"><span class="todo TODO">TODO</span> 17.7 Summary</a></li>
</ul>
</li>
<li><a href="#org749f15c"><span class="todo TODO">TODO</span> Chapter 18. Terminal I/O <code>[0/0]</code></a>
<ul>
<li><a href="#orge392956">18.1 Introduction</a></li>
<li><a href="#org910f419">18.2</a></li>
</ul>
</li>
<li><a href="#orgaa79de7"><span class="todo TODO">TODO</span> Chapter 19. Pseudo Terminals <code>[0/0]</code></a></li>
<li><a href="#org8729047"><span class="todo TODO">TODO</span> Chapter 20. A Database Library <code>[0/0]</code></a></li>
<li><a href="#orga089da9"><span class="todo TODO">TODO</span> Chapter 21. Communication with a Network Printer <code>[0/0]</code></a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-orga6453ab" class="outline-2">
<h2 id="orga6453ab">Advanced Programming in the Unix Environment <code>[76%]</code></h2>
<div class="outline-text-2" id="text-orga6453ab">
</div>
<div id="outline-container-org9a72ce7" class="outline-3">
<h3 id="org9a72ce7"><span class="done DONE">DONE</span> Chapter 1. UNIX System Overview <code>[12/12]</code></h3>
<div class="outline-text-3" id="text-org9a72ce7">
</div>

<div id="outline-container-org9a350c3" class="outline-4">
<h4 id="org9a350c3"><span class="done DONE">DONE</span> 1.1 Introduction</h4>
<div class="outline-text-4" id="text-org9a350c3">
<p>
操作系统为程序的运行提供服务。
</p>
</div>
</div>

<div id="outline-container-org88c4df0" class="outline-4">
<h4 id="org88c4df0"><span class="done DONE">DONE</span> 1.2 UNIX Architecture</h4>
<div class="outline-text-4" id="text-org88c4df0">
<ul class="org-ul">
<li>内核：控制硬件资源和提供程序运行环境的软件</li>
<li>系统调用：内核的接口层</li>
<li>库：包含系统调用上层的常用函数</li>
<li>shell：为其它程序的运行提供接口的特殊秩序</li>
</ul>

<div id="org5d0b81c" class="figure">
<p><img src="Chapter01/01fig01.jpg" alt="01fig01.jpg" />
</p>
<p><span class="figure-number">Figure 1: </span>Figure 1.1 Architecture of the UNIX operating system</p>
</div>
</div>
</div>

<div id="outline-container-org7a4e3c7" class="outline-4">
<h4 id="org7a4e3c7"><span class="done DONE">DONE</span> 1.3 Logging in</h4>
<div class="outline-text-4" id="text-org7a4e3c7">
</div>
<ul class="org-ul">
<li><a id="orgc3942ee"></a>Login Name<br />
<div class="outline-text-5" id="text-orgc3942ee">
<p>
<code>/etc/passwd</code> 文件保存了用户信息
</p>
</div>
</li>

<li><a id="org0d29767"></a>Shells<br />
<div class="outline-text-5" id="text-org0d29767">

<div id="orgd96b3e3" class="figure">
<p><img src="Chapter01/01fig02.jpg" alt="01fig02.jpg" />
</p>
<p><span class="figure-number">Figure 2: </span>Figure 1.2 Common shells used on UNIX systems</p>
</div>
</div>
</li>
</ul>
</div>

<div id="outline-container-orge9dadf9" class="outline-4">
<h4 id="orge9dadf9"><span class="done DONE">DONE</span> 1.4 Files and Directories</h4>
<div class="outline-text-4" id="text-orge9dadf9">
</div>
<ul class="org-ul">
<li><a id="orgb732d80"></a>File System<br />
<div class="outline-text-5" id="text-orgb732d80">
<p>
UNIX 文件是一个目录和文件的层级结构，从根目录 "/" 开始
</p>

<p>
目录是一个包含了目录条目的文件, 逻辑上每个条目包含了文件名, 文件属性等信息结构.
</p>
</div>

<ul class="org-ul">
<li><a id="org3c58e32"></a>Filename<br />
<div class="outline-text-6" id="text-org3c58e32">
<p>
目录中的名字称为文件名.
</p>
</div>
</li>

<li><a id="org12b8bd3"></a>Pathname<br />
<div class="outline-text-6" id="text-org12b8bd3">
<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>Figure 1.3 List all the files in a directory</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">dirent.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">__progname</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">DIR</span>           *<span style="color: #7590db;">dp</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">dirent</span> *<span style="color: #7590db;">dirp</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc != <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"usage: %s directory_name"</span>, __progname<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>dp = opendir<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"can't open %ls"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>dirp = readdir<span style="color: #67b11d;">(</span>dp<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>strcoll<span style="color: #67b11d;">(</span>dirp-&gt;d_name, <span style="color: #2d9574;">"."</span><span style="color: #67b11d;">)</span> != <span style="color: #a45bad;">0</span> &amp;&amp;
            strcoll<span style="color: #67b11d;">(</span>dirp-&gt;d_name, <span style="color: #2d9574;">".."</span><span style="color: #67b11d;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"%s\n"</span>, dirp-&gt;d_name<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    closedir<span style="color: #bc6ec5;">(</span>dp<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>

<li><a id="org34748a8"></a>Working Directory<br />
<div class="outline-text-6" id="text-org34748a8">
<p>
当前所在目录
</p>
</div>
</li>

<li><a id="org553edf7"></a>Home Directory<br />
<div class="outline-text-6" id="text-org553edf7">
<p>
设置的登录后所处的目录
</p>
</div>
</li>
</ul>
</li>
</ul>
</div>

<div id="outline-container-org8c758d4" class="outline-4">
<h4 id="org8c758d4"><span class="done DONE">DONE</span> 1.5 Input and Output - File Descriptors</h4>
<div class="outline-text-4" id="text-org8c758d4">
</div>
<ul class="org-ul">
<li><a id="org651e829"></a>文件描述符<br />
<div class="outline-text-5" id="text-org651e829">
<p>
非负整数，被内核用以区分被进程访问的文件
</p>
</div>

<ul class="org-ul">
<li><a id="orged2a60e"></a>Standard Input, Standard Output, and Standard Error<br />
<ul class="org-ul">
<li><a id="org0031ce4"></a>Unbuffered I/O<br />
<div class="outline-text-7" id="text-org0031ce4">
<p>
由 <code>open</code>, <code>read</code>, <code>write</code>, <code>lseek</code>, <code>close</code> 函数提供
</p>
<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>Figure 1.4 Copy standard input to standard output</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">BUFFSIZE</span> <span style="color: #a45bad;">4096</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>  <span style="color: #7590db;">n</span> = <span style="color: #a45bad;">0</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span>BUFFSIZE<span style="color: #bc6ec5;">]</span>;

    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>n = read<span style="color: #67b11d;">(</span>STDIN_FILENO, buf, BUFFSIZE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>write<span style="color: #67b11d;">(</span>STDOUT_FILENO, buf, n<span style="color: #67b11d;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"write error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>n &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"read error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>

<li><a id="org3da5101"></a>Standard I/O<br />
<div class="outline-text-7" id="text-org3da5101">
<p>
为无缓冲的 I/O 函数提供带缓冲的 I/O 接口。
</p>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>Figure 1.5 Copy standard input to standard output, using standard I/O</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">c</span>;
    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>c = getc<span style="color: #67b11d;">(</span>stdin<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != EOF<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>putc<span style="color: #67b11d;">(</span>c, stdout<span style="color: #67b11d;">)</span> == EOF<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"output error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ferror<span style="color: #2d9574;">(</span>stdin<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"input error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>

<div id="outline-container-org8db9575" class="outline-4">
<h4 id="org8db9575"><span class="done DONE">DONE</span> 1.6 Programs and Processes</h4>
<div class="outline-text-4" id="text-org8db9575">
</div>
<ul class="org-ul">
<li><a id="orgec840da"></a>Program<br />
<div class="outline-text-5" id="text-orgec840da">
<p>
存在于磁盘上一个目录里的 <b>可执行</b> 文件
读入内存后由内核使用 7 个 <code>exec</code> 函数之一执行
</p>
</div>

<ul class="org-ul">
<li><a id="org665d79f"></a>Proceses and Process ID<br />
<div class="outline-text-6" id="text-org665d79f">
<p>
一个运行中程序的实例称为进程。
</p>

<p>
每一个进程都有一个独有的数字标识，称为 PID，一般为非负整数。
</p>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>Figure 1.6 Print the process ID</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"hello world from process ID %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>getpid<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>

<li><a id="org0057a7f"></a>Process Control<br />
<div class="outline-text-6" id="text-org0057a7f">
<p>
<code>fork</code>, <code>exec</code>, <code>waitpid</code>
</p>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 5: </span>Figure 1.7 Read commands from standard input and execute them</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span>  <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span>MAXLINE<span style="color: #bc6ec5;">]</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">from apue.h</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">status</span>;

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%% "</span><span style="color: #bc6ec5;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">print prompt (printf require %% to print %)</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>

    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span>fgets<span style="color: #2d9574;">(</span>buf, MAXLINE, stdin<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>buf<span style="color: #67b11d;">[</span>strlen<span style="color: #b1951d;">(</span>buf<span style="color: #b1951d;">)</span> - <span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span> == <span style="color: #2d9574;">'\n'</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            buf<span style="color: #67b11d;">[</span>strlen<span style="color: #b1951d;">(</span>buf<span style="color: #b1951d;">)</span> - <span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span> = <span style="color: #a45bad;">0</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">replace newline with null</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>pid = fork<span style="color: #b1951d;">()</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            execlp<span style="color: #67b11d;">(</span>buf, buf, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span>;
            err_ret<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"coulnd't excute: %s"</span>, buf<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">parent</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>pid = waitpid<span style="color: #b1951d;">(</span>pid, &amp;status, <span style="color: #a45bad;">0</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"waitpid error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%% "</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>

<li><a id="org80345c3"></a>Threads and Thread IDs<br />
<div class="outline-text-6" id="text-org80345c3">
<p>
多线程用于多核系统的并发。
</p>

<p>
线程 ID 与进程 ID 相似。
</p>
</div>
</li>
</ul>
</li>
</ul>
</div>
<div id="outline-container-org04026b6" class="outline-4">
<h4 id="org04026b6"><span class="done DONE">DONE</span> 1.7 Error Handling</h4>
<div class="outline-text-4" id="text-org04026b6">
<p>
当 UNIX 系统函数出现错误时，返回一个负值，errno 通常被设置为错误原因代码。
</p>

<p>
&lt;errno.h&gt; 定义了 errno，并为每一个设想的错误定义了一个常数。
</p>


<p>
多线程共享进程地址空间，会互相干扰，所以需要自己的 errno 备份。Linux 多线程访问 errno:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">Linux &#22810;&#32447;&#31243;&#35775;&#38382; errno:</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">int</span> *<span style="color: #bc6ec5; font-weight: bold;">__errno_location</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">errno</span> <span style="color: #4f97d7;">(</span>*__errno_location<span style="color: #bc6ec5;">()</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<p>
关于 <code>errno</code> 需要注意以下两点：
</p>
<ol class="org-ol">
<li>如果没有发生错误， <code>errno</code> 也不会清除</li>
<li><code>errno</code> 的值不会被设为 0，&lt;errno.h&gt; 里也没有定义常数 0</li>
</ol>


<p>
打印错误信息的函数
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">string.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      Print error messages</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     pointer to message string</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #bc6ec5; font-weight: bold;">strerror</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">errnum</span><span style="color: #4f97d7;">)</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      print error messages</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@details</span><span style="color: #9f8766;">    outputs the string pointed to by msg,</span>
<span style="color: #9f8766;"> *             followed by a colon and a space,</span>
<span style="color: #9f8766;"> *             followed by the error message corresponding to the value of errno,</span>
<span style="color: #9f8766;"> *             followed by a '\n'</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">perror</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">msg</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 6: </span>Figure 1.8 Demonstrate strerror and perror</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    fprintf<span style="color: #bc6ec5;">(</span>stderr, <span style="color: #2d9574;">"EACCESS: %s\n"</span>, strerror<span style="color: #2d9574;">(</span>EACCES<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    errno = ENOENT;
    perror<span style="color: #bc6ec5;">(</span>argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>

<ul class="org-ul">
<li><a id="orgafafdd8"></a>Error Recovery<br />
<div class="outline-text-5" id="text-orgafafdd8">
<p>
&lt;errno.h&gt; 内定义的错误可以分为：致命和非致命
</p>
<ul class="org-ul">
<li>致命：退出并打印错误信息到文件或屏幕</li>
<li>非致命：大多非致命错误都是暂时的，比如资源短缺，系统活动较少时可能不发生，通常延迟重试即可。</li>
</ul>
</div>
</li>
</ul>
</div>

<div id="outline-container-org7074674" class="outline-4">
<h4 id="org7074674"><span class="done DONE">DONE</span> 1.8 User identification</h4>
<div class="outline-text-4" id="text-org7074674">
</div>
<ul class="org-ul">
<li><a id="orgbe76e9a"></a>User ID<br />
<div class="outline-text-5" id="text-orgbe76e9a">
<p>
保存在密码文件里的数字值，系统用以区分用户
</p>

<p>
<i>root</i> 或 <i>superuser</i> 的 UID 是 0
</p>
</div>
</li>

<li><a id="orgd71709f"></a>Group ID<br />
<div class="outline-text-5" id="text-orgd71709f">
<p>
类似 UID，用以区分用户属组，组文件为 /etc/group
</p>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 7: </span>Figure 1.9 Print user ID and group ID</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     uidgid.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-12-01</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    print uid and gid</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"uid = %d, gid = %d\n"</span>, getuid<span style="color: #2d9574;">()</span>, getgid<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span>;
    exit<span style="color: #bc6ec5;">(</span>EXIT_SUCCESS<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>

<li><a id="org466ebd5"></a>Supplementary Group IDs<br />
<div class="outline-text-5" id="text-org466ebd5">
<p>
除了密码本文件中为用户名指定的 GID，多数 UNIX 系统版本允许一个用户归属其它组。
</p>
</div>
</li>
</ul>
</div>

<div id="outline-container-orgc37441c" class="outline-4">
<h4 id="orgc37441c"><span class="done DONE">DONE</span> 1.9 Signals</h4>
<div class="outline-text-4" id="text-orgc37441c">
<p>
Process choices:
</p>
<ol class="org-ol">
<li>Ignore</li>
<li>default action</li>
<li>provide call function (catch signal)</li>
</ol>


<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 8: </span>Figure 1.10 Read commands from standard input and execute them</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/types.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_int</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">our signal-catching function</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span>  <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span>MAXLINE<span style="color: #bc6ec5;">]</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">from apue.h</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">status</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGINT, sig_int<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"signal error"</span><span style="color: #bc6ec5;">)</span>;

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%% "</span><span style="color: #bc6ec5;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">print prompt (printf requires %% to print %)</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span>fgets<span style="color: #2d9574;">(</span>buf, MAXLINE, stdin<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>buf<span style="color: #67b11d;">[</span>strlen<span style="color: #b1951d;">(</span>buf<span style="color: #b1951d;">)</span> - <span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span> == <span style="color: #2d9574;">'\n'</span><span style="color: #2d9574;">)</span>
            buf<span style="color: #2d9574;">[</span>strlen<span style="color: #67b11d;">(</span>buf<span style="color: #67b11d;">)</span> - <span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span> = <span style="color: #a45bad;">0</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">replace newline with null</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>pid = fork<span style="color: #b1951d;">()</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            execlp<span style="color: #67b11d;">(</span>buf, buf, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span>;
            err_ret<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"couldn't execute: %s"</span>, buf<span style="color: #67b11d;">)</span>;
            exit<span style="color: #67b11d;">(</span><span style="color: #a45bad;">127</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_int</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"interrupt\n%% "</span><span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org3bd36b9" class="outline-4">
<h4 id="org3bd36b9"><span class="done DONE">DONE</span> 1.10 Time Values</h4>
<div class="outline-text-4" id="text-org3bd36b9">
<ol class="org-ol">
<li>Calendar time. The value counts the number of seconds since the Epoch: 00:00:00 January 1, 1970, UTC.</li>
<li>Process time. CPU time, measures the central processor resources used by a process. in clock ticks. <code>clock_t</code>.
<ul class="org-ul">
<li>Clock time</li>
<li>User CPU time</li>
<li>System CPU time</li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-orgeb6db64" class="outline-4">
<h4 id="orgeb6db64"><span class="done DONE">DONE</span> 1.11 System calls and Library Functions</h4>
<div class="outline-text-4" id="text-orgeb6db64">
<ul class="org-ul">
<li>Concepts:
<ul class="org-ul">
<li>System calls:
<ul class="org-ul">
<li>Unix 系统实现，定义明确且数量有限的接口</li>
<li>learned with <code>man 2</code> (Section 2 of <i>Unix Programmer's Mannual</i>)</li>
<li>运行在内核</li>
</ul></li>
<li>Library Functions:
<ul class="org-ul">
<li>These functions aren’t entry points into the kernel, although they may invoke one or more of the kernel’s system calls</li>
<li>Can be learned with <code>man 3</code> for <b>general-purpose</b> (Section 3 of <i>Unix Programmer's Mannual</i>)</li>
</ul></li>
</ul></li>
<li>Distinction:
<ul class="org-ul">
<li>the system calls usually cannot be replaced</li>
<li>the interface the UNIX system provides to determine the current time and date</li>
</ul></li>
</ul>



<div id="org1946c80" class="figure">
<p><img src="Chapter01/01fig11.jpg" alt="01fig11.jpg" />
</p>
<p><span class="figure-number">Figure 3: </span>Figure 1.11 Separation of <code>malloc</code> function and <code>sbrk</code> system call</p>
</div>



<div id="org4175629" class="figure">
<p><img src="Chapter01/01fig12.jpg" alt="01fig12.jpg" />
</p>
<p><span class="figure-number">Figure 4: </span>Figure 1.12 Difference between C library functions and system calls</p>
</div>
</div>
</div>

<div id="outline-container-org3889160" class="outline-4">
<h4 id="org3889160"><span class="done DONE">DONE</span> 1.12 Summary</h4>
<div class="outline-text-4" id="text-org3889160">
<ul class="org-ul">
<li>Exercises
<ul class="org-ul">
<li>1.1</li>
<li>1.2  53268 50922 was occupied</li>
<li>1.3  strerror: int, value transfer, can not be changed, global errno can not be forecast
perror: pointer, can be changed the value point to, const set constant</li>
<li>1.4  2038,
\( \frac{2^{31}}{(60*60*24*365)+1970} \)
change time_t to u_64_t
recompile the program</li>
</ul></li>

<li>1.5</li>
</ul>

<p>
\( \frac{2^{31}}{(60*60*24*100)}=248.551348 \) days
</p>
</div>
</div>
</div>

<div id="outline-container-org8456245" class="outline-3">
<h3 id="org8456245"><span class="done DONE">DONE</span> Chapter 2. UNIX Standardization and Implementations <code>[10/10]</code></h3>
<div class="outline-text-3" id="text-org8456245">
</div>
<div id="outline-container-org91ee467" class="outline-4">
<h4 id="org91ee467"><span class="done DONE">DONE</span> 2.1 Introduction</h4>
</div>
<div id="outline-container-orgd167eb2" class="outline-4">
<h4 id="orgd167eb2"><span class="done DONE">DONE</span> 2.2 UNIX Standardization</h4>
<div class="outline-text-4" id="text-orgd167eb2">
</div>
<ul class="org-ul">
<li><a id="orgf24f8a9"></a><span class="done DONE">DONE</span> ISO C<br /></li>
<li><a id="org51f7a7a"></a><span class="done DONE">DONE</span> IEEE POSIX<br /></li>
<li><a id="orgad5f2a8"></a><span class="done DONE">DONE</span> The Single UNIX Specification<br />
<div class="outline-text-5" id="text-orgad5f2a8">
<ul class="org-ul">
<li>Encryption: denoted by <code>_XOPEN_CRYPE</code></li>
<li>Real-time: denoted by <code>_XOPEN_REALTIME</code></li>
<li>Advanced real-time</li>
<li>Real-time threads: denoted by <code>_XOPEN_REALTIME_THREADS</code></li>
<li>Advanced real-time threads</li>
</ul>
</div>
</li>

<li><a id="org8b43894"></a><span class="done DONE">DONE</span> FIPS<br /></li>
</ul>
</div>

<div id="outline-container-org8d4dda1" class="outline-4">
<h4 id="org8d4dda1"><span class="done DONE">DONE</span> 2.3 UNIX System Implementations</h4>
<div class="outline-text-4" id="text-org8d4dda1">
</div>
<ul class="org-ul">
<li><a id="org9c4f6a1"></a><span class="done DONE">DONE</span> 2.3.1 UNIX system V Release 4<br /></li>
<li><a id="org6ff233f"></a><span class="done DONE">DONE</span> 2.3.2 4.4BSD<br /></li>
<li><a id="org00b0fe5"></a><span class="done DONE">DONE</span> 2.3.3 FreeBSD<br /></li>
<li><a id="org820bd17"></a><span class="done DONE">DONE</span> 2.3.4 Linux<br /></li>
<li><a id="org25607f1"></a><span class="done DONE">DONE</span> 2.3.5 Mac OS X<br /></li>
<li><a id="org2ac36df"></a><span class="done DONE">DONE</span> 2.3.6 Solaris<br /></li>
<li><a id="orge00177b"></a><span class="done DONE">DONE</span> 2.3.7 Others<br />
<div class="outline-text-5" id="text-orge00177b">
<ul class="org-ul">
<li>AIX, IBMUNIX</li>
<li>HP-UX, HP</li>
<li>IRIX, Silicon Graphics</li>
<li>Unix Ware, SVR4 distribution</li>
</ul>
</div>
</li>
</ul>
</div>

<div id="outline-container-org6987d96" class="outline-4">
<h4 id="org6987d96"><span class="done DONE">DONE</span> 2.4 Relationship of Standards and Implementations</h4>
</div>

<div id="outline-container-org8ba6278" class="outline-4">
<h4 id="org8ba6278"><span class="done DONE">DONE</span> 2.5 Limits</h4>
<div class="outline-text-4" id="text-org8ba6278">
<ol class="org-ol">
<li>Comipile-time limits</li>
<li>Runtime limits</li>
</ol>


<p>
编译时限制可以在头文件中定义，运行时限制需要进程调用一个函数以获取值。
</p>


<div id="orgfa53b04" class="figure">
<p><img src="Chapter02/02fig06.jpg" alt="02fig06.jpg" />
</p>
<p><span class="figure-number">Figure 5: </span>Figure 2.6 Sizes of integral values from &lt;limits.h&gt;</p>
</div>


<div id="orgee2411f" class="figure">
<p><img src="Chapter02/02fig07.jpg" alt="02fig07.jpg" />
</p>
<p><span class="figure-number">Figure 6: </span>Figure 2.7 ISO limits on various platforms</p>
</div>
</div>

<ul class="org-ul">
<li><a id="org61fe0ac"></a><span class="done DONE">DONE</span> 2.5.1 ISO C Limits<br /></li>
<li><a id="org615ae71"></a><span class="done DONE">DONE</span> 2.5.2 POSIX Limits<br />
<div class="outline-text-5" id="text-org615ae71">
<ol class="org-ol">
<li>Numerical limits: <code>LONG_BIT</code>, <code>SSIZE_MAX</code>, and <code>WORD_BIT</code></li>
<li>Minimum value：Figure 2.8 中的 25 个常数</li>
<li>Maximum value: <code>_POSIX_CLOCKRES_MIN</code></li>
<li>Runtime increasable values: <code>CHARCLASS_NAME_MAX</code>, <code>COLL_WEIGHTS_MAX</code>, <code>LINE_MAX</code>, <code>NGROUPS_MAX</code>, and <code>RE_DUP_MAX</code></li>
<li>Runtime invariant values: the 17 constants in Figure 2.9 (plus an additional four constants introduced in Section 12.2 and three constants introduced in Section 14.5)</li>
<li>Other invariant values: <code>NL_ARGMAX</code>, <code>NL_MSGMAX</code>, <code>NL_SETMAX</code>, and <code>NL_TEXTMAX</code>;</li>
<li>Pathname variables values: <code>FILESIZEBITS</code>, <code>LINK_MAX</code>, <code>MAX_CANON</code>, <code>MAX_INPUT</code>, <code>NAME_MAX</code>, <code>PATH_MAX</code>, <code>PIPE_BUF</code>, and <code>SYMLINK_MAX</code></li>
</ol>



<div id="org1f7f5bb" class="figure">
<p><img src="Chapter02/02fig08.jpg" alt="02fig08.jpg" />
</p>
<p><span class="figure-number">Figure 7: </span>Figure 2.8 POSIX.1 minimum values from &lt;limits.h&gt;</p>
</div>


<div id="orgc8b62a6" class="figure">
<p><img src="Chapter02/02fig09.jpg" alt="02fig09.jpg" />
</p>
<p><span class="figure-number">Figure 8: </span>Figure 2.9 POSIX.1 runtime invariant values from &lt;limits.h&gt;</p>
</div>

<p>
其中部分常量最小值太小而不实用，不带 <b><span class="underline">POSIX</span></b> 前缀的常量名给定了一个实现的实用值。
</p>
</div>
</li>

<li><a id="org35a2dbf"></a><span class="done DONE">DONE</span> 2.5.3 XSI Limits<br />
<div class="outline-text-5" id="text-org35a2dbf">
<ol class="org-ol">
<li>Minimum values: the five constants in Figure 2.10</li>
<li>Runtime invariant values, possibly indeterminate: <b>IOV_MAX</b> and <b>PAGE_SIZE</b></li>
</ol>


<div id="org70be421" class="figure">
<p><img src="Chapter02/02fig10.jpg" alt="02fig10.jpg" />
</p>
<p><span class="figure-number">Figure 9: </span>Figure 2.10 XSI minimum values from &lt;limits.h&gt;</p>
</div>
</div>
</li>

<li><a id="org188547d"></a><span class="done DONE">DONE</span> 2.5.4 <code>sysconf</code>, <code>pathconf</code>, and <code>fpathconf</code> Functions<br />
<div class="outline-text-5" id="text-org188547d">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      obtain runtime limits</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@details</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     corresponding value if OK, -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #bc6ec5; font-weight: bold;">sysconf</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">name</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #bc6ec5; font-weight: bold;">pathconf</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">pathname</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">name</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #bc6ec5; font-weight: bold;">fpathconf</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">name</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
<p>
返回值细节
</p>
<ol class="org-ol">
<li>如果 <i>name</i> 参数并非适当常量之一，函数返回 -1 并将 <code>errno</code> 设为 <code>EINVAL</code></li>
<li>有些可以返回变量的值（&gt;= 0）或返回值不确定，通过返回 -1 且不改变 <code>errno</code> 的值来表示</li>
<li><code>_SC_CLK_TCK</code> 返回每秒时钟滴答数，供时间函数的返回值使用（Section 8.17）</li>
</ol>


<p>
有些限制适用于 <code>pathconf</code> 的/pathname/ 参数以及 <code>fpathconf</code> 的 <i>fd</i> 参数：
</p>
<ol class="org-ol">
<li><code>_PC_MAX_CANON</code> 和 <code>_PC_MAX_INPUT</code> 的引用文件必须是终端文件</li>
<li><code>_PC_LINK_MAX</code> 和 <code>_PC_TIMESTAMP_RESOLUTION</code> 的引用文件可以是文件或目录。如果是目录，则返回值适用于目录本身，而非目录中的文件名。</li>
<li><code>_PC_FILESIZEBITS</code> 和 <code>_PC_NAME_MAX</code> 的引用文件必须是目录。返回值适用于目录中的文件。</li>
<li><code>_PC_PATH_MAX</code> 的引用文件必须是目录。</li>
<li><code>_PC_PIPE_BUF</code> 的引用文件必须是一个 pipe, FIFO 或目录。前两个是 pipe 或 FIFO 的限制值，如果是目录时，返回值是目录中的任意 FIFO 的限制</li>
<li><code>_PC_SYMLINK_MAX</code> 的引用文件必须是一个目录。返回值是该目录中可以包含的链接的最大字符串长度。</li>
</ol>


<div id="org60d5360" class="figure">
<p><img src="Chapter02/02fig11.jpg" alt="02fig11.jpg" />
</p>
<p><span class="figure-number">Figure 10: </span>Figure 2.11 Limits and <i>name</i> arguments to <code>sysconf</code></p>
</div>


<div id="org1b0084b" class="figure">
<p><img src="Chapter02/02fig12.jpg" alt="02fig12.jpg" />
</p>
<p><span class="figure-number">Figure 11: </span>Figure 2.12 Limits and <i>name</i> arguments to <code>pathconf</code> and <code>fpathconf</code></p>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 9: </span>Figure 2.13 Build C program to print all supported configuration limits</label><pre class="src src-awk"><span style="color: #2aa1ae; background-color: #292e34;">#</span><span style="color: #2aa1ae; background-color: #292e34;">!/usr/bin/awk -f</span>

<span style="color: #4f97d7; font-weight: bold;">BEGIN</span>   <span style="color: #4f97d7;">{</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"#include \"apue.h\"\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"#include &lt;errno.h&gt;\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"#include &lt;limits.h&gt;\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"static void pr_sysconf(char *, int);\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"static void pr_pathconf(char *, char *, int);\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"int\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"main(int argc, char *argv[])\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"{\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\tif (argc != 2)\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\terr_quit(\"usage: a.out &lt;dirname&gt;\");\n\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #7590db;">FS</span>=<span style="color: #2d9574;">"\t+"</span>
    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">getline</span> &lt;<span style="color: #2d9574;">"sysconf-lim.sym"</span> &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #bc6ec5;">substr</span><span style="color: #67b11d;">(</span>$1, <span style="color: #a45bad;">1</span>, <span style="color: #a45bad;">1</span><span style="color: #67b11d;">)</span> == <span style="color: #2d9574;">"#"</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">continue</span>;
        <span style="color: #2d9574;">}</span>
        <span style="color: #bc6ec5;">printf</span><span style="color: #2d9574;">(</span><span style="color: #2d9574;">"#ifdef %s\n"</span>, $1<span style="color: #2d9574;">)</span>
        <span style="color: #bc6ec5;">printf</span><span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\tprintf(\"%s defined to be %%ld\\n\", (long)%s+0);\n"</span>, $1, $1<span style="color: #2d9574;">)</span>
        <span style="color: #bc6ec5;">printf</span><span style="color: #2d9574;">(</span><span style="color: #2d9574;">"#else\n"</span><span style="color: #2d9574;">)</span>
        <span style="color: #bc6ec5;">printf</span><span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\tprintf(\"no symbol for %s\\n\");\n"</span>, $1<span style="color: #2d9574;">)</span>
        <span style="color: #bc6ec5;">printf</span><span style="color: #2d9574;">(</span><span style="color: #2d9574;">"#endif\n"</span><span style="color: #2d9574;">)</span>
        <span style="color: #bc6ec5;">printf</span><span style="color: #2d9574;">(</span><span style="color: #2d9574;">"#ifdef %s\n"</span>, $2<span style="color: #2d9574;">)</span>
        <span style="color: #bc6ec5;">printf</span><span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\tpr_sysconf(\"%s =\", %s);\n"</span>, $1, $2<span style="color: #2d9574;">)</span>
        <span style="color: #bc6ec5;">printf</span><span style="color: #2d9574;">(</span><span style="color: #2d9574;">"#else\n"</span><span style="color: #2d9574;">)</span>
        <span style="color: #bc6ec5;">printf</span><span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\tprintf(\"no symbol for %s\\n\");\n"</span>, $2<span style="color: #2d9574;">)</span>
        <span style="color: #bc6ec5;">printf</span><span style="color: #2d9574;">(</span><span style="color: #2d9574;">"#endif\n"</span><span style="color: #2d9574;">)</span>
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #bc6ec5;">close</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"sysconf-lim.sym"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">getline</span> &lt;<span style="color: #2d9574;">"pathconf-lim.sym"</span> &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #bc6ec5;">substr</span><span style="color: #67b11d;">(</span>$1, <span style="color: #a45bad;">1</span>, <span style="color: #a45bad;">1</span><span style="color: #67b11d;">)</span> == <span style="color: #2d9574;">"#"</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">continue</span>;
        <span style="color: #2d9574;">}</span>
        <span style="color: #bc6ec5;">printf</span><span style="color: #2d9574;">(</span><span style="color: #2d9574;">"#ifdef %s\n"</span>, $1<span style="color: #2d9574;">)</span>
        <span style="color: #bc6ec5;">printf</span><span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\tprintf(\"%s defined to be %%ld\\n\", (long)%s+0);\n"</span>, $1, $1<span style="color: #2d9574;">)</span>
        <span style="color: #bc6ec5;">printf</span><span style="color: #2d9574;">(</span><span style="color: #2d9574;">"#else\n"</span><span style="color: #2d9574;">)</span>
        <span style="color: #bc6ec5;">printf</span><span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\tprintf(\"no symbol for %s\\n\");\n"</span>, $1<span style="color: #2d9574;">)</span>
        <span style="color: #bc6ec5;">printf</span><span style="color: #2d9574;">(</span><span style="color: #2d9574;">"#endif\n"</span><span style="color: #2d9574;">)</span>
        <span style="color: #bc6ec5;">printf</span><span style="color: #2d9574;">(</span><span style="color: #2d9574;">"#ifdef %s\n"</span>, $2<span style="color: #2d9574;">)</span>
        <span style="color: #bc6ec5;">printf</span><span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\tpr_pathconf(\"%s =\", argv[1], %s);\n"</span>, $1, $2<span style="color: #2d9574;">)</span>
        <span style="color: #bc6ec5;">printf</span><span style="color: #2d9574;">(</span><span style="color: #2d9574;">"#else\n"</span><span style="color: #2d9574;">)</span>
        <span style="color: #bc6ec5;">printf</span><span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\tprintf(\"no symbol for %s\\n\");\n"</span>, $2<span style="color: #2d9574;">)</span>
        <span style="color: #bc6ec5;">printf</span><span style="color: #2d9574;">(</span><span style="color: #2d9574;">"#endif\n"</span><span style="color: #2d9574;">)</span>
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #bc6ec5;">close</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"pathconf-lim.sym"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">exit</span>
<span style="color: #4f97d7;">}</span>
<span style="color: #4f97d7; font-weight: bold;">END</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\texit(0);\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"}\n\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"static void\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"pr_sysconf(char *mesg, int name)\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"{\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\tlong  val;\n\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\tfputs(mesg, stdout);\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\terrno = 0;\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\tif ((val = sysconf(name)) &lt; 0) {\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\tif (errno != 0) {\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\t\tif (errno == EINVAL)\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\t\t\tfputs(\" (not supported)\\n\", stdout);\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\t\telse\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\t\t\terr_sys(\"sysconf error\");\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\t} else {\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\t\tfputs(\" (no limit)\\n\", stdout);\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\t}\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t} else {\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\tprintf(\" %%ld\\n\", val);\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t}\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"}\n\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"static void\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"pr_pathconf(char *mesg, char *path, int name)\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"{\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\tlong val;\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\tfputs(mesg, stdout);\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\terrno = 0;\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\tif ((val = pathconf(path, name)) &lt; 0) {\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\tif (errno != 0) {\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\t\tif (errno == EINVAL)\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\t\t\tfputs(\" (not supported)\\n\", stdout);\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\t\telse\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\t\t\terr_sys(\"pathconf error, path = %%s\", path);\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\t} else {\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\t\tfputs(\" (no limit)\\n\", stdout);\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\t}\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t} else {\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\tprintf(\" %%ld\\n\", val);\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t}\n"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">printf</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"}\n"</span><span style="color: #bc6ec5;">)</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 10: </span>Figure 2.14 Print all possible sysconf and pathconf values</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">limits.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">pr_sysconf</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *, <span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">pr_pathconf</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *, <span style="color: #ce537a; font-weight: bold;">char</span> *, <span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc != <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span> err_quit<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"usage: a.out &lt;dirname&gt;"</span><span style="color: #bc6ec5;">)</span>;

<span style="color: #bc6ec5;">#ifdef</span> ARG_MAX
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"ARG_MAX defined to be %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>ARG_MAX + <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for ARG_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> _SC_ARG_MAX
    pr_sysconf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"ARG_MAX ="</span>, _SC_ARG_MAX<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for _SC_ARG_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> ATEXIT_MAX
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"ATEXIT_MAX defined to be %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>ATEXIT_MAX + <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for ATEXIT_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> _SC_ATEXIT_MAX
    pr_sysconf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"ATEXIT_MAX ="</span>, _SC_ATEXIT_MAX<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for _SC_ATEXIT_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> CHARCLASS_NAME_MAX
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"CHARCLASS_NAME_MAX defined to be %ld\n"</span>,
           <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>CHARCLASS_NAME_MAX + <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for CHARCLASS_NAME_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> _SC_CHARCLASS_NAME_MAX
    pr_sysconf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"CHARCLASS_NAME_MAX ="</span>, _SC_CHARCLASS_NAME_MAX<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for _SC_CHARCLASS_NAME_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> CHILD_MAX
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"CHILD_MAX defined to be %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>CHILD_MAX + <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for CHILD_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> _SC_CHILD_MAX
    pr_sysconf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"CHILD_MAX ="</span>, _SC_CHILD_MAX<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for _SC_CHILD_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> CLOCKTICKSPERSECOND <span style="color: #2aa1ae; background-color: #292e34;">/*</span><span style="color: #2aa1ae; background-color: #292e34;">clock ticks/second</span><span style="color: #2aa1ae; background-color: #292e34;">*/</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"CLOCKTICKSPERSECOND /*clock ticks/second*/ defined to be %ld\n"</span>,
           <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>CLOCKTICKSPERSECOND <span style="color: #2aa1ae; background-color: #292e34;">/*</span><span style="color: #2aa1ae; background-color: #292e34;">clock ticks/second</span><span style="color: #2aa1ae; background-color: #292e34;">*/</span> + <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for CLOCKTICKSPERSECOND /*clock ticks/second*/\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> _SC_CLK_TCK
    pr_sysconf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"CLOCKTICKSPERSECOND /*clock ticks/second*/ ="</span>, _SC_CLK_TCK<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for _SC_CLK_TCK\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> COLL_WEIGHTS_MAX
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"COLL_WEIGHTS_MAX defined to be %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>COLL_WEIGHTS_MAX + <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for COLL_WEIGHTS_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> _SC_COLL_WEIGHTS_MAX
    pr_sysconf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"COLL_WEIGHTS_MAX ="</span>, _SC_COLL_WEIGHTS_MAX<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for _SC_COLL_WEIGHTS_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> DELAYTIMER_MAX
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"DELAYTIMER_MAX defined to be %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>DELAYTIMER_MAX + <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for DELAYTIMER_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> _SC_DELAYTIMER_MAX
    pr_sysconf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"DELAYTIMER_MAX ="</span>, _SC_DELAYTIMER_MAX<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for _SC_DELAYTIMER_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> HOST_NAME_MAX
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"HOST_NAME_MAX defined to be %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>HOST_NAME_MAX + <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for HOST_NAME_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> _SC_HOST_NAME_MAX
    pr_sysconf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"HOST_NAME_MAX ="</span>, _SC_HOST_NAME_MAX<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for _SC_HOST_NAME_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> IOV_MAX
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"IOV_MAX defined to be %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>IOV_MAX + <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for IOV_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> _SC_IOV_MAX
    pr_sysconf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"IOV_MAX ="</span>, _SC_IOV_MAX<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for _SC_IOV_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> LINE_MAX
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"LINE_MAX defined to be %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>LINE_MAX + <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for LINE_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> _SC_LINE_MAX
    pr_sysconf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"LINE_MAX ="</span>, _SC_LINE_MAX<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for _SC_LINE_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> LOGIN_NAME_MAX
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"LOGIN_NAME_MAX defined to be %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>LOGIN_NAME_MAX + <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for LOGIN_NAME_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> _SC_LOGIN_NAME_MAX
    pr_sysconf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"LOGIN_NAME_MAX ="</span>, _SC_LOGIN_NAME_MAX<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for _SC_LOGIN_NAME_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> NGROUPS_MAX
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"NGROUPS_MAX defined to be %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>NGROUPS_MAX + <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for NGROUPS_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> _SC_NGROUPS_MAX
    pr_sysconf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"NGROUPS_MAX ="</span>, _SC_NGROUPS_MAX<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for _SC_NGROUPS_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> OPEN_MAX
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"OPEN_MAX defined to be %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>OPEN_MAX + <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for OPEN_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> _SC_OPEN_MAX
    pr_sysconf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"OPEN_MAX ="</span>, _SC_OPEN_MAX<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for _SC_OPEN_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> PAGESIZE
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"PAGESIZE defined to be %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>PAGESIZE + <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for PAGESIZE\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> _SC_PAGESIZE
    pr_sysconf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"PAGESIZE ="</span>, _SC_PAGESIZE<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for _SC_PAGESIZE\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> PAGE_SIZE
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"PAGE_SIZE defined to be %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>PAGE_SIZE + <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for PAGE_SIZE\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> _SC_PAGE_SIZE
    pr_sysconf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"PAGE_SIZE ="</span>, _SC_PAGE_SIZE<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for _SC_PAGE_SIZE\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> RE_DUP_MAX
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"RE_DUP_MAX defined to be %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>RE_DUP_MAX + <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for RE_DUP_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> _SC_RE_DUP_MAX
    pr_sysconf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"RE_DUP_MAX ="</span>, _SC_RE_DUP_MAX<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for _SC_RE_DUP_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> RTSIG_MAX
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"RTSIG_MAX defined to be %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>RTSIG_MAX + <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for RTSIG_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> _SC_RTSIG_MAX
    pr_sysconf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"RTSIG_MAX ="</span>, _SC_RTSIG_MAX<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for _SC_RTSIG_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> SEM_NSEMS_MAX
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"SEM_NSEMS_MAX defined to be %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>SEM_NSEMS_MAX + <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for SEM_NSEMS_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> _SC_SEM_NSEMS_MAX
    pr_sysconf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"SEM_NSEMS_MAX ="</span>, _SC_SEM_NSEMS_MAX<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for _SC_SEM_NSEMS_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> SEM_VALUE_MAX
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"SEM_VALUE_MAX defined to be %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>SEM_VALUE_MAX + <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for SEM_VALUE_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> _SC_SEM_VALUE_MAX
    pr_sysconf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"SEM_VALUE_MAX ="</span>, _SC_SEM_VALUE_MAX<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for _SC_SEM_VALUE_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> SIGQUEUE_MAX
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"SIGQUEUE_MAX defined to be %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>SIGQUEUE_MAX + <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for SIGQUEUE_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> _SC_SIGQUEUE_MAX
    pr_sysconf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"SIGQUEUE_MAX ="</span>, _SC_SIGQUEUE_MAX<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for _SC_SIGQUEUE_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> STREAM_MAX
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"STREAM_MAX defined to be %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>STREAM_MAX + <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for STREAM_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> _SC_STREAM_MAX
    pr_sysconf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"STREAM_MAX ="</span>, _SC_STREAM_MAX<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for _SC_STREAM_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> SYMLOOP_MAX
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"SYMLOOP_MAX defined to be %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>SYMLOOP_MAX + <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for SYMLOOP_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> _SC_SYMLOOP_MAX
    pr_sysconf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"SYMLOOP_MAX ="</span>, _SC_SYMLOOP_MAX<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for _SC_SYMLOOP_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> TIMER_MAX
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"TIMER_MAX defined to be %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>TIMER_MAX + <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for TIMER_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> _SC_TIMER_MAX
    pr_sysconf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"TIMER_MAX ="</span>, _SC_TIMER_MAX<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for _SC_TIMER_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> TTY_NAME_MAX
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"TTY_NAME_MAX defined to be %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>TTY_NAME_MAX + <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for TTY_NAME_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> _SC_TTY_NAME_MAX
    pr_sysconf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"TTY_NAME_MAX ="</span>, _SC_TTY_NAME_MAX<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for _SC_TTY_NAME_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> TZNAME_MAX
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"TZNAME_MAX defined to be %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>TZNAME_MAX + <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for TZNAME_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> _SC_TZNAME_MAX
    pr_sysconf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"TZNAME_MAX ="</span>, _SC_TZNAME_MAX<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for _SC_TZNAME_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> FILESIZEBITS
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"FILESIZEBITS defined to be %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>FILESIZEBITS + <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for FILESIZEBITS\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> _PC_FILESIZEBITS
    pr_pathconf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"FILESIZEBITS ="</span>, argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>, _PC_FILESIZEBITS<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for _PC_FILESIZEBITS\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> LINK_MAX
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"LINK_MAX defined to be %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>LINK_MAX + <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for LINK_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> _PC_LINK_MAX
    pr_pathconf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"LINK_MAX ="</span>, argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>, _PC_LINK_MAX<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for _PC_LINK_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> MAX_CANON
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"MAX_CANON defined to be %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>MAX_CANON + <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for MAX_CANON\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> _PC_MAX_CANON
    pr_pathconf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"MAX_CANON ="</span>, argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>, _PC_MAX_CANON<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for _PC_MAX_CANON\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> MAX_INPUT
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"MAX_INPUT defined to be %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>MAX_INPUT + <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for MAX_INPUT\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> _PC_MAX_INPUT
    pr_pathconf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"MAX_INPUT ="</span>, argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>, _PC_MAX_INPUT<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for _PC_MAX_INPUT\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> NAME_MAX
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"NAME_MAX defined to be %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>NAME_MAX + <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for NAME_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> _PC_NAME_MAX
    pr_pathconf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"NAME_MAX ="</span>, argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>, _PC_NAME_MAX<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for _PC_NAME_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> PATH_MAX
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"PATH_MAX defined to be %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>PATH_MAX + <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for PATH_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> _PC_PATH_MAX
    pr_pathconf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"PATH_MAX ="</span>, argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>, _PC_PATH_MAX<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for _PC_PATH_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> PIPE_BUF
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"PIPE_BUF defined to be %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>PIPE_BUF + <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for PIPE_BUF\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> _PC_PIPE_BUF
    pr_pathconf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"PIPE_BUF ="</span>, argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>, _PC_PIPE_BUF<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for _PC_PIPE_BUF\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> SYMLINK_MAX
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"SYMLINK_MAX defined to be %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>SYMLINK_MAX + <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for SYMLINK_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> _PC_SYMLINK_MAX
    pr_pathconf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"SYMLINK_MAX ="</span>, argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>, _PC_SYMLINK_MAX<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for _PC_SYMLINK_MAX\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> _POSIX_TIMESTAMP_RESOLUTION
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"_POSIX_TIMESTAMP_RESOLUTION defined to be %ld\n"</span>,
           <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>_POSIX_TIMESTAMP_RESOLUTION + <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for _POSIX_TIMESTAMP_RESOLUTION\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#ifdef</span> _PC_TIMESTAMP_RESOLUTION
    pr_pathconf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"_POSIX_TIMESTAMP_RESOLUTION ="</span>, argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>,
                _PC_TIMESTAMP_RESOLUTION<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"no symbol for _PC_TIMESTAMP_RESOLUTION\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">pr_sysconf</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">mesg</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">name</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">val</span>;

    fputs<span style="color: #bc6ec5;">(</span>mesg, stdout<span style="color: #bc6ec5;">)</span>;
    errno = <span style="color: #a45bad;">0</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>val = sysconf<span style="color: #67b11d;">(</span>name<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>errno != <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>errno == EINVAL<span style="color: #67b11d;">)</span>
                fputs<span style="color: #67b11d;">(</span><span style="color: #2d9574;">" (not supported)\n"</span>, stdout<span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">else</span>
                err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"sysconf error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            fputs<span style="color: #67b11d;">(</span><span style="color: #2d9574;">" (no limit)\n"</span>, stdout<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">" %ld\n"</span>, val<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">pr_pathconf</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">mesg</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">path</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">name</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">val</span>;

    fputs<span style="color: #bc6ec5;">(</span>mesg, stdout<span style="color: #bc6ec5;">)</span>;
    errno = <span style="color: #a45bad;">0</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>val = pathconf<span style="color: #67b11d;">(</span>path, name<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>errno != <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>errno == EINVAL<span style="color: #67b11d;">)</span>
                fputs<span style="color: #67b11d;">(</span><span style="color: #2d9574;">" (not supported)\n"</span>, stdout<span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">else</span>
                err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"pathconf error, path = %s"</span>, path<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            fputs<span style="color: #67b11d;">(</span><span style="color: #2d9574;">" (no limit)\n"</span>, stdout<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">" %ld\n"</span>, val<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>


<div id="org45ece60" class="figure">
<p><img src="Chapter02/02fig15.jpg" alt="02fig15.jpg" />
</p>
<p><span class="figure-number">Figure 12: </span>Figure 2.15 Examples of configuration limits</p>
</div>
</div>
</li>

<li><a id="orgd4c2046"></a><span class="done DONE">DONE</span> 2.5.5 Indeterminate Runtime Limits<br />
<ul class="org-ul">
<li><a id="org86270cd"></a>Pathnames<br />
<div class="outline-text-6" id="text-org86270cd">
<p>
<code>MAXPATHLEN</code>
</p>
<ol class="org-ol">
<li></li>
</ol>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 11: </span>pathalloc</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">limits.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#ifdef</span> PATH_MAX
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">pathmax</span> = PATH_MAX;
<span style="color: #bc6ec5;">#else</span>
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">pathmax</span> = <span style="color: #a45bad;">0</span>;
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">posix_version</span> = <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">xsi_version</span>   = <span style="color: #a45bad;">0</span>;

<span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">If PATH_MAX is indeterminate, no guarantee this is adequate</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">PATH_MAX_GUESS</span> <span style="color: #a45bad;">1024</span>

<span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #bc6ec5; font-weight: bold;">path_alloc</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">size_t</span> *<span style="color: #7590db;">sizep</span><span style="color: #4f97d7;">)</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">also return allocated size, if nonnull</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span> * <span style="color: #7590db;">ptr</span>;
    <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">size</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>posix_version == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> posix_version = sysconf<span style="color: #bc6ec5;">(</span>_SC_VERSION<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>xsi_version == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> xsi_version = sysconf<span style="color: #bc6ec5;">(</span>_SC_XOPEN_VERSION<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pathmax == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">first time through</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        errno = <span style="color: #a45bad;">0</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>pathmax = pathconf<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"/"</span>, _PC_PATH_MAX<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>errno == <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span>
                pathmax = PATH_MAX_GUESS; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">it's indeterminate</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
            <span style="color: #4f97d7; font-weight: bold;">else</span>
                err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"pathconf error for _PC_PATH_MAX"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            pathmax++; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">add one since it's relative to root</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">/*</span>
<span style="color: #2aa1ae; background-color: #292e34;">     * Before POSIX.1-2001, we aren't guaranteed that PATH_MAX includes</span>
<span style="color: #2aa1ae; background-color: #292e34;">     * the terminating null byte.  Same goes for XPG3.</span>
<span style="color: #2aa1ae; background-color: #292e34;">     */</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>posix_version &lt; <span style="color: #a45bad;">200112L</span><span style="color: #2d9574;">)</span> &amp;&amp; <span style="color: #2d9574;">(</span>xsi_version &lt; <span style="color: #a45bad;">4</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
        size = pathmax + <span style="color: #a45bad;">1</span>;
    <span style="color: #4f97d7; font-weight: bold;">else</span>
        size = pathmax;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>ptr = malloc<span style="color: #67b11d;">(</span>size<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"malloc error for pathname"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sizep != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> *sizep = size;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>ptr<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<ol class="org-ol">
<li></li>
</ol>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 12: </span>openmax</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">limits.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#ifdef</span> OPEN_MAX
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">openmax</span> = OPEN_MAX;
<span style="color: #bc6ec5;">#else</span>
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">openmax</span> = <span style="color: #a45bad;">0</span>;
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #2aa1ae; background-color: #292e34;">/*</span>
<span style="color: #2aa1ae; background-color: #292e34;"> * If OPEN_MAX is indeterminate, this might be inadequate.</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">OPEN_MAX_GUESS</span> <span style="color: #a45bad;">256</span>

<span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #bc6ec5; font-weight: bold;">open_max</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>openmax == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">first time through</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        errno = <span style="color: #a45bad;">0</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>openmax = sysconf<span style="color: #b1951d;">(</span>_SC_OPEN_MAX<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>errno == <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span>
                openmax = OPEN_MAX_GUESS; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">it's indeterminate</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
            <span style="color: #4f97d7; font-weight: bold;">else</span>
                err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"sysconf error for _SC_OPEN_MAX"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>openmax<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</li>
</ul>
</li>
</ul>
</div>

<div id="outline-container-org28b4bc7" class="outline-4">
<h4 id="org28b4bc7"><span class="done DONE">DONE</span> 2.6 Options</h4>
<div class="outline-text-4" id="text-org28b4bc7">
<ol class="org-ol">
<li>Compile-time options are defined in <code>&lt;unistd.h&gt;</code></li>
<li>Runtime options are not associated with a file or a directory are idnetified with the <code>sysconf</code> function</li>
<li>Runtime options that are associated with a file or a directory are discovered by calling either the <code>pathconf</code> or the <code>fpathconf</code> function</li>
</ol>
</div>
</div>

<div id="outline-container-org312d338" class="outline-4">
<h4 id="org312d338"><span class="done DONE">DONE</span> 2.7 Features Test Macros</h4>
<div class="outline-text-4" id="text-org312d338">
<p>
<code>cc -D_POSIX_C_SOURCE=200809L code.c</code>
</p>
</div>
</div>

<div id="outline-container-org55c0076" class="outline-4">
<h4 id="org55c0076"><span class="done DONE">DONE</span> 2.8 Primitive System Data Types</h4>
<div class="outline-text-4" id="text-org55c0076">
<p>
The header <code>&lt;sys/types.h&gt;</code> defines some implementation-dependent data types, called the <i>primitive system data types</i>.
</p>
</div>
</div>

<div id="outline-container-org441a6fe" class="outline-4">
<h4 id="org441a6fe"><span class="done DONE">DONE</span> 2.9 Differences Between Standards</h4>
</div>
<div id="outline-container-org1fdd66b" class="outline-4">
<h4 id="org1fdd66b"><span class="done DONE">DONE</span> 2.10 Summary</h4>
<div class="outline-text-4" id="text-org1fdd66b">
<ul class="org-ul">
<li>Exercises

<ul class="org-ul">
<li>2.1  #ifndef &#x2026; #define &#x2026; #endif</li>

<li>2.2  <code>u_long, ushort, uint, u_quad_t, quad_t, qaddr_t, daddr_t, fixpt_t</code></li>

<li><p>
2.3
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 13: </span>OPEN_MAX exercise</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">limits.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/resource.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">OPEN_MAX_GUESS</span> <span style="color: #a45bad;">256</span>

<span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #bc6ec5; font-weight: bold;">open_max</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">long</span>          <span style="color: #7590db;">openmax</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">rlimit</span> <span style="color: #7590db;">rl</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>openmax = sysconf<span style="color: #67b11d;">(</span>_SC_OPEN_MAX<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span> || openmax == LONG_MAX<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>getrlimit<span style="color: #67b11d;">(</span>RLIMIT_NOFILE, &amp;rl<span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"can&#8242;t get file limit"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>rl.rlim_max == RLIM_INFINITY<span style="color: #2d9574;">)</span>
            openmax = OPEN_MAX_GUESS;
        <span style="color: #4f97d7; font-weight: bold;">else</span>
            openmax = rl.rlim_max;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>openmax<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span> printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%ld\n"</span>, open_max<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org197bd38" class="outline-3">
<h3 id="org197bd38"><span class="done DONE">DONE</span> Chapter 3. File I/O <code>[17/17]</code></h3>
<div class="outline-text-3" id="text-org197bd38">
</div>

<div id="outline-container-org79261ef" class="outline-4">
<h4 id="org79261ef"><span class="done DONE">DONE</span> 3.1 Introduction</h4>
</div>
<div id="outline-container-org9f9e469" class="outline-4">
<h4 id="org9f9e469"><span class="done DONE">DONE</span> 3.2 File Descriptors</h4>
<div class="outline-text-4" id="text-org9f9e469">
<p>
To the kernel, all open file are referred to by file descriptors.
</p>

<ul class="org-ul">
<li>0: stdin</li>

<li>1: stdout</li>

<li>2: stderr</li>
</ul>
</div>
</div>

<div id="outline-container-org3d324de" class="outline-4">
<h4 id="org3d324de"><span class="done DONE">DONE</span> 3.3 <code>open</code> and <code>openat</code> Functions</h4>
<div class="outline-text-4" id="text-org3d324de">
<p>
<code>man 2 open</code>
</p>
</div>
</div>

<div id="outline-container-org4473961" class="outline-4">
<h4 id="org4473961"><span class="done DONE">DONE</span> 3.4 <code>creat</code> Function</h4>
<div class="outline-text-4" id="text-org4473961">
<p>
<code>man 2 creat</code>
</p>
</div>
</div>

<div id="outline-container-org01f2b87" class="outline-4">
<h4 id="org01f2b87"><span class="done DONE">DONE</span> 3.5 <code>close</code> Function</h4>
<div class="outline-text-4" id="text-org01f2b87">
<p>
<code>man 2 close</code>
</p>
</div>
</div>

<div id="outline-container-org454472e" class="outline-4">
<h4 id="org454472e"><span class="done DONE">DONE</span> 3.6 <code>lseek</code> Function</h4>
<div class="outline-text-4" id="text-org454472e">
<p>
<code>man 2 lseek</code>
</p>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 14: </span>Figure 3.1 Test whether standard input is capable of seeking</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>lseek<span style="color: #2d9574;">(</span>STDIN_FILENO, <span style="color: #a45bad;">0</span>, SEEK_CUR<span style="color: #2d9574;">)</span> == -<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"seek OK\n"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 15: </span>Figure 3.2 Create a file with a hole in it</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">buf1</span><span style="color: #4f97d7;">[]</span> = <span style="color: #2d9574;">"abcdefghij"</span>;
<span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">buf2</span><span style="color: #4f97d7;">[]</span> = <span style="color: #2d9574;">"ABCDEFGHIJ"</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fd = creat<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"file.hole"</span>, FILE_MODE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"creat error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>write<span style="color: #2d9574;">(</span>fd, buf1, <span style="color: #a45bad;">10</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">10</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"buf1 write error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>lseek<span style="color: #2d9574;">(</span>fd, <span style="color: #a45bad;">16384</span>, SEEK_SET<span style="color: #2d9574;">)</span> == -<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"lssek error: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>write<span style="color: #2d9574;">(</span>fd, buf2, <span style="color: #a45bad;">10</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">10</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"buf2 write error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge856bb5" class="outline-4">
<h4 id="orge856bb5"><span class="done DONE">DONE</span> 3.7 <code>read</code> Function</h4>
<div class="outline-text-4" id="text-orge856bb5">
<p>
<code>man 2 read</code>
</p>
</div>
</div>

<div id="outline-container-orgf11393d" class="outline-4">
<h4 id="orgf11393d"><span class="done DONE">DONE</span> 3.8 <code>write</code> Function</h4>
<div class="outline-text-4" id="text-orgf11393d">
<p>
<code>man 2 write</code>
</p>
</div>
</div>

<div id="outline-container-orgc6689e5" class="outline-4">
<h4 id="orgc6689e5"><span class="done DONE">DONE</span> 3.9 I/O Efficiency</h4>
<div class="outline-text-4" id="text-orgc6689e5">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 16: </span>Figure 3.5 Copy standard input to standard output</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/stat.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>  <span style="color: #7590db;">n</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span>BUFSIZ<span style="color: #bc6ec5;">]</span>;

    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">in</span>  = open<span style="color: #bc6ec5;">(</span>argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>, O_RDONLY<span style="color: #bc6ec5;">)</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">out</span> = open<span style="color: #bc6ec5;">(</span>argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">2</span><span style="color: #2d9574;">]</span>, O_CREAT | O_RDWR, <span style="color: #a45bad;">0644</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>n = read<span style="color: #67b11d;">(</span>in, buf, BUFSIZ<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>write<span style="color: #67b11d;">(</span>out, buf, n<span style="color: #67b11d;">)</span> != n<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"write error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    close<span style="color: #bc6ec5;">(</span>in<span style="color: #bc6ec5;">)</span>;
    close<span style="color: #bc6ec5;">(</span>out<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>n &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"read error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4f23934" class="outline-4">
<h4 id="org4f23934"><span class="done DONE">DONE</span> 3.10 File Sharing</h4>
<div class="outline-text-4" id="text-org4f23934">
<ol class="org-ol">
<li>Every process has an entry in the process table.</li>
<li>The kernel maintains a file table for all open files.</li>
<li>Each open file(or device) has a v-node structure that contains information about the type of file <br />
and pointers to functions that operate on the file;</li>
</ol>
</div>
</div>

<div id="outline-container-orgbf2d2d3" class="outline-4">
<h4 id="orgbf2d2d3"><span class="done DONE">DONE</span> 3.11 Atomic Operations</h4>
<div class="outline-text-4" id="text-orgbf2d2d3">
<ul class="org-ul">
<li>Appending to a File</li>

<li><p>
<code>pread</code> and <code>pwrite</code> Functions
</p>

<p>
Calling pread is equivalent to calling lseek followed by a call to read, with the following exceptions.
</p>

<ul class="org-ul">
<li>There is no way to interrupt the two operations that occur when we call pread.</li>

<li>The current file offset is not updated.</li>
</ul></li>

<li><p>
Creating a File
</p>

<p>
<i>atomic operation</i> refers to an operation that might be composed of multiple steps
</p></li>
</ul>
</div>
</div>

<div id="outline-container-orgb3e9083" class="outline-4">
<h4 id="orgb3e9083"><span class="done DONE">DONE</span> 3.12 <code>dup</code> and <code>dup2</code> Functions</h4>
<div class="outline-text-4" id="text-orgb3e9083">
<p>
<code>man 2 dup</code>
</p>

<ul class="org-ul">
<li><code>dup(fd)</code> ~ =fcntl(fd, F_DUPFD, 0)~</li>

<li><code>dup2(fd, fd2)= = =close(fd2); fcntl(fd, F_DUPFD, fd2);</code></li>
</ul>

<p>
Differences:
</p>

<ul class="org-ul">
<li>dup2 is an atomic operation, whereas the alternate form involves two function calls.</li>

<li>errno differences</li>
</ul>
</div>
</div>

<div id="outline-container-org47d56ee" class="outline-4">
<h4 id="org47d56ee"><span class="done DONE">DONE</span> 3.13 <code>sync</code>, <code>fsync</code> and <code>fdatasync</code> Functions</h4>
<div class="outline-text-4" id="text-org47d56ee">
<p>
<code>man 2 sync</code>
</p>
</div>
</div>

<div id="outline-container-org5c447b2" class="outline-4">
<h4 id="org5c447b2"><span class="done DONE">DONE</span> 3.14 <code>fcntl</code> Function</h4>
<div class="outline-text-4" id="text-org5c447b2">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">fcntl</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">cmd</span>, ... <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">int arg</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: dependos on cmd if OK (see following), -1 on error</span>
</pre>
</div>
<p>
The <code>fcntl</code> function is used for five different purposes.
</p>
<ol class="org-ol">
<li>Duplicate an existing descriptor (<i>cmd</i> = <code>F_DUPFD</code> or <code>F_DUPFD_CLOEXEC</code>)</li>
<li>Get/set file descriptor flags (<i>cmd</i> = <code>F_GETFD</code> or <code>F_SETFD</code>)</li>
<li>Get/set file status flags (<i>cmd</i> = <code>F_GETFL</code> or <code>F_SETFL</code>)</li>
<li>Get/set asynchronous I/O ownership (<i>cmd</i> = <code>F_GETOWN</code> or <code>F_SETOWN</code>)</li>
<li>Get/set record locks (<i>cmd</i> = <code>F_GETLK</code>, <code>F_SETLK</code>, or <code>F_SETLKW</code>)</li>

<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 17: </span>Figure 3.11 Print file flags for specified descriptor</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">val</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc != <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"usage: ./a.out &lt;descriptor#"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>val = fcntl<span style="color: #67b11d;">(</span>atoi<span style="color: #b1951d;">(</span>argv<span style="color: #4f97d7;">[</span><span style="color: #a45bad;">1</span><span style="color: #4f97d7;">]</span><span style="color: #b1951d;">)</span>, F_GETFL, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fcntl error for  %d: %s"</span>, atoi<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">switch</span> <span style="color: #bc6ec5;">(</span>val &amp; O_ACCMODE<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">case</span> O_RDONLY:
            printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"read only"</span><span style="color: #2d9574;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">break</span>;
        <span style="color: #4f97d7; font-weight: bold;">case</span> O_WRONLY:
            printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"write only"</span><span style="color: #2d9574;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">break</span>;
        <span style="color: #4f97d7; font-weight: bold;">case</span> O_RDWR:
            printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"read write"</span><span style="color: #2d9574;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">break</span>;
        <span style="color: #4f97d7; font-weight: bold;">default</span>:
            err_dump<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"unknown access mode"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>val &amp; O_APPEND<span style="color: #bc6ec5;">)</span> printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">", append"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>val &amp; O_NONBLOCK<span style="color: #bc6ec5;">)</span> printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">", nonblocking"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>val &amp; O_SYNC<span style="color: #bc6ec5;">)</span> printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">", synchronous writes"</span><span style="color: #bc6ec5;">)</span>;

<span style="color: #bc6ec5;">#if</span> <span style="color: #a45bad;">!</span><span style="color: #bc6ec5;">defined</span><span style="color: #bc6ec5;">(</span>_POSIX_C_SOURCE<span style="color: #bc6ec5;">)</span> &amp;&amp; <span style="color: #bc6ec5;">defined</span><span style="color: #bc6ec5;">(</span>O_FSYNC<span style="color: #bc6ec5;">)</span> &amp;&amp; <span style="color: #bc6ec5;">(</span>O_FSYNC != O_SYNC<span style="color: #bc6ec5;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>val &amp; O_FSYNC<span style="color: #bc6ec5;">)</span> printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">", synchronous writes"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
    putchar<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'\n'</span><span style="color: #bc6ec5;">)</span>;

    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ol>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 18: </span>Figure 3.12 Turn on one or more of the file status flags for a descriptor</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">set_fl</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">flags</span><span style="color: #4f97d7;">)</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">flags are file status flags to turn on</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>

<span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">val</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>val = fcntl<span style="color: #67b11d;">(</span>fd, F_GETFL, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fcntl F_GETFL: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    val |= flags; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">turn on flags</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>fcntl<span style="color: #2d9574;">(</span>fd, F_SETFL, val<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fcntl F_SETFL: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1271aaf" class="outline-4">
<h4 id="org1271aaf"><span class="done DONE">DONE</span> 3.15 <code>ioctl</code> Function</h4>
<div class="outline-text-4" id="text-org1271aaf">
<p>
<code>man 2 ioctl</code>
</p>
</div>
</div>

<div id="outline-container-orga6c1e72" class="outline-4">
<h4 id="orga6c1e72"><span class="done DONE">DONE</span> 3.16 <code>/dev/fd</code></h4>
</div>
<div id="outline-container-org7b9cb39" class="outline-4">
<h4 id="org7b9cb39"><span class="done DONE">DONE</span> 3.17 Summary</h4>
<div class="outline-text-4" id="text-org7b9cb39">
<ul class="org-ul">
<li>Exercises

<ul class="org-ul">
<li><p>
3.1  All disk I/O need to via buffer block.
</p>

<p>
<code>read/write</code> always be buffered via kernel automatically, unbuffered only means user process;
</p></li>

<li><p>
3.2
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">my_dup2</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd2</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>fd2 &gt; open_max<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">/*</span>
<span style="color: #2aa1ae; background-color: #292e34;">     * use lseek to verify whether fd is valid</span>
<span style="color: #2aa1ae; background-color: #292e34;">     */</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>lseek<span style="color: #2d9574;">(</span>fd, <span style="color: #a45bad;">0</span>, SEEK_CUR<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span> &amp;&amp; errno == EBADF<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"file descriptor: %d is not valid, %m\n"</span>, fd<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">return if fd2 is fd</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>fd == fd2<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> fd2;
    <span style="color: #bc6ec5;">}</span>

    close<span style="color: #bc6ec5;">(</span>fd2<span style="color: #bc6ec5;">)</span>;

    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">i</span> = <span style="color: #a45bad;">0</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; open_max<span style="color: #2d9574;">()</span>; i++<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        i = dup<span style="color: #2d9574;">(</span>fd<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>i == fd2<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">break</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">for (; i &gt; fd; i--) {</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    <span style="color: #2aa1ae; background-color: #292e34;">/*   </span><span style="color: #2aa1ae; background-color: #292e34;">close(i);</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">}</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fd2<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc &lt; <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"usage: ./a.out &lt;string&gt;"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%ld\n"</span>, open_max<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span>;
    my_dup2<span style="color: #bc6ec5;">(</span>STDERR_FILENO, <span style="color: #a45bad;">5</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">i</span> = <span style="color: #a45bad;">1</span>; i &lt; argc; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        write<span style="color: #2d9574;">(</span><span style="color: #a45bad;">5</span>, argv<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span>, strlen<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
        write<span style="color: #2d9574;">(</span><span style="color: #a45bad;">5</span>, <span style="color: #2d9574;">"\n"</span>, <span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    close<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">5</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
3.3  F_SETFD: affect fd1 <b>file descriptor</b>
</p>

<p>
F_SETFL: affect fd1 and fd2 <b>file table</b>
</p></li>

<li>3.4  without <code>if (fd &gt; 2)</code>, there are 4 descriptors pointer to file, otherwise , there will be 3</li>

<li><p>
3.5  <code>./a.out &gt; outfile 2&gt;&amp;1</code>: stdout =&gt; outfile, stderr =&gt; stdout =&gt; outfile
</p>

<p>
<code>./a.out 2&gt;&amp;1 &gt; outfile</code>: stderr =&gt; stdout, stdout =&gt; outfile <br />
</p></li>

<li><p>
3.6, can be read random, but cannot replace existing data;
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[</span>argc<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>  <span style="color: #7590db;">fd</span>           = <span style="color: #a45bad;">0</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>  <span style="color: #7590db;">ret</span>          = <span style="color: #a45bad;">0</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span>MAXLINE<span style="color: #bc6ec5;">]</span> = <span style="color: #bc6ec5;">{</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">}</span>;

    fd = open<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"./a.txt"</span>, O_CREAT | O_RDWR | O_APPEND<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>fd &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"open: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    ret = write<span style="color: #bc6ec5;">(</span>fd, <span style="color: #2d9574;">"hello world"</span>, <span style="color: #a45bad;">11</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ret &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"write: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    ret = lseek<span style="color: #bc6ec5;">(</span>fd, <span style="color: #a45bad;">0</span>, SEEK_SET<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>ret = read<span style="color: #67b11d;">(</span>fd, buf, MAXLINE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        ;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ret == -<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"read: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"read: %s\n"</span>, buf<span style="color: #bc6ec5;">)</span>;

    ret = lseek<span style="color: #bc6ec5;">(</span>fd, -<span style="color: #a45bad;">18</span>, SEEK_CUR<span style="color: #bc6ec5;">)</span>;
    ret = write<span style="color: #bc6ec5;">(</span>fd, <span style="color: #2d9574;">"hello world"</span>, <span style="color: #a45bad;">11</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ret &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"write: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    ret = lseek<span style="color: #bc6ec5;">(</span>fd, <span style="color: #a45bad;">0</span>, SEEK_SET<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>ret = read<span style="color: #67b11d;">(</span>fd, buf, MAXLINE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        ;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ret == -<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"read: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"read: %s\n"</span>, buf<span style="color: #bc6ec5;">)</span>;

    ret = lseek<span style="color: #bc6ec5;">(</span>fd, <span style="color: #a45bad;">10</span>, SEEK_SET<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>ret = read<span style="color: #67b11d;">(</span>fd, buf, MAXLINE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        ;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ret == -<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"read: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"read: %s\n"</span>, buf<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org80f2c83" class="outline-3">
<h3 id="org80f2c83"><span class="done DONE">DONE</span> Chapter 4. System Data Files and Information <code>[26/26]</code></h3>
<div class="outline-text-3" id="text-org80f2c83">
</div>

<div id="outline-container-org3630ca7" class="outline-4">
<h4 id="org3630ca7"><span class="done DONE">DONE</span> 4.1 Introduction</h4>
</div>
<div id="outline-container-org6085f86" class="outline-4">
<h4 id="org6085f86"><span class="done DONE">DONE</span> 4.2 <code>stat</code>, <code>fstat</code>, <code>fstatat</code>, and <code>lstat</code> Functions</h4>
<div class="outline-text-4" id="text-org6085f86">
<p>
<code>man 2 stat</code>
</p>
</div>
</div>

<div id="outline-container-org38828c2" class="outline-4">
<h4 id="org38828c2"><span class="done DONE">DONE</span> 4.3 File Types</h4>
<div class="outline-text-4" id="text-org38828c2">
<ol class="org-ol">
<li>Regular file.
There is no distinction to the UNIX kernel whether this data is text or binary.</li>
<li>Directory file.</li>
<li>Block special file.</li>
<li>Character special file.
providing unbuffered I/O access.</li>
<li>FIFO.</li>
<li>Socket</li>
<li>Symbolic link.</li>

<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 19: </span>Figure 4.3 Print type of file for each command-line argument</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/stat.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[</span>argc<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>         <span style="color: #7590db;">i</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">stat</span> <span style="color: #7590db;">buf</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> *      <span style="color: #7590db;">ptr</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">1</span>; i &lt; argc; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s: "</span>, argv<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>lstat<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span>, &amp;buf<span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_ret<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"%s"</span>, argv<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span>, strerror<span style="color: #b1951d;">(</span>errno<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISREG<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            ptr = <span style="color: #2d9574;">"regular"</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISLNK<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            ptr = <span style="color: #2d9574;">"symbolic link"</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISSOCK<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            ptr = <span style="color: #2d9574;">"socket"</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISBLK<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            ptr = <span style="color: #2d9574;">"block special"</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISDIR<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            ptr = <span style="color: #2d9574;">"directory"</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISCHR<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            ptr = <span style="color: #2d9574;">"character special"</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISFIFO<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            ptr = <span style="color: #2d9574;">"named pipe(fifo)"</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            ptr = <span style="color: #2d9574;">"** unknown mode **"</span>;
        <span style="color: #2d9574;">}</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s\n"</span>, ptr<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ol>
</div>
</div>

<div id="outline-container-orgcb9ffc2" class="outline-4">
<h4 id="orgcb9ffc2"><span class="done DONE">DONE</span> 4.4 Set-User-ID and Set-Group-ID</h4>
<div class="outline-text-4" id="text-orgcb9ffc2">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">IDs</th>
<th scope="col" class="org-left">using for</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">real user ID</td>
<td class="org-left">who we really are</td>
</tr>

<tr>
<td class="org-left">real group ID</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">effective user ID</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">effective group ID</td>
<td class="org-left">used for file access permission checks</td>
</tr>

<tr>
<td class="org-left">supplementary group IDs</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">save set-user-ID</td>
<td class="org-left">saved by exec functions</td>
</tr>

<tr>
<td class="org-left">save set-group-ID</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orgcb05e31" class="outline-4">
<h4 id="orgcb05e31"><span class="done DONE">DONE</span> 4.5 File Access Permissions</h4>
<div class="outline-text-4" id="text-orgcb05e31">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">st_mode mask</th>
<th scope="col" class="org-left">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">S_IRUSR</td>
<td class="org-left">user-read</td>
</tr>

<tr>
<td class="org-left">S_IWUSR</td>
<td class="org-left">user-write</td>
</tr>

<tr>
<td class="org-left">S_IXUSR</td>
<td class="org-left">user-execute</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">S_IRGRP</td>
<td class="org-left">group-read</td>
</tr>

<tr>
<td class="org-left">S_IWGRP</td>
<td class="org-left">group-write</td>
</tr>

<tr>
<td class="org-left">S_IXGRP</td>
<td class="org-left">group-execute</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">S_IROTH</td>
<td class="org-left">other-read</td>
</tr>

<tr>
<td class="org-left">S_IWOTH</td>
<td class="org-left">other-write</td>
</tr>

<tr>
<td class="org-left">S_IXOTH</td>
<td class="org-left">other-execute</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orge7d2a45" class="outline-4">
<h4 id="orge7d2a45"><span class="done DONE">DONE</span> 4.6 Ownership of New Files and Directories</h4>
</div>
<div id="outline-container-org35c8475" class="outline-4">
<h4 id="org35c8475"><span class="done DONE">DONE</span> 4.7 <code>access</code> and <code>faccessat</code> Functions</h4>
<div class="outline-text-4" id="text-org35c8475">
<p>
<code>man 2 access</code>
</p>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 20: </span>Figure 4.8 Example of access function</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc != <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"usage: a.out &lt;pathname&gt;"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>access<span style="color: #2d9574;">(</span>argv<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span>, R_OK<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_ret<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"access error for %s"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"read access OK\n"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fd = open<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span>, O_RDONLY<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_ret<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"open error for %s"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"open for reading OK\n"</span><span style="color: #2d9574;">)</span>;
        close<span style="color: #2d9574;">(</span>fd<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-orgacfb718" class="outline-4">
<h4 id="orgacfb718"><span class="done DONE">DONE</span> 4.8 <code>umask</code> Function</h4>
<div class="outline-text-4" id="text-orgacfb718">
<p>
<code>man 2 umask</code>
</p>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 21: </span>Figure 4.9 Example of umask function</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">RWRWRW</span> <span style="color: #4f97d7;">(</span>S_IRUSR | S_IWUSR | S_IRGRP | S_IWGRP | S_IROTH | S_IWOTH<span style="color: #4f97d7;">)</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[</span>argc<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    umask<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>creat<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"foo"</span>, RWRWRW<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"creat \"foo\": %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    umask<span style="color: #bc6ec5;">(</span>S_IRGRP | S_IWGRP | S_IROTH | S_IWOTH<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>creat<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"bar"</span>, RWRWRW<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"creat \"bar\": %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-orgdeef164" class="outline-4">
<h4 id="orgdeef164"><span class="done DONE">DONE</span> 4.9 <code>chmod</code>, <code>fchmod</code>, and <code>fchmodat</code> Functions</h4>
<div class="outline-text-4" id="text-orgdeef164">
<p>
<code>man 2 chmod</code>
</p>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 22: </span>Figure 4.12 Example of chmod function</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">stat</span> <span style="color: #7590db;">statbuf</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">turn on set-group-ID and turn off group-execute</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>stat<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"foo"</span>, &amp;statbuf<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"stat error for foo"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>chmod<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"foo"</span>, <span style="color: #67b11d;">(</span>statbuf.st_mode &amp; ~S_IXGRP<span style="color: #67b11d;">)</span> | S_ISGID<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"chmod error for foo"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">set absolute mode to "rw-r--r--"</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>chmod<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"bar"</span>, S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"chmod error for bar"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org43bc2f6" class="outline-4">
<h4 id="org43bc2f6"><span class="done DONE">DONE</span> 4.10 Sticky Bit</h4>
<div class="outline-text-4" id="text-org43bc2f6">
<p>
If it was set for an executable program file, then the first time the program was executed, <br />
a copy of the program’s text was saved in the swap area when the process terminated
</p>
</div>
</div>

<div id="outline-container-orge7498b3" class="outline-4">
<h4 id="orge7498b3"><span class="done DONE">DONE</span> 4.11 <code>chown</code>, <code>fchown</code>, <code>fchownat</code>, and <code>lchown</code> Functions</h4>
<div class="outline-text-4" id="text-orge7498b3">
<p>
<code>man 2 chown</code>
</p>
</div>
</div>

<div id="outline-container-orgc1f9f5a" class="outline-4">
<h4 id="orgc1f9f5a"><span class="done DONE">DONE</span> 4.12 File Size</h4>
<div class="outline-text-4" id="text-orgc1f9f5a">
<p>
<code>struct stat.st_size</code>
</p>
</div>
</div>

<div id="outline-container-orgc8d6b03" class="outline-4">
<h4 id="orgc8d6b03"><span class="done DONE">DONE</span> 4.13 File Truncation</h4>
<div class="outline-text-4" id="text-orgc8d6b03">
<p>
<code>man 2 truncate</code>
</p>
</div>
</div>

<div id="outline-container-org6159cb8" class="outline-4">
<h4 id="org6159cb8"><span class="done DONE">DONE</span> 4.14 File Systems</h4>
<div class="outline-text-4" id="text-org6159cb8">
<ul class="org-ul">
<li><p>
Only when the link count goes to 0 can the file be deleted.
</p>

<p>
<code>struct stat.st_nlink</code>
</p></li>

<li>The other type of link is called a symbolic link. With a symbolic link, the actual contents of the file—the data blocks—store the name of the file that the symbolic link points to.</li>

<li><p>
The i-node contains all the information about the file.
</p>

<p>
Most of the information in the stat structure is obtained from the i-node, exclude <b>filename</b> and <b>i-node</b> number.
</p></li>

<li>a directory entry can’t refer to an i-node in a different file system.</li>

<li>When renaming a file without changing file systems, the actual contents of the file need not be moved—all that needs to be done is to add a new directory entry that points to the existing i-node and then unlink the old directory entry.</li>
</ul>
</div>
</div>

<div id="outline-container-orgf56fe68" class="outline-4">
<h4 id="orgf56fe68"><span class="done DONE">DONE</span> 4.15 <code>link</code>, <code>linkat</code>, <code>unlink</code>, <code>unlinkat</code>, and <code>remove</code> Functions</h4>
<div class="outline-text-4" id="text-orgf56fe68">
<p>
<code>man 2 link</code>
</p>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 23: </span>Figure 4.16 Open a file and then unlink it</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>open<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"tempfile"</span>, O_RDWR<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"open: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>unlink<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"tempfile"</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"unlink: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"file unlinked\n"</span><span style="color: #bc6ec5;">)</span>;
    sleep<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">15</span><span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"done\n"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-orgcdc7dad" class="outline-4">
<h4 id="orgcdc7dad"><span class="done DONE">DONE</span> 4.16 <code>rename</code> and <code>renameat</code> Functions</h4>
<div class="outline-text-4" id="text-orgcdc7dad">
<p>
<code>man 2 rename</code>
</p>
<ol class="org-ol">
<li>If oldname specifies a file that is not a directory, then we are renaming a file or a symbolic link.</li>
<li>If oldname specifies a directory, then we are renaming a directory.</li>
<li>If either oldname or newname refers to a symbolic link, then the link itself is processed, not the file to which it resolves.</li>
<li>We can’t rename dot or dot-dot.</li>
<li>As a special case, if oldname and newname refer to the same file, the function returns successfully without changing anything.</li>
</ol>
</div>
</div>

<div id="outline-container-org98383b7" class="outline-4">
<h4 id="org98383b7"><span class="done DONE">DONE</span> 4.17 Symbolic Links</h4>
<div class="outline-text-4" id="text-org98383b7">
<ul class="org-ul">
<li>Hard links normally require that the link and the file reside in the <b>same file system</b>.</li>

<li>Only the superuser can create a hard link to a directory (when supported by the underlying file system).</li>
</ul>
</div>
</div>

<div id="outline-container-org5760eb0" class="outline-4">
<h4 id="org5760eb0"><span class="done DONE">DONE</span> 4.18 Creating and Reading Symbolic Links</h4>
<div class="outline-text-4" id="text-org5760eb0">
<p>
<code>man 2 symlink</code>
<code>man 2 readlink</code>
</p>
</div>
</div>

<div id="outline-container-org09fdee7" class="outline-4">
<h4 id="org09fdee7"><span class="done DONE">DONE</span> 4.19 File Times</h4>
<div class="outline-text-4" id="text-org09fdee7">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 1:</span> Figure 4.19 The three time values associated with each file</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Field</th>
<th scope="col" class="org-left">Description</th>
<th scope="col" class="org-left">Example</th>
<th scope="col" class="org-left">ls(1) option)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">st_atim</td>
<td class="org-left">last-access of file data</td>
<td class="org-left">read</td>
<td class="org-left">-u</td>
</tr>

<tr>
<td class="org-left">st_mtim</td>
<td class="org-left">last-modification of file data</td>
<td class="org-left">write</td>
<td class="org-left">default</td>
</tr>

<tr>
<td class="org-left">st_ctim</td>
<td class="org-left">last-change of i-node status</td>
<td class="org-left">chmod, chown</td>
<td class="org-left">-c</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orge969b66" class="outline-4">
<h4 id="orge969b66"><span class="done DONE">DONE</span> 4.20 <code>futimens</code>, <code>utimensat</code>, and <code>utimes</code> Functions</h4>
<div class="outline-text-4" id="text-orge969b66">
<p>
POSIX.1
<code>man 2 futimens</code>
XSI
<code>man 2 utimes</code>
</p>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 24: </span>Figure 4.21 Example of futimens function</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/stat.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[</span>argc<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>             <span style="color: #7590db;">i</span>, <span style="color: #7590db;">fd</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">stat</span>     <span style="color: #7590db;">statbuf</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span> <span style="color: #7590db;">times</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; argc; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>stat<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span>, &amp;statbuf<span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">fetch current times</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
            err_ret<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"%s: %s"</span>, argv<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span>, strerror<span style="color: #b1951d;">(</span>errno<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">continue</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>fd = open<span style="color: #b1951d;">(</span>argv<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span>, O_RDWR | O_TRUNC<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">truncate</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
            err_ret<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"%s: %s"</span>, argv<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span>, strerror<span style="color: #b1951d;">(</span>errno<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">continue</span>;
        <span style="color: #2d9574;">}</span>

        times<span style="color: #2d9574;">[</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">]</span> = statbuf.st_atimespec;
        times<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span> = statbuf.st_mtimespec;

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>futimens<span style="color: #67b11d;">(</span>fd, times<span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">reset times</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
            err_ret<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"%s: %s"</span>, argv<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span>, strerror<span style="color: #b1951d;">(</span>errno<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        close<span style="color: #2d9574;">(</span>fd<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org41ffcec" class="outline-4">
<h4 id="org41ffcec"><span class="done DONE">DONE</span> 4.21 <code>mkdir</code>, <code>mkdirat</code>, and <code>rmdir</code> Functions</h4>
<div class="outline-text-4" id="text-org41ffcec">
<p>
Creat4:
<code>man 42 mkdir</code>
Remov4e:
<code>man 42 rmdir</code>.2 .2 .2 .2
</p>
</div>
</div>

<div id="outline-container-org6506b6b" class="outline-4">
<h4 id="org6506b6b"><span class="done DONE">DONE</span> 4.22 Reading Directories</h4>
<div class="outline-text-4" id="text-org6506b6b">
<p>
<code>man 43 o pendir</code>
</p>

<ul class="org-ul">
<li><p>
Exa4mpl e
</p>

<p>
<a href="file:///4Use rs/zhoush/Private/Notes/books/c/APUE/Chapter04/ftw.c">Figure 4.22 Recursively descend a directory hierarchy, counting file types</a>.2 .2 .2
</p></li>
</ul>
</div>
</div>

<div id="outline-container-orga4403b0" class="outline-4">
<h4 id="orga4403b0"><span class="done DONE">DONE</span> 4.23 <code>chidr</code>, <code>fchdir</code> and <code>getcwd</code> Functions</h4>
<div class="outline-text-4" id="text-orga4403b0">
<p>
<code>man 42 c hdir</code>
</p>

<ul class="org-ul">
<li><p>
Exa4mpl e
</p>

<p>
#+c4apt ion: Figure 4.23 Example of chdir function
#+i4ncl ude: "Chapter04/chdir.c" src c
</p></li>
</ul>
<p>
<code>man 43 g etcwd</code>
</p>

<ul class="org-ul">
<li><p>
Exa4mpl e
</p>

<p>
#+c4apt ion: Figure 4.24 Example of getcwd function
#+i4ncl ude: "Chapter04/getcwd.c" src c.2 .2 .2 .2 .2 .2 .2 .2
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org21b8fa9" class="outline-4">
<h4 id="org21b8fa9"><span class="done DONE">DONE</span> 4.24 Device Special Files</h4>
<div class="outline-text-4" id="text-org21b8fa9">
<ul class="org-ul">
<li><p>
Exa4mpl e
</p>

<p>
#+c4apt ion: Figure 4.25 Print st_dev and st_rdev values
#+i4ncl ude: "Chapter04/devrdev.c" src c.2 .2 .2
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org9456282" class="outline-4">
<h4 id="org9456282"><span class="done DONE">DONE</span> 4.25 Summary of File Access Permission Bits</h4>
<div class="outline-text-4" id="text-org9456282">
<p>
S_IRW4XU  = S_IRUSR | S_IWUSR | S_IXUSR
S_IRW4XG  = S_IRGRP | S_IWGRP | S_IXGRP
S_IRW4XO  = S_IROTH | S_IWOTH | S_IXOTH.2 .2 .2
</p>
</div>
</div>

<div id="outline-container-org45fb184" class="outline-4">
<h4 id="org45fb184"><span class="done DONE">DONE</span> 4.26 Summary</h4>
<div class="outline-text-4" id="text-org45fb184">
<ul class="org-ul">
<li>Exercises

<ul class="org-ul">
<li><p>
4.1
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>         <span style="color: #7590db;">i</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">stat</span> <span style="color: #7590db;">buf</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> *      <span style="color: #7590db;">ptr</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">1</span>; i &lt; argc; i++<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s: "</span>, argv<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>stat<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span>, &amp;buf<span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_ret<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"lstat error"</span><span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">continue</span>;
        <span style="color: #2d9574;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISREG<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
            ptr = <span style="color: #2d9574;">"regular"</span>;
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISDIR<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
            ptr = <span style="color: #2d9574;">"directory"</span>;
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISCHR<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
            ptr = <span style="color: #2d9574;">"character special"</span>;
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISBLK<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
            ptr = <span style="color: #2d9574;">"block special"</span>;
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISFIFO<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
            ptr = <span style="color: #2d9574;">"fifo"</span>;
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISLNK<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
            ptr = <span style="color: #2d9574;">"symbolic link"</span>;
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISSOCK<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
            ptr = <span style="color: #2d9574;">"socket"</span>;
        <span style="color: #4f97d7; font-weight: bold;">else</span>
            ptr = <span style="color: #2d9574;">"** unknown mode **"</span>;
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s\n"</span>, ptr<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
before modification: symbolic link
after  modification: regular
</p></li>

<li>4.2  default permissions: <code>----------</code></li>

<li>4.3  <code>cat</code> get : Permission denied</li>

<li>4.4  nothing changed.</li>

<li><p>
4.5  directory always shoud be entries for . and ..
</p>

<p>
the size of symbolic link should be the size of the file contained in.
</p></li>

<li><p>
4.6
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>         <span style="color: #7590db;">in</span>, <span style="color: #7590db;">out</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>        <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span>BUFSIZ<span style="color: #bc6ec5;">]</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">stat</span> <span style="color: #7590db;">stbuf</span> = <span style="color: #bc6ec5;">{</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">}</span>;

    <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">l_size</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>stat<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"src.txt"</span>, &amp;stbuf<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"stat: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    l_size = stbuf.st_size;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>in = open<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"src.txt"</span>, O_RDONLY<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span> ||
        <span style="color: #2d9574;">(</span>out = open<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"dst.txt"</span>, O_CREAT | O_RDWR, FILE_MODE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"open: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">l_sum</span> = <span style="color: #a45bad;">0</span>;
    <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">l_cur</span> = <span style="color: #a45bad;">0</span>;

    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>l_cur = read<span style="color: #67b11d;">(</span>in, buf, BUFSIZ<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        l_sum += l_cur;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>write<span style="color: #67b11d;">(</span>out, buf, l_cur<span style="color: #67b11d;">)</span> != l_cur<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"write: %s"</span>, strerror<span style="color: #b1951d;">(</span>errno<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    close<span style="color: #bc6ec5;">(</span>in<span style="color: #bc6ec5;">)</span>;
    close<span style="color: #bc6ec5;">(</span>out<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li>4.7  default access permissions are different</li>

<li>4.8  <code>du</code> check the file/directory/path space instead of disk , and may need path permissions.</li>

<li>4.9  it's not the last link to the file.</li>

<li>4.10  recursive depth number</li>

<li><p>
4.11
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">dirent.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">limits.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">function type that is called for each filename</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">typedef</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #ce537a; font-weight: bold;">Myfunc</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">fpath</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">stat</span> *<span style="color: #7590db;">sb</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">typeflag</span><span style="color: #4f97d7;">)</span>;

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">Myfunc</span> <span style="color: #7590db;">myfunc</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span>    <span style="color: #bc6ec5; font-weight: bold;">myftw</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">dirpath</span>, <span style="color: #ce537a; font-weight: bold;">Myfunc</span> *<span style="color: #7590db;">func</span><span style="color: #4f97d7;">)</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span>    <span style="color: #bc6ec5; font-weight: bold;">dopath</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">dirname</span>, <span style="color: #ce537a; font-weight: bold;">Myfunc</span> *<span style="color: #7590db;">func</span><span style="color: #4f97d7;">)</span>;

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">nreg</span>, <span style="color: #7590db;">ndir</span>, <span style="color: #7590db;">nblk</span>, <span style="color: #7590db;">nchr</span>, <span style="color: #7590db;">nfifo</span>, <span style="color: #7590db;">nslink</span>, <span style="color: #7590db;">nsock</span>, <span style="color: #7590db;">ntot</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">ret</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc != <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"usage: %s &lt;starting-pathname&gt;"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    ret = myftw<span style="color: #bc6ec5;">(</span>argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>, myfunc<span style="color: #bc6ec5;">)</span>;

    ntot = nreg + ndir + nblk + nchr + nfifo + nslink + nsock;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ntot == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        ntot = <span style="color: #a45bad;">1</span>;
    <span style="color: #bc6ec5;">}</span>

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"regular files  = %7ld, %5.2f %%\n"</span>, nreg, nreg * <span style="color: #a45bad;">100.0</span> / ntot<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"directories    = %7ld, %5.2f %%\n"</span>, ndir, ndir * <span style="color: #a45bad;">100.0</span> / ntot<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"block special  = %7ld, %5.2f %%\n"</span>, nblk, nblk * <span style="color: #a45bad;">100.0</span> / ntot<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"char special   = %7ld, %5.2f %%\n"</span>, nchr, nchr * <span style="color: #a45bad;">100.0</span> / ntot<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"FIFOs          = %7ld, %5.2f %%\n"</span>, nfifo, nfifo * <span style="color: #a45bad;">100.0</span> / ntot<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"symbolic links = %7ld, %5.2f %%\n"</span>, nslink, nslink * <span style="color: #a45bad;">100.0</span> / ntot<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"sockets        = %7ld, %5.2f %%\n"</span>, nsock, nsock * <span style="color: #a45bad;">100.0</span> / ntot<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #2aa1ae; background-color: #292e34;">/*</span>
<span style="color: #2aa1ae; background-color: #292e34;"> * Descend through the hierarchy, starting at "pathname".</span>
<span style="color: #2aa1ae; background-color: #292e34;"> * The caller's func() is called for every file.</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">FTW_F</span>   <span style="color: #a45bad;">1</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">file other than directory</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">FTW_D</span>   <span style="color: #a45bad;">2</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">directory</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">FTW_DNR</span> <span style="color: #a45bad;">3</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">dirctory that cant'be read</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">FTW_NS</span>  <span style="color: #a45bad;">4</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">file that we can't stat</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">pathlen</span>;

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">myftw</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">pathname</span>, <span style="color: #ce537a; font-weight: bold;">Myfunc</span> *<span style="color: #7590db;">func</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">fullpath</span> = path_alloc<span style="color: #bc6ec5;">(</span>&amp;pathlen<span style="color: #bc6ec5;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">malloc PATH_MAX+1 bytes</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pathlen &lt;= strlen<span style="color: #2d9574;">(</span>pathname<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        pathlen = strlen<span style="color: #2d9574;">(</span>pathname<span style="color: #2d9574;">)</span> * <span style="color: #a45bad;">2</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>fullpath = realloc<span style="color: #b1951d;">(</span>fullpath, pathlen<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"realloc %s"</span>, strerror<span style="color: #b1951d;">(</span>errno<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>dopath<span style="color: #2d9574;">(</span>pathname, func<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #2aa1ae; background-color: #292e34;">/*</span>
<span style="color: #2aa1ae; background-color: #292e34;"> * Descend through the hierarchy, starting at "fullpath".</span>
<span style="color: #2aa1ae; background-color: #292e34;"> * If "fullpath" is anything other than a directory, we lstat() it,</span>
<span style="color: #2aa1ae; background-color: #292e34;"> * call func(), and return. For a directory, we call ourself</span>
<span style="color: #2aa1ae; background-color: #292e34;"> * recursively for each name in the directory.</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">we return whatever func() returns</span><span style="color: #2aa1ae; background-color: #292e34;">  */</span>
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">dopath</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">pathname</span>, <span style="color: #ce537a; font-weight: bold;">Myfunc</span> *<span style="color: #7590db;">func</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">stat</span>    <span style="color: #7590db;">statbuf</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">dirent</span> *<span style="color: #7590db;">dirp</span>;
    <span style="color: #ce537a; font-weight: bold;">DIR</span> *          <span style="color: #7590db;">dp</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>            <span style="color: #7590db;">ret</span>, <span style="color: #7590db;">n</span>;

    <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">l</span>   = <span style="color: #a45bad;">0</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> * <span style="color: #7590db;">cwd</span> = path_alloc<span style="color: #bc6ec5;">(</span>&amp;l<span style="color: #bc6ec5;">)</span>;

    chdir<span style="color: #bc6ec5;">(</span>pathname<span style="color: #bc6ec5;">)</span>;
    getcwd<span style="color: #bc6ec5;">(</span>cwd, l<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#ifdef</span> DEBUG
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%s\n"</span>, cwd<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>dp = opendir<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"."</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">can't read directory</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span>func<span style="color: #67b11d;">(</span>pathname, &amp;statbuf, FTW_DNR<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>dirp = readdir<span style="color: #67b11d;">(</span>dp<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>strcmp<span style="color: #b1951d;">(</span>dirp-&gt;d_name, <span style="color: #2d9574;">"."</span><span style="color: #b1951d;">)</span> == <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> ||
            <span style="color: #67b11d;">(</span>strcmp<span style="color: #b1951d;">(</span>dirp-&gt;d_name, <span style="color: #2d9574;">".."</span><span style="color: #b1951d;">)</span> == <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">continue</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">ignore dot and dot-dot</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        <span style="color: #2d9574;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>lstat<span style="color: #67b11d;">(</span>dirp-&gt;d_name, &amp;statbuf<span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">stat error</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
            func<span style="color: #67b11d;">(</span>dirp-&gt;d_name, &amp;statbuf, FTW_NS<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISDIR<span style="color: #67b11d;">(</span>statbuf.st_mode<span style="color: #67b11d;">)</span> == <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">not a directory</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
            func<span style="color: #67b11d;">(</span>dirp-&gt;d_name, &amp;statbuf, FTW_F<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            func<span style="color: #67b11d;">(</span>dirp-&gt;d_name, &amp;statbuf, FTW_D<span style="color: #67b11d;">)</span>;
            <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">chdir(dirp-&gt;d_name);</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>ret = dopath<span style="color: #4f97d7;">(</span>dirp-&gt;d_name, func<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                <span style="color: #4f97d7; font-weight: bold;">break</span>;
            <span style="color: #67b11d;">}</span>
            <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">chdir("..");</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
            getcwd<span style="color: #67b11d;">(</span>cwd, l<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>closedir<span style="color: #2d9574;">(</span>dp<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_ret<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s: %s"</span>, cwd, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>ret<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">myfunc</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">pathname</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">stat</span> *<span style="color: #7590db;">statptr</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">type</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">switch</span> <span style="color: #bc6ec5;">(</span>type<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">case</span> FTW_F:
            <span style="color: #4f97d7; font-weight: bold;">switch</span> <span style="color: #2d9574;">(</span>statptr-&gt;st_mode &amp; S_IFMT<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
                <span style="color: #4f97d7; font-weight: bold;">case</span> S_IFREG:
                    nreg++;
                    <span style="color: #4f97d7; font-weight: bold;">break</span>;
                <span style="color: #4f97d7; font-weight: bold;">case</span> S_IFBLK:
                    nblk++;
                    <span style="color: #4f97d7; font-weight: bold;">break</span>;
                <span style="color: #4f97d7; font-weight: bold;">case</span> S_IFCHR:
                    nchr++;
                    <span style="color: #4f97d7; font-weight: bold;">break</span>;
                <span style="color: #4f97d7; font-weight: bold;">case</span> S_IFIFO:
                    nfifo++;
                    <span style="color: #4f97d7; font-weight: bold;">break</span>;
                <span style="color: #4f97d7; font-weight: bold;">case</span> S_IFLNK:
                    nslink++;
                    <span style="color: #4f97d7; font-weight: bold;">break</span>;
                <span style="color: #4f97d7; font-weight: bold;">case</span> S_IFSOCK:
                    nsock++;
                    <span style="color: #4f97d7; font-weight: bold;">break</span>;
                <span style="color: #4f97d7; font-weight: bold;">case</span> S_IFDIR:
                    err_dump<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"for S_IFDIR for %s"</span>, pathname<span style="color: #67b11d;">)</span>;
                <span style="color: #4f97d7; font-weight: bold;">default</span>:
                    <span style="color: #4f97d7; font-weight: bold;">break</span>;
            <span style="color: #2d9574;">}</span>
            <span style="color: #4f97d7; font-weight: bold;">break</span>;
        <span style="color: #4f97d7; font-weight: bold;">case</span> FTW_D:
            ndir++;
            <span style="color: #4f97d7; font-weight: bold;">break</span>;
        <span style="color: #4f97d7; font-weight: bold;">case</span> FTW_DNR:
            err_dump<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s: %s"</span>, pathname, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">break</span>;
        <span style="color: #4f97d7; font-weight: bold;">case</span> FTW_NS:
            err_dump<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"stat error for %s"</span>, pathname<span style="color: #2d9574;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">break</span>;
        <span style="color: #4f97d7; font-weight: bold;">default</span>:
            err_dump<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"unknown type %d for pathname %s"</span>, type, pathname<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li>4.12  FTP</li>

<li>4.13  <code>stat</code> first, set timespec array to current time that you expect not change, and the other to the value you want.</li>

<li><p>
4.14  access time is the last read time
</p>

<p>
modify time is last received
</p></li>

<li><p>
4.15  The change time isn't stored because, even if it was stored, you wouldn't be able to set it to the original time. You cannot cheat the change time, it is always based on when the inode data was actually changed.
</p>

<p>
<br />
Depending on the utility (tar or cpio), you can tell it to keep the original access and/or modify times. For example, tar by default maintains the original modify time but you can use the -m switch to set it to extraction time. The access time is always set to extraction time.
</p></li>

<li><p>
4.16
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[</span>argc<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">dirname</span> = <span style="color: #2d9574;">"testdir"</span>;
    <span style="color: #ce537a; font-weight: bold;">size_t</span>      <span style="color: #7590db;">pathmax</span> = pathconf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"."</span>, _PC_PATH_MAX<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"pathmax: %ld\n"</span>, pathmax<span style="color: #bc6ec5;">)</span>;

    <span style="color: #ce537a; font-weight: bold;">char</span>   <span style="color: #7590db;">path</span><span style="color: #bc6ec5;">[</span>pathmax<span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">curlen</span>;

    strcpy<span style="color: #bc6ec5;">(</span>path, dirname<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>;;<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        curlen = strlen<span style="color: #2d9574;">(</span>getcwd<span style="color: #67b11d;">(</span>path, pathmax<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> + strlen<span style="color: #2d9574;">(</span>dirname<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>curlen &lt;= pathmax<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>mkdir<span style="color: #b1951d;">(</span>dirname, <span style="color: #a45bad;">0777</span><span style="color: #b1951d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                printf<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"mkdir: %s\n"</span>, strerror<span style="color: #4f97d7;">(</span>errno<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span>;
                <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
            <span style="color: #67b11d;">}</span>
            sprintf<span style="color: #67b11d;">(</span>path, <span style="color: #2d9574;">"/%s"</span>, dirname<span style="color: #67b11d;">)</span>;
            chdir<span style="color: #67b11d;">(</span>dirname<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">break</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"curlen = %ld\n"</span>, curlen<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
4.17
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[</span>argc<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">path</span> = <span style="color: #2d9574;">"/dev/fd/1"</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">fd</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">ret</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>ret = unlink<span style="color: #67b11d;">(</span>path<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"unlink: %s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fd = creat<span style="color: #67b11d;">(</span>path, FILE_MODE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"creat: %s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
<code>unlink: Operation not permitted</code>
</p></li>
</ul></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgcc74a38" class="outline-3">
<h3 id="orgcc74a38"><span class="done DONE">DONE</span> Chapter 5. Standard I/O Library <code>[16/16]</code></h3>
<div class="outline-text-3" id="text-orgcc74a38">
</div>

<div id="outline-container-org25ca748" class="outline-4">
<h4 id="org25ca748"><span class="done DONE">DONE</span> 5.1 Introduction</h4>
<div class="outline-text-4" id="text-org25ca748">
<p>
This library is specified by the ISO C standard because it has been implemented on many operating systems other than the UNIX System.
</p>
</div>
</div>

<div id="outline-container-org9bc3748" class="outline-4">
<h4 id="org9bc3748"><span class="done DONE">DONE</span> 5.2 Streams and FILE Objects</h4>
<div class="outline-text-4" id="text-org9bc3748">
<p>
<code>man 3 fwide</code>
</p>
</div>
</div>

<div id="outline-container-org8236a2b" class="outline-4">
<h4 id="org8236a2b"><span class="done DONE">DONE</span> 5.3 Standard Input, Standard Output and Standard Error</h4>
<div class="outline-text-4" id="text-org8236a2b">
<p>
<code>STDIN_FILENO</code>, <code>STDOUT_FILENO</code>, <code>STDERR_FILENO</code>
</p>
</div>
</div>

<div id="outline-container-orgc66e0fd" class="outline-4">
<h4 id="orgc66e0fd"><span class="done DONE">DONE</span> 5.4 Buffering</h4>
<div class="outline-text-4" id="text-orgc66e0fd">
<p>
Three types of buffering are provided:
</p>
<ol class="org-ol">
<li>Fully buffered. <br />
In this case, actual I/O takes place when the standard I/O buffer is filled.</li>
<li>Line buffered. <br />
In this case, the standard I/O library performs I/O when a newline character is encountered on input or output.</li>
<li>Unbuffered. <br /></li>
</ol>

<p>
ISO C requires the following buffering characteristics:
</p>

<ul class="org-ul">
<li>Standard input and standard output are fully buffered, if and only if they do not refer to an interactive device.</li>

<li>Standard error is never fully buffered.</li>
</ul>

<p>
Most implementations default to the following types of buffering:
</p>

<ul class="org-ul">
<li>Standard error is always unbuffered.</li>

<li>All other streams are line buffered if they refer to a terminal device; otherwise, they are fully buffered.</li>
</ul>

<p>
<code>man 3 setbuf</code>
<code>man 3 fflush</code>
</p>
</div>
</div>

<div id="outline-container-org665951e" class="outline-4">
<h4 id="org665951e"><span class="done DONE">DONE</span> 5.5 Opening a Stream</h4>
<div class="outline-text-4" id="text-org665951e">
<p>
<code>man 3 fopen</code>
<code>man 3 fclose</code>
</p>
</div>
</div>

<div id="outline-container-orga5e45a2" class="outline-4">
<h4 id="orga5e45a2"><span class="done DONE">DONE</span> 5.6 Reading and Writing a Stream</h4>
<div class="outline-text-4" id="text-orga5e45a2">
<p>
Three types of unformatted I/O:
</p>
<ol class="org-ol">
<li>Character-at-a-time I/O.</li>
<li>Line-at-a-time I/O.</li>
<li>Direct I/O.</li>
</ol>
<p>
5.7 <b>**</b> DONE Input Functions
<code>man 3 getc</code>
</p>
<ol class="org-ol">
<li>The argument to getc should not be an expression with side effects, because it could be evaluated more than once.</li>
<li>Since fgetc is guaranteed to be a function, we can take its address. This allows us to pass the address of fgetc as an argument to another function.</li>
<li>Calls to fgetc probably take longer than calls to getc, as it usually takes more time to call a function.</li>
</ol>

<p>
In most implementations, two flags are maintained for each stream in the FILE object:
<code>man 3 ferror</code>
</p>

<ul class="org-ul">
<li>An error flag</li>

<li>An end-of file flagp</li>
</ul>

<p>
After reading from a stream, we can push back characters by calling <code>ungetc</code>.
5.8 <b>**</b> DONE Output Functions
<code>man 3 putc</code>
</p>
</div>
</div>

<div id="outline-container-orgfe07c15" class="outline-4">
<h4 id="orgfe07c15"><span class="done DONE">DONE</span> 5.9 Line-at-a-Time I/O</h4>
<div class="outline-text-4" id="text-orgfe07c15">
<p>
<code>man fgets</code>
</p>
</div>
</div>

<div id="outline-container-org9dd8342" class="outline-4">
<h4 id="org9dd8342"><span class="done DONE">DONE</span> 5.10 Standard I/O Efficiency</h4>
<div class="outline-text-4" id="text-org9dd8342">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 25: </span>Figure 5.4 Copy standard input to output using getc and putc</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">c</span>;

    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>c = getc<span style="color: #67b11d;">(</span>stdin<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != EOF<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>putc<span style="color: #67b11d;">(</span>c, stdout<span style="color: #67b11d;">)</span> == EOF<span style="color: #2d9574;">)</span>
            err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"output error: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ferror<span style="color: #2d9574;">(</span>stdin<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"input error: %s"</span>, strerror<span style="color: #2d9574;">(</span>errno<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 26: </span>Figure 5.5 Copy standard input to output using fgets and fputs</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[</span>argc<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span>MAXLINE<span style="color: #bc6ec5;">]</span>;

    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span>fgets<span style="color: #2d9574;">(</span>buf, MAXLINE, stdin<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>fputs<span style="color: #2d9574;">(</span>buf, stdout<span style="color: #2d9574;">)</span> == EOF<span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"output error"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ferror<span style="color: #2d9574;">(</span>stdin<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"input error: %s"</span>, strerror<span style="color: #2d9574;">(</span>errno<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org44b672c" class="outline-4">
<h4 id="org44b672c"><span class="done DONE">DONE</span> 5.11 Binary I/O</h4>
<div class="outline-text-4" id="text-org44b672c">
<p>
<code>man fread</code>
</p>
</div>
</div>

<div id="outline-container-org4486daa" class="outline-4">
<h4 id="org4486daa"><span class="done DONE">DONE</span> 5.12 Positioning a Stream</h4>
<div class="outline-text-4" id="text-org4486daa">
<p>
Three way to position a standard I/O stream:
</p>
<ol class="org-ol">
<li><code>ftell</code> and <code>fseek</code></li>
<li><code>ftello</code> and <code>fseeko</code></li>
<li><code>fgetpos</code> and <code>fsetpos</code></li>
</ol>

<p>
When porting applications to non-UNIX systems, use fgetpos and fsetpos.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">fgetpos</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">stream</span>, <span style="color: #ce537a; font-weight: bold;">fpos_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">pos</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">fseek</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">stream</span>, <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">offset</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">whence</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">fseeko</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">stream</span>, <span style="color: #ce537a; font-weight: bold;">off_t</span> <span style="color: #7590db;">offset</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">whence</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">fsetpos</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">stream</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">fpos_t</span> *<span style="color: #7590db;">pos</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #bc6ec5; font-weight: bold;">ftell</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">stream</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">off_t</span> <span style="color: #bc6ec5; font-weight: bold;">ftello</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">stream</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">rewind</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">stream</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb55ec70" class="outline-4">
<h4 id="orgb55ec70"><span class="done DONE">DONE</span> 5.13 Formated I/O</h4>
<div class="outline-text-4" id="text-orgb55ec70">
<p>
<code>man 3 printf</code>
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 2:</span> Figure 5.7 The flags component of a conversion specification</caption>

<colgroup>
<col  class="org-left" />
</colgroup>

<colgroup>
<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Flag</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">'</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">(apostrophe) format integer with thousands grouping characters</a></td>
</tr>

<tr>
<td class="org-left">-</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">left justify</a></td>
</tr>

<tr>
<td class="org-left">+</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">always display sign of a signed conversion</a></td>
</tr>

<tr>
<td class="org-left">(space)</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">prefix by a space if no sign is generated</a></td>
</tr>

<tr>
<td class="org-left">\#</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">convert using alternative form(include 0x prefix for hexadecimal format, for example)</a></td>
</tr>

<tr>
<td class="org-left">0</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">prefix with leading zeros instead of padding with spaces</a></td>
</tr>
</tbody>
</table>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 3:</span> Figure 5.8 The lenth modifier component of a conversion specification</caption>

<colgroup>
<col  class="org-left" />
</colgroup>

<colgroup>
<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Length modifer</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">hh</td>
<td class="org-left">signed or unsigned char</td>
</tr>

<tr>
<td class="org-left">h</td>
<td class="org-left">sigend or unsigned short</td>
</tr>

<tr>
<td class="org-left">l</td>
<td class="org-left">signed or unsigned long or wide character</td>
</tr>

<tr>
<td class="org-left">ll</td>
<td class="org-left">signed or unsigned long long</td>
</tr>

<tr>
<td class="org-left">j</td>
<td class="org-left">inmax_t or uintmax_t</td>
</tr>

<tr>
<td class="org-left">z</td>
<td class="org-left">size_t</td>
</tr>

<tr>
<td class="org-left">t</td>
<td class="org-left">ptrdiff_t</td>
</tr>

<tr>
<td class="org-left">L</td>
<td class="org-left">long double</td>
</tr>
</tbody>
</table>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 4:</span> Figure 5.9 The conversion type component of a conversion specification</caption>

<colgroup>
<col  class="org-left" />
</colgroup>

<colgroup>
<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Conversion type</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">d,i</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">signed decimal</a></td>
</tr>

<tr>
<td class="org-left">o</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">unsigned octal</a></td>
</tr>

<tr>
<td class="org-left">u</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">unsigned decimal</a></td>
</tr>

<tr>
<td class="org-left">x,X</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">unsigned hexadecimal</a></td>
</tr>

<tr>
<td class="org-left">f,F</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">double floating-point number</a></td>
</tr>

<tr>
<td class="org-left">e,E</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">double floating-point number in exponential format</a></td>
</tr>

<tr>
<td class="org-left">g,G</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">interpreted as f, F, e, or E, depending on value converted</a></td>
</tr>

<tr>
<td class="org-left">a,A</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">double floating-point number in hexadecimal exponential format</a></td>
</tr>

<tr>
<td class="org-left">c</td>
<td class="org-left">character (with 1 length modifier, wide character)</td>
</tr>

<tr>
<td class="org-left">s</td>
<td class="org-left">string(with 1 length modifier, wide character string)</td>
</tr>

<tr>
<td class="org-left">p</td>
<td class="org-left">pointer to a void</td>
</tr>

<tr>
<td class="org-left">n</td>
<td class="org-left">pointer to a signed integer into which is written the number of characters written so far</td>
</tr>

<tr>
<td class="org-left">%</td>
<td class="org-left">a % character</td>
</tr>

<tr>
<td class="org-left">C</td>
<td class="org-left">wide chracter(XSI option, equivalent to lc)</td>
</tr>

<tr>
<td class="org-left">S</td>
<td class="org-left">wide chracter string(XSI option, equivalent to ls)</td>
</tr>
</tbody>
</table>

<p>
<b>Formatted Input</b>
<code>man 3 scanf</code>
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 5:</span> Figure 5.9 The conversion type component of a conversion specification</caption>

<colgroup>
<col  class="org-left" />
</colgroup>

<colgroup>
<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Conversion type</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">d</td>
<td class="org-left">signed decimal, base 10</td>
</tr>

<tr>
<td class="org-left">i</td>
<td class="org-left">signed decimal, base determined by format of input</td>
</tr>

<tr>
<td class="org-left">o</td>
<td class="org-left">unsigned octal(input optionally signed)</td>
</tr>

<tr>
<td class="org-left">u</td>
<td class="org-left">unsigned decimal, base 10(input optionally signed)</td>
</tr>

<tr>
<td class="org-left">x,X</td>
<td class="org-left">unsigned hexadecimal(input optionally signed)</td>
</tr>

<tr>
<td class="org-left">a,A,e,E,f,F,g,G</td>
<td class="org-left">floating-point number</td>
</tr>

<tr>
<td class="org-left">c</td>
<td class="org-left">character (with 1 length modifier, wide character)</td>
</tr>

<tr>
<td class="org-left">s</td>
<td class="org-left">string(with 1 length modifier, wide character string)</td>
</tr>

<tr>
<td class="org-left">[</td>
<td class="org-left">mathches a sequence of listed characters, ending with ]</td>
</tr>

<tr>
<td class="org-left">[^</td>
<td class="org-left">mathches all characters except the ones listed, ending with ]</td>
</tr>

<tr>
<td class="org-left">p</td>
<td class="org-left">pointer to a void</td>
</tr>

<tr>
<td class="org-left">n</td>
<td class="org-left">pointer to a signed integer into which is written the number of characters written so far</td>
</tr>

<tr>
<td class="org-left">%</td>
<td class="org-left">a % character</td>
</tr>

<tr>
<td class="org-left">C</td>
<td class="org-left">wide chracter(XSI option, equivalent to lc)</td>
</tr>

<tr>
<td class="org-left">S</td>
<td class="org-left">wide chracter string(XSI option, equivalent to ls)</td>
</tr>
</tbody>
</table>

<p>
<b>*</b>
</p>
</div>
</div>

<div id="outline-container-orga6cd9a5" class="outline-4">
<h4 id="orga6cd9a5"><span class="done DONE">DONE</span> 5.14 Implementation Details</h4>
<div class="outline-text-4" id="text-orga6cd9a5">
<p>
<code>man 3 fileno</code>
</p>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 27: </span>Figure 5.11 Print buffering for various standard I/O streams</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">pr_stdio</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *, <span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span>  <span style="color: #bc6ec5; font-weight: bold;">is_unbuffered</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span>  <span style="color: #bc6ec5; font-weight: bold;">is_linebuffered</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span>  <span style="color: #bc6ec5; font-weight: bold;">buffer_size</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span>;

    fputs<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"enter any character\n"</span>, stdout<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>getchar<span style="color: #2d9574;">()</span> == EOF<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"getchar: %s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    fputs<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"one line to standard error\n"</span>, stderr<span style="color: #bc6ec5;">)</span>;

    pr_stdio<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"stdin"</span>, stdin<span style="color: #bc6ec5;">)</span>;
    pr_stdio<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"stdout"</span>, stdout<span style="color: #bc6ec5;">)</span>;
    pr_stdio<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"stderr"</span>, stderr<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fp = fopen<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"/etc/passwd"</span>, <span style="color: #2d9574;">"r"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"fopen: %s\n"</span>, strerror<span style="color: #2d9574;">(</span>errno<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>getc<span style="color: #2d9574;">(</span>fp<span style="color: #2d9574;">)</span> == EOF<span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"getc: %s\n"</span>, strerror<span style="color: #2d9574;">(</span>errno<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;

    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">pr_stdio</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span>, <span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"stream = %s, "</span>, name<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>is_unbuffered<span style="color: #2d9574;">(</span>fp<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
        printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"unbuffered"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>is_linebuffered<span style="color: #2d9574;">(</span>fp<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
        printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"line buffered"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">if neither or above</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"fully buffered"</span><span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">", buffer size = %d\n"</span>, buffer_size<span style="color: #2d9574;">(</span>fp<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #2aa1ae; background-color: #292e34;">/*</span>
<span style="color: #2aa1ae; background-color: #292e34;"> * The following is nonportable</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>_IO_UNBUFFERED<span style="color: #4f97d7;">)</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">is_unbuffered</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fp-&gt;flags &amp; _IO_UNBUFFERED<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">is_linebuffered</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fp-&gt;flags &amp; _IO_LINE_BUF<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">buffer_size</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #bc6ec5;">#elif</span> <span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>__SNBF<span style="color: #4f97d7;">)</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">is_unbuffered</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fp-&gt;_flags &amp; __SNBF<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">is_linebuffered</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fp-&gt;_flags &amp; __SLBF<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">buffer_size</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fp-&gt;_bf._size<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #bc6ec5;">#elif</span> <span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>_IONBF<span style="color: #4f97d7;">)</span>

<span style="color: #bc6ec5;">#ifdef</span> _LP64
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">_flag</span> __pad<span style="color: #4f97d7;">[</span><span style="color: #a45bad;">4</span><span style="color: #4f97d7;">]</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">_ptr</span>  __pad<span style="color: #4f97d7;">[</span><span style="color: #a45bad;">1</span><span style="color: #4f97d7;">]</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">_base</span> __pad<span style="color: #4f97d7;">[</span><span style="color: #a45bad;">2</span><span style="color: #4f97d7;">]</span>
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">is_unbuffered</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fp-&gt;_flag &amp; _IONBF<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">is_linebuffered</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fp-&gt;_flag &amp; _IOLBF<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">buffer_size</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
<span style="color: #bc6ec5;">#ifdef</span> _LP64
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fp-&gt;_base - fp-&gt;_ptr<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>BUFSIZ<span style="color: #bc6ec5;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">just a guess</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #bc6ec5;">#else</span>

<span style="color: #bc6ec5;">#error</span> <span style="color: #2d9574;">unknown stdio implementation;</span>

<span style="color: #bc6ec5;">#endif</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-orgafd1626" class="outline-4">
<h4 id="orgafd1626"><span class="done DONE">DONE</span> 5.15 Temporary Files</h4>
<div class="outline-text-4" id="text-orgafd1626">
<p>
<code>man 3 tmpnam</code>
</p>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 28: </span>Figure 5.12 Demonstrate tmpnam and tmpfile functions</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span>  <span style="color: #7590db;">name</span><span style="color: #bc6ec5;">[</span>L_tmpnam<span style="color: #bc6ec5;">]</span>, <span style="color: #7590db;">line</span><span style="color: #bc6ec5;">[</span>MAXLINE<span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span>;

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%s\n"</span>, tmpnam<span style="color: #2d9574;">(</span><span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">first temp name</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>

    tmpnam<span style="color: #bc6ec5;">(</span>name<span style="color: #bc6ec5;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">second temp name</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%s\n"</span>, name<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fp = tmpfile<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">create temp file</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"tmpfile: %s\n"</span>, strerror<span style="color: #2d9574;">(</span>errno<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;

    fputs<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"one line of output\n"</span>, fp<span style="color: #bc6ec5;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">write to temp file</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    rewind<span style="color: #bc6ec5;">(</span>fp<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>fgets<span style="color: #2d9574;">(</span>line, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span>line<span style="color: #67b11d;">)</span>, fp<span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"fgets: %s\n"</span>, strerror<span style="color: #2d9574;">(</span>errno<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    fputs<span style="color: #bc6ec5;">(</span>line, stdout<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>

<p>
<code>man 3 mkdtemp</code>
</p>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 29: </span>Figure 5.13 Demonstrate mkstemp function</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">make_temp</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">template</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[</span>argc<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span>  <span style="color: #7590db;">good_template</span><span style="color: #bc6ec5;">[]</span> = <span style="color: #2d9574;">"/tmp/dirXXXX"</span>;  <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">right way</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">bad_template</span>    = <span style="color: #2d9574;">"/tmp/dir/</span><span style="color: #dc752f;">XXXX</span><span style="color: #2d9574;">"</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">bad way</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"trying to create first temp file ...\n"</span><span style="color: #bc6ec5;">)</span>;
    make_temp<span style="color: #bc6ec5;">(</span>good_template<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"trying to create second temp file ...\n"</span><span style="color: #bc6ec5;">)</span>;
    make_temp<span style="color: #bc6ec5;">(</span>bad_template<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">make_temp</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">template</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>         <span style="color: #7590db;">fd</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">stat</span> <span style="color: #7590db;">sbuf</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fd = mkstemp<span style="color: #67b11d;">(</span>template<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"create temp: %s\n"</span>, strerror<span style="color: #2d9574;">(</span>errno<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"temp name = %s\n"</span>, template<span style="color: #bc6ec5;">)</span>;
    close<span style="color: #bc6ec5;">(</span>fd<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>stat<span style="color: #2d9574;">(</span>template, &amp;sbuf<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"stat: %s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"file exists\n"</span><span style="color: #2d9574;">)</span>;
        unlink<span style="color: #2d9574;">(</span>template<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org6663806" class="outline-4">
<h4 id="org6663806"><span class="done DONE">DONE</span> 5.16 Memory Streams</h4>
<div class="outline-text-4" id="text-org6663806">
<p>
<code>man 3 fmemopen</code>
</p>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 30: </span>Figure 5.15 Investigate memory stream write behavior</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">BSZ</span> <span style="color: #a45bad;">48</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>  <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span>BSZ<span style="color: #bc6ec5;">]</span>;

    memset<span style="color: #bc6ec5;">(</span>buf, <span style="color: #2d9574;">'a'</span>, BSZ - <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span>;
    buf<span style="color: #bc6ec5;">[</span>BSZ - <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span> = <span style="color: #2d9574;">'\0'</span>;
    buf<span style="color: #bc6ec5;">[</span>BSZ - <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span> = <span style="color: #2d9574;">'X'</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fp = fmemopen<span style="color: #67b11d;">(</span>buf, BSZ, <span style="color: #2d9574;">"w+"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"fmemopen failed"</span><span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"initial buffer contents: %s\n"</span>, buf<span style="color: #bc6ec5;">)</span>;
    fprintf<span style="color: #bc6ec5;">(</span>fp, <span style="color: #2d9574;">"hello, world"</span><span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"before flush: %s\n"</span>, buf<span style="color: #bc6ec5;">)</span>;
    fflush<span style="color: #bc6ec5;">(</span>fp<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"after fflush: %s\n"</span>, buf<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"len of string in buf = %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>strlen<span style="color: #2d9574;">(</span>buf<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;

    memset<span style="color: #bc6ec5;">(</span>buf, <span style="color: #2d9574;">'b'</span>, BSZ - <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span>;
    buf<span style="color: #bc6ec5;">[</span>BSZ - <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span> = <span style="color: #2d9574;">'\0'</span>;
    buf<span style="color: #bc6ec5;">[</span>BSZ - <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span> = <span style="color: #2d9574;">'X'</span>;
    fprintf<span style="color: #bc6ec5;">(</span>fp, <span style="color: #2d9574;">"hello, world"</span><span style="color: #bc6ec5;">)</span>;
    fseek<span style="color: #bc6ec5;">(</span>fp, <span style="color: #a45bad;">0</span>, SEEK_SET<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"after fseek: %s\n"</span>, buf<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"len of string in buf = %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>strlen<span style="color: #2d9574;">(</span>buf<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    memset<span style="color: #bc6ec5;">(</span>buf, <span style="color: #2d9574;">'c'</span>, BSZ - <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span>;
    buf<span style="color: #bc6ec5;">[</span>BSZ - <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span> = <span style="color: #2d9574;">'\0'</span>;
    buf<span style="color: #bc6ec5;">[</span>BSZ - <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span> = <span style="color: #2d9574;">'X'</span>;
    fprintf<span style="color: #bc6ec5;">(</span>fp, <span style="color: #2d9574;">"hello, world"</span><span style="color: #bc6ec5;">)</span>;
    fclose<span style="color: #bc6ec5;">(</span>fp<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"after fclose: %s\n"</span>, buf<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"len of string in buf = %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>strlen<span style="color: #2d9574;">(</span>buf<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
<p>
<b>linux</b> result:
</p>
<blockquote>
<p>
initial buffer contents: <br />
before flush: <br />
after fflush: hello, world <br />
len of string in buf = 12 <br />
after fseek: hello, world <br />
len of string in buf = 24 <br />
after fclose: hello, world <br />
len of string in buf = 46
</p>
</blockquote>

<p>
The other two functions:
<code>man open_memstream</code>
</p>
</div>
</div>

<div id="outline-container-org52efd99" class="outline-4">
<h4 id="org52efd99"><span class="done DONE">DONE</span> 5.17 Alternatives to Standard I/O</h4>
<div class="outline-text-4" id="text-org52efd99">
<p>
The standard I/O library is not perfect. some in the basic design, but most in the various implementations.
</p>
</div>
</div>

<div id="outline-container-org82b128c" class="outline-4">
<h4 id="org82b128c"><span class="done DONE">DONE</span> 5.18 Summary</h4>
<div class="outline-text-4" id="text-org82b128c">
<ul class="org-ul">
<li>Exercises

<ul class="org-ul">
<li><p>
3.1
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">setbuf_</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">stream</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">buf</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>stream == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        setvbuf<span style="color: #2d9574;">(</span>stream, buf, _IONBF, BUFSIZ<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>isatty<span style="color: #2d9574;">(</span>fileno<span style="color: #67b11d;">(</span>stream<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        setvbuf<span style="color: #2d9574;">(</span>stream, buf, _IOLBF, BUFSIZ<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        setvbuf<span style="color: #2d9574;">(</span>stream, buf, _IOFBF, BUFSIZ<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">is_unbuffered</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fp-&gt;_flags &amp; __SNBF<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">is_linebuffered</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fp-&gt;_flags &amp; __SLBF<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">buffer_size</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fp-&gt;_bf._size<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">pr_stdio</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span>, <span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"stream = %s, "</span>, name<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>is_unbuffered<span style="color: #2d9574;">(</span>fp<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
        printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"unbuffered"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>is_linebuffered<span style="color: #2d9574;">(</span>fp<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
        printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"line buffered"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">if neither or above</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"fully buffered"</span><span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">", buffer size = %d\n"</span>, buffer_size<span style="color: #2d9574;">(</span>fp<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>  <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span>BUFSIZ<span style="color: #bc6ec5;">]</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc &lt; <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"usage: ./a.out &lt;path&gt;"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    fp = fopen<span style="color: #bc6ec5;">(</span>argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>, <span style="color: #2d9574;">"r+"</span><span style="color: #bc6ec5;">)</span>;
    pr_stdio<span style="color: #bc6ec5;">(</span>argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>, fp<span style="color: #bc6ec5;">)</span>;
    setbuf_<span style="color: #bc6ec5;">(</span>fp, buf<span style="color: #bc6ec5;">)</span>;
    pr_stdio<span style="color: #bc6ec5;">(</span>argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>, fp<span style="color: #bc6ec5;">)</span>;
    fclose<span style="color: #bc6ec5;">(</span>fp<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
3.2
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#ifdef</span> MAXLINE
<span style="color: #bc6ec5;">#undef</span> MAXLINE
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">MAXLINE</span> <span style="color: #a45bad;">4</span>
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[</span>argc<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span>MAXLINE<span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>  <span style="color: #7590db;">i</span> = <span style="color: #a45bad;">0</span>;

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"MAXLINE: %d\n"</span>, MAXLINE<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span>fgets<span style="color: #2d9574;">(</span>buf, MAXLINE, stdin<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>fputs<span style="color: #67b11d;">(</span>buf, stdout<span style="color: #67b11d;">)</span> == EOF<span style="color: #2d9574;">)</span> err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"output error"</span><span style="color: #2d9574;">)</span>;
        ++i;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">nums</span> = printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"loop_time: %d\n"</span>, i<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"nums: %d\n"</span>, nums<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ferror<span style="color: #2d9574;">(</span>stdin<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"input error: %s"</span>, strerror<span style="color: #2d9574;">(</span>errno<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
execute <code>fgets</code> and <code>fputs</code> more than 1 times;
</p></li>

<li>3.3  print nothing</li>

<li>3.4  This is a common error. The return value from getc and getchar is an int, not a char. EOF is often defined to be −1, so if the system uses signed characters, the code normally works</li>

<li>3.5  call <code>fflush</code> first</li>

<li>3.6  stdin and stdout are both line buffered. fgets will fflush automatically</li>

<li><p>
3.7
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">string.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">memstream</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span> * <span style="color: #7590db;">buf</span>;    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">in-memory buffer</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">rsize</span>;  <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">real size of buffer</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">vsize</span>;  <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">virtual size of buffer</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">curpos</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">current position in buffer</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>    <span style="color: #7590db;">flags</span>;  <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">see below</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #4f97d7;">}</span>;

<span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">flags</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">MS_READ</span>    <span style="color: #a45bad;">0x01</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">open for reading</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">MS_WRITE</span>   <span style="color: #a45bad;">0x02</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">open for writing</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">MS_APPEND</span>  <span style="color: #a45bad;">0x04</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">append to stream</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">MS_TRUNCAT</span> <span style="color: #a45bad;">0x08</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">truncate the stream on open</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">MS_MYBUF</span>   <span style="color: #a45bad;">0x10</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">free buffer on close</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>

<span style="color: #bc6ec5;">#if</span><span style="color: #bc6ec5;">n</span><span style="color: #bc6ec5;">def</span> MIN
<span style="color: #bc6ec5;">#define</span> <span style="color: #bc6ec5; font-weight: bold;">MIN</span><span style="color: #4f97d7;">(</span><span style="color: #7590db;">a</span>, <span style="color: #7590db;">b</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span>a<span style="color: #bc6ec5;">)</span> &lt; <span style="color: #bc6ec5;">(</span>b<span style="color: #bc6ec5;">)</span> ? <span style="color: #bc6ec5;">(</span>a<span style="color: #bc6ec5;">)</span> : <span style="color: #bc6ec5;">(</span>b<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span>    <span style="color: #bc6ec5; font-weight: bold;">mstream_read</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *, <span style="color: #ce537a; font-weight: bold;">char</span> *, <span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span>    <span style="color: #bc6ec5; font-weight: bold;">mstream_write</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *, <span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">fpos_t</span> <span style="color: #bc6ec5; font-weight: bold;">mstream_seek</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *, <span style="color: #ce537a; font-weight: bold;">fpos_t</span>, <span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span>    <span style="color: #bc6ec5; font-weight: bold;">mstream_close</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #4f97d7;">)</span>;

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #bc6ec5; font-weight: bold;">type_to_flags</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">__restrict</span> type<span style="color: #4f97d7;">)</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">off_t</span> <span style="color: #bc6ec5; font-weight: bold;">find_end</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">buf</span>, <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">len</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #bc6ec5; font-weight: bold;">fmemopen</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">__restrict</span> buf, <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">size</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">__restrict</span> type<span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">memstream</span> *<span style="color: #7590db;">ms</span>;
    <span style="color: #ce537a; font-weight: bold;">FILE</span> *            <span style="color: #7590db;">fp</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>size == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        errno = EINVAL;
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">NULL</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>ms = malloc<span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #b1951d;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">memstream</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        errno = ENOMEM;
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">NULL</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>ms-&gt;flags = type_to_flags<span style="color: #67b11d;">(</span>type<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        errno = EINVAL;
        free<span style="color: #2d9574;">(</span>ms<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">NULL</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>buf == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>ms-&gt;flags &amp; <span style="color: #b1951d;">(</span>MS_READ | MS_WRITE<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> != <span style="color: #67b11d;">(</span>MS_READ | MS_WRITE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            errno = EINVAL;
            free<span style="color: #67b11d;">(</span>ms<span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">NULL</span>;
        <span style="color: #2d9574;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>ms-&gt;buf = malloc<span style="color: #b1951d;">(</span>size<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            errno = ENOMEM;
            free<span style="color: #67b11d;">(</span>ms<span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">NULL</span>;
        <span style="color: #2d9574;">}</span>
        ms-&gt;rsize = size;
        ms-&gt;flags |= MS_MYBUF;
        ms-&gt;curpos = <span style="color: #a45bad;">0</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        ms-&gt;buf   = buf;
        ms-&gt;rsize = size;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>ms-&gt;flags &amp; MS_APPEND<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            ms-&gt;curpos = find_end<span style="color: #67b11d;">(</span>ms-&gt;buf, ms-&gt;rsize<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            ms-&gt;curpos = <span style="color: #a45bad;">0</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ms-&gt;flags &amp; MS_APPEND<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        ms-&gt;vsize = ms-&gt;curpos;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ms-&gt;flags &amp; MS_TRUNCAT<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        ms-&gt;vsize = <span style="color: #a45bad;">0</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        ms-&gt;vsize = size;
    <span style="color: #bc6ec5;">}</span>

    fp = funopen<span style="color: #bc6ec5;">(</span>ms, mstream_read, mstream_write, mstream_seek, mstream_close<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>fp == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>ms-&gt;flags &amp; MS_MYBUF<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            free<span style="color: #67b11d;">(</span>ms-&gt;buf<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> fp;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">type_to_flags</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">__restrict</span> type<span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">cp</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>         <span style="color: #7590db;">flags</span> = <span style="color: #a45bad;">0</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>cp = type; *cp != <span style="color: #a45bad;">0</span>; cp++<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">switch</span> <span style="color: #2d9574;">(</span>*cp<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">case</span> <span style="color: #2d9574;">'r'</span>:
                <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>flags != <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
                flags |= MS_READ;
                <span style="color: #4f97d7; font-weight: bold;">break</span>;

            <span style="color: #4f97d7; font-weight: bold;">case</span> <span style="color: #2d9574;">'w'</span>:
                <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>flags != <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
                flags |= MS_WRITE | MS_TRUNCAT;
                <span style="color: #4f97d7; font-weight: bold;">break</span>;

            <span style="color: #4f97d7; font-weight: bold;">case</span> <span style="color: #2d9574;">'a'</span>:
                <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>flags != <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
                flags |= MS_APPEND;
                <span style="color: #4f97d7; font-weight: bold;">break</span>;

            <span style="color: #4f97d7; font-weight: bold;">case</span> <span style="color: #2d9574;">'+'</span>:
                <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>flags == <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
                flags |= MS_READ | MS_WRITE;
                <span style="color: #4f97d7; font-weight: bold;">break</span>;

            <span style="color: #4f97d7; font-weight: bold;">case</span> <span style="color: #2d9574;">'b'</span>:
                <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>flags == <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
                <span style="color: #4f97d7; font-weight: bold;">break</span>;

            <span style="color: #4f97d7; font-weight: bold;">default</span>:
                <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> flags;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">off_t</span> <span style="color: #bc6ec5; font-weight: bold;">find_end</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">buf</span>, <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">len</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">off_t</span> <span style="color: #7590db;">off</span> = <span style="color: #a45bad;">0</span>;

    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span>off &lt; len<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>buf<span style="color: #67b11d;">[</span>off<span style="color: #67b11d;">]</span> == <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #4f97d7; font-weight: bold;">break</span>;
        off++;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> off;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">mstream_read</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">cookie</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">buf</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">len</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>               <span style="color: #7590db;">nr</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">memstream</span> *<span style="color: #7590db;">ms</span> = cookie;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">!</span><span style="color: #2d9574;">(</span>ms-&gt;flags &amp; MS_READ<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        errno = EBADF;
        <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ms-&gt;curpos &gt;= ms-&gt;vsize<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
    <span style="color: #bc6ec5;">}</span>

    nr = MIN<span style="color: #bc6ec5;">(</span>len, ms-&gt;vsize - ms-&gt;curpos<span style="color: #bc6ec5;">)</span>;
    memcpy<span style="color: #bc6ec5;">(</span>buf, ms-&gt;buf + ms-&gt;curpos, nr<span style="color: #bc6ec5;">)</span>;
    ms-&gt;curpos += nr;
    <span style="color: #4f97d7; font-weight: bold;">return</span> nr;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">mstream_write</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">cookie</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">buf</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">len</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>               <span style="color: #7590db;">nw</span>, <span style="color: #7590db;">off</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">memstream</span> *<span style="color: #7590db;">ms</span> = cookie;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">!</span><span style="color: #2d9574;">(</span>ms-&gt;flags &amp; <span style="color: #67b11d;">(</span>MS_APPEND | MS_WRITE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        errno = EBADF;
        <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ms-&gt;flags &amp; MS_APPEND<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        off = ms-&gt;vsize;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        off = ms-&gt;curpos;
    <span style="color: #bc6ec5;">}</span>

    nw = MIN<span style="color: #bc6ec5;">(</span>len, ms-&gt;rsize - off<span style="color: #bc6ec5;">)</span>;
    memcpy<span style="color: #bc6ec5;">(</span>ms-&gt;buf + off, buf, nw<span style="color: #bc6ec5;">)</span>;
    ms-&gt;curpos = off + nw;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ms-&gt;curpos &gt; ms-&gt;vsize<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        ms-&gt;vsize = ms-&gt;curpos;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>ms-&gt;flags &amp; <span style="color: #4f97d7;">(</span>MS_READ | MS_WRITE<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span> == <span style="color: #b1951d;">(</span>MS_READ | MS_WRITE<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &amp;&amp;
            ms-&gt;vsize &lt; ms-&gt;rsize<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            *<span style="color: #67b11d;">(</span>ms-&gt;buf + ms-&gt;vsize<span style="color: #67b11d;">)</span> = <span style="color: #a45bad;">0</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>ms-&gt;flags &amp; <span style="color: #67b11d;">(</span>MS_WRITE | MS_APPEND<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &amp;&amp; <span style="color: #a45bad;">!</span><span style="color: #2d9574;">(</span>ms-&gt;flags &amp; MS_READ<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>ms-&gt;curpos &lt; ms-&gt;rsize<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            *<span style="color: #67b11d;">(</span>ms-&gt;buf + ms-&gt;curpos<span style="color: #67b11d;">)</span> = <span style="color: #a45bad;">0</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            *<span style="color: #67b11d;">(</span>ms-&gt;buf + ms-&gt;rsize - <span style="color: #a45bad;">1</span><span style="color: #67b11d;">)</span> = <span style="color: #a45bad;">0</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> nw;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">fpos_t</span> <span style="color: #bc6ec5; font-weight: bold;">mstream_seek</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">cookie</span>, <span style="color: #ce537a; font-weight: bold;">fpos_t</span> <span style="color: #7590db;">pos</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">whence</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>               <span style="color: #7590db;">off</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">memstream</span> *<span style="color: #7590db;">ms</span> = cookie;

    <span style="color: #4f97d7; font-weight: bold;">switch</span> <span style="color: #bc6ec5;">(</span>whence<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">case</span> SEEK_SET:
            off = pos;
            <span style="color: #4f97d7; font-weight: bold;">break</span>;

        <span style="color: #4f97d7; font-weight: bold;">case</span> SEEK_END:
            off = ms-&gt;vsize + pos;
            <span style="color: #4f97d7; font-weight: bold;">break</span>;

        <span style="color: #4f97d7; font-weight: bold;">case</span> SEEK_CUR:
            off = ms-&gt;curpos + pos;
            <span style="color: #4f97d7; font-weight: bold;">break</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>off &lt; <span style="color: #a45bad;">0</span> || off &gt; ms-&gt;vsize<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        errno = EINVAL;
        <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
    <span style="color: #bc6ec5;">}</span>
    ms-&gt;curpos = off;
    <span style="color: #4f97d7; font-weight: bold;">return</span> off;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">mstream_close</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">cookie</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">memstream</span> *<span style="color: #7590db;">ms</span> = cookie;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ms-&gt;flags &amp; MS_MYBUF<span style="color: #bc6ec5;">)</span> free<span style="color: #bc6ec5;">(</span>ms-&gt;buf<span style="color: #bc6ec5;">)</span>;
    free<span style="color: #bc6ec5;">(</span>ms<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org17c2f01" class="outline-3">
<h3 id="org17c2f01"><span class="done DONE">DONE</span> Chapter 6. System Data Files and Information <code>[11/11]</code></h3>
<div class="outline-text-3" id="text-org17c2f01">
</div>

<div id="outline-container-orgb3fa8c1" class="outline-4">
<h4 id="orgb3fa8c1"><span class="done DONE">DONE</span> 6.1 introduction</h4>
</div>
<div id="outline-container-org3a729f8" class="outline-4">
<h4 id="org3a729f8"><span class="done DONE">DONE</span> 6.2 Password File</h4>
<div class="outline-text-4" id="text-org3a729f8">
<p>
<code>man getpwuid</code>
</p>
</div>
</div>

<div id="outline-container-org5ba9f1d" class="outline-4">
<h4 id="org5ba9f1d"><span class="done DONE">DONE</span> 6.3 Shadow Passwords</h4>
<div class="outline-text-4" id="text-org5ba9f1d">
<p>
<b>On Linux 3.2.0 and Solaris 10,</b>
<code>man getspnam</code>
<b>On FreeBSD 8.0 and Mac OS X 10.6.8, there is no shadow password structure</b>
</p>
</div>
</div>

<div id="outline-container-org5ba3802" class="outline-4">
<h4 id="org5ba3802"><span class="done DONE">DONE</span> 6.4 Group File</h4>
<div class="outline-text-4" id="text-org5ba3802">
<p>
<code>man getgrgid</code>
</p>
</div>
</div>

<div id="outline-container-org3dd4022" class="outline-4">
<h4 id="org3dd4022"><span class="done DONE">DONE</span> 6.5 Supplementary Group Ids</h4>
<div class="outline-text-4" id="text-org3dd4022">
<p>
<code>man getgroups</code> <br />
</p>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 31: </span>Example for get groups' info</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">grp.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">uuid/uuid.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>           <span style="color: #7590db;">grpmax</span> = sysconf<span style="color: #bc6ec5;">(</span>_SC_NGROUPS_MAX<span style="color: #bc6ec5;">)</span>;
    <span style="color: #ce537a; font-weight: bold;">gid_t</span>         <span style="color: #7590db;">grouplist</span><span style="color: #bc6ec5;">[</span>grpmax<span style="color: #bc6ec5;">]</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">group</span> *<span style="color: #7590db;">grp</span> = <span style="color: #a45bad;">NULL</span>;

    getgroups<span style="color: #bc6ec5;">(</span>grpmax, grouplist<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">i</span> = <span style="color: #a45bad;">0</span>; i &lt; grpmax; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        grp = getgrgid<span style="color: #2d9574;">(</span>grouplist<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%d\t%s\n"</span>, grouplist<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span>, grp-&gt;gr_name<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org35a4c6c" class="outline-4">
<h4 id="org35a4c6c"><span class="done DONE">DONE</span> 6.6 Implementation Differences</h4>
</div>
<div id="outline-container-orgf6be85e" class="outline-4">
<h4 id="orgf6be85e"><span class="done DONE">DONE</span> 6.7 Other Data Files</h4>
<div class="outline-text-4" id="text-orgf6be85e">
<p>
at least three functions:
</p>
<ol class="org-ol">
<li>A get function that reads the next record, opening the file if necessary.</li>
<li>A set function that opens the file, if not already open, and rewinds the file.</li>
<li>An end entry that closes the data file.</li>
</ol>
</div>
</div>

<div id="outline-container-org039007f" class="outline-4">
<h4 id="org039007f"><span class="done DONE">DONE</span> 6.8 Login Accounting</h4>
<div class="outline-text-4" id="text-org039007f">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">utmp</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">ut_line</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">8</span><span style="color: #bc6ec5;">]</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">tty line: "ttyh0", "ttyd0", "ttyp0", ...</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">ut_name</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">8</span><span style="color: #bc6ec5;">]</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">login name</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">ut_time</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">seconds since Epoch</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #4f97d7;">}</span>;
</pre>
</div>

<p>
login: filled in and written to te utmp file, and appended to the wtmp file by the login program.
logout: utmp file was filled with null bytes by the init process, and a new entry was appended to the wtmp file.
</p>

<p>
<code>who</code> reads utmp file
<code>last</code> reads wtmp file
</p>
</div>
</div>

<div id="outline-container-org34c8860" class="outline-4">
<h4 id="org34c8860"><span class="done DONE">DONE</span> 6.9 System Identification</h4>
<div class="outline-text-4" id="text-org34c8860">
<p>
information on the current host and operating system.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/utsname.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">uname</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">utsname</span> *<span style="color: #7590db;">name</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: non-negative value if OK, -1 on error</span>
</pre>
</div>

<p>
network hostname:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">gethostname</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">namelen</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, -1 on error</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc7bcf9e" class="outline-4">
<h4 id="orgc7bcf9e"><span class="done DONE">DONE</span> 6.10 Time and Date Routines</h4>
<div class="outline-text-4" id="text-orgc7bcf9e">
<p>
<code>man 3 time</code>
<code>man 3 clock_gettime</code>
<code>man 3 gmtime</code>
<code>man 3 strftime</code>
</p>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 32: </span>Figure 6.11 Using the strftime function</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">time.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">time_t</span>     <span style="color: #7590db;">t</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">tm</span> *<span style="color: #7590db;">tmp</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>       <span style="color: #7590db;">buf1</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">16</span><span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>       <span style="color: #7590db;">buf2</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">64</span><span style="color: #bc6ec5;">]</span>;

    time<span style="color: #bc6ec5;">(</span>&amp;t<span style="color: #bc6ec5;">)</span>;
    tmp = localtime<span style="color: #bc6ec5;">(</span>&amp;t<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>strftime<span style="color: #2d9574;">(</span>buf1, <span style="color: #a45bad;">16</span>, <span style="color: #2d9574;">"time and date: %r, %a %b %d, %Y"</span>, tmp<span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"buffer length 16 is too small\n"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s\n"</span>, buf1<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>strftime<span style="color: #2d9574;">(</span>buf2, <span style="color: #a45bad;">64</span>, <span style="color: #2d9574;">"time and date: %r, %a %b %d, %Y"</span>, tmp<span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"buffer length 64 is too small\n"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s\n"</span>, buf2<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
<p>
<code>man 3 strptim</code>
</p>
</div>
</div>

<div id="outline-container-org62c31da" class="outline-4">
<h4 id="org62c31da"><span class="done DONE">DONE</span> 6.11 Summary</h4>
<div class="outline-text-4" id="text-org62c31da">
<ul class="org-ul">
<li>Exercises

<ul class="org-ul">
<li><p>
6.1  On Mac OS, I can't get it
</p>

<p>
On Linux, use <code>getsnam</code> group functions
</p></li>

<li><p>
6.2
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">shadow.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">spwd</span> *<span style="color: #7590db;">ptr</span>;

    ptr = getspent<span style="color: #bc6ec5;">()</span>;

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"password: %s\n"</span>, ptr-&gt;sp_pwdp<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
6.3
</p>

<div class="org-src-container">
<pre class="src src-c,">#include &lt;stdio.h&gt;
#include &lt;sys/utsname.h&gt;

int main() {
    struct utsname name;
    uname(&amp;name);
    printf("%s %s %s %s %s \n", name.sysname, name.nodename, name.release,
           name.version, name.machine);
}
</pre>
</div></li>

<li><p>
6.4 32-bit time: <code>1970 + (2^{31}/60/60/24/365)</code>
</p>

<p>
after pass : <code>1970 - (2^{31}/60/60/24/365)</code>
</p></li>

<li><p>
6.5
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">time.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span>   <span style="color: #7590db;">tbuf</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">64</span><span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">time_t</span> <span style="color: #7590db;">t</span>;

    time<span style="color: #bc6ec5;">(</span>&amp;t<span style="color: #bc6ec5;">)</span>;

    strftime<span style="color: #bc6ec5;">(</span>tbuf, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>tbuf<span style="color: #2d9574;">)</span>, <span style="color: #2d9574;">"%a %b %d %T %Z %Y"</span>, localtime<span style="color: #2d9574;">(</span>&amp;t<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%s\n"</span>, tbuf<span style="color: #bc6ec5;">)</span>;

    setenv<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"TZ"</span>, <span style="color: #2d9574;">"dkladjlkjklasdj"</span>, <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;
    strftime<span style="color: #bc6ec5;">(</span>tbuf, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>tbuf<span style="color: #2d9574;">)</span>, <span style="color: #2d9574;">"%a %b %d %T %Z %Y"</span>, localtime<span style="color: #2d9574;">(</span>&amp;t<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%s\n"</span>, tbuf<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org171f893" class="outline-3">
<h3 id="org171f893"><span class="done DONE">DONE</span> Chapter 7. Process Environment <code>[11/11]</code></h3>
<div class="outline-text-3" id="text-org171f893">
</div>

<div id="outline-container-orgce16650" class="outline-4">
<h4 id="orgce16650"><span class="done DONE">DONE</span> 7.1 Introduction</h4>
</div>
<div id="outline-container-org0ba5cbd" class="outline-4">
<h4 id="org0ba5cbd"><span class="done DONE">DONE</span> 7.2 main Function</h4>
<div class="outline-text-4" id="text-org0ba5cbd">
<div class="org-src-container">
<pre class="src src-C"><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org32eda32" class="outline-4">
<h4 id="org32eda32"><span class="done DONE">DONE</span> 7.3 Process Termination</h4>
<div class="outline-text-4" id="text-org32eda32">
<p>
There are eight ways for a process to terminate.
Normal termination occurs in five ways:
</p>
<ol class="org-ol">
<li>Return from main</li>
<li>Calling <code>exit</code></li>
<li>Calling <code>_exit</code> or <code>_Exit</code></li>
<li>Return of the last thread from its start routine (Section 11.5)</li>
<li>Calling pthread_exit (Section 11.5) from the last thread</li>
</ol>

<p>
Abnormal termination occurs in three ways
</p>
<ol class="org-ol">
<li>Calling abort</li>
<li>Receipt of a signal</li>
<li>Response of the last thread to a cancellation request</li>
</ol>
</div>

<ul class="org-ul">
<li><a id="org2f1e4ea"></a><span class="done DONE">DONE</span> Exit Functions<br />
<div class="outline-text-5" id="text-org2f1e4ea">
<p>
<code>man 3 exit</code>
<code>man 2 _exit</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">exit</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">status</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">1. call the functions registered with atexit(3) function, in the reverse order of their registration</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">2. Flush all open output streams</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">3. close all open streams</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">4. unlink all files created with the tmpfile functions</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">_Exit</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">status</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">terminates without calling functions registered with atexit(3),</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">may or my not perform the other actions listed</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">_exit</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">status</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">The _exit() function terminates a process, with the following consequences:</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">o   All of the descriptors that were open in the calling process are closed.  This may entail delays; for example, waiting for output to drain.  A process in this state may not be</span>
<span style="color: #2aa1ae; background-color: #292e34;">//     </span><span style="color: #2aa1ae; background-color: #292e34;">killed, as it is already dying.</span>
<span style="color: #2aa1ae; background-color: #292e34;">//</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">o   If the parent process of the calling process has an outstanding wait call or catches the SIGCHLD signal, it is notified of the calling process's termination; the status is set as</span>
<span style="color: #2aa1ae; background-color: #292e34;">//     </span><span style="color: #2aa1ae; background-color: #292e34;">defined by wait(2).</span>
<span style="color: #2aa1ae; background-color: #292e34;">//</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">o   The parent process-ID of all of the calling process's existing child processes are set to 1; the initialization process (see the DEFINITIONS section of intro(2)) inherits each of</span>
<span style="color: #2aa1ae; background-color: #292e34;">//     </span><span style="color: #2aa1ae; background-color: #292e34;">these processes.</span>
<span style="color: #2aa1ae; background-color: #292e34;">//</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">o   If the termination of the process causes any process group to become orphaned (usually because the parents of all members of the group have now exited; see ``orphaned process</span>
<span style="color: #2aa1ae; background-color: #292e34;">//     </span><span style="color: #2aa1ae; background-color: #292e34;">group'' in intro(2)), and if any member of the orphaned group is stopped, the SIGHUP signal and the SIGCONT signal are sent to all members of the newly-orphaned process group.</span>
<span style="color: #2aa1ae; background-color: #292e34;">//</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">o   If the process is a controlling process (see intro(2)), the SIGHUP signal is sent to the foreground process group of the controlling terminal.  All current access to the control-</span>
<span style="color: #2aa1ae; background-color: #292e34;">//     </span><span style="color: #2aa1ae; background-color: #292e34;">ling terminal is revoked.</span>
</pre>
</div>
<p>
<code>_exit</code> does not perform any flushing of standard I/O buffers.
</p>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<pre class="src src-c">
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 33: </span>Figure 7.1 Classic C program</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"hello world\n"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>

<li><a id="org47c6b0a"></a><span class="done DONE">DONE</span> <code>atexit</code> Function<br />
<div class="outline-text-5" id="text-org47c6b0a">
<p>
<code>man 3 atexit</code>
The <code>exit</code> function calls these functions in reverse order of their registration.
</p>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 34: </span>Figure 7.3 Example of exit handlers</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">my_exit1</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">my_exit2</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>atexit<span style="color: #2d9574;">(</span>my_exit2<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"can't register my_exit2: %s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>atexit<span style="color: #2d9574;">(</span>my_exit1<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"can't register my_exit1: %s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>atexit<span style="color: #2d9574;">(</span>my_exit1<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"can't register my_exit1: %s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"main is done\n"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">my_exit1</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"first exit handler \n"</span><span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">my_exit2</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"second exit handler\n"</span><span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>

<li><a id="org068ab35"></a><span class="done DONE">DONE</span> Commond-Line Arguments<br />
<div class="outline-text-5" id="text-org068ab35">
<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 35: </span>Figure 7.4 Echo all command-line arguments to standard output</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">i</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; argc; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">echo all command-line args</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"argv[%d]: %s\n"</span>, i, argv<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>
</ul>
</div>

<div id="outline-container-org0b413f0" class="outline-4">
<h4 id="org0b413f0"><span class="done DONE">DONE</span> 7.5 Environment List</h4>
<div class="outline-text-4" id="text-org0b413f0">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">char</span> **<span style="color: #7590db;">environ</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-orge3849ae" class="outline-4">
<h4 id="orge3849ae"><span class="done DONE">DONE</span> 7.6 Memory Layout of a C Program</h4>
<div class="outline-text-4" id="text-orge3849ae">

<div id="org301749e" class="figure">
<p><img src="Chapter07/07fig06.jpg" alt="07fig06.jpg" />
</p>
</div>

<p>
Historically, a C program has been composed of the following pieces:
</p>

<ul class="org-ul">
<li>Text segment: consisting of the machine instructions that the CPU executes.</li>

<li><p>
Initilized data segment, usually called simply the data segment,
</p>

<p>
containing variables that are specifically initialized in the program.<br />
For example:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">maxcount</span>=<span style="color: #a45bad;">99</span>;
</pre>
</div></li>

<li><p>
Uninitilized data segment, often called the “bss” segment,
</p>

<p>
named after an ancient assembler operator that stood for “block started by symbol.”
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">sum</span><span style="color: #4f97d7;">[</span><span style="color: #a45bad;">1024</span><span style="color: #4f97d7;">]</span>;
</pre>
</div></li>

<li><p>
Stack, where automatic variables are stored,
</p>

<p>
along with information that is saved each time a function is called.
</p></li>

<li><p>
Heap, where dynamic memory allocation usually takes place.
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5; font-weight: bold;">malloc</span><span style="color: #4f97d7;">()</span>;
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org2b6d972" class="outline-4">
<h4 id="org2b6d972"><span class="done DONE">DONE</span> 7.7 Shared Libraries</h4>
<div class="outline-text-4" id="text-org2b6d972">
<p>
without shared libraries
</p>
<div class="org-src-container">
<pre class="src src-bash">gcc -static hello.c
size a.out
text     data     bss     dec     hex   filename
<span style="color: #a45bad;">723103</span>     <span style="color: #a45bad;">7284</span>    <span style="color: #a45bad;">6392</span>  <span style="color: #a45bad;">736779</span>   b3e0b a.out
</pre>
</div>
<p>
use shared libraries, the text and data size are greatly decreased
</p>
<div class="org-src-container">
<pre class="src src-bash">gcc hello.c
size a.out
text     data     bss     dec     hex   filename
<span style="color: #a45bad;">1173</span>      <span style="color: #a45bad;">552</span>       <span style="color: #a45bad;">8</span>    <span style="color: #a45bad;">1733</span>     <span style="color: #a45bad;">6c5</span>   a.out
</pre>
</div>
</div>
</div>

<div id="outline-container-org1100b1b" class="outline-4">
<h4 id="org1100b1b"><span class="done DONE">DONE</span> 7.8 Memory Allocation</h4>
<div class="outline-text-4" id="text-org1100b1b">
<p>
<code>man 3 malloc</code>
</p>
<ol class="org-ol">
<li><code>malloc</code>, allocates specified number of bytes of memory without initialized</li>
<li><code>calloc</code>, allocates specified number of bytes of memroy with initializing to 0</li>
<li><code>realloc</code>, increase or decrease the size of previous allocated area, the increased area was not initialized</li>
</ol>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">malloc</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">size</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">calloc</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">nobj</span>, <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">size</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">realloc</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">ptr</span>, <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">newsize</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">free</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span>*<span style="color: #7590db;">ptr</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>

<ul class="org-ul">
<li>Alternative Memory Allocators

<ul class="org-ul">
<li><p>
<code>jemalloc</code>
</p>

<p>
designed to scale well when used with multithreaded applications running on multiprocessor systems.
</p></li>

<li><p>
<code>TCMalloc</code>
</p>

<p>
for high performance, scalability, and memory efficiency.
</p></li>

<li><p>
<code>alloca</code> Function
</p>

<p>
alloc memmory from stack, instaead of heap, so we don't have to free the space;
</p></li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org6345ffd" class="outline-4">
<h4 id="org6345ffd"><span class="done DONE">DONE</span> 7.9 Environment Variable</h4>
<div class="outline-text-4" id="text-org6345ffd">
<p>
<code>man 3 getenv</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #bc6ec5; font-weight: bold;">getenv</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">putenv</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">str</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">setenv</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">value</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">rewrite</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">unsetenv</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>

<p>
<b>malloc</b>
</p>
</div>
</div>

<div id="outline-container-orge6f8dc1" class="outline-4">
<h4 id="orge6f8dc1"><span class="done DONE">DONE</span> 7.10 <code>setjmp</code> and <code>longjmp</code> Functions</h4>
<div class="outline-text-4" id="text-orge6f8dc1">
<ul class="org-ul">
<li><b>useful for dealing errors and interrupts</b></li>

<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 36: </span>Figure 7.9 Typical program skeleton for command-processing</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">TOK_ADD</span> <span style="color: #a45bad;">5</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">do_line</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span>*<span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">cmd_add</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span>  <span style="color: #bc6ec5; font-weight: bold;">get_token</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">line</span><span style="color: #bc6ec5;">[</span>MAXLINE<span style="color: #bc6ec5;">]</span>;

    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span>fgets<span style="color: #2d9574;">(</span>line, MAXLINE, stdin<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        do_line<span style="color: #2d9574;">(</span>line<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">tok_ptr</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">global pointer for get_token()</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">tok</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">do_line</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">ptr</span><span style="color: #4f97d7;">)</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">process one line of input</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">cmd</span>;

    tok_ptr = ptr;
    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>cmd = get_token<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">switch</span> <span style="color: #2d9574;">(</span>cmd<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">one case for each command</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
            <span style="color: #4f97d7; font-weight: bold;">case</span> TOK_ADD:
                cmd_add<span style="color: #67b11d;">()</span>;
                <span style="color: #4f97d7; font-weight: bold;">break</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">cmd_add</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">token</span>;

    token = get_token<span style="color: #bc6ec5;">()</span>;
    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">reset of processing for this command</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">get_token</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">fetch next token from line pointed to by tok_ptr</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> tok++;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>

<p>
<code>man 3 setjmp</code>
</p>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 37: </span>Figure 7.13 Effect of longjmp on various type of variables</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">setjmp.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">f1</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span>, <span style="color: #ce537a; font-weight: bold;">int</span>, <span style="color: #ce537a; font-weight: bold;">int</span>, <span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">f2</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">jmp_buf</span> <span style="color: #7590db;">jmpbuffer</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span>     <span style="color: #7590db;">globval</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>          <span style="color: #7590db;">autoval</span>;
    <span style="color: #4f97d7; font-weight: bold;">register</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">regival</span>;
    <span style="color: #4f97d7; font-weight: bold;">volatile</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">volaval</span>;
    <span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">statval</span>;

    globval = <span style="color: #a45bad;">1</span>;
    autoval = <span style="color: #a45bad;">2</span>;
    regival = <span style="color: #a45bad;">3</span>;
    volaval = <span style="color: #a45bad;">4</span>;
    statval = <span style="color: #a45bad;">5</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>setjmp<span style="color: #2d9574;">(</span>jmpbuffer<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"after longjmp:\n"</span><span style="color: #2d9574;">)</span>;
        printf<span style="color: #2d9574;">(</span>
            <span style="color: #2d9574;">"globval = %d, autoval = %d, regival = %d,"</span>
            <span style="color: #2d9574;">" volaval = %d, statval = %d\n"</span>,
            globval, autoval, regival, volaval, statval<span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">/*</span>
<span style="color: #2aa1ae; background-color: #292e34;">     * Change variables after setjmp, but before longjmp.</span>
<span style="color: #2aa1ae; background-color: #292e34;">     */</span>
    globval = <span style="color: #a45bad;">95</span>;
    autoval = <span style="color: #a45bad;">96</span>;
    regival = <span style="color: #a45bad;">97</span>;
    volaval = <span style="color: #a45bad;">98</span>;
    statval = <span style="color: #a45bad;">99</span>;

    f1<span style="color: #bc6ec5;">(</span>autoval, regival, volaval, statval<span style="color: #bc6ec5;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">never returns</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">f1</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">i</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">j</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">k</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">l</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"in                     f1():\n"</span><span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span>
        <span style="color: #2d9574;">"globval = %d, autoval = %d, regival = %d,"</span>
        <span style="color: #2d9574;">" volaval = %d, statval = %d\n"</span>,
        globval, i, j, k, l<span style="color: #bc6ec5;">)</span>;
    f2<span style="color: #bc6ec5;">()</span>;
<span style="color: #4f97d7;">}</span>
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">f2</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> longjmp<span style="color: #bc6ec5;">(</span>jmpbuffer, <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
<b>Automatic, Register and Volatile Variables</b>
</p>

<p>
Most implementations do not try to roll back these automatic variables and register variables, but the standards say only that their values are indeterminate
</p></li>
</ul>

<p>
<b>Potential Problem with Automatic Variables</b>
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 38: </span>Figure 7.14 Incorrect usage of an automatic variable</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     incorrect_usage.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-09-19</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Incorrect usage of an automatic variable</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #bc6ec5; font-weight: bold;">open_data</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #7590db;">fp</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>  <span style="color: #7590db;">databuf</span><span style="color: #bc6ec5;">[</span>BUFSIZ<span style="color: #bc6ec5;">]</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">setvbuf makes this the stdio buffer</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fp = fopen<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"datafile"</span>, <span style="color: #2d9574;">"r"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span><span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>setvbuf<span style="color: #2d9574;">(</span>fp, databuf, _IOLBF, BUFSIZ<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">NULL</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> fp;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<blockquote>
<p>
The problem is that when open_data returns, the space it used on the stack will be used by the stack frame for the next function that is called. But the standard I/O library will still be using that portion of memory for its stream buffer. Chaos is sure to result. To correct this problem, the array databuf needs to be allocated from global memory, either statically (static or extern) or dynamically (one of the alloc functions)
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org532778a" class="outline-4">
<h4 id="org532778a"><span class="done DONE">DONE</span> <code>getrlimit</code> and <code>setrlimit</code> Functions</h4>
<div class="outline-text-4" id="text-org532778a">
<p>
<code>man 3 getrlimit</code>
</p>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 39: </span>Figure 7.16 print the current resource limits</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/resource.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #bc6ec5; font-weight: bold;">doit</span><span style="color: #4f97d7;">(</span><span style="color: #7590db;">name</span><span style="color: #4f97d7;">)</span> pr_limits<span style="color: #4f97d7;">(</span>#name, name<span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">pr_limits</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *, <span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[</span>argc<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
<span style="color: #bc6ec5;">#ifdef</span> RLIMIT_AS
    doit<span style="color: #bc6ec5;">(</span>RLIMIT_AS<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>

    doit<span style="color: #bc6ec5;">(</span>RLIMIT_CORE<span style="color: #bc6ec5;">)</span>;
    doit<span style="color: #bc6ec5;">(</span>RLIMIT_CPU<span style="color: #bc6ec5;">)</span>;
    doit<span style="color: #bc6ec5;">(</span>RLIMIT_DATA<span style="color: #bc6ec5;">)</span>;
    doit<span style="color: #bc6ec5;">(</span>RLIMIT_FSIZE<span style="color: #bc6ec5;">)</span>;

<span style="color: #bc6ec5;">#ifdef</span> RLIMIT_MEMLOCK
    doit<span style="color: #bc6ec5;">(</span>RLIMIT_MEMLOCK<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #bc6ec5;">#ifdef</span> RLIMITS_MSGQUEUE
    doit<span style="color: #bc6ec5;">(</span>RLIMITS_MSGQUEUE<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>

    doit<span style="color: #bc6ec5;">(</span>RLIMIT_NOFILE<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">rlimit</span> <span style="color: #7590db;">r</span>;
    memset<span style="color: #bc6ec5;">(</span>&amp;r, <span style="color: #a45bad;">0</span>, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>r<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    getrlimit<span style="color: #bc6ec5;">(</span>RLIMIT_NOFILE, &amp;r<span style="color: #bc6ec5;">)</span>;
    r.rlim_cur = <span style="color: #a45bad;">4096</span>;
    setrlimit<span style="color: #bc6ec5;">(</span>RLIMIT_NOFILE, &amp;r<span style="color: #bc6ec5;">)</span>;

    doit<span style="color: #bc6ec5;">(</span>RLIMIT_NOFILE<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#ifdef</span> RLIMIT_NPTS
    doit<span style="color: #bc6ec5;">(</span>RLIMIT_NPTS<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #bc6ec5;">#ifdef</span> RLIMIT_RSS
    doit<span style="color: #bc6ec5;">(</span>RLIMIT_RSS<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #bc6ec5;">#ifdef</span> RLIMIT_SBSIZE
    doit<span style="color: #bc6ec5;">(</span>RLIMIT_SBSIZE<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #bc6ec5;">#ifdef</span> RLIMIT_SIGPENDING
    doit<span style="color: #bc6ec5;">(</span>RLIMIT_SIGPENDING<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>

    doit<span style="color: #bc6ec5;">(</span>RLIMIT_STACK<span style="color: #bc6ec5;">)</span>;

<span style="color: #bc6ec5;">#ifdef</span> RLIMIT_SWAP
    doit<span style="color: #bc6ec5;">(</span>RLIMIT_SWAP<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #bc6ec5;">#ifdef</span> RLIMIT_VMEM
    doit<span style="color: #bc6ec5;">(</span>RLIMIT_VMEM<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">pr_limits</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">resource</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">rlimit</span>      <span style="color: #7590db;">limit</span>;
    <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">lim</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>getrlimit<span style="color: #2d9574;">(</span>resource, &amp;limit<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"getrlimit error for %s"</span>, name<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%-14s "</span>, name<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>limit.rlim_cur == RLIM_INFINITY<span style="color: #bc6ec5;">)</span>
        printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"(infinite) "</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        lim = limit.rlim_cur;
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%10lld "</span>, lim<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>limit.rlim_max == RLIM_INFINITY<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"(infinite)"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        lim = limit.rlim_max;
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%10lld"</span>, lim<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    putchar<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'\n'</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org4e509ce" class="outline-4">
<h4 id="org4e509ce"><span class="done DONE">DONE</span> Summary</h4>
<div class="outline-text-4" id="text-org4e509ce">
<ul class="org-ul">
<li>Exercises

<ol class="org-ol">
<li>the length of "hello, world"</li>
<li><code>man 3 exit</code></li>
<li>Nope</li>
<li><b>for NULL usage</b></li>
<li><code>typedef void Exitfunc(void);</code> <br />
<code>int atexit(Exitfunc *func);</code></li>
<li>Yep, not sure</li>
<li>the heap and stack aren't allocated before applying</li>
<li>a.out include symbol info</li>
<li>standard I/O library was copied</li>
<li>Nope. num in heap</li>
</ol></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgb02e2f1" class="outline-3">
<h3 id="orgb02e2f1"><span class="done DONE">DONE</span> Chapter 8. Process Control <code>[18/18]</code></h3>
<div class="outline-text-3" id="text-orgb02e2f1">
</div>

<div id="outline-container-orgd43487c" class="outline-4">
<h4 id="orgd43487c"><span class="done DONE">DONE</span> 8.1 Introduction</h4>
</div>
<div id="outline-container-org5927cb9" class="outline-4">
<h4 id="org5927cb9"><span class="done DONE">DONE</span> 8.2 Process Identifiers</h4>
<div class="outline-text-4" id="text-org5927cb9">
<p>
Process ID 0 is usually the scheduler process and is often know as <i>swapper</i>.
Process ID 1 is usually the <b>init</b> process.
responsible for bring up a UNIX system after the kernel has been bootstrapped
Process ID 2 is pagedaemon.
responsible for supporting paging of virtual memory system.
</p>

<p>
<code>man 2 getpid</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span> pid_t getpid<span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: process ID of calling process</span>

<span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #bc6ec5; font-weight: bold;">getppid</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: parent process ID of calling process</span>

<span style="color: #ce537a; font-weight: bold;">uid_t</span> <span style="color: #bc6ec5; font-weight: bold;">getuid</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: real user ID of calling process</span>

<span style="color: #ce537a; font-weight: bold;">uid_t</span> <span style="color: #bc6ec5; font-weight: bold;">geteuid</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: effective user ID of calling process</span>

<span style="color: #ce537a; font-weight: bold;">gid_t</span> <span style="color: #bc6ec5; font-weight: bold;">getgid</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: real group ID of calling process</span>

<span style="color: #ce537a; font-weight: bold;">gid_t</span> <span style="color: #bc6ec5; font-weight: bold;">getegid</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: effective group ID of calling process</span>
</pre>
</div>

<blockquote>
<p>
Note that none of these functions has an error return.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-orgd81e9a7" class="outline-4">
<h4 id="orgd81e9a7"><span class="done DONE">DONE</span> 8.3 <code>fork</code> Function</h4>
<div class="outline-text-4" id="text-orgd81e9a7">
<p>
<code>man 3 fork</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #bc6ec5; font-weight: bold;">fork</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 in child, process ID of child in parent, &#8722;1 on error</span>
</pre>
</div>

<blockquote>
<p>
called once but return twice.
</p>

<p>
return value in child is 0, whereas the return value in the parent is the process ID of the new child
</p>

<p>
the child gets a copy of the parent’s data space, heap, and stack, parents and child do not share memmory
</p>
</blockquote>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 40: </span>Figure 8.1 Example of fork function</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span>  <span style="color: #7590db;">globvar</span> = <span style="color: #a45bad;">6</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">external variable in initialized data</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">buf</span><span style="color: #4f97d7;">[]</span>   = <span style="color: #2d9574;">"a write to stdout\n"</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">var</span>;
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;

    var = <span style="color: #a45bad;">88</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>write<span style="color: #2d9574;">(</span>STDOUT_FILENO, buf, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span>buf<span style="color: #67b11d;">)</span> - <span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span> != <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>buf<span style="color: #2d9574;">)</span> - <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"write error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"before fork\n"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        globvar++; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">child</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        var++;     <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">modify variables</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        sleep<span style="color: #2d9574;">(</span><span style="color: #a45bad;">2</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"pid = %ld, glob = %d, var = %d\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>getpid<span style="color: #2d9574;">()</span>, globvar, var<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
<p>
<b>changes to variables in a child process do not affect the value of the variables in the parent process.</b>
</p>

<ul class="org-ul">
<li><p>
File Sharing
</p>

<p>
handling the descriptors after a fork.
</p>
<ol class="org-ol">
<li>The parent waits for the child to complete.</li>
<li>Both the parent and the child go their own ways. after fork, close needless descriptors(<b>socket</b>)</li>
</ol></li>

<li>inherits:

<ul class="org-ul">
<li>Real user ID, real group ID, effective user ID, and effective group ID</li>

<li>Supplementary group IDs</li>

<li>Process group ID</li>

<li>Session ID</li>

<li>Controlling terminal</li>

<li>The set-user-ID and set-group-ID flags</li>

<li>Current working directory</li>

<li>Root directory</li>

<li>File mode creation mask</li>

<li>Signal mask and dispositions</li>

<li>The close-on-exec flag for any open file descriptors</li>

<li>Environment</li>

<li>Attached shared memory segments</li>

<li>Memory mappings</li>

<li>Resource limits</li>
</ul></li>

<li>differences

<ul class="org-ul">
<li>return value</li>

<li>process id</li>

<li>parent id</li>

<li>child's tms_utime, tms_stime, tms_cutime, tms_cstime set to 0</li>

<li>parent's file locks are not inherited</li>

<li>pending alarms are cleared for the child</li>

<li>pending signals set is set to empty for child</li>
</ul></li>

<li><p>
There are two uses for fork:
</p>

<blockquote>
<ol class="org-ol">
<li>When a process wants to duplicate itself so that the parent and the child can each execute different sections of code at the same time.</li>
<li>When a process wants to execute a different program.</li>
</ol>
</blockquote></li>
</ul>
</div>
</div>

<div id="outline-container-orgc5d3e4e" class="outline-4">
<h4 id="orgc5d3e4e"><span class="done DONE">DONE</span> 8.4 <code>vfork</code> Function</h4>
<div class="outline-text-4" id="text-orgc5d3e4e">
<blockquote>
<p>
just like fork, without copying the address space of the parent into the child, as the child won’t reference that address space
</p>

<p>
the child runs in the address space of the parent until it calls either exec or exit.
</p>

<p>
<b>vfork guarantees that the child runs first, until the child calls exec or exit.</b>
</p>
</blockquote>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 41: </span>Figure 8.3 Example of vfork function</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">globvar</span> = <span style="color: #a45bad;">6</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">external variable in initialized data</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">var</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">automatic variable on the stack</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;

    var = <span style="color: #a45bad;">88</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"before vfork\n"</span><span style="color: #bc6ec5;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">we don't flush stdio</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = vfork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"vfork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">child</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        globvar++;         <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">modify parent's variables</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        var++;
        exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">child terminaltes</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">parent continues here</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"pid = %ld, glob = %d, var = %d\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>getpid<span style="color: #2d9574;">()</span>, globvar, var<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org5503d40" class="outline-4">
<h4 id="org5503d40"><span class="done DONE">DONE</span> 8.5 <code>exit</code> Function</h4>
<div class="outline-text-4" id="text-org5503d40">
<blockquote>
<p>
As we described in Section 7.3, a process can terminate normally in five ways:
</p>
<ol class="org-ol">
<li>Executing a return from the main function.</li>
<li>Calling the exit function.</li>
<li>Calling the _exit or _Exit function. <b>terminate without running exit handlers or signal handlers.</b></li>
<li>Executing a return from the start routine of the last thread in the process.</li>
<li>Calling the pthread_exit function from the last thread in the process.</li>
</ol>
</blockquote>

<blockquote>
<p>
The three forms of abnormal termination are as follows:
</p>
<ol class="org-ol">
<li>Calling abort. generates <b>SIGABRT</b> signal</li>
<li>When the process receives certain signals.</li>
<li>The last thread responds to a cancellation request.</li>
</ol>
</blockquote>

<blockquote>
<p>

</p>

<ul class="org-ul">
<li>In UNIX System terminology, a process that has terminated, but whose parent has not yet waited for it, is called a zombie.</li>

<li>The ps(1) command prints the state of a zombie process as Z.</li>
</ul>
</blockquote>
</div>
</div>

<div id="outline-container-org675aa9f" class="outline-4">
<h4 id="org675aa9f"><span class="done DONE">DONE</span> 8.6 <code>wait</code> and <code>waitpid</code> Functions</h4>
<div class="outline-text-4" id="text-org675aa9f">
<blockquote>
<p>
we need to be aware that a process that calls wait or waitpid can
</p>

<ul class="org-ul">
<li>Block, if all of its children are still running</li>

<li>Return immediately with the termination status of a child, if a child has terminated and is waiting for its termination for its termination status to be fetched</li>

<li>Return immediately with an error, if it doesn't have any child processes</li>
</ul>
</blockquote>

<p>
<code>man 2 wait</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #bc6ec5; font-weight: bold;">wait</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> *<span style="color: #7590db;">statloc</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #bc6ec5; font-weight: bold;">waitpid</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>, <span style="color: #ce537a; font-weight: bold;">int</span> *<span style="color: #7590db;">statloc</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">options</span><span style="color: #4f97d7;">)</span>;

Both <span style="color: #4f97d7; font-weight: bold;">return</span>: process ID <span style="color: #4f97d7; font-weight: bold;">if</span> OK, <span style="color: #a45bad;">0</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">see</span> <span style="color: #7590db;">later</span><span style="color: #4f97d7;">)</span>, or -<span style="color: #a45bad;">1</span> on error
</pre>
</div>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 42: </span>Figure 8.5 Print a description of the exit status</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">pr_exit</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">status</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>WIFEXITED<span style="color: #2d9574;">(</span>status<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
        printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"normal termination, exit status = %d\n"</span>, WEXITSTATUS<span style="color: #2d9574;">(</span>status<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>WIFSIGNALED<span style="color: #2d9574;">(</span>status<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
        printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"abnormal termination, signal number = %d%s\n"</span>, WTERMSIG<span style="color: #2d9574;">(</span>status<span style="color: #2d9574;">)</span>,
<span style="color: #bc6ec5;">#ifdef</span> WCOREDUMP
               WCOREDUMP<span style="color: #2d9574;">(</span>status<span style="color: #2d9574;">)</span> ? <span style="color: #2d9574;">" (core file generated)"</span> : <span style="color: #2d9574;">""</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
               <span style="color: #2d9574;">""</span><span style="color: #e0211d; text-decoration: overline;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">(</span>WIFSTOPPED<span style="color: #bc6ec5;">(</span>status<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
        printf<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"child stopped, signal number = %d\n"</span>, WSTOPSIG<span style="color: #bc6ec5;">(</span>status<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>;
<span style="color: #e0211d; text-decoration: overline;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 43: </span>Figure 8.6 Demonstrate various exit status</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">status</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">child</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">7</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>wait<span style="color: #2d9574;">(</span>&amp;status<span style="color: #2d9574;">)</span> != pid<span style="color: #bc6ec5;">)</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">wait for child</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"wait error"</span><span style="color: #bc6ec5;">)</span>;
    pr_exit<span style="color: #bc6ec5;">(</span>status<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        abort<span style="color: #bc6ec5;">()</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>wait<span style="color: #2d9574;">(</span>&amp;status<span style="color: #2d9574;">)</span> != pid<span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"wait error"</span><span style="color: #bc6ec5;">)</span>;
    pr_exit<span style="color: #bc6ec5;">(</span>status<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        status /= <span style="color: #a45bad;">0</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>wait<span style="color: #2d9574;">(</span>&amp;status<span style="color: #2d9574;">)</span> != pid<span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"wait error"</span><span style="color: #bc6ec5;">)</span>;
    pr_exit<span style="color: #bc6ec5;">(</span>status<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>

<blockquote>
<p>
The waitpid function provides three features that aren’t provided by the wait function.
</p>
<ol class="org-ol">
<li>The waitpid function lets us wait for one particular process, whereas the wait function returns the status of any terminated child.</li>
<li>The waitpid function provides a nonblocking version of wait.</li>
<li>The waitpid function provides support for job control with the WUNTRACED and WCONTINUED options.</li>
</ol>
</blockquote>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 44: </span>Figure 8.8 Avoid zombie processes by calling fork twice</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">first child</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>pid = fork<span style="color: #b1951d;">()</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>pid &gt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>
            exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">parent from second fork == first child</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>

        <span style="color: #2aa1ae; background-color: #292e34;">/*</span>
<span style="color: #2aa1ae; background-color: #292e34;">         * We're the second child; our parent becomes init as soon as</span>
<span style="color: #2aa1ae; background-color: #292e34;">         * our real parent calls exit() in the statement above.</span>
<span style="color: #2aa1ae; background-color: #292e34;">         * Here's where we'd continue executing, knowing that when we're done,</span>
<span style="color: #2aa1ae; background-color: #292e34;">         * init will reap our status.</span>
<span style="color: #2aa1ae; background-color: #292e34;">         */</span>
        sleep<span style="color: #2d9574;">(</span><span style="color: #a45bad;">2</span><span style="color: #2d9574;">)</span>;
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"second child, parent pid = %ld\n"</span>, <span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #67b11d;">)</span>getppid<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>waitpid<span style="color: #2d9574;">(</span>pid, <span style="color: #a45bad;">NULL</span>, <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> != pid<span style="color: #bc6ec5;">)</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">wait for first child</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"waitpid error"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #2aa1ae; background-color: #292e34;">/*</span>
<span style="color: #2aa1ae; background-color: #292e34;">     * We're the parent (the original process); we continue executing,</span>
<span style="color: #2aa1ae; background-color: #292e34;">     * knowing that we're not the parent of the second child</span>
<span style="color: #2aa1ae; background-color: #292e34;">     */</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-orga2f6b02" class="outline-4">
<h4 id="orga2f6b02"><span class="done DONE">DONE</span> 8.7 <code>waitid</code> Function</h4>
<div class="outline-text-4" id="text-orga2f6b02">
<p>
<code>man 2 waitid</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #4f97d7;">&gt;</span> <span style="color: #ce537a; font-weight: bold;">int</span> waitid<span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">idtype_t</span> <span style="color: #7590db;">idtype</span>, <span style="color: #ce537a; font-weight: bold;">id_t</span> <span style="color: #7590db;">id</span>, <span style="color: #ce537a; font-weight: bold;">siginfo_t</span> *<span style="color: #7590db;">infop</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">options</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, &#8722;1 on error</span>
</pre>
</div>
<p>
(OS X can't get the info, but the function is valid)
</p>
</div>
</div>

<div id="outline-container-orgef17a7b" class="outline-4">
<h4 id="orgef17a7b"><span class="done DONE">DONE</span> 8.8 <code>wait3</code> and <code>wait4</code> Functions</h4>
<div class="outline-text-4" id="text-orgef17a7b">
<p>
<code>man 2 wait3</code>
</p>
</div>
</div>

<div id="outline-container-org506858a" class="outline-4">
<h4 id="org506858a"><span class="done DONE">DONE</span> 8.9 Race Conditions</h4>
<div class="outline-text-4" id="text-org506858a">
<p>
<b>Avoid race by signal</b>
</p>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 45: </span>Figure 8.12 Program with a race condition</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">charatatime</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork_ error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        charatatime<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"output from child\n"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        charatatime<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"output from parent\n"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">charatatime</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">str</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">ptr</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">c</span>;

    setbuf<span style="color: #bc6ec5;">(</span>stdout, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">set unbuffered</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>ptr = str; <span style="color: #2d9574;">(</span>c = *ptr++<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span>;<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">usleep(100);</span>
        putc<span style="color: #2d9574;">(</span>c, stdout<span style="color: #2d9574;">)</span>;
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">putchar(c);</span>
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 46: </span>Figure 8.13 Modification of Figure 8.12 to avoid race condition</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">charatatime</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;

    TELL_WAIT<span style="color: #bc6ec5;">()</span>;

<span style="color: #bc6ec5;">#if</span> <span style="color: #a45bad;">1</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        WAIT_PARENT<span style="color: #2d9574;">()</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">parent goes first</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        charatatime<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"output from child\n"</span><span style="color: #2d9574;">)</span>;
        TELL_PARENT<span style="color: #2d9574;">(</span>getppid<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        charatatime<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"output from parent\n"</span><span style="color: #2d9574;">)</span>;
        TELL_CHILD<span style="color: #2d9574;">(</span>pid<span style="color: #2d9574;">)</span>;
        WAIT_CHILD<span style="color: #2d9574;">()</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #bc6ec5;">#else</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        charatatime<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"output from child\n"</span><span style="color: #2d9574;">)</span>;
        TELL_PARENT<span style="color: #2d9574;">(</span>getppid<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        WAIT_CHILD<span style="color: #2d9574;">()</span>;
        charatatime<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"output from parent\n"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #bc6ec5;">#endif</span>

    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">charatatime</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">str</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">ptr</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">c</span>;

    setbuf<span style="color: #bc6ec5;">(</span>stdout, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">set unbuffered</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>ptr = str; <span style="color: #2d9574;">(</span>c = *ptr++<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span>;<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        usleep<span style="color: #2d9574;">(</span><span style="color: #a45bad;">100</span><span style="color: #2d9574;">)</span>;
        putc<span style="color: #2d9574;">(</span>c, stdout<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-orgacf2e88" class="outline-4">
<h4 id="orgacf2e88"><span class="done DONE">DONE</span> 8.10 <code>exec</code> Functions</h4>
<div class="outline-text-4" id="text-orgacf2e88">
<p>
<code>man 3 exec</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">execl</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">pathname</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">arg0</span>, ... <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">(char *)0</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span> <span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">execv</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">pathname</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">execle</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">pathname</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">arg0</span>, ...
           <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">(char *)0, char *const envp[]</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span> <span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">execve</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">pathname</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #7590db;">envp</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">execlp</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">filename</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">arg0</span>, ... <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">(char *)0</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span> <span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">execvp</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">filename</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">fexecve</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #7590db;">envp</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
<p>
Returns: All seven return: −1 on error, no return on success
</p>

<blockquote>
<p>
The first difference in these functions is that the first four take a pathname argument, the next two take a filename argument, and the last one takes a file descriptor argument. When a filename argument is specified,
</p>

<ul class="org-ul">
<li>If filename contains a slash, it is taken as a pathname.</li>

<li>Otherwise, the executable file is searched for in the directories specified by the <b>PATH</b> environment variable.</li>
</ul>
</blockquote>

<p>
<code>execlp</code> and <code>execvp</code> assume <b>link</b> as a <b>shell script</b>, and try to invoke <code>/bin/sh</code> with <b>filename</b>
</p>

<blockquote>
<p>
The letter <b>p</b> means that the function takes a filename argument and uses the PATH environment variable to find the executable file
The letter <b>l</b> means that the function takes a list of arguments and is mutually exclusive
The letter <b>v</b>, means that it takes an argv[] vector.
Finally, the letter <b>e</b> means that the function takes an envp[] array instead of using the current environment.
</p>
</blockquote>


<div id="org9cff3a9" class="figure">
<p><img src="Chapter08/08fig14.jpg" alt="08fig14.jpg" />
</p>
<p><span class="figure-number">Figure 13: </span>Figure 8.14 Differences among the seven exec functions</p>
</div>


<div id="org3543530" class="figure">
<p><img src="Chapter08/08fig15.jpg" alt="08fig15.jpg" />
</p>
<p><span class="figure-number">Figure 14: </span>Figure 8.15 Relationship of the seven exec functions</p>
</div>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 47: </span>Figure 8.16 Example of exec functions</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">env_init</span><span style="color: #4f97d7;">[]</span> = <span style="color: #4f97d7;">{</span><span style="color: #2d9574;">"USER=unknown"</span>, <span style="color: #2d9574;">"PATH=/tmp"</span>, <span style="color: #a45bad;">NULL</span><span style="color: #4f97d7;">}</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">specify pathname, specify environment</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>execle<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"echo"</span>, <span style="color: #2d9574;">"echoall"</span>, <span style="color: #2d9574;">"myarg1"</span>, <span style="color: #2d9574;">"MY ARG2"</span>, <span style="color: #b1951d;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #b1951d;">)</span><span style="color: #a45bad;">0</span>,
                   env_init<span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"execle error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>waitpid<span style="color: #2d9574;">(</span>pid, <span style="color: #a45bad;">NULL</span>, <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"wait error"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">specify filename, inherit environment</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>execlp<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"echo"</span>, <span style="color: #2d9574;">"echoall"</span>, <span style="color: #2d9574;">"only 1 arg"</span>, <span style="color: #b1951d;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #b1951d;">)</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>
            err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"execlp error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 48: </span>Figure 8.17 Echo all command-line arguments and all environment strings</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[</span>argc<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>           <span style="color: #7590db;">i</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> **       <span style="color: #7590db;">ptr</span>;
    <span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">char</span> **<span style="color: #7590db;">environ</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; argc; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">"echo all command-line args"</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"argv[%d]: %s\n"</span>, i, argv<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>ptr = environ; *ptr != <span style="color: #a45bad;">0</span>; ++ptr<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s\n"</span>, *ptr<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-orgf60ab30" class="outline-4">
<h4 id="orgf60ab30"><span class="done DONE">DONE</span> 8.11 Changing User IDs and Group IDs</h4>
<div class="outline-text-4" id="text-orgf60ab30">
<p>
<code>man 2 setuid</code>
</p>
<blockquote>
<ol class="org-ol">
<li>If the process has superuser privileges, the setuid function sets the real user ID, effective user ID, and saved set-user-ID to uid.</li>

<li>If the process does not have superuser privileges, but uid equals either the real user ID or the saved set-user-ID, setuid sets only the effective user ID to uid. The real user ID and the saved set-user-ID are not changed.</li>

<li>If neither of these two conditions is true, errno is set to EPERM and −1 is returned.</li>
</ol>
</blockquote>
<p>
<img src="Chapter08/08fig18.jpg" alt="08fig18.jpg" />
<code>man 2 setreuid</code>
<code>man 2 setregid</code>
</p>
</div>
</div>

<div id="outline-container-orgaa9f752" class="outline-4">
<h4 id="orgaa9f752"><span class="done DONE">DONE</span> 8.12 Interpreter Files</h4>
<div class="outline-text-4" id="text-orgaa9f752">
<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 49: </span>Figure 8.20 A program that execs an interpreter file</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>execlp<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"systype.sh"</span>, <span style="color: #a45bad;">NULL</span>, <span style="color: #a45bad;">NULL</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"execl error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>waitpid<span style="color: #2d9574;">(</span>pid, <span style="color: #a45bad;">NULL</span>, <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"waitpid error"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 50: </span>Figure 8.21 An awk program as an interpreter file</label><pre class="src src-c">#<span style="color: #a45bad;">!</span>/usr/bin/awk -f
<span style="color: #bc6ec5;"># Note</span>: On Solaris, use <span style="color: #ce537a; font-weight: bold;">nawk</span> <span style="color: #7590db;">instead</span>

BEGIN <span style="color: #4f97d7;">{</span>
  <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; ARGC; i ++<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
    printf <span style="color: #2d9574;">"ARGV[%d] = %s\n"</span>, i, ARGV<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>
  <span style="color: #bc6ec5;">}</span>
  exit
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org215e1bb" class="outline-4">
<h4 id="org215e1bb"><span class="done DONE">DONE</span> 8.13 <code>system</code> Function</h4>
<div class="outline-text-4" id="text-org215e1bb">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">system</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">cmdstring</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
<p>
*if <i>cmdstring</i> is a <code>NULL</code>, <code>system</code> returns nonzero only if a command processor is available.
</p>
<blockquote>
<ol class="org-ol">
<li>If either the fork fails or waitpid returns an error other than EINTR, system returns −1 with errno set to indicate the error.</li>

<li>If the exec fails, implying that the shell can’t be executed, the return value is as if the shell had executed exit(127).</li>

<li>Otherwise, all three functions—fork, exec, and waitpid—succeed, and the return value from system is the termination status of the shell, in the format specified for waitpid.</li>
</ol>
</blockquote>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 51: </span>Figure 8.22 The system function, without signal handling</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">version without signal handling</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">system</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">cmdstring</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">status</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>cmdstring == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">1</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">always a command processor with UNIX</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        status = -<span style="color: #a45bad;">1</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        execl<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"/bin/sh"</span>, <span style="color: #2d9574;">"shell1"</span>, <span style="color: #2d9574;">"-c"</span>, cmdstring, <span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #67b11d;">)</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>;
        _exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">27</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #2d9574;">(</span>waitpid<span style="color: #67b11d;">(</span>pid, &amp;status, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>errno != EINTR<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                status = -<span style="color: #a45bad;">1</span>;
                <span style="color: #4f97d7; font-weight: bold;">break</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> status;
<span style="color: #4f97d7;">}</span>

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">calling system function</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">status</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>status = system<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"date"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"system() error"</span><span style="color: #bc6ec5;">)</span>;

    pr_exit<span style="color: #bc6ec5;">(</span>status<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>status = system<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"nosuchcommand"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"system() error"</span><span style="color: #bc6ec5;">)</span>;
    pr_exit<span style="color: #bc6ec5;">(</span>status<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>status = system<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"who; exit 44"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"system() error"</span><span style="color: #bc6ec5;">)</span>;
    pr_exit<span style="color: #bc6ec5;">(</span>status<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 52: </span>Figure 8.23 Calling the system function</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">version without signal handling</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">system</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">cmdstring</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">status</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>cmdstring == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">1</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">always a command processor with UNIX</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        status = -<span style="color: #a45bad;">1</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        execl<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"/bin/sh"</span>, <span style="color: #2d9574;">"shell1"</span>, <span style="color: #2d9574;">"-c"</span>, cmdstring, <span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #67b11d;">)</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>;
        _exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">27</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #2d9574;">(</span>waitpid<span style="color: #67b11d;">(</span>pid, &amp;status, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>errno != EINTR<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                status = -<span style="color: #a45bad;">1</span>;
                <span style="color: #4f97d7; font-weight: bold;">break</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> status;
<span style="color: #4f97d7;">}</span>

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">calling system function</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">status</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>status = system<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"date"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"system() error"</span><span style="color: #bc6ec5;">)</span>;

    pr_exit<span style="color: #bc6ec5;">(</span>status<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>status = system<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"nosuchcommand"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"system() error"</span><span style="color: #bc6ec5;">)</span>;
    pr_exit<span style="color: #bc6ec5;">(</span>status<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>status = system<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"who; exit 44"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"system() error"</span><span style="color: #bc6ec5;">)</span>;
    pr_exit<span style="color: #bc6ec5;">(</span>status<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>

<blockquote>
<p>
The advantage in using system, instead of using fork and exec directly, is that system does all the required error handling and (in our next version of this function in Section 10.18) all the required signal handling.
</p>
</blockquote>

<p>
<b>Set-User-ID Programs</b>
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 53: </span>Figure 8.24 Execute the command-line argument using system</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[</span>argc<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">status</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc &lt; <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span> err_quit<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"command-line argument required"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>status = system<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"system() error"</span><span style="color: #bc6ec5;">)</span>;
    pr_exit<span style="color: #bc6ec5;">(</span>status<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 54: </span>Figure 8.25 Print real and effective user IDs</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[</span>argc<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"real uid = %d, effective uid = %d\n"</span>, getuid<span style="color: #2d9574;">()</span>, geteuid<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org7491235" class="outline-4">
<h4 id="org7491235"><span class="done DONE">DONE</span> 8.14 Process Accounting</h4>
<div class="outline-text-4" id="text-org7491235">
<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 55: </span>Figure 8.28 Program to generate accounting data</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        sleep<span style="color: #2d9574;">(</span><span style="color: #a45bad;">2</span><span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">2</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        sleep<span style="color: #2d9574;">(</span><span style="color: #a45bad;">4</span><span style="color: #2d9574;">)</span>;
        abort<span style="color: #2d9574;">()</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        execl<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"/bin/dd"</span>, <span style="color: #2d9574;">"dd"</span>, <span style="color: #2d9574;">"if=/etc/passwd"</span>, <span style="color: #2d9574;">"of=/dev/null"</span>, <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">7</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        sleep<span style="color: #2d9574;">(</span><span style="color: #a45bad;">8</span><span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    sleep<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">6</span><span style="color: #bc6ec5;">)</span>;
    kill<span style="color: #bc6ec5;">(</span>getpid<span style="color: #2d9574;">()</span>, SIGKILL<span style="color: #bc6ec5;">)</span>;
    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">6</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 56: </span>Figure 8.29 Print select fields from system's accounting file</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">ctype.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/acct.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/types.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>BSD<span style="color: #4f97d7;">)</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">different structure in FreeBSD</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">acct</span>    acctv2
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">ac_flag</span> ac_trailer.ac_flag
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">FMT</span>     <span style="color: #2d9574;">"%-*.*s e = %.0f, chars = %.0f, %c %c %c %c\n"</span>
<span style="color: #bc6ec5;">#elif</span> <span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>HAS_AC_STAT<span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">FMT</span> <span style="color: #2d9574;">"%-*.*s e = %6ld, chars = %7ld, stat = %3u: %c %c %c %c\n"</span>
<span style="color: #bc6ec5;">#else</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">FMT</span> <span style="color: #2d9574;">"%-*.*s e = %6ld, chars = %7ld, %c %c %c %c\n"</span>
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>LINUX<span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">acct</span> acct_v3 <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">different structure in Linux</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #bc6ec5;">#if</span> <span style="color: #a45bad;">!</span><span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>ACORE<span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">ACORE</span> <span style="color: #a45bad;">0</span>
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #bc6ec5;">#if</span> <span style="color: #a45bad;">!</span><span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>AXSIG<span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">AXSIG</span> <span style="color: #a45bad;">0</span>
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #bc6ec5;">#if</span> <span style="color: #a45bad;">!</span><span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>BSD<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #bc6ec5; font-weight: bold;">compt2ulong</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">comp_t</span> <span style="color: #7590db;">comptime</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">convert comp_t to unsigned long</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">val</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>           <span style="color: #7590db;">exp</span>;

    val = comptime &amp; <span style="color: #a45bad;">0x1fff</span>;    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">13-bit fraction</span><span style="color: #2aa1ae; background-color: #292e34;">  */</span>
    exp = <span style="color: #bc6ec5;">(</span>comptime &gt;&gt; <span style="color: #a45bad;">13</span><span style="color: #bc6ec5;">)</span> &amp; <span style="color: #a45bad;">7</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">3-bit exponent(0-7)</span><span style="color: #2aa1ae; background-color: #292e34;">  */</span>
    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span>exp-- &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> val *= <span style="color: #a45bad;">8</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> val;
<span style="color: #4f97d7;">}</span>
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[</span>argc<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">acct</span> <span style="color: #7590db;">acdata</span>;
    <span style="color: #ce537a; font-weight: bold;">FILE</span> *      <span style="color: #7590db;">fp</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc != <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span> err_quit<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"usage pracct filename"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fp = fopen<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span>, <span style="color: #2d9574;">"r"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"can't open %s"</span>, argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span>fread<span style="color: #2d9574;">(</span>&amp;acdata, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span>acdata<span style="color: #67b11d;">)</span>, <span style="color: #a45bad;">1</span>, fp<span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span>FMT, <span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #67b11d;">)</span><span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span>acdata.ac_comm<span style="color: #67b11d;">)</span>, acdata.ac_comm,
<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #67b11d;">(</span>BSD<span style="color: #67b11d;">)</span>
               acdata.ac_etime, acdata.ac_io,
<span style="color: #bc6ec5;">#else</span>
               compt2ulong<span style="color: #67b11d;">(</span>acdata.ac_etime<span style="color: #67b11d;">)</span>, compt2ulong<span style="color: #67b11d;">(</span>acdata.ac_io<span style="color: #67b11d;">)</span>,
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #67b11d;">(</span>HAS_AC_STAT<span style="color: #67b11d;">)</span>
               <span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">char</span><span style="color: #67b11d;">)</span>acdata.ac_stat,
<span style="color: #bc6ec5;">#endif</span>
               acdata.ac_flag &amp; ACORE ? <span style="color: #2d9574;">'D'</span> : <span style="color: #2d9574;">' '</span>,
               acdata.ac_flag &amp; AXSIG ? <span style="color: #2d9574;">'X'</span> : <span style="color: #2d9574;">' '</span>,
               acdata.ac_flag &amp; AFORK ? <span style="color: #2d9574;">'F'</span> : <span style="color: #2d9574;">' '</span>,
               acdata.ac_flag &amp; ASU ? <span style="color: #2d9574;">'S'</span> : <span style="color: #2d9574;">' '</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org9eedd88" class="outline-4">
<h4 id="org9eedd88"><span class="done DONE">DONE</span> 8.15 User Identification</h4>
<div class="outline-text-4" id="text-org9eedd88">
<p>
<code>man 2 getlogin</code>
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 57: </span>getlogin</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span> printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%s\n"</span>, getlogin<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge609e41" class="outline-4">
<h4 id="orge609e41"><span class="done DONE">DONE</span> 8.16 Process Scheduling</h4>
<div class="outline-text-4" id="text-orge609e41">
<p>
Lower nice values have higher scheduling priority.
</p>

<p>
<code>man 3 nice</code>
<code>man 3 getpriority</code>
</p>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 58: </span>Figure 8.30 Evaluate the effect of changing the nice value</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/time.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>__APPLE__<span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/syslimits.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#elif</span> <span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>SOLARIS<span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">limits.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#elif</span> <span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>BSD<span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/param.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">count</span>;
<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timeval</span>     <span style="color: #7590db;">end</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">checktime</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">str</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timeval</span> <span style="color: #7590db;">tv</span>;

    gettimeofday<span style="color: #bc6ec5;">(</span>&amp;tv, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>tv.tv_sec &gt;= end.tv_sec &amp;&amp; tv.tv_usec &gt;= end.tv_usec<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s count = %lld\n"</span>, str, count<span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">s</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">nzero</span>, <span style="color: #7590db;">ret</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">adj</span> = <span style="color: #a45bad;">0</span>;

    setbuf<span style="color: #bc6ec5;">(</span>stdout, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #bc6ec5;">(</span>NZERO<span style="color: #bc6ec5;">)</span>
    nzero = NZERO;
<span style="color: #bc6ec5;">#elif</span> <span style="color: #bc6ec5;">defined</span><span style="color: #bc6ec5;">(</span>_SC_NZERO<span style="color: #bc6ec5;">)</span>
    nzero = sysconf<span style="color: #bc6ec5;">(</span>_SC_NZERO<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
<span style="color: #bc6ec5;">#error</span> <span style="color: #2d9574;">NZERO undefined</span>
<span style="color: #bc6ec5;">#endif</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"NZERO = %d\n"</span>, nzero<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc == <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span> adj = strtol<span style="color: #bc6ec5;">(</span>argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>, <span style="color: #a45bad;">NULL</span>, <span style="color: #a45bad;">10</span><span style="color: #bc6ec5;">)</span>;
    gettimeofday<span style="color: #bc6ec5;">(</span>&amp;end, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    end.tv_sec += <span style="color: #a45bad;">10</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">run for 10 seconds</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork failed"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">child</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        s = <span style="color: #2d9574;">"child"</span>;
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"current nice value in child is %d adjusting by %d\n"</span>,
               nice<span style="color: #67b11d;">(</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> + nzero, adj<span style="color: #2d9574;">)</span>;
        errno = <span style="color: #a45bad;">0</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>ret = nice<span style="color: #b1951d;">(</span>adj<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> == -<span style="color: #a45bad;">1</span> &amp;&amp; errno != <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"child set scheduling priority"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"now child nice value is %d\n"</span>, ret + nzero<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">parent</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        s = <span style="color: #2d9574;">"parent"</span>;
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"current nice value in parent is %d\n"</span>, nice<span style="color: #67b11d;">(</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> + nzero<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>;;<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>++count == <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_quit<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"%s counter wrap"</span>, s<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        checktime<span style="color: #2d9574;">(</span>s<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org078da78" class="outline-4">
<h4 id="org078da78"><span class="done DONE">DONE</span> 8.17 Process Times</h4>
<div class="outline-text-4" id="text-org078da78">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/times.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">clock_t</span> <span style="color: #bc6ec5; font-weight: bold;">times</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">tms</span> *<span style="color: #7590db;">buf</span><span style="color: #4f97d7;">)</span>;

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: elapsed wall clock time in clock ticks if OK, -1 on error</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 59: </span>Figure 8.31 Time and execute all command-line arguments</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/times.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">pr_times</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">clock_t</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">tms</span> *, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">tms</span> *<span style="color: #4f97d7;">)</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">do_cmd</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">i</span>;
    setbuf<span style="color: #bc6ec5;">(</span>stdout, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">1</span>; i &lt; argc; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        do_cmd<span style="color: #2d9574;">(</span>argv<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">do_cmd</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">cmd</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">tms</span> <span style="color: #7590db;">tmsstart</span>, <span style="color: #7590db;">tmsend</span>;
    <span style="color: #ce537a; font-weight: bold;">clock_t</span>    <span style="color: #7590db;">start</span>, <span style="color: #7590db;">end</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>        <span style="color: #7590db;">status</span>;

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\ncommand: %s\n"</span>, cmd<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>start = times<span style="color: #67b11d;">(</span>&amp;tmsstart<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == -<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"times error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>status = system<span style="color: #67b11d;">(</span>cmd<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"system() error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>end = times<span style="color: #67b11d;">(</span>&amp;tmsend<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == -<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"times error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    pr_times<span style="color: #bc6ec5;">(</span>end - start, &amp;tmsstart, &amp;tmsend<span style="color: #bc6ec5;">)</span>;
    pr_exit<span style="color: #bc6ec5;">(</span>status<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">pr_times</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">clock_t</span> <span style="color: #7590db;">real</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">tms</span> *<span style="color: #7590db;">tmsstart</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">tms</span> *<span style="color: #7590db;">tmsend</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">clktck</span> = <span style="color: #a45bad;">0</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>clktck == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>clktck = sysconf<span style="color: #b1951d;">(</span>_SC_CLK_TCK<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"sysconf error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"  real:         %7.2f\n"</span>, real / <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">double</span><span style="color: #2d9574;">)</span>clktck<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"  user:         %7.2f\n"</span>,
           <span style="color: #2d9574;">(</span>tmsend-&gt;tms_utime - tmsstart-&gt;tms_utime<span style="color: #2d9574;">)</span> / <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">double</span><span style="color: #2d9574;">)</span>clktck<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"  sys:          %7.2f\n"</span>,
           <span style="color: #2d9574;">(</span>tmsend-&gt;tms_stime - tmsstart-&gt;tms_stime<span style="color: #2d9574;">)</span> / <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">double</span><span style="color: #2d9574;">)</span>clktck<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"  child user:   %7.2f\n"</span>,
           <span style="color: #2d9574;">(</span>tmsend-&gt;tms_cutime - tmsstart-&gt;tms_cutime<span style="color: #2d9574;">)</span> / <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">double</span><span style="color: #2d9574;">)</span>clktck<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"  child sys:    %7.2f\n"</span>,
           <span style="color: #2d9574;">(</span>tmsend-&gt;tms_cstime - tmsstart-&gt;tms_cstime<span style="color: #2d9574;">)</span> / <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">double</span><span style="color: #2d9574;">)</span>clktck<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org883f24f" class="outline-4">
<h4 id="org883f24f"><span class="done DONE">DONE</span> 8.18 Summary</h4>
<div class="outline-text-4" id="text-org883f24f">
<p>
functions to master: <code>fork</code>, <code>exec</code> family, <code>_exit</code>, <code>wait</code> and <code>waitpid</code>.
</p>

<p>
<code>fork</code> function gave us an opportunity to look at race conditions.
</p>

<ul class="org-ul">
<li>Exercises

<ul class="org-ul">
<li><div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 60: </span>8.1</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">globvar</span> = <span style="color: #a45bad;">6</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">external variable in initialized data</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">var</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">automatic variable on the stack</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;

    var = <span style="color: #a45bad;">88</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"before vfork\n"</span><span style="color: #bc6ec5;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">we don't flush stdio</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = vfork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"vfork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">child</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        globvar++;         <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">modify parent's variables</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        var++;
        exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">child terminaltes</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">parent continues here</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"pid = %ld, glob = %d, var = %d\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>getpid<span style="color: #2d9574;">()</span>, globvar, var<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 61: </span>8.2</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">f1</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>, <span style="color: #bc6ec5; font-weight: bold;">f2</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    f1<span style="color: #bc6ec5;">()</span>;

    f2<span style="color: #bc6ec5;">()</span>;

    _exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">f1</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = vfork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"vfork error"</span><span style="color: #bc6ec5;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">child and parent both return</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">f2</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">100</span><span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>  <span style="color: #7590db;">i</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">automatic variables</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>buf<span style="color: #2d9574;">)</span>; i++<span style="color: #bc6ec5;">)</span> buf<span style="color: #bc6ec5;">[</span>i<span style="color: #bc6ec5;">]</span> = <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 62: </span>8.3</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">globvar</span> = <span style="color: #a45bad;">6</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">external variable in initialized data</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">var</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">automatic variable on the stack</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;

    var = <span style="color: #a45bad;">88</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"before vfork\n"</span><span style="color: #bc6ec5;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">we don't flush stdio</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = vfork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"vfork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">child</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        globvar++;         <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">modify parent's variables</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        var++;
        exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">child terminaltes</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">parent continues here</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"pid = %ld, glob = %d, var = %d\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>getpid<span style="color: #2d9574;">()</span>, globvar, var<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li>8.4</li>
</ul></li>
</ul>

<p>
In Figure 8.13, we have the parent write its output first. When the parent is done, the child writes its output, but we let the parent terminate. Whether the parent terminates or whether the child finishes its output first depends on the kernel’s scheduling of the two processes (another race condition). When the parent terminates, the shell starts up the next program, and this next program can interfere with the output from the previous child.
We can prevent this from happening by not letting the parent terminate until the child has also finished its output. Replace the code following the fork with the following:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">(</span>pid ~~ <span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
        WAIT_PARENT<span style="color: #bc6ec5;">()</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">parent goes first</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        charatatime<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"output from child\n"</span><span style="color: #bc6ec5;">)</span>;
        TELL_PARENT<span style="color: #bc6ec5;">(</span>getppid<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">tell parent we&#8217;re done</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #4f97d7;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7;">{</span>
        charatatime<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"output from parent\n"</span><span style="color: #bc6ec5;">)</span>;
        TELL_CHILD<span style="color: #bc6ec5;">(</span>pid<span style="color: #bc6ec5;">)</span>;
        <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">tell child we&#8217;re done</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        WAIT_CHILD<span style="color: #bc6ec5;">()</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">wait for child to finish</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
We won’t see this happen if we let the child go first, since the shell doesn’t start the next program until the parent terminates.
</p>

<ul class="org-ul">
<li>8.5 The same value</li>

<li><div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 63: </span>8.6</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    sleep<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">4</span><span style="color: #bc6ec5;">)</span>;

    system<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"ps -o pid,ppid,state,tty,command"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org3d47b11" class="outline-3">
<h3 id="org3d47b11"><span class="done DONE">DONE</span> Chapter 9. Process Relationships <code>[12/12]</code></h3>
<div class="outline-text-3" id="text-org3d47b11">
</div>

<div id="outline-container-orgb794aeb" class="outline-4">
<h4 id="orgb794aeb"><span class="done DONE">DONE</span> 9.1 Introduction</h4>
</div>
<div id="outline-container-org2399575" class="outline-4">
<h4 id="org2399575"><span class="done DONE">DONE</span> 9.2 Terminal Logins</h4>
<div class="outline-text-4" id="text-org2399575">
<ul class="org-ul">
<li><p>
BSD Terminal Logins
</p>


<div id="orgd4f0b61" class="figure">
<p><a href="Chapter09/9fig1.jpg"><img src="Chapter09/09fig01.jpg" alt="09fig01.jpg" /></a>
</p>
<p><span class="figure-number">Figure 15: </span>Figure 9.1 Processes invoked by init to allow terminal logins</p>
</div>
<blockquote>
<p>
a real user ID of 0 and an effective user ID of 0
</p>
</blockquote>

<p>
<code>login</code> program similar to
</p>
<div class="org-src-container">
<pre class="src src-c">execle<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"/bin/login"</span>, <span style="color: #2d9574;">"login"</span>, <span style="color: #2d9574;">"-p"</span>, username, <span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #bc6ec5;">)</span><span style="color: #a45bad;">0</span>, envp<span style="color: #4f97d7;">)</span>;
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-orge058d69" class="outline-4">
<h4 id="orge058d69"><span class="done DONE">DONE</span> 9.3 Network Logins</h4>
<div class="outline-text-4" id="text-orge058d69">
<blockquote>
<p>
The main (physical) difference between logging in to a system through a serial terminal and logging ni to a system through a network is that the connection between the terminal and the computer isn't point-to-point.
</p>

<p>
To allow the same software to process logins over both terminal logins and network logins, a software driver called a pseudo terminal is used to emulate the behavior of a serial terminal and map terminal operations to network operations, and vice versa.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org362d15a" class="outline-4">
<h4 id="org362d15a"><span class="done DONE">DONE</span> 9.4 Process Groups</h4>
<div class="outline-text-4" id="text-org362d15a">
<div class="org-src-container">
<pre class="src src-c" id="orgf19ff8b"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #bc6ec5; font-weight: bold;">getpgrp</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: process group ID of calling process</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-c" id="orgd9fdef9"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #bc6ec5; font-weight: bold;">getpgid</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: process group ID if OK, -1 on error</span>
</pre>
</div>

<p>
<code>getpgid(0) == getpgrp()</code>
</p>

<div class="org-src-container">
<pre class="src src-c" id="orga59fed7"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">setpgid</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">ipd_t</span> <span style="color: #7590db;">pid</span>, <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pgid</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, -1 on error</span>
</pre>
</div>
<p>
if <i>pid == pgid</i>, the pid becomes a process group leader
if <i>pid == 0</i>, the process ID of the caller is used.
if <i>pgid == 0</i>, the process ID specified by pid is used as process group ID
</p>
</div>
</div>

<div id="outline-container-org5e64133" class="outline-4">
<h4 id="org5e64133"><span class="done DONE">DONE</span> 9.5 Sessions</h4>
<div class="outline-text-4" id="text-org5e64133">
<blockquote>
<p>
A session is a collection of one or more process groups.
</p>
</blockquote>

<div class="org-src-container">
<pre class="src src-c" id="org108652a"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #bc6ec5; font-weight: bold;">setsid</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: process group ID if OK, -1 on error</span>
</pre>
</div>
<ol class="org-ol">
<li>The process becomes the <i>session leader</i> of this new session. (A session leader is the process that creates a session)</li>
<li>The process becomes the process group leader of a new process group.</li>
<li>The process has no controlling terminal.</li>
</ol>

<div class="org-src-container">
<pre class="src src-c" id="org54d35ad"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #bc6ec5; font-weight: bold;">getsid</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: session leader's process group ID if OK, -1 on error</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1e6d214" class="outline-4">
<h4 id="org1e6d214"><span class="done DONE">DONE</span> 9.6 Controlling Terminal</h4>
<div class="outline-text-4" id="text-org1e6d214">
<p>
Sessions and progress groups have a few other characteristics
</p>

<ul class="org-ul">
<li>A session can have a single <i>controlling terminal</i>.</li>

<li>The session leader that establishes the connection to the controlling terminal</li>

<li>The process groups within a session can be divided into a single <i>foreground process group</i> and one or more <i>background proces groups</i></li>

<li>If a session has a controlling terminal, it has a single foreground process group and all other process groups in the session are background process groups</li>

<li>Whenever we press the terminal's interrupt key(often DELETE or Control-C), the interrupt signal is sent to all processes in the foreground process group.</li>

<li>Whenever we press the terminal's quit key(Often Control-backslash), the quit signal is sent to all processes in the foreground process group.</li>

<li>If a modem(or network) disconnect is detected by the terminal interface, the hang-up signal is sent to the controlling process (the session leader).</li>
</ul>
</div>
</div>

<div id="outline-container-orge174c6b" class="outline-4">
<h4 id="orge174c6b"><span class="done DONE">DONE</span> 9.7 <code>tcgetpgrp</code>, <code>tcsetpgrp</code>, and <code>tcgetsid</code> Functions</h4>
<div class="outline-text-4" id="text-orge174c6b">
<div class="org-src-container">
<pre class="src src-c" id="orga8ece29"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #bc6ec5; font-weight: bold;">tcgetpgrp</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: process group ID of foreground process group if OK, -1 on error</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">tcsetpgrp</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>, <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pgrpid</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, -1 on error</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c" id="orgea9ae53"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">termios.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #bc6ec5; font-weight: bold;">tcgetsid</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: session leader's process group ID if OK, -1 on error</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge927023" class="outline-4">
<h4 id="orge927023"><span class="done DONE">DONE</span> 9.8 Job Control</h4>
<div class="outline-text-4" id="text-orge927023">
<p>
Requirements:
</p>
<ol class="org-ol">
<li>A shell that supports job control</li>
<li>The terminal driver in the kernel must support job control</li>
<li>The kernel must support certain job-control signals</li>
</ol>

<div class="org-src-container">
<pre class="src src-sh">cat &gt; temp.foo &amp; <span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&amp; let start in background</span>
<span style="color: #4f97d7;">fg</span> % <span style="color: #a45bad;">1</span> <span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">% bring job number into the foreground</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-sh">stty tostop <span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">disable ability of background to output to controlling terminal</span>
</pre>
</div>

<p>
generate signals to the foreground process group:
</p>
<ol class="org-ol">
<li>The interrupt character (typically DELETE or Control-C) generates SIGINT.</li>
<li>The quit character (typically Control-backslash) generates SIGQUIT.</li>
<li>The suspend character (typically Control-Z) generates SIGTSTP.</li>
</ol>


<div id="org424a27d" class="figure">
<p><img src="Chapter09/09fig09.jpg" alt="09fig09.jpg" />
</p>
<p><span class="figure-number">Figure 16: </span>Figure 9.9 Summary of job control features with foreground and background jobs, and terminal driver</p>
</div>
</div>
</div>

<div id="outline-container-orgd0f4cab" class="outline-4">
<h4 id="orgd0f4cab"><span class="done DONE">DONE</span> 9.9 Shell Execution Programs</h4>
<div class="outline-text-4" id="text-orgd0f4cab">
<div class="org-src-container">
<pre class="src src-sh">ps -o pid,ppid,pgid,comm
</pre>
</div>


<div id="orgc1a3db0" class="figure">
<p><img src="Chapter09/09fig10.jpg" alt="09fig10.jpg" />
</p>
<p><span class="figure-number">Figure 17: </span>Figure 9.10 Processes in the pipeline as <code>ps | cat1 | cat2 when invoked by bash</code></p>
</div>
</div>
</div>

<div id="outline-container-org5ea14a2" class="outline-4">
<h4 id="org5ea14a2"><span class="done DONE">DONE</span> 9.10 Orphaned Process Groups</h4>
<div class="outline-text-4" id="text-org5ea14a2">

<div id="orge865f00" class="figure">
<p><img src="Chapter09/09fig11.jpg" alt="09fig11.jpg" />
</p>
<p><span class="figure-number">Figure 18: </span>Figure 9.11 Example of a process group about to be orphaned</p>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 64: </span>Figure 9.12 Creating an orphaned process group</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     09fig12.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-12-09</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Creating an orphaned process group</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_hup</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"SIGHUP received, pid = %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>getpid<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">pr_ids</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%s: pid = %ld, ppid = %ld, pgrp = %ld, tpgrp = %ld\n"</span>, name,
           <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>getpid<span style="color: #2d9574;">()</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>getppid<span style="color: #2d9574;">()</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>getpgrp<span style="color: #2d9574;">()</span>,
           <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>tcgetpgrp<span style="color: #2d9574;">(</span>STDIN_FILENO<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    fflush<span style="color: #bc6ec5;">(</span>stdout<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">c</span>;
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;

    pr_ids<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"parent"</span><span style="color: #bc6ec5;">)</span>;
    pid = fork<span style="color: #bc6ec5;">()</span>;
    <span style="color: #4f97d7; font-weight: bold;">switch</span><span style="color: #bc6ec5;">(</span>pid<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">case</span> -<span style="color: #a45bad;">1</span>:
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">case</span> <span style="color: #a45bad;">0</span>:
        pr_ids<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"child"</span><span style="color: #2d9574;">)</span>;
        signal<span style="color: #2d9574;">(</span>SIGHUP, sig_hup<span style="color: #2d9574;">)</span>;
        kill<span style="color: #2d9574;">(</span>getpid<span style="color: #67b11d;">()</span>, SIGTSTP<span style="color: #2d9574;">)</span>;
        pr_ids<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"child"</span><span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>read<span style="color: #67b11d;">(</span>STDIN_FILENO, &amp;c, <span style="color: #a45bad;">1</span><span style="color: #67b11d;">)</span> != <span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"read error %d on controlling TTY\n"</span>, errno<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">default</span>:
        sleep<span style="color: #2d9574;">(</span><span style="color: #a45bad;">5</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<blockquote>
<p>
After the fork
</p>

<ul class="org-ul">
<li>The parent sleeps for 5 seconds.</li>

<li>The child establishes a signal handler for the hang-up signal(SIGHUP) so we can see whether it is sent to the child.</li>

<li>The child sends itself to stop signal(SIGTSTP) with the kill function.</li>

<li>When the parent terminates, the child is orphaned, so the child's parent process ID becomes 1, which is the init process ID.</li>

<li>At this point, the child is now a member of an <i>orphaned process group</i>.</li>

<li>Since the process group is orphaned when the parent terminates, and the process group contains a stopped process, <b>POSIX.1 requires that every process in the newly orphaned process group be sent the hang-up signal(SIGHUP) followed by the continue signal(SIGCONT)</b></li>

<li>This causes the child to be continued, after processing the hang-up signal.</li>
</ul>
</blockquote>
</div>
</div>

<div id="outline-container-orgb5fad65" class="outline-4">
<h4 id="orgb5fad65"><span class="done DONE">DONE</span> 9.11 FreeBSD Implementation</h4>
<div class="outline-text-4" id="text-orgb5fad65">

<div id="orgece8a35" class="figure">
<p><img src="Chapter09/09fig13.jpg" alt="09fig13.jpg" />
</p>
<p><span class="figure-number">Figure 19: </span>Figure 9.13 Free BSD implementation of sessions and process groups</p>
</div>

<blockquote>
<p>
<b>session structure</b>
</p>
<ul class="org-ul">
<li><code>s_count</code>: the number of the process groups in the session.</li>
<li><code>s_leader</code>: a pointer to the proc structure of the session leader</li>
<li><code>s_ttyvp</code>: a pointer to the vnode structure of the controlling terminal</li>
<li><code>s_ttyp</code>: a pointer to the tty structure of the controlling terminal</li>
<li><code>s_sid</code>: the session ID.</li>
</ul>

<p>
<b>tty structure</b>
</p>
<ul class="org-ul">
<li><code>t_session</code>: points to the session structure that has this terminal as its controlling terminal.</li>
<li><code>t_pgrp</code>: points to the pgrp structure of the foreground process group.</li>
<li><code>t_termios</code>: is a structure containing all the special characters and related information for this terminal.</li>
<li><code>t_winsize</code>: is a winsize structure that contains the current size of the terminal window.</li>
</ul>

<p>
<b>pgrp structure</b>
</p>
<ul class="org-ul">
<li><code>pg_id</code>: the process group ID</li>
<li><code>pg_session</code>: points to the session structure to the session leader</li>
<li><code>pg_members</code>: a pointer to the list of members' proc structures</li>
</ul>

<p>
<b>proc structure</b>
</p>
<ul class="org-ul">
<li><code>p_pid</code>: contains the process ID</li>
<li><code>p_pptr</code>: a pointer to the proc structure of the parent process.</li>
<li><code>p_pgrp</code>: a pointer to the pgrp structure of the process group to which it belongs to</li>
<li><code>p_pglist</code>: a structure containing pointers to the next and previous process in the process group.</li>
</ul>

<p>
<b>vnode structure</b> : allocated when the controlling terminal device is opened.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-orgcee5c4b" class="outline-4">
<h4 id="orgcee5c4b"><span class="done DONE">DONE</span> 9.12 Summary</h4>
<div class="outline-text-4" id="text-orgcee5c4b">
<ul class="org-ul">
<li>Exercises

<ul class="org-ul">
<li><p>
9.1
</p>

<blockquote>
<p>
The init process learns when a terminal user logs out, because init is the parent of the login shell and receives the SIGCHLD signal when the login shell terminates.
</p>

<p>
For a network login, however, init is not involved. Instead, the login entries in the utmp and wtmp files, and their corresponding logout entries, are usually written by the process that handles the login and detects the logout (telnetd in our example).
</p>
</blockquote></li>

<li><p>
9.2
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     09ex02.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-12-14</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Exercises 9.2</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> *  Write a small program that calls fork and has the child create a new</span>
<span style="color: #9f8766;"> * session. Verify that the child becomes a process group leader and that the</span>
<span style="color: #9f8766;"> * child no longer has a controlling terminal.</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">fd</span>  = <span style="color: #a45bad;">0</span>;
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span> = <span style="color: #a45bad;">0</span>;

    TELL_WAIT<span style="color: #bc6ec5;">()</span>;

    pid = fork<span style="color: #bc6ec5;">()</span>;
    <span style="color: #4f97d7; font-weight: bold;">switch</span> <span style="color: #bc6ec5;">(</span>pid<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">case</span> -<span style="color: #a45bad;">1</span>:
            err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;

        <span style="color: #4f97d7; font-weight: bold;">case</span> <span style="color: #a45bad;">0</span>:
            WAIT_PARENT<span style="color: #2d9574;">()</span>;

            printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"getsid in child before setsid: %lu\n"</span>,
                   <span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #67b11d;">)</span>getsid<span style="color: #67b11d;">(</span>pid<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
            setsid<span style="color: #2d9574;">()</span>;
            printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"getsid in child after setsid : %lu\n"</span>,
                   <span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #67b11d;">)</span>getsid<span style="color: #67b11d;">(</span>pid<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;

            fd = open<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"/dev/tty"</span>, O_RDONLY<span style="color: #2d9574;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>fd &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
                printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"child get tty failed: %s\n"</span>, strerror<span style="color: #b1951d;">(</span>errno<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>;
            <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
                printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"child get tty success\n"</span><span style="color: #67b11d;">)</span>;
                close<span style="color: #67b11d;">(</span>fd<span style="color: #67b11d;">)</span>;
            <span style="color: #2d9574;">}</span>

            TELL_PARENT<span style="color: #2d9574;">(</span>getppid<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span>;
            exit<span style="color: #2d9574;">(</span>EXIT_SUCCESS<span style="color: #2d9574;">)</span>;

        <span style="color: #4f97d7; font-weight: bold;">default</span>:
            printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"getsid in parent before child setsid: %lu\n"</span>,
                   <span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #67b11d;">)</span>getsid<span style="color: #67b11d;">(</span>pid<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
            TELL_CHILD<span style="color: #2d9574;">(</span>pid<span style="color: #2d9574;">)</span>;
            WAIT_CHILD<span style="color: #2d9574;">()</span>;

            fd = open<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"/dev/tty"</span>, O_RDONLY<span style="color: #2d9574;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>fd &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
                printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"parent get tty failed: %s\n"</span>, strerror<span style="color: #b1951d;">(</span>errno<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>;
            <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
                printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"parent get tty success\n"</span><span style="color: #67b11d;">)</span>;
                close<span style="color: #67b11d;">(</span>fd<span style="color: #67b11d;">)</span>;
            <span style="color: #2d9574;">}</span>

            printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"getsid in parent after child setsid: %lu\n"</span>,
                   <span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #67b11d;">)</span>getsid<span style="color: #67b11d;">(</span>pid<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;

            exit<span style="color: #2d9574;">(</span>EXIT_SUCCESS<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org83a7183" class="outline-3">
<h3 id="org83a7183"><span class="done DONE">DONE</span> Chapter 10. Signals <code>[23/23]</code></h3>
<div class="outline-text-3" id="text-org83a7183">
</div>

<div id="outline-container-org16b9dcb" class="outline-4">
<h4 id="org16b9dcb"><span class="done DONE">DONE</span> 10.1 Introduction</h4>
<div class="outline-text-4" id="text-org16b9dcb">
<blockquote>
<p>
Signals provide a way of handling asynchronous events
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org4f65cf9" class="outline-4">
<h4 id="org4f65cf9"><span class="done DONE">DONE</span> 10.2 Signal Concepts</h4>
<div class="outline-text-4" id="text-org4f65cf9">
<p>
<code>&lt;signal.h&gt;</code>
conditions can generate a signal
</p>
<ul class="org-ul">
<li>terminal generated when users press certain terminal keys.</li>
<li>hardware exceptions</li>
<li>function <code>kill</code> (man 2 kill)</li>
<li>command <code>kill</code> (man 1 kill)</li>
<li>software conditions : <code>SIGURG</code> <code>SIGPIPE</code> <code>SIGALARM</code></li>
</ul>

<p>
deal with signals via one of things below:
</p>
<ul class="org-ul">
<li>ignore</li>
<li>catch</li>
<li>use defaut action apply</li>
</ul>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 6:</span> Figure 10.1 UNIX System signals</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Name</th>
<th scope="col" class="org-left">Description</th>
<th scope="col" class="org-left">Default Action</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">SIGABRT</td>
<td class="org-left">abnormal termination(abort)</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGALARM</td>
<td class="org-left">timer expired(alarm)</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGBUS</td>
<td class="org-left">hardware fault</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGCHLD</td>
<td class="org-left">change in the status of child</td>
<td class="org-left">ignore</td>
</tr>

<tr>
<td class="org-left">SIGCONT</td>
<td class="org-left">continue stopped process</td>
<td class="org-left">continue/ignore</td>
</tr>

<tr>
<td class="org-left">SIGEMT</td>
<td class="org-left">hardware fault</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGFPE</td>
<td class="org-left">arithmetic exception</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGFREEZE</td>
<td class="org-left">checkpoint freeze</td>
<td class="org-left">ignore</td>
</tr>

<tr>
<td class="org-left">SIGHUP</td>
<td class="org-left">hangup</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGILL</td>
<td class="org-left">illegal instruction</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGINFO</td>
<td class="org-left">status request from keyboard</td>
<td class="org-left">ignore</td>
</tr>

<tr>
<td class="org-left">SIGINT</td>
<td class="org-left">terminal interrupt character</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGIO</td>
<td class="org-left">asynchronous I/O</td>
<td class="org-left">terminate/ignore</td>
</tr>

<tr>
<td class="org-left">SIGIOT</td>
<td class="org-left">hardware fault</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGKILL</td>
<td class="org-left">termination : <b>can't be caught or ignored</b></td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGPIPE</td>
<td class="org-left">write to pipe with no readers</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGPOLL</td>
<td class="org-left">pollable event(poll): <b>might be removed</b></td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGPROF</td>
<td class="org-left">profiling time alarm(setitimer):  <b>might be removed</b></td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGPWR</td>
<td class="org-left">power fail/restart</td>
<td class="org-left">terminate/ignore</td>
</tr>

<tr>
<td class="org-left">SIGQUIT</td>
<td class="org-left">terminal quit character</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGSEGV</td>
<td class="org-left">invalid memory reference</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGSTKFLT</td>
<td class="org-left">coprocessor stack fault</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGSTOP</td>
<td class="org-left">stop: <b>can't be caught or ignored</b></td>
<td class="org-left">stop process</td>
</tr>

<tr>
<td class="org-left">SIGSYS</td>
<td class="org-left">invalid system call</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGTERM</td>
<td class="org-left">termination</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGTHAW</td>
<td class="org-left">checkpoint thaw</td>
<td class="org-left">ignore</td>
</tr>

<tr>
<td class="org-left">SIGTHR</td>
<td class="org-left">threads library internal use</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGTRAP</td>
<td class="org-left">hardware fault</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGTSTP</td>
<td class="org-left">terminal stop character</td>
<td class="org-left">stop process</td>
</tr>

<tr>
<td class="org-left">SIGTTIN</td>
<td class="org-left">background read from control tty</td>
<td class="org-left">stop process</td>
</tr>

<tr>
<td class="org-left">SIGTTOU</td>
<td class="org-left">background write to control tty</td>
<td class="org-left">stop process</td>
</tr>

<tr>
<td class="org-left">SIGURG</td>
<td class="org-left">urgent condition(sockets)</td>
<td class="org-left">ignore</td>
</tr>

<tr>
<td class="org-left">SIGUSR1</td>
<td class="org-left">user-defined signal</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGUSR2</td>
<td class="org-left">user-defined signal</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGVTALRM</td>
<td class="org-left">virtual time alarm(setitimer)</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGWAITING</td>
<td class="org-left">threads library internal use</td>
<td class="org-left">ignore</td>
</tr>

<tr>
<td class="org-left">SIGWINCH</td>
<td class="org-left">terminal window size change</td>
<td class="org-left">ignore</td>
</tr>

<tr>
<td class="org-left">SIGXCPU</td>
<td class="org-left">CPU limit exceeded (setrlimit)</td>
<td class="org-left">terminate or terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGXFSZ</td>
<td class="org-left">file size limit exceeded(setrlimit0)</td>
<td class="org-left">terminate or terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGXRES</td>
<td class="org-left">resource control exceeded</td>
<td class="org-left">ignore</td>
</tr>
</tbody>
</table>

<blockquote>
<p>
The core file will not be generated if
</p>
<ol class="org-ol">
<li>the process was set-user-ID and the current user is not the owner of the program file</li>
<li>the process was set-group-ID and the current user is not the group owner of the file</li>
<li>the user does not have permission to write in the current working directory</li>
<li>the file already exists and the user does not have permission to write it</li>
<li>the file is too big (recall the RLIMIT_CORE)</li>
</ol>

<p>
The permission of the core file are usually <code>rw</code>, although Mac OSX sets only <code>r</code>
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org53115df" class="outline-4">
<h4 id="org53115df"><span class="done DONE">DONE</span> 10.3 <code>signal</code> Function</h4>
<div class="outline-text-4" id="text-org53115df">
<div class="org-src-container">
<pre class="src src-sh">man signal
</pre>
</div>

<ul class="org-ul">
<li>Example:</li>
</ul>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 65: </span>Figure 10.2 Simple program to catch SIGUSR1 and SIGUSR2</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_usr</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">one handler for both signals</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGUSR1, sig_usr<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"can't catch SIGUSR1"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGUSR2, sig_usr<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"can't catch SIGUSR2"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>;;<span style="color: #bc6ec5;">)</span> pause<span style="color: #bc6ec5;">()</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_usr</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signo == SIGUSR1<span style="color: #bc6ec5;">)</span>
        printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"received SIGUSR1\n"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signo == SIGUSR2<span style="color: #bc6ec5;">)</span>
        printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"received SIGUSR2\n"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">else</span>
        err_dump<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"received signal %d\n"</span>, signo<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<blockquote>
<p>
FreeBSD 8.0 and Mac OS X 10.6.8 don’t exhibit this problem, because BSD - based systems generally don’t support historical System V semantics for SIGCLD. Linux 3.2.0 also doesn’t exhibit this problem, because it doesn’t call the SIGCHLD signal handler when a process arranges to catch SIGCHLD and child processes are ready to be waited for, even though SIGCLD and SIGCHLD are defined to be the same value.
</p>
</blockquote>

<ul class="org-ul">
<li><p>
Program Start-Up
</p>

<p>
we are not able to determine the current disposition of a signal without changing the disposition
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org170ec9b" class="outline-4">
<h4 id="org170ec9b"><span class="done DONE">DONE</span> 10.4 Unreliable Signals</h4>
<div class="outline-text-4" id="text-org170ec9b">
<p>
In ealier versions of the UNIX system :
</p>

<ul class="org-ul">
<li>signals could get lost</li>

<li>the process was unable to turn a signal off when it didn’t want the signal to occur</li>
</ul>
</div>
</div>

<div id="outline-container-org82b41fb" class="outline-4">
<h4 id="org82b41fb"><span class="done DONE">DONE</span> 10.5 Interrupted System Calls</h4>
<div class="outline-text-4" id="text-org82b41fb">
<ul class="org-ul">
<li><p>
automatically restarted functions: <code>ioctl</code>, <code>read</code>, <code>readv</code>, <code>write</code>, <code>writev</code>, <code>wait</code>, <code>waitpid</code>
</p>

<p>
POSIX.1 requires an implementation to restart system calls only when the SA_RESTART flag is in effect for the interrupting signal.
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org3bcc88d" class="outline-4">
<h4 id="org3bcc88d"><span class="done DONE">DONE</span> 10.6 Reentrant Functions</h4>
<div class="outline-text-4" id="text-org3bcc88d">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 66: </span>Figure 10.5 Call a nonreentrant function from a signal handler</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pwd.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">my_alarm</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">passwd</span> *<span style="color: #7590db;">rootptr</span>;

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"in signal hander\n"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>rootptr = getpwnam<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"hello"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"getpwnam(root) error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    alarm<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">passwd</span> *<span style="color: #7590db;">ptr</span>;
    signal<span style="color: #bc6ec5;">(</span>SIGALRM, my_alarm<span style="color: #bc6ec5;">)</span>;
    alarm<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">usleep(500);                  // it seems alarm cannot interrupt sleep</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">function</span>

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>;;<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>ptr = getpwnam<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"zhoush"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"getpwnam error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>strcmp<span style="color: #67b11d;">(</span>ptr-&gt;pw_name, <span style="color: #2d9574;">"zhoush"</span><span style="color: #67b11d;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"return value corrupted!, pw_name = %s\n"</span>, ptr-&gt;pw_name<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orga40cabd" class="outline-4">
<h4 id="orga40cabd"><span class="done DONE">DONE</span> 10.7 <code>SIGCLD</code> Semantics</h4>
<div class="outline-text-4" id="text-orga40cabd">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 67: </span>Figure 10.6 System V SIGCLD handler that doesn't work</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_cld</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;

<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #bc6ec5;">(</span>__linux__<span style="color: #bc6ec5;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGCLD, sig_cld<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        perror<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"signal error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

<span style="color: #bc6ec5;">#endif</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        perror<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        sleep<span style="color: #2d9574;">(</span><span style="color: #a45bad;">2</span><span style="color: #2d9574;">)</span>;
        _exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    pause<span style="color: #bc6ec5;">()</span>;
    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_cld</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">interrupts pause()</span>

    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">status</span>;

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"SIGCLD received\n"</span><span style="color: #bc6ec5;">)</span>;

<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #bc6ec5;">(</span>__linux__<span style="color: #bc6ec5;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGCLD, sig_cld<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        perror<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"signal erro"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #bc6ec5;">#endif</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = wait<span style="color: #67b11d;">(</span>&amp;status<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        perror<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"wait error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"pid = %d\n"</span>, pid<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb6c0195" class="outline-4">
<h4 id="orgb6c0195"><span class="done DONE">DONE</span> 10.8 Reliable-Signal Terminology and Semantics</h4>
<div class="outline-text-4" id="text-orgb6c0195">
<blockquote>
<p>
If the system delivers the signal more than once, we say that the signals are queued. <br />
<b>Most UNIX systems do <i>not</i> queue signals unless they support the real-time extensions to POSIX.1.</b> <br />
POSIX.1 <b>does not specify the order</b> in which the signals are delivered to the process more than once.
</p>
</blockquote>

<ul class="org-ul">
<li><i>signal mask</i>: a set of signals currently blocked from delivery to the process (<b>on</b> is blocked)</li>
<li><i><code>sigprocmask</code></i>: examine and change its current signal mask</li>
</ul>
</div>
</div>

<div id="outline-container-orgc06cb9f" class="outline-4">
<h4 id="orgc06cb9f"><span class="done DONE">DONE</span> 10.9 <code>kill</code> and <code>raise</code> Functions</h4>
<div class="outline-text-4" id="text-orgc06cb9f">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">kill</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">raise</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span>;

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, -1 on error</span>
</pre>
</div>

<p>
<code>raise(signo);</code> is equivalent to <code>kill(getpid(), signo);</code>
</p>
</div>
</div>

<div id="outline-container-orgc3914c7" class="outline-4">
<h4 id="orgc3914c7"><span class="done DONE">DONE</span> 10.10 <code>alarm</code> and <code>pause</code> Functions</h4>
<div class="outline-text-4" id="text-orgc3914c7">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">alarm</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">seconds</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 or number of seconds until previously set alarm</span>
</pre>
</div>

<blockquote>
<p>

</p>

<p>
There is only one of these alarm clocks per process. If, when we call alarm, a previously registered alarm clock for the process has not yet expired, the number of seconds left for that alarm clock is returned as the value of this function.
</p>

<p>
If a previously registered alarm clock for the process has not yet expired and if the seconds value is 0, the previous alarm clock is canceled.
</p>

<p>
If we call alarm first and are sent SIGALRM before we can install the signal handler, our process will terminate
</p>
</blockquote>

<p>
suspends the calling process until a signal is caught
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pause</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: -1 with errno set to EINTR</span>
</pre>
</div>

<ul class="org-ul">
<li><p>
Example:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 68: </span>Figure 10.7 Simple, incomplete implementation of sleep</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_alrm</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">nothing to do , just return to wake up the pause;</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sleep1</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">seconds</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGALRM, sig_alrm<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span>seconds<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    alarm<span style="color: #bc6ec5;">(</span>seconds<span style="color: #bc6ec5;">)</span>;     <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">start timer</span>
    pause<span style="color: #bc6ec5;">()</span>;            <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">caught signal wake up</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>alarm<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">turn off timer, return unslept time</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 69: </span>Figure 10.8 Another (imperfect) implementation of sleep</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">setjmp.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">jmp_buf</span> <span style="color: #7590db;">env_alrm</span>;

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_alrm</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> longjmp<span style="color: #bc6ec5;">(</span>env_alrm, <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sleep2</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">seconds</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGALRM, sig_alrm<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span>seconds<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>setjmp<span style="color: #2d9574;">(</span>env_alrm<span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        alarm<span style="color: #2d9574;">(</span>seconds<span style="color: #2d9574;">)</span>;
        pause<span style="color: #2d9574;">()</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> alarm<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 70: </span>Figure 10.9 Calling sleep2 from a program that catches other signals</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sleep2</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span>  <span style="color: #bc6ec5; font-weight: bold;">sig_int</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">unslept</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGINT, sig_int<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"signal(SIGINT) error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    unslept = sleep2<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">5</span><span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"sleep2 returned: %u\n"</span>, unslept<span style="color: #bc6ec5;">)</span>;
    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_int</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>          <span style="color: #7590db;">i</span>, <span style="color: #7590db;">j</span>;
    <span style="color: #4f97d7; font-weight: bold;">volatile</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">k</span>;

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\nsig_int starting\n"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; <span style="color: #a45bad;">3000000</span>; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #2d9574;">(</span>j = <span style="color: #a45bad;">0</span>; j &lt; <span style="color: #a45bad;">40000</span>; ++j<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            k += i * j;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"sig_int finished"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 71: </span>Figure 10.10 Calling <code>read</code> with a timeout</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     10fig10.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-10-26</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    calling </span><span style="color: #a45bad;">read()</span><span style="color: #9f8766;"> with timeout</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@bug</span><span style="color: #9f8766;"> race condition between first call to </span><span style="color: #a45bad;">alarm()</span><span style="color: #9f8766;"> and </span><span style="color: #a45bad;">read()</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@bug</span><span style="color: #9f8766;"> if system are automatically restarted, the read is not interrupted</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_alrm</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>  <span style="color: #7590db;">n</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">line</span><span style="color: #bc6ec5;">[</span>MAXLINE<span style="color: #bc6ec5;">]</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGALRM, sig_alrm<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"signal(SIGALRM) error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    alarm<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">10</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>n = read<span style="color: #67b11d;">(</span>STDIN_FILENO, line, MAXLINE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"read error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    alarm<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;

    write<span style="color: #bc6ec5;">(</span>STDOUT_FILENO, line, n<span style="color: #bc6ec5;">)</span>;
    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_alrm</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 72: </span>Figure 10.11 Calling <code>read</code> with a timeout, using longjmp</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     10fig11.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-10-26</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    calling read with a timeout, using longjmp</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">setjmp.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span>    <span style="color: #bc6ec5; font-weight: bold;">sig_alrm</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">jmp_buf</span> <span style="color: #7590db;">env_alrm</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>  <span style="color: #7590db;">n</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">line</span><span style="color: #bc6ec5;">[</span>MAXLINE<span style="color: #bc6ec5;">]</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGALRM, sig_alrm<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"signal(SIGALRM) error"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>setjmp<span style="color: #2d9574;">(</span>env_alrm<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> err_quit<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"read timeout"</span><span style="color: #bc6ec5;">)</span>;

    alarm<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">10</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>n = read<span style="color: #67b11d;">(</span>STDIN_FILENO, line, MAXLINE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"read error"</span><span style="color: #bc6ec5;">)</span>;

    alarm<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;

    write<span style="color: #bc6ec5;">(</span>STDOUT_FILENO, line, n<span style="color: #bc6ec5;">)</span>;
    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_alrm</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> longjmp<span style="color: #bc6ec5;">(</span>env_alrm, <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org60e4b93" class="outline-4">
<h4 id="org60e4b93"><span class="done DONE">DONE</span> 10.11 Signal Sets</h4>
<div class="outline-text-4" id="text-org60e4b93">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sigemptyset</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">sigset_t</span> *<span style="color: #7590db;">set</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sigfillset</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">sigset_t</span> *<span style="color: #7590db;">set</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sigaddset</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">sigset</span> *<span style="color: #7590db;">set</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sigdelset</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">sigset</span> *<span style="color: #7590db;">set</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">All four returns: 0 if OK, -1 on error</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sigismember</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">sigset</span> *<span style="color: #7590db;">set</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 1 if true, 0 if false, -1 on error</span>
</pre>
</div>

<p>
Implementation:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#define</span> <span style="color: #bc6ec5; font-weight: bold;">sigemptyset</span><span style="color: #4f97d7;">(</span><span style="color: #7590db;">ptr</span><span style="color: #4f97d7;">)</span>  <span style="color: #4f97d7;">(</span>*<span style="color: #bc6ec5;">(</span>ptr<span style="color: #bc6ec5;">)</span> = <span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #bc6ec5; font-weight: bold;">sigfillset</span><span style="color: #4f97d7;">(</span><span style="color: #7590db;">ptr</span><span style="color: #4f97d7;">)</span>   <span style="color: #4f97d7;">(</span>*<span style="color: #bc6ec5;">(</span>ptr<span style="color: #bc6ec5;">)</span> = ~<span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">sigset_t</span><span style="color: #bc6ec5;">)</span><span style="color: #a45bad;">0</span>, <span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span>
</pre>
</div>
<p>
<code>sigfillset</code> returns value after the comma (value: 0)
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     10fig12.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-10-26</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    implementations</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> *  An implementation of </span><span style="color: #a45bad;">sigaddset()</span><span style="color: #9f8766;">, </span><span style="color: #a45bad;">sigdelset()</span><span style="color: #9f8766;">, </span><span style="color: #a45bad;">sigismember()</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * &lt;signal.h&gt; usually defines NSIG to include signal number 0.</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #bc6ec5; font-weight: bold;">SIGBAD</span><span style="color: #4f97d7;">(</span><span style="color: #7590db;">signao</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span>signo<span style="color: #bc6ec5;">)</span> &lt;= <span style="color: #a45bad;">0</span> || <span style="color: #bc6ec5;">(</span>signo<span style="color: #bc6ec5;">)</span> &gt;= NSIG<span style="color: #4f97d7;">)</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">my_sigaddset</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">sigset_t</span> *<span style="color: #7590db;">set</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>SIGBAD<span style="color: #2d9574;">(</span>signo<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        errno = EINVAL;
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span>-<span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    *set |= <span style="color: #a45bad;">1</span> &lt;&lt; <span style="color: #bc6ec5;">(</span>signo - <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">turn bit on</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">my_sigdelset</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">sigset_t</span> *<span style="color: #7590db;">set</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>SIGBAD<span style="color: #2d9574;">(</span>signo<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        errno = EINVAL;
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span>-<span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    *set &amp;= ~<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span> &lt;&lt; <span style="color: #2d9574;">(</span>signo - <span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">turn bit off</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">my_sigismember</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">sigset_t</span> *<span style="color: #7590db;">set</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>SIGBAD<span style="color: #2d9574;">(</span>signo<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        errno = EINVAL;
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span>-<span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>*set &amp; <span style="color: #67b11d;">(</span><span style="color: #a45bad;">1</span> &lt;&lt; <span style="color: #b1951d;">(</span>signo - <span style="color: #a45bad;">1</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org7c51d44" class="outline-4">
<h4 id="org7c51d44"><span class="done DONE">DONE</span> 10.12 <code>sigprocmask</code> Function</h4>
<div class="outline-text-4" id="text-org7c51d44">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sigprocmask</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">how</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">sigset_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">set</span>, <span style="color: #ce537a; font-weight: bold;">sigset_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">oset</span><span style="color: #4f97d7;">)</span>;

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, -1 on error</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 7:</span> Figure 10.13 Ways to change the current signal mask using sigprocmask</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">how</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>SIG_BLOCK</code></td>
<td class="org-left"><i>set</i> contains the additional signals that we want to block.</td>
</tr>

<tr>
<td class="org-left"><code>SIG_UNBLOCK</code></td>
<td class="org-left"><i>set</i> contains the signals that we want to unblock</td>
</tr>

<tr>
<td class="org-left"><code>SIG_SETMASK</code></td>
<td class="org-left">new signal mask replaced by the signal set pointed to by <i>set</i></td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li><p>
Example:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 73: </span>Figure 10.14 Print the signal mask for the process</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     10fig14.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-10-27</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Print the signal mask for the process</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> *   shows a function that prints the names of the signals in the signal mask of</span>
<span style="color: #9f8766;"> * the calling process.</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">pr_mask</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">str</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">sigset_t</span> <span style="color: #7590db;">sigset</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>      <span style="color: #7590db;">errno_save</span>;

    errno_save = errno;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">we can be canceld by signal handlers</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigprocmask<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span>, <span style="color: #a45bad;">NULL</span>, &amp;sigset<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_ret<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"sigprocmask error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s"</span>, str<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>sigismember<span style="color: #67b11d;">(</span>&amp;sigset, SIGINT<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">" SIGINT"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>sigismember<span style="color: #67b11d;">(</span>&amp;sigset, SIGQUIT<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">" SIGQUIT"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>sigismember<span style="color: #67b11d;">(</span>&amp;sigset, SIGUSR1<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">" SIGUSR1"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>sigismember<span style="color: #67b11d;">(</span>&amp;sigset, SIGALRM<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">" SIGGALRM"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\n"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    errno = errno_save;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org89b0287" class="outline-4">
<h4 id="org89b0287"><span class="done DONE">DONE</span> 10.13 <code>sigpending</code> Function</h4>
<div class="outline-text-4" id="text-org89b0287">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sigpending</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">sigset_t</span> *<span style="color: #7590db;">set</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, -1 on error</span>
</pre>
</div>

<ul class="org-ul">
<li><p>
Example:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 74: </span>Example of signal sets and sigprocmask</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pwd.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">my_alarm</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">passwd</span> *<span style="color: #7590db;">rootptr</span>;

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"in signal hander\n"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>rootptr = getpwnam<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"hello"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"getpwnam(root) error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    alarm<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">passwd</span> *<span style="color: #7590db;">ptr</span>;
    signal<span style="color: #bc6ec5;">(</span>SIGALRM, my_alarm<span style="color: #bc6ec5;">)</span>;
    alarm<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">usleep(500);                  // it seems alarm cannot interrupt sleep</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">function</span>

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>;;<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>ptr = getpwnam<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"zhoush"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"getpwnam error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>strcmp<span style="color: #67b11d;">(</span>ptr-&gt;pw_name, <span style="color: #2d9574;">"zhoush"</span><span style="color: #67b11d;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"return value corrupted!, pw_name = %s\n"</span>, ptr-&gt;pw_name<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org1fce263" class="outline-4">
<h4 id="org1fce263"><span class="done DONE">DONE</span> 10.14 <code>sigaction</code> Function</h4>
<div class="outline-text-4" id="text-org1fce263">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sigaction</span> <span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sigaction</span>* <span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">act</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sigaction</span>* <span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">oact</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, -1 on error</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sigaction</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5;">(</span>*<span style="color: #bc6ec5; font-weight: bold;">sa_handler</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #bc6ec5;">)</span>;       <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">addr of signal handler or SIG_IGN or SIG_DFL</span>

        <span style="color: #ce537a; font-weight: bold;">sigset_t</span> <span style="color: #7590db;">sa_mask</span>;               <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">addtional signals to block</span>
        <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">sa_flags</span>;                   <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">signal options, Figure 10.16</span>

        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">alternate handler</span>
        <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5;">(</span>*<span style="color: #bc6ec5; font-weight: bold;">sa_action</span><span style="color: #bc6ec5;">)(</span><span style="color: #ce537a; font-weight: bold;">int</span>, <span style="color: #ce537a; font-weight: bold;">siginfo_t</span> *, <span style="color: #ce537a; font-weight: bold;">void</span>*<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 8:</span> Figure 10.16 Option flags (sa_flags) for the handling of each signal</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Option</th>
<th scope="col" class="org-left">SUS</th>
<th scope="col" class="org-left">FreeBSD</th>
<th scope="col" class="org-left">Linux</th>
<th scope="col" class="org-left">Mac OSX</th>
<th scope="col" class="org-left">Solaris</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">SA_INTERRUPT</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">system call interrupted by this signal are not automatically restarted</td>
</tr>

<tr>
<td class="org-left">SA_NOCLDSTOP</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">SIGCHLD do not generate signal when a child process stops(job control).</td>
</tr>

<tr>
<td class="org-left">SA_NOCLDWAIT</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">SIGCHLD prevents the system call from creating process zombie processes</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">when children of the calling process terminate.</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">if the subsequently calls wait, the calling process blocks until all</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">its child processes have terminated and then returns -1 when errno set to ECHILD</td>
</tr>

<tr>
<td class="org-left">SA_NODEFER</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">signal is not automatically blocked by the system while the signao-catching function executes</td>
</tr>

<tr>
<td class="org-left">SA_ONSTACK</td>
<td class="org-left">XSI</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">if an alternative stack has been declared with <code>signalstack</code><sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup></td>
</tr>

<tr>
<td class="org-left">SA_RESETHAND</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">the disposition for this signal is reset to SIG_DFL, and the SA_SIGINFO flag is cleared</td>
</tr>

<tr>
<td class="org-left">SA_RESTART</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">system calls interrupted by this signal are automatically restarted</td>
</tr>

<tr>
<td class="org-left">SA_SIGINFO</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">provides additional information to a signal hander</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">normal signal handler</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">handler</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span>;

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">if SA_SIGINFO flag is set</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">handler</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span>, <span style="color: #ce537a; font-weight: bold;">siginfo_t</span> *<span style="color: #7590db;">info</span>, <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">context</span><span style="color: #4f97d7;">)</span>;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">siginfo</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">si_signo</span>;          <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">signal number</span>
        <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">si_errno</span>;          <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">if nonzero, errno value from errno.h</span>
        <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">si_code</span>;           <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">additional info (depends on signal)</span>
        <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">si_pid</span>;          <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">sending process ID</span>
        <span style="color: #ce537a; font-weight: bold;">uid_t</span> <span style="color: #7590db;">si_uid</span>;          <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">sending process real user ID</span>
        <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">si_addr</span>;         <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">address that caused the fault</span>
        <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">si_status</span>;         <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">exit value or signal number</span>
        <span style="color: #4f97d7; font-weight: bold;">union</span> <span style="color: #ce537a; font-weight: bold;">sigval</span> <span style="color: #7590db;">si_value</span>; <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">application-specific value</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">possibly other fields also</span>
<span style="color: #4f97d7;">}</span>;
<span style="color: #4f97d7; font-weight: bold;">union</span> <span style="color: #ce537a; font-weight: bold;">sigval</span> <span style="color: #4f97d7;">{</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">sival_int</span>; <span style="color: #ce537a; font-weight: bold;">void</span>* <span style="color: #7590db;">sival_ptr</span>; <span style="color: #4f97d7;">}</span>;

</pre>
</div>

<p>
<code>man sigaction</code> (linux)for details
</p>

<ul class="org-ul">
<li><p>
Example - <code>signal</code> function
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 75: </span>Figure 10.18 An implementation of signal using sigaction</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     10fig18.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-10-27</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    An implementation of signal using sigaction</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Reliable version of signal(), using POSIX sigaction().</span>

<span style="color: #ce537a; font-weight: bold;">Sigfunc</span> *<span style="color: #bc6ec5; font-weight: bold;">signal</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span>, <span style="color: #ce537a; font-weight: bold;">Sigfunc</span> *<span style="color: #7590db;">func</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sigaction</span> <span style="color: #7590db;">act</span>, <span style="color: #7590db;">oact</span>;

    act.sa_handler = func;
    sigemptyset<span style="color: #bc6ec5;">(</span>&amp;act.sa_mask<span style="color: #bc6ec5;">)</span>;
    act.sa_flags = <span style="color: #a45bad;">0</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signo == SIGALRM<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #2d9574;">(</span>SA_INTERRUPT<span style="color: #2d9574;">)</span>
        act.sa_flags |= SA_INTERRUPT;
<span style="color: #bc6ec5;">#endif</span>
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        act.sa_flags |= SA_RESTART;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigaction<span style="color: #2d9574;">(</span>signo, &amp;act, &amp;oact<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> SIG_ERR;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> oact.sa_handler;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
Example - <code>signal_intr</code> function
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 76: </span>Figure 10.19 The signal_intr function</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     10fig19.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-10-27</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    The signal_intr function</span>
<span style="color: #9f8766;"> *   tries to prevent any interrupted system calls from being restarted.</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">Sigfunc</span> *<span style="color: #bc6ec5; font-weight: bold;">signal_intr</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span>, <span style="color: #ce537a; font-weight: bold;">Sigfunc</span> *<span style="color: #7590db;">func</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sigaction</span> <span style="color: #7590db;">act</span>, <span style="color: #7590db;">oact</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>             <span style="color: #7590db;">signame</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">32</span><span style="color: #bc6ec5;">]</span> = <span style="color: #bc6ec5;">{</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">}</span>;

    psignal<span style="color: #bc6ec5;">(</span>signo, signame<span style="color: #bc6ec5;">)</span>;

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%s is caught\n"</span>, signame<span style="color: #bc6ec5;">)</span>;

    act.sa_handler = func;
    sigemptyset<span style="color: #bc6ec5;">(</span>&amp;act.sa_mask<span style="color: #bc6ec5;">)</span>;
    act.sa_flags = <span style="color: #a45bad;">0</span>;
<span style="color: #bc6ec5;">#ifdef</span> SA_INTERRUPT
    act.sa_flags |= SA_INTERRUPT;
<span style="color: #bc6ec5;">#endif</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigaction<span style="color: #2d9574;">(</span>signo, &amp;act, &amp;oact<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> SIG_ERR;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>oact.sa_handler<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-orgd64281d" class="outline-4">
<h4 id="orgd64281d"><span class="done DONE">DONE</span> 10.15 <code>sigsetjmp</code> and <code>siglongjmp</code> Functions</h4>
<div class="outline-text-4" id="text-orgd64281d">
<p>
These two functions should always be used when branching from a signal handler.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">setjmp.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sigsetjmp</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">sigjmp_buf</span> <span style="color: #7590db;">env</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">savemask</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if called directly, nonzero if returning from a call to siglongjmp</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">siglongjmp</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">sigjmp_buf</span> <span style="color: #7590db;">env</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">val</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 77: </span>Figure 10.20 Example of signal masks, sigsetjmp, and siglongjmp</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     10fig20.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-10-28</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Figure 10.20 Example of signal masks, sigsetjmp, and siglongjmp</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">setjmp.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">time.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span>                  <span style="color: #bc6ec5; font-weight: bold;">sig_usr1</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span>                  <span style="color: #bc6ec5; font-weight: bold;">sig_alrm</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">sigjmp_buf</span>            <span style="color: #7590db;">jmpbuf</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #4f97d7; font-weight: bold;">volatile</span> <span style="color: #ce537a; font-weight: bold;">sig_atomic_t</span> <span style="color: #7590db;">canjump</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGUSR1, sig_usr1<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"signal(SIGUSR1) error"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGALRM, sig_alrm<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"signal(SIGALRM) error"</span><span style="color: #bc6ec5;">)</span>;

    pr_mask<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"starting main: "</span><span style="color: #bc6ec5;">)</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Figure 10.14</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigsetjmp<span style="color: #2d9574;">(</span>jmpbuf, <span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        pr_mask<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"ending main: "</span><span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    canjump = <span style="color: #a45bad;">1</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>;;<span style="color: #bc6ec5;">)</span> pause<span style="color: #bc6ec5;">()</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_usr1</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">time_t</span> <span style="color: #7590db;">starttime</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>canjump == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span>;
    <span style="color: #bc6ec5;">}</span>

    pr_mask<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"starting sig_usr1: "</span><span style="color: #bc6ec5;">)</span>;

    alarm<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">3</span><span style="color: #bc6ec5;">)</span>;
    starttime = time<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>;;<span style="color: #bc6ec5;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>time<span style="color: #2d9574;">(</span><span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> &gt; starttime + <span style="color: #a45bad;">5</span><span style="color: #bc6ec5;">)</span> <span style="color: #4f97d7; font-weight: bold;">break</span>;

    pr_mask<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"finishing sig_usr1: "</span><span style="color: #bc6ec5;">)</span>;

    canjump = <span style="color: #a45bad;">0</span>;
    siglongjmp<span style="color: #bc6ec5;">(</span>jmpbuf, <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">jump back to main, don't return</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_alrm</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> pr_mask<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"in sig_alrm: "</span><span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>
</pre>
</div>

<blockquote>
<p>
If we change the program in Figure 10.20 so that the calls to sigsetjmp and siglongjmp are replaced with calls to setjmp and longjmp on Linux (or _setjmp and _longjmp on FreeBSD), the final line of output becomes
</p>

<p>
ending main: SIGUSR1
</p>

<p>
This means that the main function is executing with the SIGUSR1 signal blocked, after the call to setjmp.
</p>
</blockquote></li>
</ul>
</div>
</div>

<div id="outline-container-orgd1af33b" class="outline-4">
<h4 id="orgd1af33b"><span class="done DONE">DONE</span> 10.16 <code>sigsuspend</code> Function</h4>
<div class="outline-text-4" id="text-orgd1af33b">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sigsuspend</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">sigset_t</span> *<span style="color: #7590db;">sigmask</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: &#8722;1 with errno set to EINTR</span>
</pre>
</div>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 78: </span>Figure 10.22 Protecting a critical region from a signal</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     10fig22.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-10-28</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Protecting a critical region from a signal</span>
<span style="color: #9f8766;"> *   the correct way to protect a critical region of code from a speci&#64257;c signal.</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_int</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">sigset_t</span> <span style="color: #7590db;">newmask</span>, <span style="color: #7590db;">oldmask</span>, <span style="color: #7590db;">waitmask</span>;

    pr_mask<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"program start: "</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGINT, sig_int<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"signal(SIGINT) error"</span><span style="color: #bc6ec5;">)</span>;

    sigemptyset<span style="color: #bc6ec5;">(</span>&amp;waitmask<span style="color: #bc6ec5;">)</span>;
    sigaddset<span style="color: #bc6ec5;">(</span>&amp;waitmask, SIGUSR1<span style="color: #bc6ec5;">)</span>;
    sigemptyset<span style="color: #bc6ec5;">(</span>&amp;newmask<span style="color: #bc6ec5;">)</span>;
    sigaddset<span style="color: #bc6ec5;">(</span>&amp;newmask, SIGINT<span style="color: #bc6ec5;">)</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">block SIGINT and save current signal mask</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigprocmask<span style="color: #2d9574;">(</span>SIG_BLOCK, &amp;newmask, &amp;oldmask<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"SIG_BLOCK error"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">critical region of code</span>
    pr_mask<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"in critical region: "</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">pause, allowing all signals except SIGUSR1</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigsuspend<span style="color: #2d9574;">(</span>&amp;waitmask<span style="color: #2d9574;">)</span> != -<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"sigsuspend error"</span><span style="color: #bc6ec5;">)</span>;

    pr_mask<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"after return from sigsuspend"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">reset signal mask which unblock SIGINT</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigprocmask<span style="color: #2d9574;">(</span>SIG_SETMASK, &amp;oldmask, <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"SIG_SETMASK error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">and continue processing...</span>
    pr_mask<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"program exit: "</span><span style="color: #bc6ec5;">)</span>;
    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_int</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> pr_mask<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\nin sig_int: "</span><span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 79: </span>Figure 10.23 Using sigsuspend to wait for a global variable to be set</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     10fig23.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-10-28</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    wait for a signal handler to set a global variable</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> *  catch both the interrupt signal and the quit signal,</span>
<span style="color: #9f8766;"> *  but want to wake up the main routine only when the quit signal is caught.</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>
<span style="color: #4f97d7; font-weight: bold;">volatile</span> <span style="color: #ce537a; font-weight: bold;">sig_atomic_t</span> <span style="color: #7590db;">quitflag</span>;

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">one signal handler for SIGINT and SIGQUIT</span>
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_int</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signo == SIGINT<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\ninterrupt\n"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signo == SIGQUIT<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        quitflag = <span style="color: #a45bad;">1</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">set flag for main loop</span>
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">sigset_t</span> <span style="color: #7590db;">newmask</span>, <span style="color: #7590db;">oldmask</span>, <span style="color: #7590db;">zeromask</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGINT, sig_int<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"signal(SIGINT) error"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGQUIT, sig_int<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"signal(SIGQUIT) error"</span><span style="color: #bc6ec5;">)</span>;

    sigemptyset<span style="color: #bc6ec5;">(</span>&amp;zeromask<span style="color: #bc6ec5;">)</span>;
    sigemptyset<span style="color: #bc6ec5;">(</span>&amp;newmask<span style="color: #bc6ec5;">)</span>;
    sigaddset<span style="color: #bc6ec5;">(</span>&amp;newmask, SIGQUIT<span style="color: #bc6ec5;">)</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">block SIGQUIT and save current signal mask.</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigprocmask<span style="color: #2d9574;">(</span>SIG_BLOCK, &amp;newmask, &amp;oldmask<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"SIG_BLOCK error"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span>quitflag == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> sigsuspend<span style="color: #bc6ec5;">(</span>&amp;zeromask<span style="color: #bc6ec5;">)</span>;

    quitflag = <span style="color: #a45bad;">0</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigprocmask<span style="color: #2d9574;">(</span>SIG_SETMASK, &amp;oldmask, <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"SIG_SETMASK error"</span><span style="color: #bc6ec5;">)</span>;

    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 80: </span>Figure 10.24 Routines to allow a parent and child to synchronize</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     10fig24.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-10-28</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Routines to allow a parent and child to synchronize</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> *  show how signals can be used to synchronize a parent and child.</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #4f97d7; font-weight: bold;">volatile</span> <span style="color: #ce537a; font-weight: bold;">sig_atomic_t</span> <span style="color: #7590db;">sigflag</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">set nonzero by sig handler</span>
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">sigset_t</span>              <span style="color: #7590db;">newmask</span>, <span style="color: #7590db;">oldmask</span>, <span style="color: #7590db;">zeromask</span>;

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">one signal handler for SIGUSR1 and SIGUSR2</span>
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_usr</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> sigflag = <span style="color: #a45bad;">1</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">TELL_WAIT</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGUSR1, sig_usr<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"signal(SIGUSR1) error"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGUSR2, sig_usr<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"signal(SIGUSR2) error"</span><span style="color: #bc6ec5;">)</span>;

    sigemptyset<span style="color: #bc6ec5;">(</span>&amp;zeromask<span style="color: #bc6ec5;">)</span>;
    sigemptyset<span style="color: #bc6ec5;">(</span>&amp;newmask<span style="color: #bc6ec5;">)</span>;
    sigaddset<span style="color: #bc6ec5;">(</span>&amp;newmask, SIGUSR1<span style="color: #bc6ec5;">)</span>;
    sigaddset<span style="color: #bc6ec5;">(</span>&amp;newmask, SIGUSR2<span style="color: #bc6ec5;">)</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">block SIGUSR1 and SIGUSR2, and save current signal mask</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigprocmask<span style="color: #2d9574;">(</span>SIG_BLOCK, &amp;newmask, &amp;oldmask<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"SIG_BLOCK error"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">TELL_PARENT</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> kill<span style="color: #bc6ec5;">(</span>pid, SIGUSR2<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">WAIT_PARENT</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span>sigflag == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> sigsuspend<span style="color: #bc6ec5;">(</span>&amp;zeromask<span style="color: #bc6ec5;">)</span>;

    sigflag = <span style="color: #a45bad;">0</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigprocmask<span style="color: #2d9574;">(</span>SIG_SETMASK, &amp;oldmask, <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"SIG_SETMASK error"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">TELL_CHILD</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> kill<span style="color: #bc6ec5;">(</span>pid, SIGUSR1<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">WAIT_CHILD</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span>sigflag == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> sigsuspend<span style="color: #bc6ec5;">(</span>&amp;zeromask<span style="color: #bc6ec5;">)</span>;
    sigflag = <span style="color: #a45bad;">0</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigprocmask<span style="color: #2d9574;">(</span>SIG_SETMASK, &amp;oldmask, <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"SIG_SETMASK error"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>

<blockquote>
<ol class="org-ol">
<li>Block SIGINT and SIGALRM.</li>

<li>Test the two global variables to see whether either signal has occurred and, if so, handle the condition.</li>

<li>Call read (or any other system function) and unblock the two signals, as an atomic operation.</li>
</ol>

<p>
The sigsuspend function helps us only if step 3 is a pause operation.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org93398c1" class="outline-4">
<h4 id="org93398c1"><span class="done DONE">DONE</span> 10.17 <code>abort</code> Function</h4>
<div class="outline-text-4" id="text-org93398c1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">abort</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 81: </span>Figure 10.25 Implementation of POSIX.1 <code>abort</code></label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     10fig25.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-10-28</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Implementation of POSIX.1 abort</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">POSIX-style abort() function</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">abort</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">sigset_t</span>         <span style="color: #7590db;">mask</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sigaction</span> <span style="color: #7590db;">action</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">caller can't ignore SIGABRT, if so reset to defautl</span>
    sigaction<span style="color: #bc6ec5;">(</span>SIGABRT, <span style="color: #a45bad;">NULL</span>, &amp;action<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>action.sa_handler == SIG_IGN<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        action.sa_handler = SIG_DFL;
        sigaction<span style="color: #2d9574;">(</span>SIGABRT, &amp;action, <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>action.sa_handler == SIG_DFL<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        fflush<span style="color: #2d9574;">(</span><span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">flush all open stdio streams</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">caller can't block SIGABRT; make sure it's unblocked</span>
    sigfillset<span style="color: #bc6ec5;">(</span>&amp;mask<span style="color: #bc6ec5;">)</span>;
    sigdelset<span style="color: #bc6ec5;">(</span>&amp;mask, SIGABRT<span style="color: #bc6ec5;">)</span>;
    sigprocmask<span style="color: #bc6ec5;">(</span>SIG_SETMASK, &amp;mask, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    kill<span style="color: #bc6ec5;">(</span>getpid<span style="color: #2d9574;">()</span>, SIGABRT<span style="color: #bc6ec5;">)</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">if we're here, process caught SIGABRT and returned</span>
    fflush<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    action.sa_handler = SIG_DFL;
    sigaction<span style="color: #bc6ec5;">(</span>SIG_DFL, &amp;action, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    sigprocmask<span style="color: #bc6ec5;">(</span>SIG_SETMASK, &amp;mask, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    kill<span style="color: #bc6ec5;">(</span>getpid<span style="color: #2d9574;">()</span>, SIGABRT<span style="color: #bc6ec5;">)</span>;
    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb8ab86c" class="outline-4">
<h4 id="orgb8ab86c"><span class="done DONE">DONE</span> 10.18 <code>system</code> Function</h4>
<div class="outline-text-4" id="text-orgb8ab86c">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 82: </span>Figure 10.26 Using <code>system</code> to invoke the <code>ed</code> editor</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     10fig26.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-10-28</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Using system to invoke the ed editor</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_int</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"caught SIGINT\n"</span><span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_chld</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"caught SIGCHLD\n"</span><span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGINT, sig_int<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"signal(SIGINT) error"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGCHLD, sig_chld<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"signal(SIGCHLD) error"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>system<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"/bin/ed"</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"system() error"</span><span style="color: #bc6ec5;">)</span>;

    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>


<div id="orge2be095" class="figure">
<p><img src="Chapter10/10fig27.jpg" alt="10fig27.jpg" />
</p>
<p><span class="figure-number">Figure 20: </span>Figure 10.27 Foreground and background process groups for Figure 10.26</p>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 83: </span>Figure 10.28 Correct POSIX.1 implementation of <code>system</code> function</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     10fig28.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-10-28</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Correct POSIX.1 implementation of system function</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> *  implementation of the system function with the required signal handling</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">with appropriate signal handling</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">system</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">cmdstring</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span>            <span style="color: #7590db;">pid</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>              <span style="color: #7590db;">status</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sigaction</span> <span style="color: #7590db;">ignore</span>, <span style="color: #7590db;">saveintr</span>, <span style="color: #7590db;">savequit</span>;
    <span style="color: #ce537a; font-weight: bold;">sigset_t</span>         <span style="color: #7590db;">chldmask</span>, <span style="color: #7590db;">savemask</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>cmdstring == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">always a command processor with UNIX</span>
    <span style="color: #bc6ec5;">}</span>

    ignore.sa_handler = SIG_IGN;
    sigemptyset<span style="color: #bc6ec5;">(</span>&amp;ignore.sa_mask<span style="color: #bc6ec5;">)</span>;
    ignore.sa_flags = <span style="color: #a45bad;">0</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigaction<span style="color: #2d9574;">(</span>SIGINT, &amp;ignore, &amp;saveintr<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>-<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigaction<span style="color: #2d9574;">(</span>SIGQUIT, &amp;ignore, &amp;savequit<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>-<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;

    sigemptyset<span style="color: #bc6ec5;">(</span>&amp;chldmask<span style="color: #bc6ec5;">)</span>;
    sigaddset<span style="color: #bc6ec5;">(</span>&amp;chldmask, SIGCHLD<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigprocmask<span style="color: #2d9574;">(</span>SIG_BLOCK, &amp;chldmask, &amp;savemask<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>-<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        status = -<span style="color: #a45bad;">1</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">restore previous signal actions &amp; reset signal mask</span>
        sigaction<span style="color: #2d9574;">(</span>SIGINT, &amp;saveintr, <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span>;
        sigaction<span style="color: #2d9574;">(</span>SIGQUIT, &amp;savequit, <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span>;
        sigprocmask<span style="color: #2d9574;">(</span>SIG_SETMASK, &amp;savemask, <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span>;

        execl<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"/bin/sh"</span>, <span style="color: #2d9574;">"sh"</span>, <span style="color: #2d9574;">"-c"</span>, cmdstring, <span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #67b11d;">)</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>;
        _exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">127</span><span style="color: #2d9574;">)</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">exec error</span>
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #2d9574;">(</span>waitpid<span style="color: #67b11d;">(</span>pid, &amp;status, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>errno != EINTR<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                status = -<span style="color: #a45bad;">1</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">error other than EINTR from waitpid()</span>
                <span style="color: #4f97d7; font-weight: bold;">break</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">restore previous signal actions &amp; reset signal mask</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigaction<span style="color: #2d9574;">(</span>SIGINT, &amp;saveintr, <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>-<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigaction<span style="color: #2d9574;">(</span>SIGQUIT, &amp;savequit, <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>-<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigprocmask<span style="color: #2d9574;">(</span>SIG_SETMASK, &amp;savemask, <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>-<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>status<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5bfd396" class="outline-4">
<h4 id="org5bfd396"><span class="done DONE">DONE</span> 10.19 <code>sleep</code>, <code>nanaosleep</code>, and <code>clock_nanosleep</code> Functions</h4>
<div class="outline-text-4" id="text-org5bfd396">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sleep</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">seconds</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 or number of unslept seconds</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 84: </span>Figure 10.29 Reliable implementation of <code>sleep</code></label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     10.29.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-10-28</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Implementation of the POSIX.1 sleep function</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> *  modification of figure 10.17, hands signals reliably</span>
<span style="color: #9f8766;"> *  avoiding the race condition in the earlier implementation</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_alrm</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">nothing to do, just return wakes up sigsuspend()</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sleep</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">seconds</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sigaction</span> <span style="color: #7590db;">newact</span>, <span style="color: #7590db;">oldact</span>;
    <span style="color: #ce537a; font-weight: bold;">sigset_t</span>         <span style="color: #7590db;">newmask</span>, <span style="color: #7590db;">oldmask</span>, <span style="color: #7590db;">suspmask</span>;
    <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span>     <span style="color: #7590db;">unslept</span>;

    newact.sa_handler = sig_alrm;
    sigemptyset<span style="color: #bc6ec5;">(</span>&amp;newact.sa_mask<span style="color: #bc6ec5;">)</span>;
    newact.sa_flags = <span style="color: #a45bad;">0</span>;
    sigaction<span style="color: #bc6ec5;">(</span>SIGALRM, &amp;newact, &amp;oldact<span style="color: #bc6ec5;">)</span>;

    sigemptyset<span style="color: #bc6ec5;">(</span>&amp;newmask<span style="color: #bc6ec5;">)</span>;
    sigaddset<span style="color: #bc6ec5;">(</span>&amp;newmask, SIGALRM<span style="color: #bc6ec5;">)</span>;
    sigprocmask<span style="color: #bc6ec5;">(</span>SIG_BLOCK, &amp;newmask, &amp;oldmask<span style="color: #bc6ec5;">)</span>;

    alarm<span style="color: #bc6ec5;">(</span>seconds<span style="color: #bc6ec5;">)</span>;
    suspmask = oldmask;

    sigdelset<span style="color: #bc6ec5;">(</span>&amp;suspmask, SIGALRM<span style="color: #bc6ec5;">)</span>;

    sigsuspend<span style="color: #bc6ec5;">(</span>&amp;suspmask<span style="color: #bc6ec5;">)</span>;

    unslept = alarm<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;

    sigaction<span style="color: #bc6ec5;">(</span>SIGALRM, &amp;oldact, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;

    sigprocmask<span style="color: #bc6ec5;">(</span>SIG_SETMASK, &amp;oldmask, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>unslept<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">time.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">clock_nanosleep</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">clockid_t</span> <span style="color: #7590db;">clock_id</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">flags</span>,
                    <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span>* <span style="color: #7590db;">reqtp</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span>* <span style="color: #7590db;">remtp</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if slept for requested time or error number on failue</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org42c5fa3" class="outline-4">
<h4 id="org42c5fa3"><span class="done DONE">DONE</span> 10.20 <code>sigqueue</code> Function</h4>
<div class="outline-text-4" id="text-org42c5fa3">
<ul class="org-ul">
<li>Specify the SA_SIGINFO flag when we install a signal handler using the sigaction function</li>

<li>Provide a signal handler in the sa_sigaction member of the sigaction structure instead of using the usual sa_handler field.</li>

<li><p>
Use the sigqueue function to send signals.
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sigqueue</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">union</span> <span style="color: #ce537a; font-weight: bold;">sigval</span> <span style="color: #7590db;">value</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, -1 on error</span>
</pre>
</div>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 9:</span> Figure 10.30 Behavior of queued signals on various platforms</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Behavior</th>
<th scope="col" class="org-left">SUS</th>
<th scope="col" class="org-left">FreeBSD8.0</th>
<th scope="col" class="org-left">Linux3.2.0</th>
<th scope="col" class="org-left">Mac OSX</th>
<th scope="col" class="org-left">Solaris</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">supports sigqueue</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
</tr>

<tr>
<td class="org-left">queues other signals besides SIGRTMIN to SIGRTMAX</td>
<td class="org-left">optional</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
</tr>

<tr>
<td class="org-left">queues signals even if the caller don't use the SA_SIGINFO flags</td>
<td class="org-left">optional</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table></li>
</ul>
</div>
</div>

<div id="outline-container-org6a11967" class="outline-4">
<h4 id="org6a11967"><span class="done DONE">DONE</span> 10.21 Job-Control Signals</h4>
<div class="outline-text-4" id="text-org6a11967">
<p>
job-control signals:
SIGCHLD   Child process has stopped or terminated
SIGCONT   Continue process, if stopped.
SIGSTOP   Stop signal(can't caught or ignored)
SIGTSTP   Interactive stop signal.
SIGTTIN   Read from controlling terminately by background process group number
SIGTTOU   Write to controlling terminal by a background process group member
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 85: </span>Figure 10.31 How to handle SIGTSTP</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     10fig31.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-10-28</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    How to handle SIGTSTP</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">BUFFSIZE</span> <span style="color: #a45bad;">1024</span>

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">signal handler to SIGTSTP</span>
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_tstp</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">sigset_t</span> <span style="color: #7590db;">mask</span>;

    sigemptyset<span style="color: #bc6ec5;">(</span>&amp;mask<span style="color: #bc6ec5;">)</span>;
    sigaddset<span style="color: #bc6ec5;">(</span>&amp;mask, SIGTSTP<span style="color: #bc6ec5;">)</span>;
    sigprocmask<span style="color: #bc6ec5;">(</span>SIG_UNBLOCK, &amp;mask, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;

    signal<span style="color: #bc6ec5;">(</span>SIGTSTP, SIG_DFL<span style="color: #bc6ec5;">)</span>;
    kill<span style="color: #bc6ec5;">(</span>getpid<span style="color: #2d9574;">()</span>, SIGTSTP<span style="color: #bc6ec5;">)</span>;

    signal<span style="color: #bc6ec5;">(</span>SIGTSTP, sig_tstp<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>  <span style="color: #7590db;">n</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span>BUFFSIZE<span style="color: #bc6ec5;">]</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGTSTP, SIG_IGN<span style="color: #2d9574;">)</span> == SIG_DFL<span style="color: #bc6ec5;">)</span> signal<span style="color: #bc6ec5;">(</span>SIGTSTP, sig_tstp<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>n = read<span style="color: #67b11d;">(</span>STDIN_FILENO, buf, BUFFSIZE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>write<span style="color: #2d9574;">(</span>STDOUT_FILENO, buf, n<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"write error"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>n &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"read error"</span><span style="color: #bc6ec5;">)</span>;
    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc31fbb3" class="outline-4">
<h4 id="orgc31fbb3"><span class="done DONE">DONE</span> 10.22 Signal Names and Numbers</h4>
<div class="outline-text-4" id="text-orgc31fbb3">
<p>
map between signal numbers and names.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">sys_siglist</span><span style="color: #4f97d7;">[]</span>;
</pre>
</div>

<p>
in a portable manner
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">psignal</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">msg</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>

<p>
print signal information
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">psiginfo</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">siginfo_t</span>* <span style="color: #7590db;">info</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">msg</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>

<p>
string description of the signal and don't necessarily wnat to write it to standard error
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">string.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #bc6ec5; font-weight: bold;">strsignal</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: a pointer to a string describing the signal</span>
</pre>
</div>

<p>
<b>Solaris provides</b>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sig2str</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">str</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">str2sig</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">str</span>, <span style="color: #ce537a; font-weight: bold;">int</span> *<span style="color: #7590db;">signop</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, -1 on error</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc9671f4" class="outline-4">
<h4 id="orgc9671f4"><span class="done DONE">DONE</span> 10.23 Summary</h4>
<div class="outline-text-4" id="text-orgc9671f4">
<ul class="org-ul">
<li>Exercises

<ul class="org-ul">
<li><p>
10.1
</p>

<blockquote>
<p>
terminates the first time
<code>pause</code> until a signal is received from either the kill(2) function or an interval timer
</p>
</blockquote></li>

<li><p>
10.2
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     10ex02.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-10-28</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    example code for 10.2</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sig2str</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">str</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signo &lt;= <span style="color: #a45bad;">0</span> || signo &gt;= NSIG<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
    <span style="color: #bc6ec5;">}</span>
    snprintf<span style="color: #bc6ec5;">(</span>str, SIG2STR_MAX, <span style="color: #2d9574;">"%s"</span>, sys_siglist<span style="color: #2d9574;">[</span>signo<span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
10.3
</p>


<div id="orge0e1953" class="figure">
<p><a href="Chapter10/10ex03.png"><img src="file:///home/zhoushang/Documents/Notes/books/system/APUE/Chapter10/10ex03.png" alt="10ex03.png" /></a>
</p>
</div></li>

<li><p>
10.4
</p>

<p>
race condition between first call <code>alarm</code> and <code>setjmp</code>
</p></li>

<li><p>
10.5
</p>

<p>
<a href="http://www.kohala.com/start/libes.timers.txt">www.kohala.com/start/libes.timers.txt</a>
</p></li>

<li><p>
10.6
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     exx10.6.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-10-29</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    test figure 10.24</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span> = fopen<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"a.txt"</span>, <span style="color: #2d9574;">"w+"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">num</span> = <span style="color: #a45bad;">0</span>;

    fwrite<span style="color: #bc6ec5;">(</span>&amp;num, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>num<span style="color: #2d9574;">)</span>, <span style="color: #a45bad;">1</span>, fp<span style="color: #bc6ec5;">)</span>;

    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span> = fork<span style="color: #bc6ec5;">()</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">fread(&amp;num, sizeof(num), 1, fp);</span>
        ++num;
        fwrite<span style="color: #2d9574;">(</span>&amp;num, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span>num<span style="color: #67b11d;">)</span>, <span style="color: #a45bad;">1</span>, fp<span style="color: #2d9574;">)</span>;
        fprintf<span style="color: #2d9574;">(</span>stdout, <span style="color: #2d9574;">"child process: %d\n"</span>, num<span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span>EXIT_SUCCESS<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">fread(&amp;num, sizeof(num), 1, fp);</span>
    ++num;
    fwrite<span style="color: #bc6ec5;">(</span>&amp;num, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>num<span style="color: #2d9574;">)</span>, <span style="color: #a45bad;">1</span>, fp<span style="color: #bc6ec5;">)</span>;
    fprintf<span style="color: #bc6ec5;">(</span>stdout, <span style="color: #2d9574;">"parent process: %d\n"</span>, num<span style="color: #bc6ec5;">)</span>;

    fclose<span style="color: #bc6ec5;">(</span>fp<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
10.7
</p>

<blockquote>
<p>
the termination status of the process would not show that it was terminated by the SIGABRT signal.
</p>
</blockquote></li>

<li><p>
10.8
</p>

<blockquote>
<p>
If the signal was sent by a process owned by some other user, the process has to be set-user-ID to either root or to the owner of the receiving process, or the kill attempt won’t work. Therefore, the real user ID provides more information to the receiver of the signal.
</p>
</blockquote></li>

<li><p>
10.9
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     10fig14.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-10-27</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Print the signal mask for the process</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> *   shows a function that prints the names of the signals in the signal mask of</span>
<span style="color: #9f8766;"> * the calling process.</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#if</span><span style="color: #bc6ec5;">n</span><span style="color: #bc6ec5;">def</span> NSIG
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">NSIG</span> <span style="color: #a45bad;">32</span>
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">pr_mask</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">str</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">sigset_t</span> <span style="color: #7590db;">sigset</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>      <span style="color: #7590db;">errno_save</span>;

    errno_save = errno;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">we can be canceld by signal handlers</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigprocmask<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span>, <span style="color: #a45bad;">NULL</span>, &amp;sigset<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_ret<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"sigprocmask error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s"</span>, str<span style="color: #2d9574;">)</span>;

        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span> = <span style="color: #a45bad;">1</span>; signo &lt; NSIG; ++signo<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>sigismember<span style="color: #b1951d;">(</span>&amp;sigset, signo<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                printf<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"%s "</span>, strdup<span style="color: #4f97d7;">(</span>strsignal<span style="color: #bc6ec5;">(</span>signo<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>

        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\n"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    errno = errno_save;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span> pr_mask<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"starting main"</span><span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
10.10
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     10ex10.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-11-03</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">spawn.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">time.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">log_to_stderr</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">cron</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    log_to_stderr = <span style="color: #a45bad;">0</span>;
    log_open<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"10ex10"</span>, <span style="color: #a45bad;">0</span>, <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">i</span> = <span style="color: #a45bad;">0</span>;; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>i % <span style="color: #a45bad;">5</span> == <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #ce537a; font-weight: bold;">time_t</span>    <span style="color: #7590db;">t</span>  = time<span style="color: #67b11d;">(</span><span style="color: #a45bad;">NULL</span><span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">tm</span> <span style="color: #7590db;">st</span> = <span style="color: #67b11d;">{}</span>;

            localtime_r<span style="color: #67b11d;">(</span>&amp;t, &amp;st<span style="color: #67b11d;">)</span>;
            log_msg<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"time_of day: %02d:%02d:%02d"</span>, st.tm_hour, st.tm_min,
                    st.tm_sec<span style="color: #67b11d;">)</span>;
            log_msg<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"tm_sec: %d"</span>, st.tm_sec<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        sleep<span style="color: #2d9574;">(</span><span style="color: #a45bad;">60</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span>, <span style="color: #ce537a; font-weight: bold;">char</span> **<span style="color: #7590db;">env</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span> = <span style="color: #a45bad;">0</span>;
    daemonize<span style="color: #bc6ec5;">(</span>argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span>;
    cron<span style="color: #bc6ec5;">()</span>;
    exit<span style="color: #bc6ec5;">(</span>EXIT_SUCCESS<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
10.11
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/resource.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/stat.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">BUFFSIZ</span> <span style="color: #a45bad;">10</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>  <span style="color: #7590db;">n</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>  <span style="color: #7590db;">ret</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span>BUFFSIZ<span style="color: #bc6ec5;">]</span>;

    signal<span style="color: #bc6ec5;">(</span>SIGXFSZ, signal_intr<span style="color: #bc6ec5;">)</span>;

    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">in</span>  = open<span style="color: #bc6ec5;">(</span>argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>, O_RDONLY<span style="color: #bc6ec5;">)</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">out</span> = open<span style="color: #bc6ec5;">(</span>argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">2</span><span style="color: #2d9574;">]</span>, O_CREAT | O_RDWR, <span style="color: #a45bad;">0644</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">rlimit</span> <span style="color: #7590db;">r</span> = <span style="color: #bc6ec5;">{</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">}</span>;
    r.rlim_max      = <span style="color: #a45bad;">12</span>;
    setrlimit<span style="color: #bc6ec5;">(</span>RLIMIT_FSIZE, &amp;r<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>n = read<span style="color: #67b11d;">(</span>in, buf, BUFFSIZ<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>ret = write<span style="color: #b1951d;">(</span>out, buf, n<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> != n<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">err_sys("write error: %d", ret);</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"%d write\n"</span>, ret<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    close<span style="color: #bc6ec5;">(</span>in<span style="color: #bc6ec5;">)</span>;
    close<span style="color: #bc6ec5;">(</span>out<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>n &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"read error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
SIGXFSZ never caught
</p></li>

<li><p>
10.12
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     10ex02.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-10-28</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    example code for 10.2</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sig2str</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">str</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signo &lt;= <span style="color: #a45bad;">0</span> || signo &gt;= NSIG<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
    <span style="color: #bc6ec5;">}</span>
    snprintf<span style="color: #bc6ec5;">(</span>str, SIG2STR_MAX, <span style="color: #2d9574;">"%s"</span>, sys_siglist<span style="color: #2d9574;">[</span>signo<span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
finished, alarm appears until fwrite finshied, it seems the kernel is blocking SIGALRM
</p></li>
</ul></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org62b8cc4" class="outline-3">
<h3 id="org62b8cc4"><span class="done DONE">DONE</span> Chapter 11. Threads <code>[7/7]</code></h3>
<div class="outline-text-3" id="text-org62b8cc4">
</div>

<div id="outline-container-orga54e664" class="outline-4">
<h4 id="orga54e664"><span class="done DONE">DONE</span> 11.1 Introduction</h4>
<div class="outline-text-4" id="text-orga54e664">
</div>
</div>

<div id="outline-container-orgab89991" class="outline-4">
<h4 id="orgab89991"><span class="done DONE">DONE</span> 11.2 Thread Concepts</h4>
<div class="outline-text-4" id="text-orgab89991">
<p>
便利：
</p>
<ul class="org-ul">
<li>通过分配单独的线程处理不同的事件类型来简化处理异步事件的代码</li>
<li>多进程需要复杂的技术共享内存和文件描述符。而线程具有相同的内存地址和文件描述符</li>
<li>可以对一些整体问题进行分区以提高吞吐量</li>
<li>交互式程序可以通过多线程区分用户输入和输出以提高响应时间</li>
</ul>
</div>
</div>

<div id="outline-container-org90fd1f2" class="outline-4">
<h4 id="org90fd1f2"><span class="done DONE">DONE</span> 11.3 Thread Identification</h4>
<div class="outline-text-4" id="text-org90fd1f2">
<p>
每一个线程都有一个线程ID。不同于进程ID在系统中唯一，线程ID只有在所属进程中有意义。
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;"> compare two thread</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> tid1     1st thread ID</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> tid2     2nd thread ID</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;"> nonzero if equal, 0 otherwise</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_equal</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_t</span> <span style="color: #7590db;">tid1</span>, <span style="color: #ce537a; font-weight: bold;">pthread_t</span> <span style="color: #7590db;">tid2</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>

<p>
obtain its own thread ID :
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;"> obtain thread's ID</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;"> the thread ID of the calling thread</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">pthread_t</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_self</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org2c4ec82" class="outline-4">
<h4 id="org2c4ec82"><span class="done DONE">DONE</span> 11.4 Thread Creation</h4>
<div class="outline-text-4" id="text-org2c4ec82">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;"> create thread</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> tidp       the pointer to store thread ID</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> attr       specified attributes</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> start_rtn  function for thread calling</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> arg        for start_rtn</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;"> 0 if OK, error number on failure</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_create</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">tidp</span>,
                   <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">pthread_attr_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">attr</span>,
                   <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5;">(</span>*<span style="color: #bc6ec5; font-weight: bold;">start_rtn</span><span style="color: #bc6ec5;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span>*<span style="color: #bc6ec5;">)</span>,
                   <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>


<div id="org50ab256" class="figure">
<p><img src="Chapter11/11fig01.jpg" alt="11fig01.jpg" />
</p>
<p><span class="figure-number">Figure 21: </span>Figure 11.1 Work queue example</p>
</div>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 86: </span>Figure 11.2 Printing thread IDs</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">pthread_t</span> <span style="color: #7590db;">ntid</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">printids</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">s</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span>     <span style="color: #7590db;">pid</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_t</span> <span style="color: #7590db;">tid</span>;

    pid = getpid<span style="color: #bc6ec5;">()</span>;
    tid = pthread_self<span style="color: #bc6ec5;">()</span>;

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%s pid %lu tid %lu (0x%lx)\n"</span>, s, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>pid,
           <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>tid, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>tid<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>


<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">thr_fn</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printids<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"new thread: "</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">err</span>;

    pthread_create<span style="color: #bc6ec5;">(</span>&amp;ntid, <span style="color: #a45bad;">NULL</span>, thr_fn, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't creat thread"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    printids<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"main thread: "</span><span style="color: #bc6ec5;">)</span>;
    sleep<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org56ee833" class="outline-4">
<h4 id="org56ee833"><span class="done DONE">DONE</span> 11.5 Thread Termination</h4>
<div class="outline-text-4" id="text-org56ee833">
<ol class="org-ol">
<li>线程可以简单地从启动程序退出，返回值即线程返回码</li>
<li>线程可以被进程内另一线程终止</li>
<li>可以调用 <code>pthread_exit</code></li>
</ol>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_exit</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">rval_ptr</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_join</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_t</span> <span style="color: #7590db;">thread</span>, <span style="color: #ce537a; font-weight: bold;">void</span> **<span style="color: #7590db;">rval_ptr</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
<blockquote>
<p>
The calling thread will block until the specified thread calls pthread_exit, returns from its start routine, or is canceled.
</p>
</blockquote>

<blockquote>
<p>
<b>The Linux Programming Language:</b>
If the main thread calls pthread_exit() instead of calling exit() or performing a return, then the other threads continue to execute.
</p>
</blockquote>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 87: </span>Figure 11.3 Fetching the thread exit status</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">thr_fn1</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"thread 1 returning\n"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">thr_fn2</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"thread 2 returning\n"</span><span style="color: #bc6ec5;">)</span>;
    pthread_exit<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span><span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>       <span style="color: #7590db;">err</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_t</span> <span style="color: #7590db;">tid1</span>, <span style="color: #7590db;">tid2</span>;
    <span style="color: #ce537a; font-weight: bold;">void</span> *    <span style="color: #7590db;">tret</span>;

    err = pthread_create<span style="color: #bc6ec5;">(</span>&amp;tid1, <span style="color: #a45bad;">NULL</span>, thr_fn1, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't create thread1"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    err = pthread_create<span style="color: #bc6ec5;">(</span>&amp;tid2, <span style="color: #a45bad;">NULL</span>, thr_fn2, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't create thread2"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    err = pthread_join<span style="color: #bc6ec5;">(</span>tid1, &amp;tret<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't join thread1"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"thread 1 exit code %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>tret<span style="color: #bc6ec5;">)</span>;
    err = pthread_join<span style="color: #bc6ec5;">(</span>tid2, &amp;tret<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't join thread2"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"thread 2 exit code %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>tret<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 88: </span>Figure 11.4 Incorrect use of <code>pthread_exit</code> argument</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     11fig04.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-11-05</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Figure 11.4</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> *  shows the problem with using an automatic variable (allocated on the stack)</span>
<span style="color: #9f8766;"> * as the argument to pthread_exit.</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">a</span>, <span style="color: #7590db;">b</span>, <span style="color: #7590db;">c</span>, <span style="color: #7590db;">d</span>;
<span style="color: #4f97d7;">}</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">printfoo</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">s</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%s"</span>, s<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">" structure at 0x%lx\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>fp<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">" foo.a = %d\n"</span>, fp-&gt;a<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">" foo.b = %d\n"</span>, fp-&gt;b<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">" foo.c = %d\n"</span>, fp-&gt;c<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">" foo.d = %d\n"</span>, fp-&gt;d<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">thr_fn1</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> <span style="color: #7590db;">foo</span> = <span style="color: #bc6ec5;">{</span><span style="color: #a45bad;">1</span>, <span style="color: #a45bad;">2</span>, <span style="color: #a45bad;">3</span>, <span style="color: #a45bad;">4</span><span style="color: #bc6ec5;">}</span>;
    printfoo<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"thread 1:\n"</span>, &amp;foo<span style="color: #bc6ec5;">)</span>;
    pthread_exit<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span>&amp;foo<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">thr_fn2</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"thread 2: ID is %lu\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>pthread_self<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span>;
    pthread_exit<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>         <span style="color: #7590db;">err</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_t</span>   <span style="color: #7590db;">tid1</span>, <span style="color: #7590db;">tid2</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #7590db;">fp</span>;

    err = pthread_create<span style="color: #bc6ec5;">(</span>&amp;tid1, <span style="color: #a45bad;">NULL</span>, thr_fn1, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't create thread 1"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    err = pthread_join<span style="color: #bc6ec5;">(</span>tid1, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span>&amp;fp<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't join with thread 1"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    sleep<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;

    err = pthread_create<span style="color: #bc6ec5;">(</span>&amp;tid2, <span style="color: #a45bad;">NULL</span>, thr_fn2, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't create thread"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    sleep<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;
    printfoo<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"parent:\n"</span>, fp<span style="color: #bc6ec5;">)</span>;

    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<blockquote>
<p>
the contents of the structure (allocated on the stack of thread tid1) have changed by the time the main thread can access the structure
</p>
</blockquote></li>
</ul>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      exit with PTHREAD_CANCELED</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@details</span><span style="color: #9f8766;">    call pthread_exit with PTHREAD_CANCLED</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">      tid      thread id</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     0 if OK, error number on failure</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_cancel</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_t</span> <span style="color: #7590db;">tid</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
<p>
in default circumstances, <code>pthread_exit</code> with <b>PTHREAD_CANCELD</b> <br />
doesn't wait for the thread to terminate; it merely makes the request. <br />
similar to <code>atexit</code> used by a process <br />
known as <i>thread cleanup handlers</i>
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;"> schedules the cleanup function</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> *  - Make a call to pthread_exit</span>
<span style="color: #9f8766;"> *  - Responds to a cancellation request</span>
<span style="color: #9f8766;"> *  - Makes a call to pthread_cleanup_pop with a nonzero execute argument</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">        rtn cleanup handler</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">        arg for rtn</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_cleanup_push</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5;">(</span>*<span style="color: #bc6ec5; font-weight: bold;">rtn</span><span style="color: #bc6ec5;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span>*<span style="color: #bc6ec5;">)</span>, <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span>;
<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;"> remove cleanup handler</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> execute    execute the function if nonzero</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_cleanup_pop</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">execute</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 89: </span>Figure 11.5 Thread cleanup handler</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     11fig05.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-11-05</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    use thread cleanup handlers</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">cleanup</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"cleanup: %s\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #2d9574;">)</span>arg<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">thr_fn1</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"thread 1 start\n"</span><span style="color: #bc6ec5;">)</span>;
    pthread_cleanup_push<span style="color: #bc6ec5;">(</span>cleanup, <span style="color: #2d9574;">"thread 1 first handler"</span><span style="color: #bc6ec5;">)</span>;
    pthread_cleanup_push<span style="color: #bc6ec5;">(</span>cleanup, <span style="color: #2d9574;">"thread 1 second handler"</span><span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"thread 1 push complete\n"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>arg<span style="color: #bc6ec5;">)</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;
    pthread_cleanup_pop<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
    pthread_cleanup_pop<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">thr_fn2</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"thread 2 start\n"</span><span style="color: #bc6ec5;">)</span>;
    pthread_cleanup_push<span style="color: #bc6ec5;">(</span>cleanup, <span style="color: #2d9574;">"thread 2 first hander"</span><span style="color: #bc6ec5;">)</span>;
    pthread_cleanup_push<span style="color: #bc6ec5;">(</span>cleanup, <span style="color: #2d9574;">"thread 2 second handler"</span><span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"thread 2 push complete\n"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>arg<span style="color: #bc6ec5;">)</span> pthread_exit<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span><span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span>;
    pthread_cleanup_pop<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
    pthread_cleanup_pop<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
    pthread_exit<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span><span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>       <span style="color: #7590db;">err</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_t</span> <span style="color: #7590db;">tid1</span>, <span style="color: #7590db;">tid2</span>;
    <span style="color: #ce537a; font-weight: bold;">void</span> *    <span style="color: #7590db;">tret</span>;

    err = pthread_create<span style="color: #bc6ec5;">(</span>&amp;tid1, <span style="color: #a45bad;">NULL</span>, thr_fn1, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't create thread 1"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    err = pthread_create<span style="color: #bc6ec5;">(</span>&amp;tid2, <span style="color: #a45bad;">NULL</span>, thr_fn2, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't create thread 2"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    err = pthread_join<span style="color: #bc6ec5;">(</span>tid1, &amp;tret<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't join with thread 1"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"thread 1 exit code %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>tret<span style="color: #bc6ec5;">)</span>;
    err = pthread_join<span style="color: #bc6ec5;">(</span>tid2, &amp;tret<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't join with thread 2"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"thread 2 exit code %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>tret<span style="color: #bc6ec5;">)</span>;
    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<blockquote>
<p>
当线程通过例程返回被终止时，不调用清理程序
</p>

<p>
<code>return</code> 在FreeBSD Mac OSX 上运行时会断错误并产生 core 文件，这是因为在这些平台上 pthread_cleanup_push 是一个宏并在栈上存储了一些文本，在调用return函数时栈区被覆盖，但调用cleanup时尝试使用此上下文（已损坏）。
</p>
</blockquote></li>
</ul>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 10:</span> Figure 11.6 Comparison of process and thread primitives</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Process primitives</th>
<th scope="col" class="org-left">Thread Primitive</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">fork</td>
<td class="org-left">pthread_create</td>
<td class="org-left">create a new flow of control</td>
</tr>

<tr>
<td class="org-left">exit</td>
<td class="org-left">pthread_exit</td>
<td class="org-left">exit from an existing flow of control</td>
</tr>

<tr>
<td class="org-left">waitpid</td>
<td class="org-left">pthread_join</td>
<td class="org-left">get exit status from flow of control</td>
</tr>

<tr>
<td class="org-left">atexit</td>
<td class="org-left">pthread_cleanup_push</td>
<td class="org-left">register function to be called at exit from flow of control</td>
</tr>

<tr>
<td class="org-left">getpid</td>
<td class="org-left">pthread_self</td>
<td class="org-left">get ID for flow of control</td>
</tr>

<tr>
<td class="org-left">abort</td>
<td class="org-left">pthread_cancel</td>
<td class="org-left">request abnormal termination of flow of control</td>
</tr>
</tbody>
</table>

<blockquote>
<p>
默认情况下，线程终止状态将被保留至调用 <code>pthread_join</code> ，线程被分离后不可使用 <code>pthread_join</code> 等待。
</p>
</blockquote>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      detach a thread</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">      tid      thread id</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     0 if OK, error number on failure</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_detach</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_t</span> <span style="color: #7590db;">tid</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org4a64f5a" class="outline-4">
<h4 id="org4a64f5a"><span class="done DONE">DONE</span> 11.6 Thread Synchronization <code>[8/8]</code></h4>
<div class="outline-text-4" id="text-org4a64f5a">
<p>
需要线程同步以确保在访问变量内存时不会使用非法值。
</p>


<div id="orgd9bf65c" class="figure">
<p><img src="Chapter11/11fig07.jpg" alt="11fig07.jpg" />
</p>
<p><span class="figure-number">Figure 22: </span>Figure 11.7 Interleaved memory cycles with two threads</p>
</div>


<div id="org6bf2c91" class="figure">
<p><img src="Chapter11/11fig08.jpg" alt="11fig08.jpg" />
</p>
<p><span class="figure-number">Figure 23: </span>Figure 11.8 Two threads synchronizing memory access</p>
</div>

<p>
Increment operation:
</p>
<blockquote>
<ol class="org-ol">
<li>Read the memory location into a register.</li>
<li>Increment the value in the register.</li>
<li>Write the new value back to the memory location.</li>
</ol>

<p>
<b>If our data always appears to be sequentially consistent, then we need no additional synchronization.</b>
</p>
</blockquote>


<div id="org7556436" class="figure">
<p><img src="Chapter11/11fig09.jpg" alt="11fig09.jpg" />
</p>
<p><span class="figure-number">Figure 24: </span>Figure 11.9 Two unsynchronized threads incrementing the same variable</p>
</div>
</div>

<ul class="org-ul">
<li><a id="org307e7cc"></a><span class="done DONE">DONE</span> 11.6.1 Mutexes<br />
<div class="outline-text-5" id="text-org307e7cc">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      init pthread mutex</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@details</span><span style="color: #9f8766;">    detailed description</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">      mutex        mutex to be used</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">      attr         set attr for mutex</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     0 if OK, error number on failure</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_mutex_init</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">mutex</span>,
                       <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">pthread_mutexattr_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">attr</span><span style="color: #4f97d7;">)</span>;
<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      destroy pthread_mutex</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@details</span><span style="color: #9f8766;">    detailed description</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">      mutex        mutex to be destroyed</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     0 if OK, error number on failure</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_mutex_destroy</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> *<span style="color: #7590db;">mutex</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_mutex_lock</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> *<span style="color: #7590db;">mutex</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_mutex_trylock</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> *<span style="color: #7590db;">mutex</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_mutex_unlock</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> *<span style="color: #7590db;">mutex</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">All return: 0 if OK, error number on failure</span>
</pre>
</div>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 90: </span>Figure 11.10 Using a mutex to protect a data structure</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     11fig10.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-11-06</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    use mutex to protect a data structure</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>             <span style="color: #7590db;">f_count</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> <span style="color: #7590db;">f_lock</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>             <span style="color: #7590db;">f_id</span>;
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">... more stuff here  ...</span>
<span style="color: #4f97d7;">}</span>;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #bc6ec5; font-weight: bold;">foo_alloc</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">id</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #7590db;">fp</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fp = malloc<span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #b1951d;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        fp-&gt;f_count = <span style="color: #a45bad;">1</span>;
        fp-&gt;f_id    = id;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>pthread_mutex_init<span style="color: #67b11d;">(</span>&amp;fp-&gt;f_lock, <span style="color: #a45bad;">NULL</span><span style="color: #67b11d;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            free<span style="color: #67b11d;">(</span>fp<span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #67b11d;">(</span><span style="color: #a45bad;">NULL</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fp<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">foo_hold</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;fp-&gt;f_lock<span style="color: #bc6ec5;">)</span>;
    fp-&gt;f_count++;
    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;fp-&gt;f_lock<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">foo_release</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;fp-&gt;f_lock<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>--fp-&gt;f_count == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        pthread_mutex_unlock<span style="color: #2d9574;">(</span>&amp;fp-&gt;f_lock<span style="color: #2d9574;">)</span>;
        pthread_mutex_destroy<span style="color: #2d9574;">(</span>&amp;fp-&gt;f_lock<span style="color: #2d9574;">)</span>;
        free<span style="color: #2d9574;">(</span>fp<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        pthread_mutex_unlock<span style="color: #2d9574;">(</span>&amp;fp-&gt;f_lock<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>

<li><a id="org149c627"></a><span class="done DONE">DONE</span> 11.6.2 Deadlock Avoidance<br />
<div class="outline-text-5" id="text-org149c627">
<p>
线程如果尝试两次锁一个互斥锁将会造成 <b>死锁</b>
</p>

<p>
死锁可以通过谨慎控制锁定 <b>顺序</b> 来避免
</p>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 91: </span>Figure 11.11 Using two mutexes</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     11fig11.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-11-06</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    the use of two mutexes</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">NHASH</span>    <span style="color: #a45bad;">29</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #bc6ec5; font-weight: bold;">HASH</span><span style="color: #4f97d7;">(</span><span style="color: #7590db;">id</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>id<span style="color: #bc6ec5;">)</span> % NHASH<span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #7590db;">fh</span><span style="color: #4f97d7;">[</span>NHASH<span style="color: #4f97d7;">]</span>;

<span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> <span style="color: #7590db;">hashlock</span> = PTHREAD_MUTEX_INITIALIZER;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #ce537a; font-weight: bold;">int</span>             <span style="color: #7590db;">f_count</span>;
        <span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> <span style="color: #7590db;">f_lock</span>;
        <span style="color: #ce537a; font-weight: bold;">int</span>             <span style="color: #7590db;">f_id</span>;
        <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span>     *<span style="color: #7590db;">f_next</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">protected by hashlock</span>
<span style="color: #4f97d7;">}</span>;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #bc6ec5; font-weight: bold;">foo_alloc</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">id</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #7590db;">fp</span>;
        <span style="color: #ce537a; font-weight: bold;">int</span>         <span style="color: #7590db;">idx</span>;

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fp = malloc<span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #b1951d;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
                <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>pthread_mutex_init<span style="color: #67b11d;">(</span>&amp;fp-&gt;f_lock, <span style="color: #a45bad;">NULL</span><span style="color: #67b11d;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
                        free<span style="color: #67b11d;">(</span>fp<span style="color: #67b11d;">)</span>;
                        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #67b11d;">(</span><span style="color: #a45bad;">NULL</span><span style="color: #67b11d;">)</span>;
                <span style="color: #2d9574;">}</span>
                fp-&gt;f_count = <span style="color: #a45bad;">1</span>;
                fp-&gt;f_id    = id;

                idx = HASH<span style="color: #2d9574;">(</span>id<span style="color: #2d9574;">)</span>;
                pthread_mutex_lock<span style="color: #2d9574;">(</span>&amp;hashlock<span style="color: #2d9574;">)</span>;
                fp-&gt;f_next = fh<span style="color: #2d9574;">[</span>idx<span style="color: #2d9574;">]</span>;
                pthread_mutex_lock<span style="color: #2d9574;">(</span>&amp;fp-&gt;f_lock<span style="color: #2d9574;">)</span>;
                pthread_mutex_unlock<span style="color: #2d9574;">(</span>&amp;hashlock<span style="color: #2d9574;">)</span>;
                <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">continue initialization</span>
                pthread_mutex_unlock<span style="color: #2d9574;">(</span>&amp;fp-&gt;f_lock<span style="color: #2d9574;">)</span>;
        <span style="color: #bc6ec5;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fp<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">foo_hold</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
        pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;fp-&gt;f_lock<span style="color: #bc6ec5;">)</span>;
        fp-&gt;f_count++;
        pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;fp-&gt;f_lock<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #bc6ec5; font-weight: bold;">foo_find</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">id</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #7590db;">fp</span>;

        pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;hashlock<span style="color: #bc6ec5;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>fp = fh<span style="color: #2d9574;">[</span>HASH<span style="color: #67b11d;">(</span>id<span style="color: #67b11d;">)</span><span style="color: #2d9574;">]</span>; fp != <span style="color: #a45bad;">NULL</span>; fp = fp-&gt;f_next<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
                <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>fp-&gt;f_id == id<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
                        foo_hold<span style="color: #67b11d;">(</span>fp<span style="color: #67b11d;">)</span>;
                        <span style="color: #4f97d7; font-weight: bold;">break</span>;
                <span style="color: #2d9574;">}</span>
        <span style="color: #bc6ec5;">}</span>

        pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;hashlock<span style="color: #bc6ec5;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fp<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">release a reference to the object</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">foo_rele</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #7590db;">tfp</span>;
        <span style="color: #ce537a; font-weight: bold;">int</span>         <span style="color: #7590db;">idx</span>;

        pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;fp-&gt;f_lock<span style="color: #bc6ec5;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>fp-&gt;f_count == <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
                pthread_mutex_unlock<span style="color: #2d9574;">(</span>&amp;fp-&gt;f_lock<span style="color: #2d9574;">)</span>;
                pthread_mutex_lock<span style="color: #2d9574;">(</span>&amp;hashlock<span style="color: #2d9574;">)</span>;
                pthread_mutex_lock<span style="color: #2d9574;">(</span>&amp;fp-&gt;f_lock<span style="color: #2d9574;">)</span>;
                <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>fp-&gt;f_count != <span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
                        fp-&gt;f_count--;
                        pthread_mutex_unlock<span style="color: #67b11d;">(</span>&amp;fp-&gt;f_lock<span style="color: #67b11d;">)</span>;
                        pthread_mutex_unlock<span style="color: #67b11d;">(</span>&amp;hashlock<span style="color: #67b11d;">)</span>;
                        <span style="color: #4f97d7; font-weight: bold;">return</span>;
                <span style="color: #2d9574;">}</span>

                idx = HASH<span style="color: #2d9574;">(</span>fp-&gt;f_id<span style="color: #2d9574;">)</span>;
                tfp = fh<span style="color: #2d9574;">[</span>idx<span style="color: #2d9574;">]</span>;
                <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>tfp == fp<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
                        fh<span style="color: #67b11d;">[</span>idx<span style="color: #67b11d;">]</span> = fp-&gt;f_next;
                <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
                        <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #67b11d;">(</span>tfp-&gt;f_next != fp<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                                tfp = tfp-&gt;f_next;
                        <span style="color: #67b11d;">}</span>
                        tfp-&gt;f_next = fp-&gt;f_next;
                <span style="color: #2d9574;">}</span>
                pthread_mutex_unlock<span style="color: #2d9574;">(</span>&amp;hashlock<span style="color: #2d9574;">)</span>;
                pthread_mutex_unlock<span style="color: #2d9574;">(</span>&amp;fp-&gt;f_lock<span style="color: #2d9574;">)</span>;
                pthread_mutex_destroy<span style="color: #2d9574;">(</span>&amp;fp-&gt;f_lock<span style="color: #2d9574;">)</span>;
                free<span style="color: #2d9574;">(</span>fp<span style="color: #2d9574;">)</span>;
        <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
                fp-&gt;f_count--;
                pthread_mutex_unlock<span style="color: #2d9574;">(</span>&amp;fp-&gt;f_lock<span style="color: #2d9574;">)</span>;
        <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 92: </span>Figure 11.12 Simplified locking</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     11fig12.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-11-08</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Simplified locking</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">NHASH</span>    <span style="color: #a45bad;">29</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #bc6ec5; font-weight: bold;">HASH</span><span style="color: #4f97d7;">(</span><span style="color: #7590db;">id</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>id<span style="color: #bc6ec5;">)</span> % NHASH<span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *    <span style="color: #7590db;">fh</span><span style="color: #4f97d7;">[</span>NHASH<span style="color: #4f97d7;">]</span>;
<span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> <span style="color: #7590db;">hashlock</span> = PTHREAD_MUTEX_INITIALIZER;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>             <span style="color: #7590db;">f_count</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">protected by hashlock</span>
    <span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> <span style="color: #7590db;">f_lock</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>             <span style="color: #7590db;">f_id</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *    <span style="color: #7590db;">f_next</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">protected by hashlock</span>
                             <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">... more stuff here ...</span>
<span style="color: #4f97d7;">}</span>;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #bc6ec5; font-weight: bold;">foo_alloc</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">id</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #7590db;">fp</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>         <span style="color: #7590db;">idx</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fp = malloc<span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #b1951d;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        fp-&gt;f_count = <span style="color: #a45bad;">1</span>;
        fp-&gt;f_id    = id;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>pthread_mutex_init<span style="color: #67b11d;">(</span>&amp;fp-&gt;f_lock, <span style="color: #a45bad;">NULL</span><span style="color: #67b11d;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            free<span style="color: #67b11d;">(</span>fp<span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #67b11d;">(</span><span style="color: #a45bad;">NULL</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        idx = HASH<span style="color: #2d9574;">(</span>id<span style="color: #2d9574;">)</span>;
        pthread_mutex_lock<span style="color: #2d9574;">(</span>&amp;hashlock<span style="color: #2d9574;">)</span>;
        fp-&gt;f_next = fh<span style="color: #2d9574;">[</span>idx<span style="color: #2d9574;">]</span>;
        fh<span style="color: #2d9574;">[</span>idx<span style="color: #2d9574;">]</span>    = fp;
        pthread_mutex_lock<span style="color: #2d9574;">(</span>&amp;fp-&gt;f_lock<span style="color: #2d9574;">)</span>;
        pthread_mutex_unlock<span style="color: #2d9574;">(</span>&amp;hashlock<span style="color: #2d9574;">)</span>;
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">continue initialization</span>
        pthread_mutex_unlock<span style="color: #2d9574;">(</span>&amp;fp-&gt;f_lock<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fp<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">foo_hold</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;hashlock<span style="color: #bc6ec5;">)</span>;
    fp-&gt;f_count++;
    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;hashlock<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #bc6ec5; font-weight: bold;">foo_find</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">id</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #7590db;">fp</span>;

    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;hashlock<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>fp = fh<span style="color: #2d9574;">[</span>HASH<span style="color: #67b11d;">(</span>id<span style="color: #67b11d;">)</span><span style="color: #2d9574;">]</span>; fp != <span style="color: #a45bad;">NULL</span>; fp = fp-&gt;f_next<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>fp-&gt;f_id == id<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            fp-&gt;f_count++;
            <span style="color: #4f97d7; font-weight: bold;">break</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;hashlock<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fp<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">foo_rele</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #7590db;">tfp</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>         <span style="color: #7590db;">idx</span>;

    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;hashlock<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>--fp-&gt;f_count == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        idx = HASH<span style="color: #2d9574;">(</span>fp-&gt;f_id<span style="color: #2d9574;">)</span>;
        tfp = fh<span style="color: #2d9574;">[</span>idx<span style="color: #2d9574;">]</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>tfp == fp<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            fh<span style="color: #67b11d;">[</span>idx<span style="color: #67b11d;">]</span> = fp-&gt;f_next;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #67b11d;">(</span>tfp-&gt;f_next != fp<span style="color: #67b11d;">)</span> tfp = tfp-&gt;f_next;
            tfp-&gt;f_next = fp-&gt;f_next;
        <span style="color: #2d9574;">}</span>
        pthread_mutex_unlock<span style="color: #2d9574;">(</span>&amp;hashlock<span style="color: #2d9574;">)</span>;
        pthread_mutex_destroy<span style="color: #2d9574;">(</span>&amp;fp-&gt;f_lock<span style="color: #2d9574;">)</span>;
        free<span style="color: #2d9574;">(</span>fp<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;hashlock<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>

<li><a id="orgb00c559"></a><span class="done DONE">DONE</span> 11.6.3 <code>pthread_mutex_timedlock</code> function<br />
<div class="outline-text-5" id="text-orgb00c559">
<p>
<b>Mac OSX 10.15.1 doesn't support <code>pthread_mutex_timedlock</code> yet</b>
</p>

<p>
<code>pthread_mutex_timedlock</code> is equivalent to <code>pthread_mutex_lock</code>, but returns <b>ETIMEDOUT</b> without locking mutex after timeout
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">time.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_mutex_timedlock</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">mutex</span>,
                            <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">tsptr</span><span style="color: #4f97d7;">)</span>;

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, error number on failure</span>
</pre>
</div>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 93: </span>Figure 11.13 Using <code>pthread_mutex_timedlock</code></label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     11fig13.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-11-08</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    use </span><span style="color: #a45bad;">pthread_mutex_timedlock()</span><span style="color: #9f8766;"> to avoid blocking indefinitely</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #bc6ec5;">(</span>__linux__<span style="color: #bc6ec5;">)</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>             <span style="color: #7590db;">err</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span> <span style="color: #7590db;">tout</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">tm</span>*      <span style="color: #7590db;">tmp</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>            <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">64</span><span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> <span style="color: #7590db;">lock</span> = PTHREAD_MUTEX_INITIALIZER;

    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;lock<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"mutex is locked"</span><span style="color: #bc6ec5;">)</span>;
    clock_gettime<span style="color: #bc6ec5;">(</span>CLOCK_REALTIME, &amp;tout<span style="color: #bc6ec5;">)</span>;
    tmp = localtime<span style="color: #bc6ec5;">(</span>&amp;tout.tv_sec<span style="color: #bc6ec5;">)</span>;
    strftime<span style="color: #bc6ec5;">(</span>buf, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>buf<span style="color: #2d9574;">)</span>, <span style="color: #2d9574;">"%r"</span>, tmp<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"current time is %s\n"</span>, buf<span style="color: #bc6ec5;">)</span>;

    tout.tv_sec += <span style="color: #a45bad;">10</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">10 seconds from now</span>

    err = pthread_mutex_timedlock<span style="color: #bc6ec5;">(</span>&amp;lock, &amp;tout<span style="color: #bc6ec5;">)</span>;
    clock_gettime<span style="color: #bc6ec5;">(</span>CLOCK_REALTIME, &amp;tout<span style="color: #bc6ec5;">)</span>;
    tmp = localtime<span style="color: #bc6ec5;">(</span>&amp;tout.tv_sec<span style="color: #bc6ec5;">)</span>;
    strftime<span style="color: #bc6ec5;">(</span>buf, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>buf<span style="color: #2d9574;">)</span>, <span style="color: #2d9574;">"%r"</span>, tmp<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"the time is now %s\n"</span>, buf<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"mutex locked again!\n"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"can't lock mutex again: %s\n"</span>, strerror<span style="color: #67b11d;">(</span>err<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;

<span style="color: #bc6ec5;">#endif</span>  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">__linux__</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>

<li><a id="org9440423"></a><span class="done DONE">DONE</span> 11.6.4 Reader-Writer Locks<br />
<div class="outline-text-5" id="text-org9440423">
<ul class="org-ul">
<li>mutex  : can only one thread lock it at a time, lock/unlock.</li>
<li>rw-lock: read lock, write lock, unlock.</li>
<li>rw-lock: 同时间段内只有一个线程可以加写锁，但多个线程允许加读锁
<ul class="org-ul">
<li>w-lock: 所有线程尝试上锁时都会被阻塞直至解锁</li>
<li>r-lock: 所有线程尝试读锁时将被允许，但写锁将被阻塞直至释放读锁</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_rwlock_init</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_rwlock_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">rwlock</span>,
                        <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">pthread_rwlockattr_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">attr</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_rwlock_destroy</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_rwlock_t</span> *<span style="color: #7590db;">rwlock</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>
<p>
The Single UNIX specification defines <b>PTHREAD_RWLOCK_INITIALIZE</b> constant in the XSI option to initialize a statically allocated rw lock.
</p>

<p>
rw-lock control:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_rwlock_rdlock</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_rwlock_t</span> *<span style="color: #7590db;">rwlock</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_rwlock_wrlock</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_rwlock_t</span> *<span style="color: #7590db;">rwlock</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_rwlock_unlock</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_rwlock_t</span> *<span style="color: #7590db;">rwlock</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">All return: 0 if OK, error number on failure</span>
</pre>
</div>

<p>
rw-lock try control:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_rwlock_tryrdlock</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_rwlock_t</span> *<span style="color: #7590db;">rwlock</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_rwlock_trywrlock</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_rwlock_t</span> *<span style="color: #7590db;">rwlock</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 94: </span>Figure 11.14 Using reader-writer locks</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     11fig14.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-11-09</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    illustrates the use of reader&#8211;writer locks</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> *<span style="color: #7590db;">j_next</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> *<span style="color: #7590db;">j_prev</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_t</span>   <span style="color: #7590db;">j_id</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">tells which thread handles this job</span>
<span style="color: #4f97d7;">}</span>;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">queue</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> *     <span style="color: #7590db;">q_head</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> *     <span style="color: #7590db;">q_tail</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_rwlock_t</span> <span style="color: #7590db;">q_lock</span>;
<span style="color: #4f97d7;">}</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">queue_init</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">queue</span> *<span style="color: #7590db;">q</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">err</span>;

    q-&gt;q_head = <span style="color: #a45bad;">NULL</span>;
    q-&gt;q_tail = <span style="color: #a45bad;">NULL</span>;
    err       = pthread_rwlock_init<span style="color: #bc6ec5;">(</span>&amp;q-&gt;q_lock, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span>err<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">continue initialization</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">job_insert</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">queue</span> *<span style="color: #7590db;">qp</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> *<span style="color: #7590db;">jp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    pthread_rwlock_wrlock<span style="color: #bc6ec5;">(</span>&amp;qp-&gt;q_lock<span style="color: #bc6ec5;">)</span>;
    jp-&gt;j_next = qp-&gt;q_head;
    jp-&gt;j_prev = <span style="color: #a45bad;">NULL</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>qp-&gt;q_head != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>
        qp-&gt;q_head-&gt;j_prev = jp;
    <span style="color: #4f97d7; font-weight: bold;">else</span>
        qp-&gt;q_tail = jp;

    qp-&gt;q_head = jp;
    pthread_rwlock_unlock<span style="color: #bc6ec5;">(</span>&amp;qp-&gt;q_lock<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">job_append</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">queue</span> *<span style="color: #7590db;">qp</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> *<span style="color: #7590db;">jp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    pthread_rwlock_wrlock<span style="color: #bc6ec5;">(</span>&amp;qp-&gt;q_lock<span style="color: #bc6ec5;">)</span>;
    jp-&gt;j_next = <span style="color: #a45bad;">NULL</span>;
    jp-&gt;j_prev = qp-&gt;q_tail;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>qp-&gt;q_tail != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>
        qp-&gt;q_tail-&gt;j_next = jp;
    <span style="color: #4f97d7; font-weight: bold;">else</span>
        qp-&gt;q_head = jp;

    qp-&gt;q_tail = jp;

    pthread_rwlock_unlock<span style="color: #bc6ec5;">(</span>&amp;qp-&gt;q_lock<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">job_remove</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">queue</span> *<span style="color: #7590db;">qp</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> *<span style="color: #7590db;">jp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    pthread_rwlock_wrlock<span style="color: #bc6ec5;">(</span>&amp;qp-&gt;q_lock<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>jp == qp-&gt;q_head<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        qp-&gt;q_head = jp-&gt;j_next;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>qp-&gt;q_tail == jp<span style="color: #2d9574;">)</span>
            qp-&gt;q_tail = <span style="color: #a45bad;">NULL</span>;
        <span style="color: #4f97d7; font-weight: bold;">else</span>
            jp-&gt;j_next-&gt;j_prev = jp-&gt;j_prev;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>jp == qp-&gt;q_tail<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        qp-&gt;q_tail         = jp-&gt;j_prev;
        jp-&gt;j_prev-&gt;j_next = jp-&gt;j_next;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        jp-&gt;j_prev-&gt;j_next = jp-&gt;j_next;
        jp-&gt;j_next-&gt;j_prev = jp-&gt;j_prev;
    <span style="color: #bc6ec5;">}</span>
    pthread_rwlock_unlock<span style="color: #bc6ec5;">(</span>&amp;qp-&gt;q_lock<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> *<span style="color: #bc6ec5; font-weight: bold;">job_find</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">queue</span> *<span style="color: #7590db;">qp</span>, <span style="color: #ce537a; font-weight: bold;">pthread_t</span> <span style="color: #7590db;">id</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> *<span style="color: #7590db;">jp</span> = <span style="color: #a45bad;">NULL</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pthread_rwlock_rdlock<span style="color: #2d9574;">(</span>&amp;qp-&gt;q_lock<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">NULL</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>jp = qp-&gt;q_head; jp; jp = jp-&gt;j_next<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>pthread_equal<span style="color: #67b11d;">(</span>id, jp-&gt;j_id<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #4f97d7; font-weight: bold;">break</span>;
    <span style="color: #bc6ec5;">}</span>
    pthread_rwlock_unlock<span style="color: #bc6ec5;">(</span>&amp;qp-&gt;q_lock<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>jp<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>

<li><a id="orgc2db73c"></a><span class="done DONE">DONE</span> 11.6.5 Reader-Writer Locking with Timeouts<br />
<div class="outline-text-5" id="text-orgc2db73c">
<p>
rw-lock with timeout to avoid blocking indefinitely
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">time.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_rwlock_timedrdlock</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_rwlock_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">rwlock</span>,
                               <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">tsptr</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_rwlock_timedwrlock</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_rwlock_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">rwlock</span>,
                               <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">tsptr</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>
<p>
<b>the timeout specifies an absolute time, not a relative one.</b>
</p>
</div>
</li>

<li><a id="org0c33e52"></a><span class="done DONE">DONE</span> 11.6.6 Condition Variables<br />
<div class="outline-text-5" id="text-org0c33e52">
<blockquote>
<p>
条件本身被互斥锁保护。一个线程必须锁定互斥锁才能改变条件状态。其它线程只有获取互斥锁时才会提示修改，因为互斥锁必须被锁定才能评估条件。
</p>

<p>
assign the constant <code>PTHREAD_COND_INITIALIZER</code> to a statically allocated condition variable
</p>
</blockquote>

<p>
<code>pthread_cond_init/destroy</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_cond_init</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_cond_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">cond</span>,
                      <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">pthread_condattr_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">attr</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_cond_destroy</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_cond_t</span> *<span style="color: #7590db;">cond</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both returns: 0 if OK, error number on failure</span>
</pre>
</div>

<p>
<code>pthread_cond wait/timedwait</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_cond_wait</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_cond_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">cond</span>,
                      <span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">mutex</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_cond_timedwait</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_cond_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">cond</span>,
                           <span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">mutex</span>,
                           <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">tsptr</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>
<p>
wait as an absolute time instead of a relative time.
</p>

<p>
To obtain the absolute time for the timeout value,
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/time.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">maketimeout</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span> *<span style="color: #7590db;">tsp</span>, <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">minutes</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timeval</span> <span style="color: #7590db;">now</span>;

        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">get the current time</span>
        gettimeofday<span style="color: #bc6ec5;">(</span>&amp;now, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
        tsp-&gt;tv_sec = now.tv_sec;
        tsp-&gt;tv_nsec = now.tv_usec * <span style="color: #a45bad;">1000</span>; <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">usec to nsec</span>
        tsp-&gt;tv_sec += minutes * <span style="color: #a45bad;">60</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<p>
notify threads that a condition has been satisfied.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_cond_signal</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_cond_t</span> *<span style="color: #7590db;">cond</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_cond_broadcast</span> <span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_cond_t</span> *<span style="color: #7590db;">cond</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 95: </span>Figure 11.15 Using a condition variable</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     11fig15.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-11-10</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    an example of how to use a condition variable and a mutex</span>
<span style="color: #9f8766;"> * together to synchronize threads.</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">msg</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">msg</span> *<span style="color: #7590db;">m_next</span>;
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">more stuff here</span>
<span style="color: #4f97d7;">}</span>;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">msg</span> *<span style="color: #7590db;">workd</span>;

<span style="color: #ce537a; font-weight: bold;">pthread_cond_t</span>  <span style="color: #7590db;">qready</span> = PTHREAD_COND_INITIALIZER;
<span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> <span style="color: #7590db;">qlock</span>  = PTHREAD_MUTEX_INITIALIZER;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">process_msg</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">msg</span> *<span style="color: #7590db;">mp</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>;;<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        pthread_mutex_lock<span style="color: #2d9574;">(</span>&amp;qlock<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #2d9574;">(</span>workd == <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            pthread_cond_wait<span style="color: #67b11d;">(</span>&amp;qready, &amp;qlock<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        mp    = workd;
        workd = mp-&gt;m_next;
        pthread_mutex_unlock<span style="color: #2d9574;">(</span>&amp;qlock<span style="color: #2d9574;">)</span>;
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">now process the messg mp</span>
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">enqueue_msg</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">msg</span> *<span style="color: #7590db;">mp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;qlock<span style="color: #bc6ec5;">)</span>;
    mp-&gt;m_next = workd;
    workd      = mp;
    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;qlock<span style="color: #bc6ec5;">)</span>;
    pthread_cond_signal<span style="color: #bc6ec5;">(</span>&amp;qready<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>

<li><a id="org9153a32"></a><span class="done DONE">DONE</span> 11.6.7 Spin Locks<br />
<div class="outline-text-5" id="text-org9153a32">
<blockquote>
<p>
A spin lock is like a mutex, except that <b>instead of blocking</b> a process by sleeping, the process is blocked by busy-waiting (spinning) until the lock can be acquired
</p>

<p>
use for short periods of times
</p>
</blockquote>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_spin_init</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_spinlock_t</span> *<span style="color: #7590db;">lock</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">pshared</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_spin_destroy</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_spinlock_t</span> *<span style="color: #7590db;">lock</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>
<ul class="org-ul">
<li><b>PTHREAD_PROCESS_SHARED</b>: the spin lock can be acquired by threads that have access to the lock's underlying memory</li>
<li><b>PTHREAD_PROCESS_PRIVATE</b>: the spin lock can be accessed by only from threads within the process that initialized it.</li>
</ul>

<p>
<code>pthread_spin_trylock</code> doesn't spin,
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_spin_lock</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_spinlock_t</span> *<span style="color: #7590db;">lock</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_spin_trylock</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_spinlock_t</span> *<span style="color: #7590db;">lock</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_spin_unlock</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_spinlock_t</span> *<span style="color: #7590db;">lock</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">All return: 0 if OK, error number on failure</span>
</pre>
</div>
<p>
If either pthread_spin_lock or pthread_spin_trylock returns 0, then the spin lock is locked
</p>
</div>
</li>

<li><a id="org4c930b8"></a><span class="done DONE">DONE</span> 11.6.8 Barriers<br />
<div class="outline-text-5" id="text-org4c930b8">
<p>
<b>Mac OSX doesn't implemented yet, but we can implemente it by pthread_cond and pthread_mutex</b>
coordinate multiple threads working in parallel.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_barrier_init</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_barrier_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">barrier</span>,
                         <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">pthread_barrierattr_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">attr</span>,
                         <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">count</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_barrier_destroy</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_barrier_t</span> *<span style="color: #7590db;">barrier</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>
<p>
<b>count</b> refers to the number of threads that must call <code>pthread_barrier_wait()</code> (includes the calling in process)
</p>

<p>
<code>pthread_barrier_wait</code> indicates a thread is done with its work and is ready to wait for all the other threads to catch up .
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_barrier_wait</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_barrier_t</span> *<span style="color: #7590db;">barrier</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 or PTHREAD_BARRIER_SERIAL_THREAD if OK, error number on failure</span>
</pre>
</div>
<p>
calling <code>pthread_barrier_wait</code> is put to sleep if barrier count is not yet satisfied.
</p>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 96: </span>Figure 11.16 Using a barrier</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     11fig16.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-11-10</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    show how a barrier can be used to synchronize threads cooperating</span>
<span style="color: #9f8766;"> * on a single task</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">limits.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/time.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">NTHR</span>   <span style="color: #a45bad;">8</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">NUMNUM</span> <span style="color: #a45bad;">800000L</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">TNUM</span>   <span style="color: #4f97d7;">(</span>NUMNUM / NTHR<span style="color: #4f97d7;">)</span>

<span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">nums</span><span style="color: #4f97d7;">[</span>NUMNUM<span style="color: #4f97d7;">]</span>;
<span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">snums</span><span style="color: #4f97d7;">[</span>NUMNUM<span style="color: #4f97d7;">]</span>;

<span style="color: #ce537a; font-weight: bold;">pthread_barrier_t</span> <span style="color: #7590db;">b</span>;

<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>SOLARIS<span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">heapsort</span> gsort
<span style="color: #bc6ec5;">#elif</span> <span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>__linux__<span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">heapsort</span> qsort
<span style="color: #bc6ec5;">#else</span>
<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">heapsort</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *, <span style="color: #ce537a; font-weight: bold;">size_t</span>, <span style="color: #ce537a; font-weight: bold;">size_t</span>,
                    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5;">(</span>*<span style="color: #bc6ec5;">)(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">void</span> *, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>;
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">complong</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg1</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg2</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">l1</span> = *<span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">long</span> *<span style="color: #bc6ec5;">)</span>arg1;
    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">l2</span> = *<span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">long</span> *<span style="color: #bc6ec5;">)</span>arg2;

    <span style="color: #4f97d7; font-weight: bold;">return</span> l1 == l2 ? <span style="color: #a45bad;">0</span> : l1 &gt; l2 ? <span style="color: #a45bad;">1</span> : -<span style="color: #a45bad;">1</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">thr_fn</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">idx</span> = <span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #bc6ec5;">)</span>arg;

    heapsort<span style="color: #bc6ec5;">(</span>&amp;nums<span style="color: #2d9574;">[</span>idx<span style="color: #2d9574;">]</span>, TNUM, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>, complong<span style="color: #bc6ec5;">)</span>;
    pthread_barrier_wait<span style="color: #bc6ec5;">(</span>&amp;b<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">merge</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">idx</span><span style="color: #bc6ec5;">[</span>NTHR<span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">i</span>, <span style="color: #7590db;">minidx</span>, <span style="color: #7590db;">sidx</span>, <span style="color: #7590db;">num</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; NTHR; i++<span style="color: #bc6ec5;">)</span> idx<span style="color: #bc6ec5;">[</span>i<span style="color: #bc6ec5;">]</span> = i * TNUM;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>sidx = <span style="color: #a45bad;">0</span>; sidx &lt; NUMNUM; sidx++<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        num = LONG_MAX;
        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #2d9574;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; NTHR; ++i<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>idx<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span> &lt; <span style="color: #4f97d7;">(</span>i + <span style="color: #a45bad;">1</span><span style="color: #4f97d7;">)</span> * TNUM<span style="color: #b1951d;">)</span> &amp;&amp; <span style="color: #b1951d;">(</span>nums<span style="color: #4f97d7;">[</span>idx<span style="color: #bc6ec5;">[</span>i<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">]</span> &lt; num<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                num    = nums<span style="color: #b1951d;">[</span>idx<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span><span style="color: #b1951d;">]</span>;
                minidx = i;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>
        snums<span style="color: #2d9574;">[</span>sidx<span style="color: #2d9574;">]</span> = nums<span style="color: #2d9574;">[</span>idx<span style="color: #67b11d;">[</span>minidx<span style="color: #67b11d;">]</span><span style="color: #2d9574;">]</span>;
        idx<span style="color: #2d9574;">[</span>minidx<span style="color: #2d9574;">]</span>++;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span>  <span style="color: #7590db;">i</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timeval</span> <span style="color: #7590db;">start</span>, <span style="color: #7590db;">end</span>;
    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #ce537a; font-weight: bold;">long</span>      <span style="color: #7590db;">startusec</span>, <span style="color: #7590db;">endusec</span>;
    <span style="color: #ce537a; font-weight: bold;">double</span>         <span style="color: #7590db;">elapsed</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>            <span style="color: #7590db;">err</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_t</span>      <span style="color: #7590db;">tid</span>;

    srandom<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; NUMNUM; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        nums<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span> = random<span style="color: #2d9574;">()</span>;
    <span style="color: #bc6ec5;">}</span>

    gettimeofday<span style="color: #bc6ec5;">(</span>&amp;start, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    pthread_barrier_init<span style="color: #bc6ec5;">(</span>&amp;b, <span style="color: #a45bad;">NULL</span>, NTHR + <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; NTHR; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err = pthread_create<span style="color: #2d9574;">(</span>&amp;tid, <span style="color: #a45bad;">NULL</span>, thr_fn, <span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #67b11d;">)(</span>i * TNUM<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_exit<span style="color: #67b11d;">(</span>err, <span style="color: #2d9574;">"can't create thread"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
    pthread_barrier_wait<span style="color: #bc6ec5;">(</span>&amp;b<span style="color: #bc6ec5;">)</span>;
    merge<span style="color: #bc6ec5;">()</span>;
    gettimeofday<span style="color: #bc6ec5;">(</span>&amp;end, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;

    startusec = start.tv_sec * <span style="color: #a45bad;">1000000</span> + start.tv_usec;
    endusec   = end.tv_sec * <span style="color: #a45bad;">100000</span> + end.tv_usec;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"sort took %.4f seconds"</span>, elapsed<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; NUMNUM; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%ld\n"</span>, snums<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>
</ul>
</div>

<div id="outline-container-orga45038d" class="outline-4">
<h4 id="orga45038d"><span class="done DONE">DONE</span> 11.7 Summary</h4>
<div class="outline-text-4" id="text-orga45038d">
<ul class="org-ul">
<li>Exercises

<ul class="org-ul">
<li><p>
11.1
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     11fig04.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-11-05</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Exerciese 11.1</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">a</span>, <span style="color: #7590db;">b</span>, <span style="color: #7590db;">c</span>, <span style="color: #7590db;">d</span>;
<span style="color: #4f97d7;">}</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">printfoo</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">s</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%s"</span>, s<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">" structure at 0x%lx\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>fp<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">" foo.a = %d\n"</span>, fp-&gt;a<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">" foo.b = %d\n"</span>, fp-&gt;b<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">" foo.c = %d\n"</span>, fp-&gt;c<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">" foo.d = %d\n"</span>, fp-&gt;d<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">thr_fn1</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #7590db;">fp</span> = <span style="color: #a45bad;">NULL</span>;

    fp = calloc<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span>, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;

    fp-&gt;a = <span style="color: #a45bad;">1</span>;
    fp-&gt;b = <span style="color: #a45bad;">2</span>;
    fp-&gt;c = <span style="color: #a45bad;">3</span>;
    fp-&gt;d = <span style="color: #a45bad;">4</span>;

    printfoo<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"thread 1:\n"</span>, fp<span style="color: #bc6ec5;">)</span>;
    pthread_exit<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span>fp<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">thr_fn2</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #7590db;">fp</span> = arg;
    printfoo<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"thread 2: "</span>, fp<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"thread 2: ID is %lu\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>pthread_self<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span>;
    pthread_exit<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>         <span style="color: #7590db;">err</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_t</span>   <span style="color: #7590db;">tid1</span>, <span style="color: #7590db;">tid2</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #7590db;">fp</span>;

    err = pthread_create<span style="color: #bc6ec5;">(</span>&amp;tid1, <span style="color: #a45bad;">NULL</span>, thr_fn1, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't create thread 1"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    err = pthread_join<span style="color: #bc6ec5;">(</span>tid1, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span>&amp;fp<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't join with thread 1"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    err = pthread_create<span style="color: #bc6ec5;">(</span>&amp;tid2, <span style="color: #a45bad;">NULL</span>, thr_fn2, fp<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't create thread"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    printfoo<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"parent:\n"</span>, fp<span style="color: #bc6ec5;">)</span>;

    free<span style="color: #bc6ec5;">(</span>fp<span style="color: #bc6ec5;">)</span>;
    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
11.2
</p>

<blockquote>
<p>
write-mode lock on the whole list while the ID is changing.
</p>

<p>
the thread ID between <code>job_find</code> and <code>job_remove</code> maybe changed
</p>

<p>
to solve this problem, add another mutex in struct job
</p>
</blockquote></li>

<li><p>
11.3
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     11fig14.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-11-09</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    illustrates the use of reader&#8211;writer locks</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@todo</span><span style="color: #9f8766;">     something need to be considered</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> *<span style="color: #7590db;">j_next</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> *<span style="color: #7590db;">j_prev</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_t</span>   <span style="color: #7590db;">j_id</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">tells which thread handles this job</span>
    <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5;">(</span>*<span style="color: #bc6ec5; font-weight: bold;">j_func</span><span style="color: #bc6ec5;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">queue</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pthread_t</span>       <span style="color: #7590db;">q_id</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> *    <span style="color: #7590db;">q_head</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> *    <span style="color: #7590db;">q_tail</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_cond_t</span>  <span style="color: #7590db;">q_cond</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> <span style="color: #7590db;">q_mutex</span>;
<span style="color: #4f97d7;">}</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">thr_fn</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"thread %lu start\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>pthread_self<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span>;
    pthread_exit<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">queue_init</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">queue</span> *<span style="color: #7590db;">q</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">err</span>;

    q-&gt;q_id   = pthread_self<span style="color: #bc6ec5;">()</span>;
    q-&gt;q_head = <span style="color: #a45bad;">NULL</span>;
    q-&gt;q_tail = <span style="color: #a45bad;">NULL</span>;
    err       = pthread_mutex_init<span style="color: #bc6ec5;">(</span>&amp;q-&gt;q_mutex, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span>err<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    err = pthread_cond_init<span style="color: #bc6ec5;">(</span>&amp;q-&gt;q_cond, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        pthread_mutex_destroy<span style="color: #2d9574;">(</span>&amp;q-&gt;q_mutex<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">continue initialization</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> err;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">job_insert</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">queue</span> *<span style="color: #7590db;">qp</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> *<span style="color: #7590db;">jp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;qp-&gt;q_mutex<span style="color: #bc6ec5;">)</span>;

    jp-&gt;j_next = qp-&gt;q_head;
    jp-&gt;j_prev = <span style="color: #a45bad;">NULL</span>;
    jp-&gt;j_func = thr_fn;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>qp-&gt;q_head != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>
        qp-&gt;q_head-&gt;j_prev = jp;
    <span style="color: #4f97d7; font-weight: bold;">else</span>
        qp-&gt;q_tail = jp;

    qp-&gt;q_head = jp;

    pthread_cond_signal<span style="color: #bc6ec5;">(</span>&amp;qp-&gt;q_cond<span style="color: #bc6ec5;">)</span>;
    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;qp-&gt;q_mutex<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">job_append</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">queue</span> *<span style="color: #7590db;">qp</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> *<span style="color: #7590db;">jp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;qp-&gt;q_mutex<span style="color: #bc6ec5;">)</span>;

    jp-&gt;j_next = <span style="color: #a45bad;">NULL</span>;
    jp-&gt;j_prev = qp-&gt;q_tail;
    jp-&gt;j_func = thr_fn;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>qp-&gt;q_tail != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>
        qp-&gt;q_tail-&gt;j_next = jp;
    <span style="color: #4f97d7; font-weight: bold;">else</span>
        qp-&gt;q_head = jp;

    qp-&gt;q_tail = jp;

    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;qp-&gt;q_mutex<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">job_remove</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">queue</span> *<span style="color: #7590db;">qp</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> *<span style="color: #7590db;">jp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;qp-&gt;q_mutex<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>jp == qp-&gt;q_head<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        qp-&gt;q_head = jp-&gt;j_next;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>qp-&gt;q_tail == jp<span style="color: #2d9574;">)</span>
            qp-&gt;q_tail = <span style="color: #a45bad;">NULL</span>;
        <span style="color: #4f97d7; font-weight: bold;">else</span>
            jp-&gt;j_next-&gt;j_prev = jp-&gt;j_prev;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>jp == qp-&gt;q_tail<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        qp-&gt;q_tail         = jp-&gt;j_prev;
        jp-&gt;j_prev-&gt;j_next = jp-&gt;j_next;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        jp-&gt;j_prev-&gt;j_next = jp-&gt;j_next;
        jp-&gt;j_next-&gt;j_prev = jp-&gt;j_prev;
    <span style="color: #bc6ec5;">}</span>

    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;qp-&gt;q_mutex<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> *<span style="color: #bc6ec5; font-weight: bold;">job_find</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">queue</span> *<span style="color: #7590db;">qp</span>, <span style="color: #ce537a; font-weight: bold;">pthread_t</span> <span style="color: #7590db;">id</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> *<span style="color: #7590db;">jp</span> = <span style="color: #a45bad;">NULL</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pthread_mutex_lock<span style="color: #2d9574;">(</span>&amp;qp-&gt;q_mutex<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">NULL</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>jp = qp-&gt;q_head; jp; jp = jp-&gt;j_next<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>pthread_equal<span style="color: #67b11d;">(</span>id, jp-&gt;j_id<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #4f97d7; font-weight: bold;">break</span>;
    <span style="color: #bc6ec5;">}</span>
    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;qp-&gt;q_mutex<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>jp<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<ol class="org-ol">
<li>rwlock change to condition lock, and need additional mutex lock</li>
<li>data structure for each thread OR</li>
<li>if lock the whole list, the other jobs have to wait, it is the waste of time</li>
</ol></li>

<li><p>
11.4
</p>

<blockquote>
<p>
It depends on the circumstances. In general, both can be correct, but each alternative has drawbacks. In the first sequence, the waiting threads will be scheduled to run after we call pthread_cond_broadcast. If the program is running on a multiprocessor, some threads will run and immediately block because we are still holding the mutex (recall that pthread_cond_wait returns with the mutex held). In the second sequence, a running thread can acquire the mutex between steps 3 and 4, invalidate the condition, and release the mutex. Then, when we call pthread_cond_broadcast, the condition will no longer be true, and the threads will run needlessly. This is why the awakened threads must recheck the condition and not assume that it is true merely because pthread_cond_wait returned.
</p>
</blockquote></li>

<li><p>
11.5
</p>

<p>
pthread_cond &amp;&amp; counter
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     11fig16.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-11-10</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    show how a barrier can be used to synchronize threads cooperating</span>
<span style="color: #9f8766;"> * on a single task</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">limits.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/time.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">NTHR</span>   <span style="color: #a45bad;">8</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">NUMNUM</span> <span style="color: #a45bad;">800000L</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">TNUM</span>   <span style="color: #4f97d7;">(</span>NUMNUM / NTHR<span style="color: #4f97d7;">)</span>

<span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">nums</span><span style="color: #4f97d7;">[</span>NUMNUM<span style="color: #4f97d7;">]</span>;
<span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">snums</span><span style="color: #4f97d7;">[</span>NUMNUM<span style="color: #4f97d7;">]</span>;

<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>SOLARIS<span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">heapsort</span> gsort
<span style="color: #bc6ec5;">#elif</span> <span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>__linux__<span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">heapsort</span> qsort
<span style="color: #bc6ec5;">#else</span>
<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">heapsort</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *, <span style="color: #ce537a; font-weight: bold;">size_t</span>, <span style="color: #ce537a; font-weight: bold;">size_t</span>,
                    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5;">(</span>*<span style="color: #bc6ec5;">)(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">void</span> *, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>;
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>__APPLE__<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">typedef</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>             <span style="color: #7590db;">counter</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_cond_t</span>  <span style="color: #7590db;">cond</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> <span style="color: #7590db;">mutex</span>;
<span style="color: #4f97d7;">}</span> <span style="color: #ce537a; font-weight: bold;">pthread_barrier_t</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_barrier_init</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_barrier_t</span> *<span style="color: #7590db;">b</span>, <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">attr</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">count</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">ret</span>;

    ret = pthread_mutex_init<span style="color: #bc6ec5;">(</span>&amp;b-&gt;mutex, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ret != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">goto</span> <span style="color: #a45bad;">err</span>;
    <span style="color: #bc6ec5;">}</span>
    ret = pthread_cond_init<span style="color: #bc6ec5;">(</span>&amp;b-&gt;cond, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ret != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        pthread_mutex_destroy<span style="color: #2d9574;">(</span>&amp;b-&gt;mutex<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">goto</span> <span style="color: #a45bad;">err</span>;
    <span style="color: #bc6ec5;">}</span>
    b-&gt;counter = count;

    <span style="color: #4f97d7; font-weight: bold;">return</span> ret;
<span style="color: #a45bad;">err</span>:
    <span style="color: #4f97d7; font-weight: bold;">return</span> ret;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_destroy</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_barrier_t</span> *<span style="color: #7590db;">b</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">ret</span> = <span style="color: #a45bad;">0</span>;

    ret = pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;b-&gt;mutex<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ret != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">goto</span> <span style="color: #a45bad;">err</span>;
    <span style="color: #bc6ec5;">}</span>

    ret = pthread_mutex_destroy<span style="color: #bc6ec5;">(</span>&amp;b-&gt;mutex<span style="color: #bc6ec5;">)</span>;
    ret = pthread_cond_destroy<span style="color: #bc6ec5;">(</span>&amp;b-&gt;cond<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> ret;
<span style="color: #a45bad;">err</span>:
    <span style="color: #4f97d7; font-weight: bold;">return</span> ret;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_barrier_wait</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_barrier_t</span> *<span style="color: #7590db;">b</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">cancel</span> = <span style="color: #a45bad;">0</span>;

    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">ret</span> = pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;b-&gt;mutex<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ret != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">goto</span> <span style="color: #a45bad;">err</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>--b-&gt;counter == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        pthread_cond_broadcast<span style="color: #2d9574;">(</span>&amp;b-&gt;cond<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        pthread_setcancelstate<span style="color: #2d9574;">(</span>PTHREAD_CANCEL_DISABLE, &amp;cancel<span style="color: #2d9574;">)</span>;

        pthread_cond_wait<span style="color: #2d9574;">(</span>&amp;b-&gt;cond, &amp;b-&gt;mutex<span style="color: #2d9574;">)</span>;
        pthread_setcancelstate<span style="color: #2d9574;">(</span>cancel, <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;b-&gt;mutex<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> ret;

<span style="color: #a45bad;">err</span>:
    <span style="color: #4f97d7; font-weight: bold;">return</span> ret;
<span style="color: #4f97d7;">}</span>
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #ce537a; font-weight: bold;">pthread_barrier_t</span> <span style="color: #7590db;">b</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">complong</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg1</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg2</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">l1</span> = *<span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">long</span> *<span style="color: #bc6ec5;">)</span>arg1;
    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">l2</span> = *<span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">long</span> *<span style="color: #bc6ec5;">)</span>arg2;

    <span style="color: #4f97d7; font-weight: bold;">return</span> l1 == l2 ? <span style="color: #a45bad;">0</span> : l1 &gt; l2 ? <span style="color: #a45bad;">1</span> : -<span style="color: #a45bad;">1</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">thr_fn</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">idx</span> = <span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #bc6ec5;">)</span>arg;

    heapsort<span style="color: #bc6ec5;">(</span>&amp;nums<span style="color: #2d9574;">[</span>idx<span style="color: #2d9574;">]</span>, TNUM, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>, complong<span style="color: #bc6ec5;">)</span>;
    pthread_barrier_wait<span style="color: #bc6ec5;">(</span>&amp;b<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">merge</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">idx</span><span style="color: #bc6ec5;">[</span>NTHR<span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">i</span>, <span style="color: #7590db;">minidx</span>, <span style="color: #7590db;">sidx</span>, <span style="color: #7590db;">num</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; NTHR; i++<span style="color: #bc6ec5;">)</span> idx<span style="color: #bc6ec5;">[</span>i<span style="color: #bc6ec5;">]</span> = i * TNUM;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>sidx = <span style="color: #a45bad;">0</span>; sidx &lt; NUMNUM; sidx++<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        num = LONG_MAX;
        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #2d9574;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; NTHR; ++i<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>idx<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span> &lt; <span style="color: #4f97d7;">(</span>i + <span style="color: #a45bad;">1</span><span style="color: #4f97d7;">)</span> * TNUM<span style="color: #b1951d;">)</span> &amp;&amp; <span style="color: #b1951d;">(</span>nums<span style="color: #4f97d7;">[</span>idx<span style="color: #bc6ec5;">[</span>i<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">]</span> &lt; num<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                num    = nums<span style="color: #b1951d;">[</span>idx<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span><span style="color: #b1951d;">]</span>;
                minidx = i;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>
        snums<span style="color: #2d9574;">[</span>sidx<span style="color: #2d9574;">]</span> = nums<span style="color: #2d9574;">[</span>idx<span style="color: #67b11d;">[</span>minidx<span style="color: #67b11d;">]</span><span style="color: #2d9574;">]</span>;
        idx<span style="color: #2d9574;">[</span>minidx<span style="color: #2d9574;">]</span>++;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span>  <span style="color: #7590db;">i</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timeval</span> <span style="color: #7590db;">start</span>, <span style="color: #7590db;">end</span>;
    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #ce537a; font-weight: bold;">long</span>      <span style="color: #7590db;">startusec</span>, <span style="color: #7590db;">endusec</span>;
    <span style="color: #ce537a; font-weight: bold;">double</span>         <span style="color: #7590db;">elapsed</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>            <span style="color: #7590db;">err</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_t</span>      <span style="color: #7590db;">tid</span>;

    srandom<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; NUMNUM; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        nums<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span> = random<span style="color: #2d9574;">()</span>;
    <span style="color: #bc6ec5;">}</span>

    gettimeofday<span style="color: #bc6ec5;">(</span>&amp;start, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    pthread_barrier_init<span style="color: #bc6ec5;">(</span>&amp;b, <span style="color: #a45bad;">NULL</span>, NTHR + <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; NTHR; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">func</span> = thr_fn;
        err        = pthread_create<span style="color: #2d9574;">(</span>&amp;tid, <span style="color: #a45bad;">NULL</span>, thr_fn, <span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #67b11d;">)(</span>i * TNUM<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_exit<span style="color: #67b11d;">(</span>err, <span style="color: #2d9574;">"can't create thread"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
    pthread_barrier_wait<span style="color: #bc6ec5;">(</span>&amp;b<span style="color: #bc6ec5;">)</span>;
    merge<span style="color: #bc6ec5;">()</span>;
    gettimeofday<span style="color: #bc6ec5;">(</span>&amp;end, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;

    startusec = start.tv_sec * <span style="color: #a45bad;">1000000</span> + start.tv_usec;
    endusec   = end.tv_sec * <span style="color: #a45bad;">100000</span> + end.tv_usec;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"sort took %.4f seconds"</span>, elapsed<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; NUMNUM; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%ld\n"</span>, snums<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org1fc0cca" class="outline-3">
<h3 id="org1fc0cca"><span class="done DONE">DONE</span> Chapter 12. Thread Control <code>[11/11]</code></h3>
<div class="outline-text-3" id="text-org1fc0cca">
</div>

<div id="outline-container-org7040819" class="outline-4">
<h4 id="org7040819"><span class="done DONE">DONE</span> 12.1 Introduction</h4>
<div class="outline-text-4" id="text-org7040819">
</div>
</div>

<div id="outline-container-org361dd8a" class="outline-4">
<h4 id="org361dd8a"><span class="done DONE">DONE</span> 12.2 Thread Limits</h4>
<div class="outline-text-4" id="text-org361dd8a">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 11:</span> Figure 12.1 Thread limits and <i>name</i> arguments to <code>sysconf</code></caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Name of limit</th>
<th scope="col" class="org-left">Description</th>
<th scope="col" class="org-left"><i>name</i> argument</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">PTHREAD_DESTRUCTOR_ITERATIONS</td>
<td class="org-left">maximum number of times an implemetation will</td>
<td class="org-left">_SC_THREAD_DESTRUCTOR_ITERATIONS</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">try to destroy the thread-specific data</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">when a thread exits (Section 12.6)</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">PTHREAD_KEYS_MAX</td>
<td class="org-left">maximum number of keys that can be created</td>
<td class="org-left">_SC_THREAD_KEYS_MAX</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">by a process (Section 12.6)</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">PTHREAD_STACK_MIN</td>
<td class="org-left">minimum number of bytes that can be used</td>
<td class="org-left">_SC_THREAD_STACK_MIN</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">for a thread's stack (Section by 12.3)</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">PTHREAD_STACK_MAX</td>
<td class="org-left">maximum number of threads that can be created</td>
<td class="org-left">_SC_THREAD_STACK_MAX</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">in a process (Section 12.3)</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orgc0f7c7b" class="outline-4">
<h4 id="orgc0f7c7b"><span class="done DONE">DONE</span> 12.3 Thread Attributes</h4>
<div class="outline-text-4" id="text-orgc0f7c7b">
<blockquote>
<ol class="org-ol">
<li>Each object is associated with its own type of attribute object (threads with thread attributes, mutexes with mutex attributes, and so on).</li>

<li>An initialization function exists to set the attributes to their default values.</li>

<li>Another function exists to destroy the attributes object.</li>

<li>Each attribute has a function to get the value of the attribute from the attribute object.</li>

<li>Each attribute has a function to set the value of the attribute.</li>
</ol>
</blockquote>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_attr_init</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_attr_t</span> *<span style="color: #7590db;">attr</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_attr_destroy</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_attr_t</span> *<span style="color: #7590db;">attr</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>

<p>
attributes:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 12:</span> Figure 12.3 POSIX.1 thread attributes</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Name</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><i>detachstate</i></td>
<td class="org-left">detached threada attribute</td>
</tr>

<tr>
<td class="org-left"><i>guardsize</i></td>
<td class="org-left">guard buffer size in bytes at end of thread stack</td>
</tr>

<tr>
<td class="org-left"><i>stackaddr</i></td>
<td class="org-left">lowest address of thread stack</td>
</tr>

<tr>
<td class="org-left"><i>stacksize</i></td>
<td class="org-left">minimum size in bytes of thread stack</td>
</tr>
</tbody>
</table>

<p>
detachstate:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_attr_getdetachstate</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">ptrhead_attr_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">attr</span>,
                                <span style="color: #ce537a; font-weight: bold;">int</span> *<span style="color: #7590db;">detachstate</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_attr_setdetachstate</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_attr_t</span> *<span style="color: #7590db;">attr</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">detachstate</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>
<p>
<code>PTHREAD_CREATE_DETACHED</code> or <code>PTHREAD_CREATE_JOINABLE</code>
</p>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 97: </span>Figure 12.4 Creating a thread in the detached state</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     12fig04.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-11-15</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    create a thread in the detached state</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">makethread</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5;">(</span>*<span style="color: #bc6ec5; font-weight: bold;">fn</span><span style="color: #bc6ec5;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5;">)</span>, <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>            <span style="color: #7590db;">err</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_t</span>      <span style="color: #7590db;">tid</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_attr_t</span> <span style="color: #7590db;">attr</span>;

    err = pthread_attr_init<span style="color: #bc6ec5;">(</span>&amp;attr<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span>err<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    err = pthread_attr_setdetachstate<span style="color: #bc6ec5;">(</span>&amp;attr, PTHREAD_CREATE_DETACHED<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err = pthread_create<span style="color: #2d9574;">(</span>&amp;tid, &amp;attr, fn, arg<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    pthread_attr_destroy<span style="color: #bc6ec5;">(</span>&amp;attr<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> err;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>

<p>
stack:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_attr_getstack</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">pthread_attr_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">attr</span>,
                          <span style="color: #ce537a; font-weight: bold;">void</span> **<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">stackattr</span>,
                          <span style="color: #ce537a; font-weight: bold;">size_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">stacksize</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_attr_setstack</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_attr_t</span> *<span style="color: #7590db;">attr</span>,
                          <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">stackaddr</span>, <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">stacksize</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>

<p>
guardsize:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_attr_getguardsize</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">pthread_attr_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">attr</span>,
                              <span style="color: #ce537a; font-weight: bold;">size_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">guardsize</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_attr_setguardsize</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_attr_t</span> *<span style="color: #7590db;">attr</span>, <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">guardsize</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>

<blockquote>
<p>
Threads have other attributes not represented by the pthread_attr_t structure: the cancelability state and the cancelability type.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org762a0d8" class="outline-4">
<h4 id="org762a0d8"><span class="done DONE">DONE</span> 12.4 Synchronization Attributes <code>[4/4]</code></h4>
<div class="outline-text-4" id="text-org762a0d8">
</div>

<ul class="org-ul">
<li><a id="org6eec38a"></a><span class="done DONE">DONE</span> 12.4.1 Mutex Attributes<br />
<div class="outline-text-5" id="text-org6eec38a">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_mutexattr_init</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_mutexattr_t</span> *<span style="color: #7590db;">attr</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_mutexattr_destroy</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_mutexattr</span> *<span style="color: #7590db;">attr</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_mutexattr_getpshared</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">pthread_mutexattr_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">attr</span>,
                                 <span style="color: #ce537a; font-weight: bold;">int</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">pshared</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_mutexattr_setpshared</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_mutexattr_t</span> *<span style="color: #7590db;">attr</span>,
                                 <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">pshared</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>
<p>
default: <code>PTHREAD_PROCESS_PRIVATE</code>
</p>
<blockquote>
<p>
multiple threads can access the same synchronization object
</p>
</blockquote>
<p>
other: <code>PTHREAD_PROCESS_SHARED</code>
</p>
<blockquote>
<p>
a mutex allocated from a memory extent shared between multiple processes may be used for synchronization by those processes.
</p>
</blockquote>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_mutexattr_getrobust</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">pthread_mutexattr_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">attr</span>,
                                <span style="color: #ce537a; font-weight: bold;">int</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">robust</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_mutexattr_setrobust</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_mutexattr_t</span> *<span style="color: #7590db;">attr</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">robust</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>
<p>
default: <code>PTHREAD_MUTEX_STALLED</code>
</p>
<blockquote>
<p>
use of the mutex can result in undefined behavior, and applications waiting for it to be unlocked are effectively "stalled".
</p>
</blockquote>
<p>
other:   <code>PTHREAD_MUTEX_ROBUST</code>
</p>
<blockquote>
<p>
This value will cause a thread blocked in a call to pthread_mutex_lock to acquire the lock when another process holding the lock terminates without first unlocking it, but the return value from pthread_mutex_lock is EOWNERDEAD instead of 0.
</p>
</blockquote>

<p>
<b>Using robust mutexes has to check for three return values instead of two</b>:
</p>
<ul class="org-ul">
<li>success with no recovery</li>
<li>success but recovery needj</li>
<li>failure</li>
</ul>

<p>
for application can't be recovered to indicate that the state associated with the mutex is consistent before unlocking the mutex.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_mutex_consistent</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> *<span style="color: #7590db;">mutex</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, error number on failure</span>
</pre>
</div>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 13:</span> mutex types</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">type</th>
<th scope="col" class="org-left">description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">PTHREAD_MUTEX_NORMAL</td>
<td class="org-left">doesn't do any special error checking or deadlock detection</td>
</tr>

<tr>
<td class="org-left">PTHREAD_MUTEX_ERRORCHECK</td>
<td class="org-left">provides error checking</td>
</tr>

<tr>
<td class="org-left">PTHREAD_MUTEX_RECURSIVE</td>
<td class="org-left">allow the same thread to lock multiple times without first unlocking</td>
</tr>

<tr>
<td class="org-left">PTHREAD_MUTEX_DEFAULT</td>
<td class="org-left">prividing default characteristics and behavior.</td>
</tr>
</tbody>
</table>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 14:</span> Figure 12.5 Mutex type behavior</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Mutex type</th>
<th scope="col" class="org-left">Relock without unlock?</th>
<th scope="col" class="org-left">Unlock when not owned?</th>
<th scope="col" class="org-left">Unlock when unlocked?</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">PTHREAD_MUTEX_NORMAL</td>
<td class="org-left">deadlock</td>
<td class="org-left">undefined</td>
<td class="org-left">undefined</td>
</tr>

<tr>
<td class="org-left">PTHREAD_MUTEX_ERRORCHECK</td>
<td class="org-left">returns error</td>
<td class="org-left">returns error</td>
<td class="org-left">returns error</td>
</tr>

<tr>
<td class="org-left">PTHREAD_MUTEX_RECURSIVE</td>
<td class="org-left">allowed</td>
<td class="org-left">returns error</td>
<td class="org-left">returns error</td>
</tr>

<tr>
<td class="org-left">PTHREAD_MUTEX_DEFAULT</td>
<td class="org-left">undefined</td>
<td class="org-left">undefined</td>
<td class="org-left">undefined</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_mutexattr_gettype</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">pthread_mutexattr_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">attr</span>,
                              <span style="color: #ce537a; font-weight: bold;">int</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">type</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_mutexattr_settype</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_mutexattr_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">attr</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">type</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>

<blockquote>
<p>
If a recursive mutex is locked multiple times and used in a call to pthread_cond_wait, the condition can never be satisfied, because the unlock done by pthread_cond_wait doesn’t release the mutex.
</p>

<p>
should be used only when no other solution is possible.
</p>
</blockquote>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 98: </span>Figure 12.8 Using a recursive mutex</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     fig.8.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-11-15</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Using a recursive mutex</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/time.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">time.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">makethread</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5;">(</span>*<span style="color: #bc6ec5;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5;">)</span>, <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #4f97d7;">)</span>;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">to_info</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5;">(</span>*<span style="color: #bc6ec5; font-weight: bold;">to_fn</span><span style="color: #bc6ec5;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5;">)</span>;    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">function</span>
    <span style="color: #ce537a; font-weight: bold;">void</span> *          <span style="color: #7590db;">to_arg</span>;   <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">argument</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span> <span style="color: #7590db;">to_wait</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">time to wait</span>
<span style="color: #4f97d7;">}</span>;

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">SECTONSEC</span> <span style="color: #a45bad;">1000000000</span>  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">seconds to nanoseconds</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #bc6ec5; font-weight: bold;">clock_nanosleep</span><span style="color: #4f97d7;">(</span><span style="color: #7590db;">ID</span>, <span style="color: #7590db;">FL</span>, <span style="color: #7590db;">REQ</span>, <span style="color: #7590db;">REM</span><span style="color: #4f97d7;">)</span> nanosleep<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span>REQ<span style="color: #bc6ec5;">)</span>, <span style="color: #bc6ec5;">(</span>REM<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #bc6ec5;">#if</span><span style="color: #bc6ec5;">n</span><span style="color: #bc6ec5;">def</span> CLOCK_REALTIME
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">CLOCK_REALTIME</span> <span style="color: #a45bad;">0</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">USECTONSEC</span>     <span style="color: #a45bad;">1000</span>  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">microseconds to nanoseconds</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">clock_gettime</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">id</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span> *<span style="color: #7590db;">tsp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timeval</span> <span style="color: #7590db;">tv</span>;

    gettimeofday<span style="color: #bc6ec5;">(</span>&amp;tv, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    tsp-&gt;tv_sec  = tv.tv_sec;
    tsp-&gt;tv_nsec = tv.tv_usec * USECTONSEC
<span style="color: #4f97d7;">}</span>
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">timeout_helper</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">to_info</span> *<span style="color: #7590db;">tip</span>;

    tip = <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">to_info</span> *<span style="color: #bc6ec5;">)</span>arg;
    clock_nanosleep<span style="color: #bc6ec5;">(</span>CLOCK_REALTIME, <span style="color: #a45bad;">0</span>, &amp;tip-&gt;to_wait, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #bc6ec5;">(</span>*tip-&gt;to_fn<span style="color: #bc6ec5;">)(</span>tip-&gt;to_arg<span style="color: #bc6ec5;">)</span>;
    free<span style="color: #bc6ec5;">(</span>arg<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">timeout</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span> *<span style="color: #7590db;">when</span>, <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5;">(</span>*<span style="color: #bc6ec5; font-weight: bold;">func</span><span style="color: #bc6ec5;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5;">)</span>, <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span> <span style="color: #7590db;">now</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">to_info</span> *<span style="color: #7590db;">tip</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>             <span style="color: #7590db;">err</span>;

    clock_gettime<span style="color: #bc6ec5;">(</span>CLOCK_REALTIME, &amp;now<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>when-&gt;tv_sec &gt; now.tv_sec<span style="color: #2d9574;">)</span> ||
        <span style="color: #2d9574;">(</span>when-&gt;tv_sec == now.tv_sec &amp;&amp; when-&gt;tv_nsec &gt; now.tv_nsec<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        tip = malloc<span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">to_info</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>tip != <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            tip-&gt;to_fn          = func;
            tip-&gt;to_arg         = arg;
            tip-&gt;to_wait.tv_sec = when-&gt;tv_sec - now.tv_sec;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>when-&gt;tv_nsec &gt;= now.tv_nsec<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                tip-&gt;to_wait.tv_nsec = when-&gt;tv_nsec - now.tv_nsec;
            <span style="color: #67b11d;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #67b11d;">{</span>
                tip-&gt;to_wait.tv_sec--;
                tip-&gt;to_wait.tv_nsec = SECTONSEC - now.tv_nsec + when-&gt;tv_nsec;
            <span style="color: #67b11d;">}</span>

            <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">err = makethread(timeout_helper, (void *)tip);</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>err == <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                <span style="color: #4f97d7; font-weight: bold;">return</span>;
            <span style="color: #67b11d;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #67b11d;">{</span>
                free<span style="color: #b1951d;">(</span>tip<span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #bc6ec5;">(</span>*func<span style="color: #bc6ec5;">)(</span>arg<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">pthread_mutexattr_t</span> <span style="color: #7590db;">attr</span>;
<span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span>     <span style="color: #7590db;">mutex</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">retry</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;mutex<span style="color: #bc6ec5;">)</span>;

    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;mutex<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>             <span style="color: #7590db;">err</span> = <span style="color: #a45bad;">0</span>, <span style="color: #7590db;">condition</span> = <span style="color: #a45bad;">0</span>, <span style="color: #7590db;">arg</span> = <span style="color: #a45bad;">0</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span> <span style="color: #7590db;">when</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = pthread_mutexattr_init<span style="color: #67b11d;">(</span>&amp;attr<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"pthread_mutexattr_init failed"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = pthread_mutexattr_settype<span style="color: #67b11d;">(</span>&amp;attr, PTHREAD_MUTEX_RECURSIVE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> !=
        <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't set recursive type"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = pthread_mutex_init<span style="color: #67b11d;">(</span>&amp;mutex, &amp;attr<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't create recursive mutex"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>condition == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        clock_gettime<span style="color: #2d9574;">(</span>CLOCK_REALTIME, &amp;when<span style="color: #2d9574;">)</span>;
        when.tv_sec += <span style="color: #a45bad;">10</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">10 seconds after now</span>
        timeout<span style="color: #2d9574;">(</span>&amp;when, retry, <span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #67b11d;">)(</span><span style="color: #b1951d;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #b1951d;">)</span>arg<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;mutex<span style="color: #bc6ec5;">)</span>;

    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>

<li><a id="org6716f82"></a><span class="done DONE">DONE</span> 12.4.2 Reader-Writer Lock Attributes<br />
<div class="outline-text-5" id="text-org6716f82">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_rwlockattr_init</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_rwlockattr_t</span> *<span style="color: #7590db;">attr</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_rwlockattr_destroy</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_rwlockattr_t</span> *<span style="color: #7590db;">attr</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_rwlockattr_getpshared</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">pthread_rwlockattr_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">attr</span>,
                                  <span style="color: #ce537a; font-weight: bold;">int</span> *<span style="color: #7590db;">restirct</span> pshared<span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_rwlockattr_setpshared</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">pthread_rwlockattr_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">attr</span>,
                                  <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">pshared</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>
</div>
</li>

<li><a id="orge58535e"></a><span class="done DONE">DONE</span> 12.4.3 Condition Variable Attributes<br />
<div class="outline-text-5" id="text-orge58535e">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_condattr_init</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_condattr_t</span> *<span style="color: #7590db;">attr</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_condattr_destroy</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_condattr_t</span> *<span style="color: #7590db;">attr</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_condattr_getpshared</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_condattr_t</span> <span style="color: #4f97d7; font-weight: bold;">const</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">attr</span>,
                                <span style="color: #ce537a; font-weight: bold;">int</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">pshared</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_condattr_setpshared</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_condattr_t</span> *<span style="color: #7590db;">attr</span>,
                                <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">pshared</span><span style="color: #4f97d7;">)</span>; ;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_condattr_getclock</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">pthread_condattr_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">attr</span>,
                              <span style="color: #ce537a; font-weight: bold;">clockid_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">clock_id</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_condattr_setclock</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_condattr_t</span> *<span style="color: #7590db;">attr</span>,
                              <span style="color: #ce537a; font-weight: bold;">clockid_t</span> <span style="color: #7590db;">clock_id</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>
</div>
</li>

<li><a id="orgc0174cc"></a><span class="done DONE">DONE</span> 12.4.4 Barrier Attributes<br />
<div class="outline-text-5" id="text-orgc0174cc">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_barrierattr_init</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_barrierattr_t</span> *<span style="color: #7590db;">attr</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_barrierattr_destroy</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_barrierattr_t</span> *<span style="color: #7590db;">attr</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_barrierattr_getpshared</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">pthread_barrierattr_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">attr</span>,
                                   <span style="color: #ce537a; font-weight: bold;">int</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">pshared</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_barrierattr_setpshared</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">pthread_barrierattr_t</span> *<span style="color: #7590db;">attr</span>,
                                   <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">pshared</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>
</div>
</li>
</ul>
</div>

<div id="outline-container-org2c2e344" class="outline-4">
<h4 id="org2c2e344"><span class="done DONE">DONE</span> 12.5 Reentrancy</h4>
<div class="outline-text-4" id="text-org2c2e344">
<blockquote>
<p>
If a function can be safely called by multiple threads at the same time, we say that the function is thread-safe.
</p>

<p>
<i>thread-safe</i> version of functions with an _r appended at the end of its name
</p>
</blockquote>

<p>
lock associated with a given FILE object
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sstdio.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">ftrylockfile</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, nonzero if lock can't be acquired</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">flockfile</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">funlockfile</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
<p>
I/O routines might be implemented to be thread-safe, but locking applications is still useful
</p>

<p>
lock associated with character-based standard I/O
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">getchar_unlcoked</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">getc_unlcoked</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: the next character if OK, EOF on the end of file or error</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">putchar_unlocked</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">c</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">putc_unlcoked</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">c</span>, <span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: c if OK, EOF on error</span>
</pre>
</div>
<blockquote>
<p>
<b>These four functions should not be called unless they are surrounded by calls to flockfile (or ftrylockfile) and funlockfile</b>
</p>
</blockquote>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 99: </span>Figure 12.11 A nonreentrant version of getenv</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     12fig11.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-11-17</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    a possible implementation of getenv</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">limits.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">string.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">MAXSTRINGSZ</span> <span style="color: #a45bad;">4096</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">envbuf</span><span style="color: #4f97d7;">[</span>MAXSTRINGSZ<span style="color: #4f97d7;">]</span>;

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">char</span> **<span style="color: #7590db;">environ</span>;

<span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #bc6ec5; font-weight: bold;">getenv</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">i</span>, <span style="color: #7590db;">len</span>;

    len = strlen<span style="color: #bc6ec5;">(</span>name<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; environ<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span> != <span style="color: #a45bad;">NULL</span>; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>strncmp<span style="color: #b1951d;">(</span>name, environ<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span>, len<span style="color: #b1951d;">)</span> == <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> &amp;&amp; <span style="color: #67b11d;">(</span>environ<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">][</span>len<span style="color: #b1951d;">]</span> == <span style="color: #2d9574;">'='</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            strncpy<span style="color: #67b11d;">(</span>envbuf, &amp;environ<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">][</span>len + <span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span>, MAXSTRINGSZ - <span style="color: #a45bad;">1</span><span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #67b11d;">(</span>envbuf<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 100: </span>Figure 12.12 a reentrant (thread-safe) version of getenv</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     12fig12.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-11-17</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    a reentrant version of getenv</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">string.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">char</span> **<span style="color: #7590db;">environ</span>;

<span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> <span style="color: #7590db;">env_mutex</span>;

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">pthread_once_t</span> <span style="color: #7590db;">init_done</span> = PTHREAD_ONCE_INIT;

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">thread_init</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pthread_mutexattr_t</span> <span style="color: #7590db;">attr</span>;

    pthread_mutexattr_init<span style="color: #bc6ec5;">(</span>&amp;attr<span style="color: #bc6ec5;">)</span>;
    pthread_mutexattr_settype<span style="color: #bc6ec5;">(</span>&amp;attr, PTHREAD_MUTEX_RECURSIVE<span style="color: #bc6ec5;">)</span>;
    pthread_mutex_init<span style="color: #bc6ec5;">(</span>&amp;env_mutex, &amp;attr<span style="color: #bc6ec5;">)</span>;
    pthread_mutexattr_destroy<span style="color: #bc6ec5;">(</span>&amp;attr<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">getenv_r</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">buf</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">buflen</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">i</span>, <span style="color: #7590db;">len</span>, <span style="color: #7590db;">olen</span>;

    pthread_once<span style="color: #bc6ec5;">(</span>&amp;init_done, thread_init<span style="color: #bc6ec5;">)</span>;
    len = strlen<span style="color: #bc6ec5;">(</span>name<span style="color: #bc6ec5;">)</span>;
    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;env_mutex<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; environ<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span> != <span style="color: #a45bad;">NULL</span>; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>strncmp<span style="color: #b1951d;">(</span>name, environ<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span>, len<span style="color: #b1951d;">)</span> == <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> &amp;&amp; <span style="color: #67b11d;">(</span>environ<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">][</span>len<span style="color: #b1951d;">]</span> == <span style="color: #2d9574;">'='</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            olen = strlen<span style="color: #67b11d;">(</span>&amp;environ<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">][</span>len + <span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>olen &gt;= buflen<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                pthread_mutex_unlock<span style="color: #b1951d;">(</span>&amp;env_mutex<span style="color: #b1951d;">)</span>;
                pthread_mutex_destroy<span style="color: #b1951d;">(</span>&amp;env_mutex<span style="color: #b1951d;">)</span>;
                <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #b1951d;">(</span>ENOSPC<span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
            strcpy<span style="color: #67b11d;">(</span>buf, &amp;environ<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">][</span>len + <span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span>;
            pthread_mutex_unlock<span style="color: #67b11d;">(</span>&amp;env_mutex<span style="color: #67b11d;">)</span>;
            pthread_mutex_destroy<span style="color: #67b11d;">(</span>&amp;env_mutex<span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #67b11d;">(</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;env_mutex<span style="color: #bc6ec5;">)</span>;
    pthread_mutex_destroy<span style="color: #bc6ec5;">(</span>&amp;env_mutex<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>ENOENT<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-orgeafa146" class="outline-4">
<h4 id="orgeafa146"><span class="done DONE">DONE</span> 12.6 Thread-Specific Data</h4>
<div class="outline-text-4" id="text-orgeafa146">
<blockquote>
<p>
Thread-specific data, also known as thread-private data, is a mechanism for storing and finding data associated with a particular thread
</p>

<p>
The reasons to prevent sharing process data and attributes
</p>

<ul class="org-ul">
<li>First, sometimes we need to maintain data on a per-thread basis.</li>

<li>The second reason for thread-private data is to provide a mechanism for adapting process-based interfaces to a multithreaded environment.</li>
</ul>
</blockquote>

<p>
crate a <i>key</i> to gain acess to with the thread-specific data
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_key_create</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_key_t</span> *<span style="color: #7590db;">keyp</span>, <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5;">(</span>*<span style="color: #bc6ec5; font-weight: bold;">destructor</span><span style="color: #bc6ec5;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span>*<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, error number on failure</span>
</pre>
</div>
<p>
break the association of a key with the thread-specific data
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_key_delete</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_key_t</span> <span style="color: #7590db;">key</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
<blockquote>
<p>
<b>calling pthread_key_delete will not invoke the destructor function. To free a key:</b>
ensure a key we allocated doesn't change because of a race during initialization. Code like the following can result in two threads both calling <code>pthread_key_create</code>:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">destructor</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">pthread_key_t</span> <span style="color: #7590db;">key</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">init_done</span> = <span style="color: #a45bad;">0</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">threadfunc</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">!</span>init_done<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
                init_done = <span style="color: #a45bad;">1</span>;
                err = pthread_key_create<span style="color: #2d9574;">(</span>&amp;key, destructor<span style="color: #2d9574;">)</span>;
        <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<p>
The proper way to create a key without a race is as follows:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">destructor</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">pthread_key_t</span> <span style="color: #7590db;">key</span>;
<span style="color: #ce537a; font-weight: bold;">pthread_once_t</span> <span style="color: #7590db;">init_done</span> = PTHREAD_ONCE_INIT;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">thread_init</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
        err = pthread_key_create<span style="color: #bc6ec5;">(</span>&amp;key, destructor<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">threadfunc</span> <span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
        pthread_once<span style="color: #bc6ec5;">(</span>&amp;init_done, thread_init<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</blockquote>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 101: </span>Figure 12.13 A thread-safe, compatible version of getenv</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     12fig13.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-11-17</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    a hypothetical implementation of getenv</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">limits.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">string.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">MAXSTRINGSZ</span> <span style="color: #a45bad;">4096</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">pthread_key_t</span>  <span style="color: #7590db;">key</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">pthread_once_t</span> <span style="color: #7590db;">init_done</span> = PTHREAD_ONCE_INIT;
<span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span>       <span style="color: #7590db;">env_mutex</span> = PTHREAD_MUTEX_INITIALIZER;

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">char</span> **<span style="color: #7590db;">environ</span>;

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">thread_init</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> pthread_key_create<span style="color: #bc6ec5;">(</span>&amp;key, free<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #bc6ec5; font-weight: bold;">getenv</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">i</span>, <span style="color: #7590db;">len</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">envbuf</span>;

    pthread_once<span style="color: #bc6ec5;">(</span>&amp;init_done, thread_init<span style="color: #bc6ec5;">)</span>;
    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;env_mutex<span style="color: #bc6ec5;">)</span>;
    envbuf = <span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #bc6ec5;">)</span>pthread_getspecific<span style="color: #bc6ec5;">(</span>key<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>envbuf == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        envbuf = malloc<span style="color: #2d9574;">(</span>MAXSTRINGSZ<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>envbuf == <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">goto</span> <span style="color: #a45bad;">nil</span>;
        <span style="color: #2d9574;">}</span>
        pthread_setspecific<span style="color: #2d9574;">(</span>key, envbuf<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    len = strlen<span style="color: #bc6ec5;">(</span>name<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; environ<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span> != <span style="color: #a45bad;">NULL</span>; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>strncmp<span style="color: #b1951d;">(</span>name, environ<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span>, len<span style="color: #b1951d;">)</span> == <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> &amp;&amp; <span style="color: #67b11d;">(</span>environ<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">][</span>len<span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span> == <span style="color: #2d9574;">'='</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            snprintf<span style="color: #67b11d;">(</span>envbuf, MAXSTRINGSZ - <span style="color: #a45bad;">1</span>, <span style="color: #2d9574;">"%s"</span>, &amp;environ<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">][</span>len + <span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span>;
            pthread_mutex_unlock<span style="color: #67b11d;">(</span>&amp;env_mutex<span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #67b11d;">(</span>envbuf<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

<span style="color: #a45bad;">nil</span>:
    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;env_mutex<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org251542e" class="outline-4">
<h4 id="org251542e"><span class="done DONE">DONE</span> 12.7 Cancel Options</h4>
<div class="outline-text-4" id="text-org251542e">
<blockquote>
<p>
The <i>cancelability state</i> attribute can be either PTHREAD_CANCEL_ENABLE or PTHREAD_CANCEL_DISABLE.
</p>
</blockquote>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_setcancelstate</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">state</span>, <span style="color: #ce537a; font-weight: bold;">int</span>* <span style="color: #7590db;">oldstate</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, error number on failure</span>
</pre>
</div>

<blockquote>
<p>
a call to pthread_cancel doesn’t wait for a thread to terminate. In the default case, a thread will continue to execute after a cancellation request is made until the thread reaches a cancellation point.
</p>

<p>
When the state is set to PTHREAD_CANCEL_DISABLE, a call to pthread_cancel will not kill the thread. Instead, the cancellation request remains pending for the thread. When the state is enabled again, the thread will act on any pending cancellation requests at the next cancellation point.
</p>
</blockquote>

<p>
add you own cancellation points
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_testcancel</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
<p>
Cancel the pending and enbaled cancellation request, no effect when cancellation is disabled.
</p>

<p>
change the cancellation type
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_setcanceltype</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">type</span>, <span style="color: #ce537a; font-weight: bold;">int</span> *<span style="color: #7590db;">oldtype</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, error number on failure</span>
</pre>
</div>
<p>
type: PTHREAD_CANCEL_DEFERRED, PTHREAD_CANCEL_ASYNCHRONOUS
</p>
</div>
</div>

<div id="outline-container-org135236c" class="outline-4">
<h4 id="org135236c"><span class="done DONE">DONE</span> 12.8 Threads and Signals</h4>
<div class="outline-text-4" id="text-org135236c">
<p>
function like <code>sigprocmask</code>, but works with threads and returns error number instead:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_sigmask</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">how</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">sigset_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">set</span>,
                    <span style="color: #ce537a; font-weight: bold;">sigset_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">oset</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, error number on failure</span>
</pre>
</div>
<p>
how values:
</p>
<ul class="org-ul">
<li>SIG_BLOCK</li>
<li>SIG_SETMASK</li>
<li><p>
SIG_UNBLOCK
</p>

<p>
wait one or more signals:
</p></li>
</ul>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sigwait</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">siget_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">set</span>, <span style="color: #ce537a; font-weight: bold;">int</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">signop</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, error number on failure</span>
</pre>
</div>

<p>
function like <code>kill</code>:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_kill</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_t</span> <span style="color: #7590db;">thread</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, error number on failure</span>
</pre>
</div>

<ul class="org-ul">
<li><p>
Example:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 102: </span>Figure 12.16 Synchronous signal handling</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     12fig16.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-11-27</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes81 <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    threads protect flag via mutex</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span>      <span style="color: #7590db;">quitflag</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">set nonzero by thread</span>
<span style="color: #ce537a; font-weight: bold;">sigset_t</span> <span style="color: #7590db;">mask</span>;

<span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> <span style="color: #7590db;">lock</span>    = PTHREAD_MUTEX_INITIALIZER;
<span style="color: #ce537a; font-weight: bold;">pthread_cond_t</span>  <span style="color: #7590db;">waitloc</span> = PTHREAD_COND_INITIALIZER;

<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">thr_fn</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">err</span>, <span style="color: #7590db;">signo</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>;;<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err = sigwait<span style="color: #2d9574;">(</span>&amp;mask, &amp;signo<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_exit<span style="color: #67b11d;">(</span>err, <span style="color: #2d9574;">"sigwait failed"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">switch</span> <span style="color: #2d9574;">(</span>signo<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">case</span> SIGINT:
                printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"\ninterrupt\n"</span><span style="color: #67b11d;">)</span>;
                <span style="color: #4f97d7; font-weight: bold;">break</span>;

            <span style="color: #4f97d7; font-weight: bold;">case</span> SIGQUIT:
                pthread_mutex_lock<span style="color: #67b11d;">(</span>&amp;lock<span style="color: #67b11d;">)</span>;
                quitflag = <span style="color: #a45bad;">1</span>;
                pthread_mutex_unlock<span style="color: #67b11d;">(</span>&amp;lock<span style="color: #67b11d;">)</span>;
                pthread_cond_signal<span style="color: #67b11d;">(</span>&amp;waitloc<span style="color: #67b11d;">)</span>;
                <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;

            <span style="color: #4f97d7; font-weight: bold;">default</span>:
                printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"unexpected signal %s\n"</span>, strsignal<span style="color: #b1951d;">(</span>signo<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>;
                exit<span style="color: #67b11d;">(</span>EXIT_FAILURE<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>       <span style="color: #7590db;">err</span>;
    <span style="color: #ce537a; font-weight: bold;">sigset_t</span>  <span style="color: #7590db;">oldmask</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_t</span> <span style="color: #7590db;">tid</span>;

    sigemptyset<span style="color: #bc6ec5;">(</span>&amp;mask<span style="color: #bc6ec5;">)</span>;
    sigaddset<span style="color: #bc6ec5;">(</span>&amp;mask, SIGINT<span style="color: #bc6ec5;">)</span>;
    sigaddset<span style="color: #bc6ec5;">(</span>&amp;mask, SIGQUIT<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = pthread_sigmask<span style="color: #67b11d;">(</span>SIG_BLOCK, &amp;mask, &amp;oldmask<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"SIG_BLOCK error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    err = pthread_create<span style="color: #bc6ec5;">(</span>&amp;tid, <span style="color: #a45bad;">NULL</span>, thr_fn, <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't create thread"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;lock<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span>quitflag == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        pthread_cond_wait<span style="color: #2d9574;">(</span>&amp;waitloc, &amp;lock<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;lock<span style="color: #bc6ec5;">)</span>;

    quitflag = <span style="color: #a45bad;">0</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigprocmask<span style="color: #2d9574;">(</span>SIG_SETMASK, &amp;oldmask, <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"SIG_SETMASK error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-orgbfc013c" class="outline-4">
<h4 id="orgbfc013c"><span class="done DONE">DONE</span> 12.9 Threads and fork</h4>
<div class="outline-text-4" id="text-orgbfc013c">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_atfork</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5;">(</span>*<span style="color: #bc6ec5; font-weight: bold;">prepare</span><span style="color: #bc6ec5;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #bc6ec5;">)</span>, <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5;">(</span>*<span style="color: #bc6ec5; font-weight: bold;">parent</span><span style="color: #bc6ec5;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #bc6ec5;">)</span>,
                   <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5;">(</span>*<span style="color: #bc6ec5; font-weight: bold;">child</span><span style="color: #bc6ec5;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, error number on failure</span>
</pre>
</div>

<ul class="org-ul">
<li><b>prepare</b> called before <code>fork</code> creates the child process</li>
<li><b>parent</b> called in parent after <code>fork</code> has created the child but before returned</li>
<li><b>child</b> called in child before returning</li>
</ul>

<p>
<b>the child will get a copy of all locks that the parent defined, but in new memory</b>
</p>
<ol class="org-ol">
<li>The parent acquired all its locks.</li>
<li>The child acquired all its locks.</li>
<li>The parent released its locks.</li>
<li>The child relased its locks.</li>

<li><p>
Example:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 103: </span>Figure 12.17 pthread_atfork example</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     12fig17.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-11-27</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes81 <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    pthread_atfork example</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> <span style="color: #7590db;">lock1</span> = PTHREAD_MUTEX_INITIALIZER;
<span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> <span style="color: #7590db;">lock2</span> = PTHREAD_MUTEX_INITIALIZER;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">prepare</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">err</span>;

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"preparing locks ...\n"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = pthread_mutex_lock<span style="color: #67b11d;">(</span>&amp;lock1<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_cont<span style="color: #bc6ec5;">(</span>err, <span style="color: #2d9574;">"can't lock lock1 in the prepare handler"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = pthread_mutex_lock<span style="color: #67b11d;">(</span>&amp;lock2<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_cont<span style="color: #bc6ec5;">(</span>err, <span style="color: #2d9574;">"can't lock lock2 in the prepare handler"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">parent</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">err</span>;

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"parent unlocking locks...\n"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = pthread_mutex_unlock<span style="color: #67b11d;">(</span>&amp;lock1<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_cont<span style="color: #bc6ec5;">(</span>err, <span style="color: #2d9574;">"can't unlock lock1 in parent handler"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = pthread_mutex_unlock<span style="color: #67b11d;">(</span>&amp;lock2<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_cont<span style="color: #bc6ec5;">(</span>err, <span style="color: #2d9574;">"can't unlock lock2 in parent handler"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">child</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">err</span>;

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"child unlocking locks...\n"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = pthread_mutex_unlock<span style="color: #67b11d;">(</span>&amp;lock1<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_cont<span style="color: #bc6ec5;">(</span>err, <span style="color: #2d9574;">"can't unlock lock1 in child handler"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = pthread_mutex_unlock<span style="color: #67b11d;">(</span>&amp;lock2<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_cont<span style="color: #bc6ec5;">(</span>err, <span style="color: #2d9574;">"can't unlock lock2 in child handler"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">thr_fn</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"thread started...\n"</span><span style="color: #bc6ec5;">)</span>;
    pause<span style="color: #bc6ec5;">()</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>       <span style="color: #7590db;">err</span>;
    <span style="color: #ce537a; font-weight: bold;">pid_t</span>     <span style="color: #7590db;">pid</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_t</span> <span style="color: #7590db;">tid</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = pthread_atfork<span style="color: #67b11d;">(</span>prepare, parent, child<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_exit<span style="color: #bc6ec5;">(</span>err, <span style="color: #2d9574;">"can't install fork handlers"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = pthread_create<span style="color: #67b11d;">(</span>&amp;tid, <span style="color: #a45bad;">NULL</span>, thr_fn, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_exit<span style="color: #bc6ec5;">(</span>err, <span style="color: #2d9574;">"can't create thread"</span><span style="color: #bc6ec5;">)</span>;

    sleep<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"parent about to fork...\n"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">switch</span> <span style="color: #bc6ec5;">(</span>fork<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">case</span> -<span style="color: #a45bad;">1</span>:
            err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork failed"</span><span style="color: #2d9574;">)</span>;

        <span style="color: #4f97d7; font-weight: bold;">case</span> <span style="color: #a45bad;">0</span>:
            printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"child returned from fork\n"</span><span style="color: #2d9574;">)</span>;

        <span style="color: #4f97d7; font-weight: bold;">default</span>:
            printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"parent returned from fork\n"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ol>

<p>
<b>drawbacks</b>:
</p>
<blockquote>
<ul class="org-ul">
<li>no good way to reinitialize the state for more complex synchronization like conditioon and barriers.</li>
<li>some implementations of error-checking mutexes will generate errors when the child fork handler tries to unlock a mutex that was locked by the parent</li>
<li>recursive mutexes can't be cleand up in the child fork handler, because there is no way to determine the number of times one has been locked</li>
<li>if child process are allowed to call only async-singal safe functions, then the child fork handler shouldn't even be able to clean up synchronization objects, because none of the functions are used to manipulate them are async-signal safe.</li>
<li>if an application calls fork in a signal handler(which is legal, because fork is async-signal safe), then the fork handlers registered by <code>pthread_atfork</code> can only async-signal safe functions, or else the results are undefined.</li>
</ul>
</blockquote>
</div>
</div>

<div id="outline-container-org35b95fb" class="outline-4">
<h4 id="org35b95fb"><span class="done DONE">DONE</span> 12.10 Threads and I/O</h4>
<div class="outline-text-4" id="text-org35b95fb">
<p>
use <code>pread/pwrite</code> in Chapter 3 to solve I/O at different record
</p>
</div>
</div>

<div id="outline-container-org4550453" class="outline-4">
<h4 id="org4550453"><span class="done DONE">DONE</span> 12.11 Summary</h4>
<div class="outline-text-4" id="text-org4550453">
<ul class="org-ul">
<li>Exercises

<ul class="org-ul">
<li><p>
12.1 there are duplicated prints in the file
</p>

<blockquote>
<p>
This is not a multithreading problem, as one might first guess. The standard I/O routines are indeed thread-safe. When we call fork, each process gets a copy of the standard I/O data structures. When we run the program with standard output attached to a terminal, the output is line buffered, so every time we print a line, the standard I/O library writes it to our terminal. However, if we redirect the standard output to a file, then the standard output is fully buffered. The output is written when the buffer fills or the process closes the stream. When we fork in this example, the buffer contains several printed lines not yet written, so when the parent and the child finally flush their copies of the buffer, the initial duplicate contents are written to the file.
</p>
</blockquote></li>

<li><p>
12.2 reentrant version of <code>putenv</code>
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     12ex02.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-11-28</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    a thread-safe reentrant version of putenv</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">string.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">char</span> **<span style="color: #7590db;">environ</span>;

<span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> <span style="color: #7590db;">env_mutex</span>;

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">pthread_once_t</span> <span style="color: #7590db;">init_done</span> = PTHREAD_ONCE_INIT;

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">thread_init</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pthread_mutexattr_t</span> <span style="color: #7590db;">attr</span>;

    pthread_mutexattr_init<span style="color: #bc6ec5;">(</span>&amp;attr<span style="color: #bc6ec5;">)</span>;
    pthread_mutexattr_settype<span style="color: #bc6ec5;">(</span>&amp;attr, PTHREAD_MUTEX_RECURSIVE<span style="color: #bc6ec5;">)</span>;
    pthread_mutex_init<span style="color: #bc6ec5;">(</span>&amp;env_mutex, &amp;attr<span style="color: #bc6ec5;">)</span>;
    pthread_mutexattr_destroy<span style="color: #bc6ec5;">(</span>&amp;attr<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">putenv_r</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">val</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">i</span>, <span style="color: #7590db;">len</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">buf</span> = <span style="color: #a45bad;">NULL</span>;

    pthread_once<span style="color: #bc6ec5;">(</span>&amp;init_done, thread_init<span style="color: #bc6ec5;">)</span>;
    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;env_mutex<span style="color: #bc6ec5;">)</span>;

    setenv<span style="color: #bc6ec5;">(</span>name, val, <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;

    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;env_mutex<span style="color: #bc6ec5;">)</span>;
    pthread_mutex_destroy<span style="color: #bc6ec5;">(</span>&amp;env_mutex<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
12.3 a signal-blocked version of getenv
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     12fig13.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-11-17</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    a signal-blocked version of getenv</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">limits.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">string.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">MAXSTRINGSZ</span> <span style="color: #a45bad;">4096</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">pthread_key_t</span>  <span style="color: #7590db;">key</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">pthread_once_t</span> <span style="color: #7590db;">init_done</span> = PTHREAD_ONCE_INIT;
<span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span>       <span style="color: #7590db;">env_mutex</span> = PTHREAD_MUTEX_INITIALIZER;

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">char</span> **<span style="color: #7590db;">environ</span>;

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">thread_init</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> pthread_key_create<span style="color: #bc6ec5;">(</span>&amp;key, free<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #bc6ec5; font-weight: bold;">getenv</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>       <span style="color: #7590db;">i</span>, <span style="color: #7590db;">len</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>     *<span style="color: #7590db;">envbuf</span>;
    <span style="color: #ce537a; font-weight: bold;">sigset_t</span>  <span style="color: #7590db;">mask</span>, <span style="color: #7590db;">omask</span>;

    sigfillset<span style="color: #bc6ec5;">(</span>&amp;mask<span style="color: #bc6ec5;">)</span>;
    sigprocmask<span style="color: #bc6ec5;">(</span>SIG_BLOCK, &amp;mask, &amp;omask<span style="color: #bc6ec5;">)</span>;

    pthread_once<span style="color: #bc6ec5;">(</span>&amp;init_done, thread_init<span style="color: #bc6ec5;">)</span>;
    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;env_mutex<span style="color: #bc6ec5;">)</span>;
    envbuf = <span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #bc6ec5;">)</span>pthread_getspecific<span style="color: #bc6ec5;">(</span>key<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>envbuf == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        envbuf = malloc<span style="color: #2d9574;">(</span>MAXSTRINGSZ<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>envbuf == <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">goto</span> <span style="color: #a45bad;">nil</span>;
        <span style="color: #2d9574;">}</span>
        pthread_setspecific<span style="color: #2d9574;">(</span>key, envbuf<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    len = strlen<span style="color: #bc6ec5;">(</span>name<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; environ<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span> != <span style="color: #a45bad;">NULL</span>; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>strncmp<span style="color: #b1951d;">(</span>name, environ<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span>, len<span style="color: #b1951d;">)</span> == <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> &amp;&amp; <span style="color: #67b11d;">(</span>environ<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">][</span>len<span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span> == <span style="color: #2d9574;">'='</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            snprintf<span style="color: #67b11d;">(</span>envbuf, MAXSTRINGSZ - <span style="color: #a45bad;">1</span>, <span style="color: #2d9574;">"%s"</span>, &amp;environ<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">][</span>len + <span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span>;
            pthread_mutex_unlock<span style="color: #67b11d;">(</span>&amp;env_mutex<span style="color: #67b11d;">)</span>;

            sigprocmask<span style="color: #67b11d;">(</span>SIG_SETMASK, &amp;omask, <span style="color: #a45bad;">NULL</span><span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #67b11d;">(</span>envbuf<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

<span style="color: #a45bad;">nil</span>:
    sigprocmask<span style="color: #bc6ec5;">(</span>SIG_SETMASK, &amp;omask, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;env_mutex<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<blockquote>
<p>
The problem is that we don’t know whether any of the functions we call might unmask a signal that we’ve blocked, thereby making it possible for the function to be reentered through another signal handler.
</p>
</blockquote></li>

<li><p>
12.4 just copied the answer
</p>

<blockquote>
<p>
On FreeBSD 8.0, the program drops core. With gdb, we are able to see that the program initialization calls pthread functions, which call getenv to find the value of the LIBPTHREAD_SPINLOOPS and LIBPTHREAD_YIELDLOOPS environment variables. However, our thread-safe version of getenv calls back into the pthread library while it is in an intermediate, inconsistent state. In addition, the thread initialization functions call malloc, which, in turn, call getenv to find the value of the MALLOC_OPTIONS environment variable.
</p>

<p>
To get around this problem, we could make the reasonable assumption that program start-up is single threaded, and use a flag to indicate whether the thread initialization had been completed by our version of getenv. While this flag is false, our version of getenv can operate as the non-reentrant version does (and avoid all calls to pthread functions and malloc). Then we could provide a separate initialization function to call pthread_once, instead of calling it from inside getenv. This requires that the program call our initialization function before calling getenv. This solves our problem, because this can’t be done until the program start-up initialization completes. After the program calls our initialization function, our version of getenv operates in a thread-safe manner.
</p>
</blockquote></li>

<li>12.5 run a program within a program</li>

<li><p>
12.6 implemented sleep by using select
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     10.29.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-10-28</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    implementation of sleep using select</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sleep</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">seconds</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>            <span style="color: #7590db;">n</span>;
    <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">slept</span>;
    <span style="color: #ce537a; font-weight: bold;">time_t</span>         <span style="color: #7590db;">start</span>, <span style="color: #7590db;">end</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timeval</span> <span style="color: #7590db;">tv</span>;

    tv.tv_sec  = seconds;
    tv.tv_usec = <span style="color: #a45bad;">0</span>;

    time<span style="color: #bc6ec5;">(</span>&amp;start<span style="color: #bc6ec5;">)</span>;
    n = select<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span>, <span style="color: #a45bad;">NULL</span>, <span style="color: #a45bad;">NULL</span>, <span style="color: #a45bad;">NULL</span>, &amp;tv<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>n == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
    <span style="color: #bc6ec5;">}</span>
    time<span style="color: #bc6ec5;">(</span>&amp;end<span style="color: #bc6ec5;">)</span>;
    slept = end - start;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>slept &gt;= seconds<span style="color: #bc6ec5;">)</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> seconds - slept;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li>12.7 unsafe to do that, because we hardly acquire and release the mutex protected condition variable</li>

<li><p>
12.8 use select instead?
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     fig.8.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-11-15</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Using a recursive mutex</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/time.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">time.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">makethread</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5;">(</span>*<span style="color: #bc6ec5;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5;">)</span>, <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #4f97d7;">)</span>;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">to_info</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5;">(</span>*<span style="color: #bc6ec5; font-weight: bold;">to_fn</span><span style="color: #bc6ec5;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5;">)</span>;   <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">function</span>
    <span style="color: #ce537a; font-weight: bold;">void</span> *         <span style="color: #7590db;">to_arg</span>;   <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">argument</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timeval</span> <span style="color: #7590db;">to_wait</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">time to wait</span>
<span style="color: #4f97d7;">}</span>;

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">SECTOUSEC</span> <span style="color: #a45bad;">1000000</span>  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">seconds to nanoseconds</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #bc6ec5; font-weight: bold;">clock_nanosleep</span><span style="color: #4f97d7;">(</span><span style="color: #7590db;">ID</span>, <span style="color: #7590db;">FL</span>, <span style="color: #7590db;">REQ</span>, <span style="color: #7590db;">REM</span><span style="color: #4f97d7;">)</span> nanosleep<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span>REQ<span style="color: #bc6ec5;">)</span>, <span style="color: #bc6ec5;">(</span>REM<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #bc6ec5;">#if</span><span style="color: #bc6ec5;">n</span><span style="color: #bc6ec5;">def</span> CLOCK_REALTIME
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">CLOCK_REALTIME</span> <span style="color: #a45bad;">0</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">USECTONSEC</span>     <span style="color: #a45bad;">1000</span>  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">microseconds to nanoseconds</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">clock_gettime</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">id</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span> *<span style="color: #7590db;">tsp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timeval</span> <span style="color: #7590db;">tv</span>;

    gettimeofday<span style="color: #bc6ec5;">(</span>&amp;tv, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    tsp-&gt;tv_sec  = tv.tv_sec;
    tsp-&gt;tv_nsec = tv.tv_usec * USECTONSEC
<span style="color: #4f97d7;">}</span>
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">timeout_helper</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">to_info</span> *<span style="color: #7590db;">tip</span>;

    tip = <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">to_info</span> *<span style="color: #bc6ec5;">)</span>arg;
    clock_nanosleep<span style="color: #bc6ec5;">(</span>CLOCK_REALTIME, <span style="color: #a45bad;">0</span>, &amp;tip-&gt;to_wait, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #bc6ec5;">(</span>*tip-&gt;to_fn<span style="color: #bc6ec5;">)(</span>tip-&gt;to_arg<span style="color: #bc6ec5;">)</span>;
    free<span style="color: #bc6ec5;">(</span>arg<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">timeout</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span> *<span style="color: #7590db;">when</span>, <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5;">(</span>*<span style="color: #bc6ec5; font-weight: bold;">func</span><span style="color: #bc6ec5;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5;">)</span>, <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span> <span style="color: #7590db;">now</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">to_info</span> *<span style="color: #7590db;">tip</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>             <span style="color: #7590db;">err</span>;

    clock_gettime<span style="color: #bc6ec5;">(</span>CLOCK_REALTIME, &amp;now<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>when-&gt;tv_sec &gt; now.tv_sec<span style="color: #2d9574;">)</span> ||
        <span style="color: #2d9574;">(</span>when-&gt;tv_sec == now.tv_sec &amp;&amp; when-&gt;tv_nsec &gt; now.tv_nsec<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        tip = malloc<span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">to_info</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>tip != <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            tip-&gt;to_fn          = func;
            tip-&gt;to_arg         = arg;
            tip-&gt;to_wait.tv_sec = when-&gt;tv_sec - now.tv_sec;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>when-&gt;tv_nsec &gt;= now.tv_nsec<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                tip-&gt;to_wait.tv_usec = when-&gt;tv_nsec / <span style="color: #a45bad;">1000</span> - now.tv_nsec;
            <span style="color: #67b11d;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #67b11d;">{</span>
                tip-&gt;to_wait.tv_sec--;
                tip-&gt;to_wait.tv_usec =
                    SECTOUSEC - now.tv_usec + when-&gt;tv_nsec / <span style="color: #a45bad;">1000</span>;
            <span style="color: #67b11d;">}</span>

            select<span style="color: #67b11d;">(</span><span style="color: #a45bad;">0</span>, <span style="color: #a45bad;">NULL</span>, <span style="color: #a45bad;">NULL</span>, <span style="color: #a45bad;">NULL</span>, &amp;tip-&gt;to_wait<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #bc6ec5;">(</span>*func<span style="color: #bc6ec5;">)(</span>arg<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">pthread_mutexattr_t</span> <span style="color: #7590db;">attr</span>;
<span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span>     <span style="color: #7590db;">mutex</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">retry</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;mutex<span style="color: #bc6ec5;">)</span>;

    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;mutex<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>             <span style="color: #7590db;">err</span> = <span style="color: #a45bad;">0</span>, <span style="color: #7590db;">condition</span> = <span style="color: #a45bad;">0</span>, <span style="color: #7590db;">arg</span> = <span style="color: #a45bad;">0</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span> <span style="color: #7590db;">when</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = pthread_mutexattr_init<span style="color: #67b11d;">(</span>&amp;attr<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"pthread_mutexattr_init failed"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = pthread_mutexattr_settype<span style="color: #67b11d;">(</span>&amp;attr, PTHREAD_MUTEX_RECURSIVE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> !=
        <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't set recursive type"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = pthread_mutex_init<span style="color: #67b11d;">(</span>&amp;mutex, &amp;attr<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't create recursive mutex"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>condition == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        clock_gettime<span style="color: #2d9574;">(</span>CLOCK_REALTIME, &amp;when<span style="color: #2d9574;">)</span>;
        when.tv_sec += <span style="color: #a45bad;">10</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">10 seconds after now</span>
        timeout<span style="color: #2d9574;">(</span>&amp;when, retry, <span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #67b11d;">)(</span><span style="color: #b1951d;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #b1951d;">)</span>arg<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;mutex<span style="color: #bc6ec5;">)</span>;

    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgfef4460" class="outline-3">
<h3 id="orgfef4460"><span class="done DONE">DONE</span> Chapter 13. Daemon Processes <code>[8/8]</code></h3>
<div class="outline-text-3" id="text-orgfef4460">
</div>

<div id="outline-container-org86063a8" class="outline-4">
<h4 id="org86063a8"><span class="done DONE">DONE</span> 13.1 Introduction</h4>
<div class="outline-text-4" id="text-org86063a8">
<p>
A process live for a long time in the background.
</p>
</div>
</div>

<div id="outline-container-org3afc8ae" class="outline-4">
<h4 id="org3afc8ae"><span class="done DONE">DONE</span> 13.2 Daemon Characteristics</h4>
<div class="outline-text-4" id="text-org3afc8ae">
<div class="org-src-container">
<pre class="src src-sh">ps -axj
</pre>
</div>

<blockquote>
<ul class="org-ul">
<li>The kswapd daemon is also known as pageout daemon. It supports the virtual memory subsystem by writing dirty pages to disk slowly over time, so the pages can be reclamed.</li>
<li>The flush daemon fluhes dirty pages to disk when available memory reaches a configured minimum thrshold.</li>
<li>The sync_supers daemon periodically fluhes the system metadata to disk.</li>
<li>The jbd daemon helps implement the journal in the ext4 file system.</li>
</ul>
</blockquote>

<blockquote>
<p>
Process 1 is uaually init (launchd on Mac OS X). It is a system daemon responsible for, among other things, starting system services specific to various run levels.
</p>

<p>
The rpcbind provides the service of mapping RPC(Remote Procedure Call) program numbers to network port. The rsyslogd daemon is available to any program to log system messages for administrator.
</p>

<p>
inetd daemon listens on the system's network interfaces for incoming requests for various network servers. The nfsd, nfsiod, lockd, rpciod, rpc.idmapd, rpc.statd, and rpc.mountd daemons provide support for the Network File System(NFS). The fist four are <b>kernel</b> daemons, while the last three are <b>user-level</b> daemons
</p>

<p>
The cron daemon executes commands at regularly scheduled dates and times.
</p>

<p>
most of daemons run with superuser(root) privileges.
</p>

<p>
the parent of the user-level daemons is the init process.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org0d6e4d6" class="outline-4">
<h4 id="org0d6e4d6"><span class="done DONE">DONE</span> 13.3 Coding Rules</h4>
<div class="outline-text-4" id="text-org0d6e4d6">
<p>
basic rules to coding a daemon prevent unwanted interactions from happening.
</p>
<ol class="org-ol">
<li>Call unmask to set the file mode createion mask to a known value, usually 0.</li>
<li>Call fork and have the parent exit.</li>
<li>Call setsid to create a new session.
<ol class="org-ol">
<li>becomes the leader of a new session</li>
<li>becomes the leader of a new process group</li>
<li>is disassociated from its controlling terminal</li>
</ol></li>
<li>Change the current working directory to the root directory.</li>
<li>Unneeded file descriptors should be closed</li>
<li>Some daemons open file descriptors 0, 1 and 2 to /dev/null so that any library routines that try to read from standard input or write to standard output or standard error will have no effect.</li>

<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 104: </span>Figure 13.1 initialize a daemon process</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     13fig01.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-11-28</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    a function that can be called from a program</span>
<span style="color: #9f8766;"> *             that wants to initialize itsef as a daemon</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/resource.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">syslog.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">__progname</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">daemonize</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">cmd</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>              <span style="color: #7590db;">i</span>, <span style="color: #7590db;">fd0</span>, <span style="color: #7590db;">fd1</span>, <span style="color: #7590db;">fd2</span>;
    <span style="color: #ce537a; font-weight: bold;">pid_t</span>            <span style="color: #7590db;">pid</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">rlimit</span>    <span style="color: #7590db;">rl</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sigaction</span> <span style="color: #7590db;">sa</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>cmd == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        cmd = __progname;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">clear file creation mask.</span>
    umask<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">get maximum number of file descriptors</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>getrlimit<span style="color: #2d9574;">(</span>RLIMIT_NOFILE, &amp;rl<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s: can't get file limit"</span>, cmd<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">become a session leader to lose controlling TTY.</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s: can't fork"</span>, cmd<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">parent</span>
    <span style="color: #bc6ec5;">}</span>

    setsid<span style="color: #bc6ec5;">()</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">ensure future opens won't allocate controlling TTYs.</span>
    sa.sa_handler = SIG_IGN;
    sigemptyset<span style="color: #bc6ec5;">(</span>&amp;sa.sa_mask<span style="color: #bc6ec5;">)</span>;
    sa.sa_flags = <span style="color: #a45bad;">0</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigaction<span style="color: #2d9574;">(</span>SIGHUP, &amp;sa, <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_quit<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%s: can't ignore SIGHUP"</span>, cmd<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s: can't fork"</span>, cmd<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">parent</span>
        exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">change the current working directory to the root so</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">we won't prevent file systems from being unmounted.</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>chdir<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"/"</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s: can't change directory to /"</span>, cmd<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    chroot<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"/"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">close all open file descriptors</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>rl.rlim_max == RLIM_INFINITY<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        rl.rlim_max = <span style="color: #a45bad;">1024</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; rl.rlim_max; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        close<span style="color: #2d9574;">(</span>i<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">attach file descriptors 0, 1 and 2 to /dev/null</span>
    fd0 = open<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"/dev/null"</span>, O_RDWR<span style="color: #bc6ec5;">)</span>;
    fd1 = dup<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
    fd2 = dup<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">initialize the log file</span>
    openlog<span style="color: #bc6ec5;">(</span>cmd, LOG_CONS, LOG_DAEMON<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>fd0 != <span style="color: #a45bad;">0</span> || fd1 != <span style="color: #a45bad;">1</span> || fd2 != <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        syslog<span style="color: #2d9574;">(</span>LOG_ERR, <span style="color: #2d9574;">"unexpected file descriptors %d %d %d"</span>, fd0, fd1, fd2<span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ol>
</div>
</div>

<div id="outline-container-org9f32caf" class="outline-4">
<h4 id="org9f32caf"><span class="done DONE">DONE</span> 13.4 Error Logging</h4>
<div class="outline-text-4" id="text-org9f32caf">
<p>
three ways to generate log messages:
</p>
<ul class="org-ul">
<li>Kernel routines can call the log function.</li>
<li>Most user processes (daemons) call the syslog(3) function to generate log messages.</li>
<li>A user process on this host, or on some other host that is connected to this host by a TCP/IP network can send log messages to UDP port 514.</li>
</ul>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">syslog.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">openlog</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">ident</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">option</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">facility</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">syslog</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">priority</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">fmt</span>, ...<span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">closelog</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">setlogmask</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">maskpri</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: previous log priority mask value</span>
</pre>
</div>
<p>
calling openlog is optional. the first time syslog called automatically calls openlog.
</p>

<p>
calling closelog is also optional.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 15:</span> Figure 13.3 The <i>option</i> argument for <code>openlog</code></caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left"><i>option</i></th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">LOG_CONS</td>
<td class="org-left">ifthe log message can't be sent to syslog via the UNIX domain datagram,</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">the message is writen to the console instead</td>
</tr>

<tr>
<td class="org-left">LOG_NDELAY</td>
<td class="org-left">Open the UNIX domain datagram socket to the syslogd daemon immediately;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">don't wait until the frst message is logged.</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">Normally, the socket is not opened until the first message is logged.</td>
</tr>

<tr>
<td class="org-left">LOG_NOWAIT</td>
<td class="org-left">Do not wait for child processes that might have been created in the process</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">of logging message. The prevents conflicts with applications that catch <b>SIGCHLD</b>,</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">since the application might have retrieved the child's status by the time that syslog calls <code>wait</code></td>
</tr>

<tr>
<td class="org-left">LOG_ODELAY</td>
<td class="org-left">Delay the opening ofthe connection to the syslogd daemon until the first message is logged.</td>
</tr>

<tr>
<td class="org-left">LOG_PERROR</td>
<td class="org-left">write the log message to standard error in addition to sending it to syslogd</td>
</tr>

<tr>
<td class="org-left">LOG_PID</td>
<td class="org-left">Log the process ID with each message. This is intended fr daemons that fork a child process</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">to handle different requests (as compared to daemons, such as syslogd, that never call fork)</td>
</tr>
</tbody>
</table>

<p>
<b><i>format</i> and any other arguments are passed to vsprintf function for formatting. %m in <i>format</i> are first replaced with the error message string(strerror)</b>
</p>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<pre class="src src-c">openlog<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"lpd"</span>, LOG_PID, LOG_LPR<span style="color: #4f97d7;">)</span>;
<span style="color: #bc6ec5; font-weight: bold;">syslog</span><span style="color: #4f97d7;">(</span>LOG_ERR, <span style="color: #2d9574;">"open error for %s: %m"</span>, filename<span style="color: #4f97d7;">)</span>;
</pre>
</div>
<p>
if we had not called <code>openlog</code>, the second call could have been
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5; font-weight: bold;">syslog</span><span style="color: #4f97d7;">(</span>LOG_ERR | LOG_LPR, <span style="color: #2d9574;">"open error for %s: %m"</span>, filename<span style="color: #4f97d7;">)</span>;
</pre>
</div></li>
</ul>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 16:</span> Figure 13.4 The <i>facility</i> argument for <code>openlog</code></caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">facility</th>
<th scope="col" class="org-left">XSI</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">LOG_AUDIT</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">the audit fcility</td>
</tr>

<tr>
<td class="org-left">LOG_AUTH</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">authorization programs: login, su, getty, &#x2026;</td>
</tr>

<tr>
<td class="org-left">LOG_AUTHPRIV</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">same as LOG_AUTH, but logged to fle with restricted permissions</td>
</tr>

<tr>
<td class="org-left">LOG_CONSOLE</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">messages written to /dev/console</td>
</tr>

<tr>
<td class="org-left">LOG_CRON</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">cron and at</td>
</tr>

<tr>
<td class="org-left">LOG_DAEMON</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">system daemons: inetd, routed, &#x2026;</td>
</tr>

<tr>
<td class="org-left">LOG_FTP</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">the FTP daemon (ftpd)</td>
</tr>

<tr>
<td class="org-left">LOG_KERN</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">messages generated by the kernel</td>
</tr>

<tr>
<td class="org-left">LOG_LOCAL0</td>
<td class="org-left">*</td>
<td class="org-left">reserved for local use</td>
</tr>

<tr>
<td class="org-left">LOG_LOCAL1</td>
<td class="org-left">*</td>
<td class="org-left">reserved for local use</td>
</tr>

<tr>
<td class="org-left">LOG_LOCAL2</td>
<td class="org-left">*</td>
<td class="org-left">reserved for local use</td>
</tr>

<tr>
<td class="org-left">LOG_LOCAL3</td>
<td class="org-left">*</td>
<td class="org-left">reserved for local use</td>
</tr>

<tr>
<td class="org-left">LOG_LOCAL4</td>
<td class="org-left">*</td>
<td class="org-left">reserved for local use</td>
</tr>

<tr>
<td class="org-left">LOG_LOCAL5</td>
<td class="org-left">*</td>
<td class="org-left">reserved for local use</td>
</tr>

<tr>
<td class="org-left">LOG_LOCAL6</td>
<td class="org-left">*</td>
<td class="org-left">reserved for local use</td>
</tr>

<tr>
<td class="org-left">LOG_LOCAL7</td>
<td class="org-left">*</td>
<td class="org-left">reserved for local use</td>
</tr>

<tr>
<td class="org-left">LOG_LPR</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">line printer system: lpd, lpc, &#x2026;</td>
</tr>

<tr>
<td class="org-left">LOG_MAIL</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">the mail system</td>
</tr>

<tr>
<td class="org-left">LOG_NEWS</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">the network time protocol system</td>
</tr>

<tr>
<td class="org-left">LOG_SECURITY</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">the security subsystem</td>
</tr>

<tr>
<td class="org-left">LOG_SYSLOG</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">the syslogd daemon itself</td>
</tr>

<tr>
<td class="org-left">LOG_USER</td>
<td class="org-left">*</td>
<td class="org-left">message from other user processes(deafult)</td>
</tr>

<tr>
<td class="org-left">LOG_UUCP</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">the UUCP system</td>
</tr>
</tbody>
</table>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 17:</span> Figure 13.5 The <code>syslog</code> <i>levels</i> (ordered)</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">level</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">LOG_EMERG</td>
<td class="org-left">emergency (system is unusuable) (highest priority)</td>
</tr>

<tr>
<td class="org-left">LOG_ALERT</td>
<td class="org-left">condition that must be fxed immediately</td>
</tr>

<tr>
<td class="org-left">LOG_CRIT</td>
<td class="org-left">critical condition (e.g., hard device error)</td>
</tr>

<tr>
<td class="org-left">LOG_ERR</td>
<td class="org-left">error condition</td>
</tr>

<tr>
<td class="org-left">LOG_WARNING</td>
<td class="org-left">warning condition</td>
</tr>

<tr>
<td class="org-left">LOG_NOTICE</td>
<td class="org-left">normal, but significant condition</td>
</tr>

<tr>
<td class="org-left">LOG_INFO</td>
<td class="org-left">infrmational message</td>
</tr>

<tr>
<td class="org-left">LOG_DEBUG</td>
<td class="org-left">debug message(lowest priority)</td>
</tr>
</tbody>
</table>

<p>
syslog that handles variable argument lists
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">syslog.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdarg.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">vsyslog</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">priority</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">format</span>, <span style="color: #ce537a; font-weight: bold;">va_list</span> <span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org3860ed0" class="outline-4">
<h4 id="org3860ed0"><span class="done DONE">DONE</span> 13.5 Single-Instance Daemons</h4>
<div class="outline-text-4" id="text-org3860ed0">
<ul class="org-ul">
<li><p>
Example:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 105: </span>Figure 13.6 Ensure that only one copy of a daemon is running</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     13fig06.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-11-29</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    figure 13.6</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> *  illustrates the use of file and record locking</span>
<span style="color: #9f8766;"> *  to ensure that only one coyp of a daemon is running</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">string.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/stat.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">syslog.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">LOCKFILE</span> <span style="color: #2d9574;">"/var/run/daemon.pid"</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">LOCKMODE</span> <span style="color: #4f97d7;">(</span>S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH<span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">lockfile</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">already_running</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>  <span style="color: #7590db;">fd</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">16</span><span style="color: #bc6ec5;">]</span>;

    fd = open<span style="color: #bc6ec5;">(</span>LOCKFILE, O_RDWR | O_CREAT, LOCKFILE<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>fd &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        syslog<span style="color: #2d9574;">(</span>LOG_ERR, <span style="color: #2d9574;">"can't open %s: %m"</span>, LOCKFILE<span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span>EXIT_FAILURE<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>lockfile<span style="color: #2d9574;">(</span>fd<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>errno == EACCES || errno == EAGAIN<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            close<span style="color: #67b11d;">(</span>fd<span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #67b11d;">(</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        syslog<span style="color: #2d9574;">(</span>LOG_ERR, <span style="color: #2d9574;">"can't lock %s: %m"</span>, LOCKFILE<span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span>EXIT_FAILURE<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    ftruncate<span style="color: #bc6ec5;">(</span>fd, <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
    sprintf<span style="color: #bc6ec5;">(</span>buf, <span style="color: #2d9574;">"%ld"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>getpid<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span>;
    write<span style="color: #bc6ec5;">(</span>fd, <span style="color: #2d9574;">"%ld"</span>, strlen<span style="color: #2d9574;">(</span>buf<span style="color: #2d9574;">)</span> + <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org90939e5" class="outline-4">
<h4 id="org90939e5"><span class="done DONE">DONE</span> 13.6 Daemon Conventions</h4>
<div class="outline-text-4" id="text-org90939e5">
<ul class="org-ul">
<li>daemon's lock file is usually stored in /var/run. (might need superuser permissions to create a file here.)</li>

<li>daemon's configuration options usually stored in /etc</li>

<li>daemons can be started from the command line , but they are usually started from one of the system initialization scripts</li>

<li>daemon read configuration file when it starts, but usually won't look at it again.</li>

<li><p>
Example:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 106: </span>Figure 13.7 Daemon reredaing configuration files</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     13fig07.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-11-30</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    one way a daemon can reread its configuration file.</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">syslog.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">sigset_t</span> <span style="color: #7590db;">mask</span>;

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">already_running</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">reread</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">...</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">thr_fn</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">err</span>, <span style="color: #7590db;">signo</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>;;<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err = sigwait<span style="color: #2d9574;">(</span>&amp;mask, &amp;signo<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            syslog<span style="color: #67b11d;">(</span>LOG_ERR, <span style="color: #2d9574;">"sigwait failed: %m"</span><span style="color: #67b11d;">)</span>;
            exit<span style="color: #67b11d;">(</span>EXIT_FAILURE<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">switch</span> <span style="color: #2d9574;">(</span>signo<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">case</span> SIGHUP:
                syslog<span style="color: #67b11d;">(</span>LOG_INFO, <span style="color: #2d9574;">"Re-reading configuration file"</span><span style="color: #67b11d;">)</span>;
                reread<span style="color: #67b11d;">()</span>;
                <span style="color: #4f97d7; font-weight: bold;">break</span>;

            <span style="color: #4f97d7; font-weight: bold;">case</span> SIGTERM:
                syslog<span style="color: #67b11d;">(</span>LOG_INFO, <span style="color: #2d9574;">"got SIGTERM; exiting"</span><span style="color: #67b11d;">)</span>;
                exit<span style="color: #67b11d;">(</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span>;

            <span style="color: #4f97d7; font-weight: bold;">default</span>:
                syslog<span style="color: #67b11d;">(</span>LOG_INFO, <span style="color: #2d9574;">"unexpected signal: %d\n"</span>, signo<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>              <span style="color: #7590db;">err</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_t</span>        <span style="color: #7590db;">tid</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>            *<span style="color: #7590db;">cmd</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sigaction</span> <span style="color: #7590db;">sa</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>cmd = strchr<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #a45bad;">0</span><span style="color: #b1951d;">]</span>, <span style="color: #2d9574;">'/'</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        cmd = argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">]</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        cmd++;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">become a dameon</span>
    daemonize<span style="color: #bc6ec5;">(</span>cmd<span style="color: #bc6ec5;">)</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">make sure only one copy of the daemon is running</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>already_running<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        syslog<span style="color: #2d9574;">(</span>LOG_ERR, <span style="color: #2d9574;">"daemon already running"</span><span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">restore SIGHUP default and block all signals.</span>
    sa.sa_handler = SIG_DFL;
    sigemptyset<span style="color: #bc6ec5;">(</span>&amp;sa.sa_mask<span style="color: #bc6ec5;">)</span>;
    sa.sa_flags = <span style="color: #a45bad;">0</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigaction<span style="color: #2d9574;">(</span>SIGHUP, &amp;sa, <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        syslog<span style="color: #2d9574;">(</span>LOG_ERR, <span style="color: #2d9574;">"%m: can't restore SIGHUP default."</span><span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    sigfillset<span style="color: #bc6ec5;">(</span>&amp;mask<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = pthread_sigmask<span style="color: #67b11d;">(</span>SIG_BLOCK, &amp;mask, <span style="color: #a45bad;">NULL</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"SIG_BLOCK error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">create a thread to handle SIGHUP and SIGTERM</span>
    err = pthread_create<span style="color: #bc6ec5;">(</span>&amp;tid, <span style="color: #a45bad;">NULL</span>, thr_fn, <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't create thread"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
Example:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 107: </span>Figure 13.8 Alternative implementation of daemon rereading configuration files</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     13fig08.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-12-01</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    single-threaded daemon can catch SIGHUP and reread its configuration file.</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">syslog.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>


<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">lockfile</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;
<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">already_running</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">reread</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">...</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sigterm</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    syslog<span style="color: #bc6ec5;">(</span>LOG_INFO, <span style="color: #2d9574;">"got SIGTERM; exiting"</span><span style="color: #bc6ec5;">)</span>;
    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sighup</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    syslog<span style="color: #bc6ec5;">(</span>LOG_INFO, <span style="color: #2d9574;">"Re-reading configuration file"</span><span style="color: #bc6ec5;">)</span>;
    reread<span style="color: #bc6ec5;">()</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span>             *<span style="color: #7590db;">cmd</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sigaction</span>  <span style="color: #7590db;">sa</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>cmd = strchr<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #a45bad;">0</span><span style="color: #b1951d;">]</span>, <span style="color: #2d9574;">'/'</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>
        cmd = argv<span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span>;
    <span style="color: #4f97d7; font-weight: bold;">else</span>
        cmd++;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">become a daemon</span>
    daemonize<span style="color: #bc6ec5;">(</span>cmd<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>already_running<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        syslog<span style="color: #2d9574;">(</span>LOG_ERR, <span style="color: #2d9574;">"daemon already running"</span><span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span>EXIT_FAILURE<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    sa.sa_handler = sigterm;
    sigemptyset<span style="color: #bc6ec5;">(</span>&amp;sa.sa_mask<span style="color: #bc6ec5;">)</span>;
    sigaddset<span style="color: #bc6ec5;">(</span>&amp;sa.sa_mask, SIGHUP<span style="color: #bc6ec5;">)</span>;
    sa.sa_flags = <span style="color: #a45bad;">0</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>sigaction<span style="color: #67b11d;">(</span>SIGTERM, &amp;sa, <span style="color: #a45bad;">NULL</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        syslog<span style="color: #2d9574;">(</span>LOG_ERR, <span style="color: #2d9574;">"can't catch SIGTERM: %m"</span><span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span>EXIT_FAILURE<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    sa.sa_handler = sighup;
    sigemptyset<span style="color: #bc6ec5;">(</span>&amp;sa.sa_mask<span style="color: #bc6ec5;">)</span>;
    sigaddset<span style="color: #bc6ec5;">(</span>&amp;sa.sa_mask, SIGTERM<span style="color: #bc6ec5;">)</span>;
    sa.sa_flags = <span style="color: #a45bad;">0</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>sigaction<span style="color: #67b11d;">(</span>SIGHUP, &amp;sa, <span style="color: #a45bad;">NULL</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        syslog<span style="color: #2d9574;">(</span>LOG_ERR, <span style="color: #2d9574;">"can't catch SIGHUP: %m"</span><span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span>EXIT_FAILURE<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org392fc48" class="outline-4">
<h4 id="org392fc48"><span class="done DONE">DONE</span> 13.7 Client-Server Model</h4>
<div class="outline-text-4" id="text-org392fc48">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 108: </span>Figure 13.9 Set close-on-exec flag</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     13fig09.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-12-01</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    solve multiple file descriptors may left open</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">set_cloexec</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">val</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>val = fcntl<span style="color: #67b11d;">(</span>fd, FD_GETFD, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span>-<span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    val |= FD_CLOEXEC;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fcntl<span style="color: #2d9574;">(</span>fd, FD_SETFD, val<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5451179" class="outline-4">
<h4 id="org5451179"><span class="done DONE">DONE</span> 13.8 Summary</h4>
<div class="outline-text-4" id="text-org5451179">
<ul class="org-ul">
<li>Exercises

<ul class="org-ul">
<li><p>
13.1 actually I didn't find there is anything wrong here, but the answer is:
</p>

<blockquote>
<p>
If it calls chroot, the process will not be able to open /dev/log. The solution is for the daemon to call openlog with an option of LOG_NDELAY, before calling chroot. This opens the special device file (the UNIX domain datagram socket), yielding a descriptor that is still valid, even after a call to chroot. This scenario is encountered in daemons, such as ftpd (the File Transfer Protocol daemon), that specifically call chroot for security reasons but still need to call syslog to log error conditions.
</p>
</blockquote></li>

<li>13.2 syslog did not to create a session</li>

<li>&#x2026;</li>

<li><p>
13.4 code below
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 109: </span>call daemon and get login name</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     13ex03.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-12-01</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    call daemonize then call getlogin</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">__progname</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span>   = <span style="color: #a45bad;">NULL</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span> = <span style="color: #a45bad;">NULL</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">tdir</span> = <span style="color: #a45bad;">NULL</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">out</span><span style="color: #bc6ec5;">[</span>FILENAME_MAX<span style="color: #bc6ec5;">]</span> = <span style="color: #bc6ec5;">{</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">}</span>;

    daemonize<span style="color: #bc6ec5;">(</span>__progname<span style="color: #bc6ec5;">)</span>;
    name = getlogin<span style="color: #bc6ec5;">()</span>;

    tdir = getenv<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"TMPDIR"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>tdir<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        snprintf<span style="color: #2d9574;">(</span>out, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span>out<span style="color: #67b11d;">)</span>, <span style="color: #2d9574;">"%s/getlog.txt"</span>, tdir<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        snprintf<span style="color: #2d9574;">(</span>out, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span>out<span style="color: #67b11d;">)</span>, <span style="color: #2d9574;">"/var/tmp/getlog.txt"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    fp = fopen<span style="color: #bc6ec5;">(</span>out, <span style="color: #2d9574;">"w+"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>fp != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>name == <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            fprintf<span style="color: #67b11d;">(</span>fp, <span style="color: #2d9574;">"null"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            fprintf<span style="color: #67b11d;">(</span>fp, <span style="color: #2d9574;">"login name: %s\n"</span>, name<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    fclose<span style="color: #bc6ec5;">(</span>fp<span style="color: #bc6ec5;">)</span>;
    fp = <span style="color: #a45bad;">NULL</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgf88b4e5" class="outline-3">
<h3 id="orgf88b4e5"><span class="done DONE">DONE</span> Chapter 14. Advanced I/O <code>[9/9]</code></h3>
<div class="outline-text-3" id="text-orgf88b4e5">
</div>

<div id="outline-container-orgf797944" class="outline-4">
<h4 id="orgf797944"><span class="done DONE">DONE</span> 14.1 Introduction</h4>
<div class="outline-text-4" id="text-orgf797944">
<p>
nonblocking I/O, I/O multiplexing(<code>select</code> and <code>poll</code>), asynchronous I/O, the <code>readv</code> and <code>writev</code> functions, and memory-mapped I/O (mmap).
</p>
</div>
</div>

<div id="outline-container-org1b4ac0c" class="outline-4">
<h4 id="org1b4ac0c"><span class="done DONE">DONE</span> 14.2 Nonblocking I/O</h4>
<div class="outline-text-4" id="text-org1b4ac0c">
<p>
slow system calls can block forever. include:
</p>
<ul class="org-ul">
<li>reads if data isn't present with certain file types</li>
<li>writes if data isn't present with certain file types</li>
<li>open conditions</li>
<li>mandatory record locking</li>
<li><code>ioctl</code> options</li>
<li>IPC</li>
</ul>

<p>
Q: What does Nonblocking do?
A: returns immediately with an error nothing that the operation would have blocked if the operation cannot be completed.
</p>

<p>
two way to specify nonblocking I/O:
</p>
<ol class="org-ol">
<li><code>open</code> to get the descriptor, specify <code>O_NONBLOCK</code> flag</li>
<li>call <code>fcntl</code> to trun on the <code>O_NONBLOCK</code> if already open.</li>

<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 110: </span>Figure 14.1 Large nonblocking write</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     14fig01.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-12-15</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Figure 14.1 Large nonblocking write</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">buf</span><span style="color: #4f97d7;">[</span><span style="color: #a45bad;">50000</span><span style="color: #4f97d7;">]</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">ntowrite</span>, <span style="color: #7590db;">nwrite</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">ptr</span>;

    ntowrite = read<span style="color: #bc6ec5;">(</span>STDIN_FILENO, buf, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>buf<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    fprintf<span style="color: #bc6ec5;">(</span>stderr, <span style="color: #2d9574;">"read %d bytes\n"</span>, ntowrite<span style="color: #bc6ec5;">)</span>;

    set_fl<span style="color: #bc6ec5;">(</span>STDOUT_FILENO, O_NONBLOCK<span style="color: #bc6ec5;">)</span>;

    ptr = buf;
    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span>ntowrite &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        errno  = <span style="color: #a45bad;">0</span>;
        nwrite = write<span style="color: #2d9574;">(</span>STDOUT_FILENO, ptr, ntowrite<span style="color: #2d9574;">)</span>;
        fprintf<span style="color: #2d9574;">(</span>stderr, <span style="color: #2d9574;">"nwrite = %d, errno = %d\n"</span>, nwrite, errno<span style="color: #2d9574;">)</span>;

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>nwrite &gt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            ptr += nwrite;
            ntowrite -= nwrite;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    clr_fl<span style="color: #bc6ec5;">(</span>STDOUT_FILENO, O_NONBLOCK<span style="color: #bc6ec5;">)</span>;

    exit<span style="color: #bc6ec5;">(</span>EXIT_SUCCESS<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-sh">ls -l /etc/services
bin/14fig01 &lt; /etc/services &gt; temp.file
ls -l temp.file
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">bin/14fig01 &lt; /etc/services <span style="color: #a45bad;">2</span>&gt;stderr.out
cat stderr.out
</pre>
</div>

<blockquote>
<p>
On OSX, a there are lots of
nwirte = some number, errno = 0
nwrite = -1, errno = 35
</p>

<p>
but on Linux, the error message is
nwrite = -1, errno = 11 instead
</p>

<p>
<b>they are both EAGAIN number</b>
</p>
</blockquote></li>
</ol>
</div>
</div>

<div id="outline-container-orgaeea125" class="outline-4">
<h4 id="orgaeea125"><span class="done DONE">DONE</span> 14.3 Record Locking</h4>
<div class="outline-text-4" id="text-orgaeea125">
<p>
Record locking is the term normally used to describe the ability of a process to prevent other processes from modifying a region of a file while the first process is reading or modifying that portion of the file
</p>

<ul class="org-ul">
<li>1. History</li>
</ul>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 18:</span> Figure 14.2 Forms of record locking supported by various UNIX systems</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Systems</th>
<th scope="col" class="org-left">Advisory</th>
<th scope="col" class="org-left">Mandatory</th>
<th scope="col" class="org-left">fcntl</th>
<th scope="col" class="org-left">lockf</th>
<th scope="col" class="org-left">flock</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">SUS</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
<td class="org-left">XSI</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">FreeBSD 8.0</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>

<tr>
<td class="org-left">Linux 3.2.0</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>

<tr>
<td class="org-left">Mac OS X 10.6.8</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>

<tr>
<td class="org-left">Solaris</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li><p>
2. <code>fcntl</code> Record Locking
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">fcntl</span>.<span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">cmd</span>, ... <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">struct flock *flockptr</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: depends on cmd if OK (see following), -1 on error</span>
</pre>
</div>
<p>
<code>cmd</code> is F_GETLK, F_SETLK, or F_SETLKW.
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">flock</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #ce537a; font-weight: bold;">short</span> <span style="color: #7590db;">l_type</span>;                  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">F_RDLCK, or F_UNLCK</span>
        <span style="color: #ce537a; font-weight: bold;">short</span> <span style="color: #7590db;">l_whence</span>;                <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">SEEK_SET, SEEK_CUR, or SEEK_END</span>
        <span style="color: #ce537a; font-weight: bold;">off_t</span> <span style="color: #7590db;">l_start</span>;                 <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">offset in bytes, relative to l_whence</span>
        <span style="color: #ce537a; font-weight: bold;">off_t</span> <span style="color: #7590db;">l_len</span>;                   <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">length, in bytes; 0 means lock to EOF</span>
        <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">l_pid</span>;                   <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">returned with F_GETLK</span>
<span style="color: #4f97d7;">}</span>;
</pre>
</div>

<ul class="org-ul">
<li>describes

<ul class="org-ul">
<li>The type of lock desired: F_RDLCK, F_WRLCK, or F_UNLCK</li>

<li>The starting byte offset of the region being locked or unlocked (l_start and l_whence)</li>

<li>The size of the region in bytes(l_len)</li>

<li>The ID(l_pid) of the process holding the lock that can block the current process(returned by F_GETLK only)</li>
</ul></li>

<li><p>
rules to the specification of the region to be locked or unlocked
</p>

<ul class="org-ul">
<li>The two elements that specify the starting offset of the region are similar to the last two arguments of the <code>lseek</code> function.</li>

<li>Locks can start and extend beyond the current end of file, but cannot start or extend before the beginning of the file</li>

<li>if l_len is 0, it means that the lock extends to the <b>largest</b> possible offset of the file</li>

<li>To lock the entire file, we set l_start and l_whence to point the beginning of the file and specify a length(l_len) of 0.</li>
</ul>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 19:</span> Figure 14.3 Compatibility between different types</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">conditions</th>
<th scope="col" class="org-left">read lock</th>
<th scope="col" class="org-left">write lock</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">no locks</td>
<td class="org-left">OK</td>
<td class="org-left">OK</td>
</tr>

<tr>
<td class="org-left">one or more read locks</td>
<td class="org-left">OK</td>
<td class="org-left">denied</td>
</tr>

<tr>
<td class="org-left">one or more write lock</td>
<td class="org-left">denied</td>
<td class="org-left">denied</td>
</tr>
</tbody>
</table></li>

<li>Commands for the <code>fcntl</code> function

<ul class="org-ul">
<li>F_GETLK: determine lock</li>

<li>F_SETLK: set lock, also used to clear lock(F_UNLCK)</li>

<li>F_SETLWK: a block version of F_SETLK. (The <b>W</b> means wait)</li>
</ul></li>
</ul></li>
</ul>

<p>
testing for a lock with F_GETLK and then trying to obtain that lock with F_SETLK or F_SETLKW is not an atomic operation
</p>


<div id="org10685b5" class="figure">
<p><img src="Chapter14/14fig04.jpg" alt="14fig04.jpg" />
</p>
<p><span class="figure-number">Figure 25: </span>Figure 14.4 File byte-range lock diagram</p>
</div>

<ul class="org-ul">
<li><p>
Example - Requesting and Releasing a Lock
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 111: </span>Figure 14.5 Function to lock or unlock a region of a file</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     14fig05.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-12-16</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Function to lock or unlock a region of a file</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">lock_reg</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">cmd</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">type</span>, <span style="color: #ce537a; font-weight: bold;">off_t</span> <span style="color: #7590db;">offset</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">whence</span>, <span style="color: #ce537a; font-weight: bold;">off_t</span> <span style="color: #7590db;">len</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">flock</span> <span style="color: #7590db;">lock</span>;

    lock.l_type   = type;
    lock.l_start  = offset;
    lock.l_whence = whence;
    lock.l_len    = len;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fcntl<span style="color: #2d9574;">(</span>fd, cmd, &amp;lock<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
Example - Testing for a Lock
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 112: </span>Figure 14.6 Function to test for a locking condition</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     14fig06.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-12-16</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Figure 14.6 Function to test for a locking condition</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #bc6ec5; font-weight: bold;">lock_test</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">type</span>, <span style="color: #ce537a; font-weight: bold;">off_t</span> <span style="color: #7590db;">offset</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">whence</span>, <span style="color: #ce537a; font-weight: bold;">off_t</span> <span style="color: #7590db;">len</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">flock</span> <span style="color: #7590db;">lock</span>;

    lock.l_type   = type;
    lock.l_start  = offset;
    lock.l_whence = whence;
    lock.l_len    = len;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>fcntl<span style="color: #2d9574;">(</span>fd, F_GETLK, &amp;lock<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fcntl error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>lock.l_type == F_UNLCK<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>lock.l_pid<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
Example - Deadlock
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 113: </span>Figure 14.7 Example of deadlock detection</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     deadlock.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-12-16</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Example of deadlock detection</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">lockabyte</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>, <span style="color: #ce537a; font-weight: bold;">off_t</span> <span style="color: #7590db;">offset</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>writew_lock<span style="color: #2d9574;">(</span>fd, offset, SEEK_END, <span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s: writew_lock error"</span>, name<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%s: got the lock, byte %lld\n"</span>, name, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>offset<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">fd</span>;
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">/*</span>
<span style="color: #2aa1ae; background-color: #292e34;">     * Create a file and write two bytes to it.</span>
<span style="color: #2aa1ae; background-color: #292e34;">     */</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fd = creat<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"templock"</span>, FILE_MODE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"creat error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>write<span style="color: #2d9574;">(</span>fd, <span style="color: #2d9574;">"ab"</span>, <span style="color: #a45bad;">2</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"write error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    TELL_WAIT<span style="color: #bc6ec5;">()</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        lockabyte<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"child"</span>, fd, <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>;
        TELL_PARENT<span style="color: #2d9574;">(</span>getppid<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span>;
        WAIT_PARENT<span style="color: #2d9574;">()</span>;
        lockabyte<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"child"</span>, fd, <span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        lockabyte<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"parent"</span>, fd, <span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span>;
        TELL_CHILD<span style="color: #2d9574;">(</span>pid<span style="color: #2d9574;">)</span>;
        WAIT_CHILD<span style="color: #2d9574;">()</span>;
        lockabyte<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"parent"</span>, fd, <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li>Implied Inheritance and Release of Locks

<ol class="org-ol">
<li>Locks are associated with a process and a file.</li>
<li>Locks are never inherited by the child accross a fork</li>
<li>Locks are inherited by a new program accross exec.</li>
</ol></li>

<li><p>
FreeBSD Implementation
</p>

<p>
<img src="Chapter14/14fig08.jpg" alt="14fig08.jpg" />
new here are <b>lockf</b> structure
</p>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 114: </span>Figure 14.9 Place a write lock on an entire file</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     14fig09.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-12-16</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Place a write lock on an entire file</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">lockfile</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">flock</span> <span style="color: #7590db;">fl</span>;

    fl.l_type   = F_WRLCK;
    fl.l_start  = <span style="color: #a45bad;">0</span>;
    fl.l_whence = SEEK_SET;
    fl.l_len    = <span style="color: #a45bad;">0</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fcntl<span style="color: #2d9574;">(</span>fd, F_SETLK, &amp;fl<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>

<p>
macro
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#define</span> <span style="color: #bc6ec5; font-weight: bold;">lockfile</span><span style="color: #4f97d7;">(</span><span style="color: #7590db;">fd</span><span style="color: #4f97d7;">)</span> write_lock<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span>fd<span style="color: #bc6ec5;">)</span>, <span style="color: #a45bad;">0</span>, SEEK_SET, <span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span>
</pre>
</div></li>

<li><p>
Locks at End of File
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">The commented code should be the right one</span>
<span style="color: #bc6ec5; font-weight: bold;">writew_lock</span><span style="color: #4f97d7;">(</span>fd, <span style="color: #a45bad;">0</span>, SEEK_END, <span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span>;
<span style="color: #bc6ec5; font-weight: bold;">write</span><span style="color: #4f97d7;">(</span>fd, buf, <span style="color: #a45bad;">1</span><span style="color: #4f97d7;">)</span>;
<span style="color: #bc6ec5; font-weight: bold;">un_lock</span><span style="color: #4f97d7;">(</span>fd, <span style="color: #a45bad;">0</span>, SEEK_END<span style="color: #4f97d7;">)</span>;       <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">un_lock(fd, -1, SEEK_END) instead</span>
<span style="color: #bc6ec5; font-weight: bold;">write</span><span style="color: #4f97d7;">(</span>fd, buf, <span style="color: #a45bad;">1</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>

<div id="org0ecef99" class="figure">
<p><img src="Chapter14/14fig10.jpg" alt="14fig10.jpg" />
</p>
<p><span class="figure-number">Figure 26: </span>Figure 14.10 File range lock diagram</p>
</div></li>

<li><p>
Advisory versus Mandatory Locking
</p>


<div id="orgdfa0e13" class="figure">
<p><img src="Chapter14/14fig11.jpg" alt="14fig11.jpg" />
</p>
<p><span class="figure-number">Figure 27: </span>Figure 14.11 Effect of mandatory locking on reads and writes by other processes</p>
</div>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 115: </span>Figure 14.12 Determine whether mandatory locking is supported</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     mandatory.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-12-17</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    determine whether our system supports mandatory locking</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>         <span style="color: #7590db;">fd</span>;
    <span style="color: #ce537a; font-weight: bold;">pid_t</span>       <span style="color: #7590db;">pid</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>        <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">5</span><span style="color: #bc6ec5;">]</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">stat</span> <span style="color: #7590db;">statbuf</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc != <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"usage: %s filename"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fd = open<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span>, O_RDWR | O_CREAT | O_TRUNC, FILE_MODE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"open error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>write<span style="color: #2d9574;">(</span>fd, <span style="color: #2d9574;">"abcdef"</span>, <span style="color: #a45bad;">6</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">6</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fstat error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>fstat<span style="color: #2d9574;">(</span>fd, &amp;statbuf<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fstat error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>fchmod<span style="color: #2d9574;">(</span>fd, <span style="color: #67b11d;">(</span>statbuf.st_mode &amp; ~S_IXGRP<span style="color: #67b11d;">)</span> | S_ISGID<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fchmod error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    TELL_WAIT<span style="color: #bc6ec5;">()</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>write_lock<span style="color: #67b11d;">(</span>fd, <span style="color: #a45bad;">0</span>, SEEK_SET, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"write_lock error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        TELL_CHILD<span style="color: #2d9574;">(</span>pid<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>waitpid<span style="color: #67b11d;">(</span>pid, <span style="color: #a45bad;">NULL</span>, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"waitpid error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        WAIT_PARENT<span style="color: #2d9574;">()</span>;

        set_fl<span style="color: #2d9574;">(</span>fd, O_NONBLOCK<span style="color: #2d9574;">)</span>;

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>read_lock<span style="color: #67b11d;">(</span>fd, <span style="color: #a45bad;">0</span>, SEEK_SET, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> != -<span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"child: read_lock succeeded"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"read_lock of already-locked region returns %d\n"</span>, errno<span style="color: #2d9574;">)</span>;

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>lseek<span style="color: #67b11d;">(</span>fd, <span style="color: #a45bad;">0</span>, SEEK_SET<span style="color: #67b11d;">)</span> == -<span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"lseek error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>read<span style="color: #67b11d;">(</span>fd, buf, <span style="color: #a45bad;">2</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>
            err_ret<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"read failed (mandatory locking works)"</span><span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">else</span>
            printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"read OK(no mandatory locking), buf = %2.2s\n"</span>, buf<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-sh">bin/14fig12 temp.lockk
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-orgd4d91f2" class="outline-4">
<h4 id="orgd4d91f2"><span class="done DONE">DONE</span> 14.4 I/O Multiplexing <code>[2/2]</code></h4>
<div class="outline-text-4" id="text-orgd4d91f2">

<div id="org3df6514" class="figure">
<p><img src="Chapter14/14fig13.jpg" alt="14fig13.jpg" />
</p>
</div>


<div id="org3c32112" class="figure">
<p><img src="Chapter14/14fig14.jpg" alt="14fig14.jpg" />
</p>
</div>

<p>
polling:
</p>
<ul class="org-ul">
<li>waste CPU time</li>
</ul>

<p>
asynchronous IO:
</p>
<ul class="org-ul">
<li>*we tell the kernel to notify us with a signal when a descriptor is ready for I/O.</li>
<li>*If we enable this signal for two descriptors (in the example we’ve been talking about, reading from two descriptors), the occurrence of the signal doesn’t tell us which descriptor is ready.</li>
</ul>

<p>
I/O multiplexing:
</p>
<ul class="org-ul">
<li>build a list of descriptors that we are interested in</li>
<li>call a function that doesn't return until one of the descriptors is ready for I/O.</li>
</ul>
</div>

<ul class="org-ul">
<li><a id="orgd672c6d"></a><span class="done DONE">DONE</span> 14.4.1 <code>select</code> and <code>pselect</code> Functions<br />
<div class="outline-text-5" id="text-orgd672c6d">
<p>
select arguments:
</p>
<ul class="org-ul">
<li>which descriptors we're interested in</li>
<li>which conditions we're interested in for each descriptor.</li>
<li>How long we want to wait.</li>
</ul>

<p>
return information:
</p>
<ul class="org-ul">
<li>The total count of the number of descriptors that are ready.</li>
<li>which descriptors are ready for each of the three conditions (read, write, or exception)</li>
</ul>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/select.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">select</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">maxfdp1</span>, <span style="color: #ce537a; font-weight: bold;">fd_set</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">readfds</span>,
           <span style="color: #ce537a; font-weight: bold;">fd_set</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">wriefds</span>, <span style="color: #ce537a; font-weight: bold;">fd_set</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">exceptfds</span>,
           <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timevval</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">tvptr</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: count of ready descriptors, 0 on timeout, -1 on error</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c" id="org2f4f103"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/select.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">FD_ISSET</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>, <span style="color: #ce537a; font-weight: bold;">fd_set</span> *<span style="color: #7590db;">fdset</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: nonzero if fd is in set, 0 otherwise</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">FD_CLR</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>, <span style="color: #ce537a; font-weight: bold;">fd_set</span> *<span style="color: #7590db;">fdset</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">FD_SET</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>, <span style="color: #ce537a; font-weight: bold;">fd_set</span> *<span style="color: #7590db;">fdset</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">FD_ZERO</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">fd_set</span> *<span style="color: #7590db;">fdset</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c" id="org3f5ee4f"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/select.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pselect</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">maxfdp1</span>, <span style="color: #ce537a; font-weight: bold;">fd_set</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">readfds</span>,
            <span style="color: #ce537a; font-weight: bold;">fd_set</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">writefds</span>, <span style="color: #ce537a; font-weight: bold;">fd_set</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">exceptfds</span>,
            <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">tsptr</span>,
            <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">sigset_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">sigmask</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
<p>
differences from select
</p>
<ul class="org-ul">
<li>timeout value for <code>select</code> is specified by a timeval structure, but timespec structure for pselect</li>
<li>timeout for pselect is declared const</li>
<li>An optional signal mask argument is available for pselect.</li>
</ul>
</div>
</li>

<li><a id="orga9f06aa"></a><span class="done DONE">DONE</span> 14.4.2 <code>poll</code> Function<br />
<div class="outline-text-5" id="text-orga9f06aa">
<p>
<code>poll</code> is similar to <code>select</code>, but without differentiating conditions
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">poll.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">poll</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">pollfd</span> <span style="color: #7590db;">fdarray</span><span style="color: #bc6ec5;">[]</span>, <span style="color: #ce537a; font-weight: bold;">nfds_t</span> <span style="color: #7590db;">nfds</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">timeout</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #4f97d7; font-weight: bold;">typedef</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">fd</span>;                        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">file descriptor to check, or &lt;0 to ignore</span>
        <span style="color: #ce537a; font-weight: bold;">short</span> <span style="color: #7590db;">events</span>;                    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">events of interest on fd</span>
        <span style="color: #ce537a; font-weight: bold;">short</span> <span style="color: #7590db;">revents</span>;                   <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">events that occurred on fd</span>
<span style="color: #4f97d7;">}</span>;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 20:</span> Figure 14.17 The events and revents flags for poll</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Name</th>
<th scope="col" class="org-left">Input to events?</th>
<th scope="col" class="org-left">Result from revents?</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">POLLIN</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">Equivalent to POLLRDNORM <code>OR</code> POLLRDBAND</td>
</tr>

<tr>
<td class="org-left">POLLRDNORM</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">Normal data can bread without blocking</td>
</tr>

<tr>
<td class="org-left">POLLRDBAND</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">Priority data can be read without blocking</td>
</tr>

<tr>
<td class="org-left">POLLPRI</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">High-priority data can be read without blocking</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">POLLOUT</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">Normal data can be written without blocking</td>
</tr>

<tr>
<td class="org-left">POLLWRNORM</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">Same as POLLOUT</td>
</tr>

<tr>
<td class="org-left">POLLWRBAND</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">Priority data can be written without blocking</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">POLLERR</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
<td class="org-left">An error has occurred</td>
</tr>

<tr>
<td class="org-left">POLLHUP</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
<td class="org-left">A hangup has occurred</td>
</tr>

<tr>
<td class="org-left">POLLNVAL</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
<td class="org-left">The descriptor does not reference an open file</td>
</tr>
</tbody>
</table>

<p>
When a descriptor is hang up (POLLHUP), we can no longer write, but still can read
</p>

<ul class="org-ul">
<li><p>
Interruptibility of <code>select</code> and <code>poll</code>
</p>

<p>
When the automatic restarting of interrupted system calls was introduced with 4.2BSD, the <code>select</code> function was never restarted.  <br />
even if the SA_RESTART option is specified. <br />
but under SVR4, if SA_RESTART was specified, even <code>select</code> and <code>poll</code> were automatically restarted.
</p></li>
</ul>
</div>
</li>
</ul>
</div>

<div id="outline-container-org51e0335" class="outline-4">
<h4 id="org51e0335"><span class="done DONE">DONE</span> 14.5 Asynchronous I/O <code>[3/3]</code></h4>
<div class="outline-text-4" id="text-org51e0335">
</div>

<ul class="org-ul">
<li><a id="org21710db"></a><span class="done DONE">DONE</span> 14.5.1 System V Asynchronous I/O<br />
<div class="outline-text-5" id="text-org21710db">
<p>
<code>&lt;stropt.h&gt;</code>
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 21:</span> Figure 14.18 Conditions for generating SIGPOLL signal</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Constant</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">S_INPUT</td>
<td class="org-left">We can read data (other than high-priority data) without blocking</td>
</tr>

<tr>
<td class="org-left">S_RDNORM</td>
<td class="org-left">We can read normal data without blocking</td>
</tr>

<tr>
<td class="org-left">S_RDBND</td>
<td class="org-left">We can read priority dat without blocking</td>
</tr>

<tr>
<td class="org-left">S_BANDURG</td>
<td class="org-left">If this constant is specified with S_RDBAND, the SIGURG signal is generated</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">instead of SIGPOLL When we can read priority data without blocking</td>
</tr>

<tr>
<td class="org-left">S_HIPRI</td>
<td class="org-left">we can read high-priority data without blocking</td>
</tr>

<tr>
<td class="org-left">S_OUTPUT</td>
<td class="org-left">We can write normal data wihout blocking</td>
</tr>

<tr>
<td class="org-left">S_WRNORM</td>
<td class="org-left">Same as S_OUTPUT</td>
</tr>

<tr>
<td class="org-left">S_WRBAND</td>
<td class="org-left">We can write priority data without blocing.</td>
</tr>

<tr>
<td class="org-left">S_MSG</td>
<td class="org-left">The SIGPOLL signal message has reached the stream head.</td>
</tr>

<tr>
<td class="org-left">S_ERROR</td>
<td class="org-left">The stream has an error.</td>
</tr>

<tr>
<td class="org-left">S_HANGUP</td>
<td class="org-left">The stream has hung up.</td>
</tr>
</tbody>
</table>
</div>
</li>

<li><a id="orgfc8efea"></a><span class="done DONE">DONE</span> 14.5.2 BSD Asynchronous I/O<br />
<div class="outline-text-5" id="text-orgfc8efea">
<p>
Asynchronous I/O in BSD-derived system is a combination of two signals: SIGIO and SIGURG.
</p>

<p>
To receive the <code>SIGIO</code> signal, perform the following steps:
</p>
<ol class="org-ol">
<li>Establish a signal handler for SIGIO, by calling either <code>signal</code> or <code>sigaction</code>.</li>
<li>Set the process ID or process group ID to receive the signal for the descriptor, by calling <code>fcntl</code> with a command of <code>F_SETOWN</code> (Section 3.14)</li>
<li>Enable asynchronous I/O on the descriptor by calling <code>fcntl</code> with a command of <code>F_SETFL</code> to set the <code>O_ASYNC</code> file status flag (Figure 3.10)</li>
</ol>

<p>
For the <code>SIGURG</code> signal, we need perform only steps 1 and 2. <code>SIGURG</code> is generated only for descriptors that refer to network connections that support out-of-band data, such as TCP connections.
</p>
</div>
</li>

<li><a id="org9f48760"></a><span class="done DONE">DONE</span> 14.5.3 POSIX Asynchronous I/O<br />
<div class="outline-text-5" id="text-org9f48760">
<p>
The asynchronous I/O interfaces use AIO control blocks to describe I/O operations.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">aiocb</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #ce537a; font-weight: bold;">int</span>             <span style="color: #7590db;">aio_filedes</span>;    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">file descriptor</span>
        <span style="color: #ce537a; font-weight: bold;">off_t</span>           <span style="color: #7590db;">aio_offset</span>;     <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">file offset for I/O</span>
        <span style="color: #4f97d7; font-weight: bold;">volatile</span> <span style="color: #ce537a; font-weight: bold;">void</span>   *<span style="color: #7590db;">aio_buf</span>;       <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">buffer for I/O</span>
        <span style="color: #ce537a; font-weight: bold;">size_t</span>          <span style="color: #7590db;">aio_nbytes</span>;     <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">number of bytes to transfer</span>
        <span style="color: #ce537a; font-weight: bold;">int</span>             <span style="color: #7590db;">aio_reqprio</span>;    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">priority</span>
        <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sigevent</span> <span style="color: #7590db;">aio_sigevent</span>;   <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">signal information</span>
        <span style="color: #ce537a; font-weight: bold;">int</span>             <span style="color: #7590db;">aio_lio_opcode</span>; <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">operation for list I/O</span>
<span style="color: #4f97d7;">}</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sigevent</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #ce537a; font-weight: bold;">int</span>             <span style="color: #7590db;">sigev_notify</span>;                <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">notify type</span>
        <span style="color: #ce537a; font-weight: bold;">int</span>             <span style="color: #7590db;">sigev_signo</span>;                 <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">signal number</span>
        <span style="color: #4f97d7; font-weight: bold;">union</span> <span style="color: #ce537a; font-weight: bold;">sigval</span>    <span style="color: #7590db;">sigev_values</span>;                <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">notify argument</span>
        <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5;">(</span>*<span style="color: #bc6ec5; font-weight: bold;">sigev_notify_function</span><span style="color: #bc6ec5;">)(</span><span style="color: #4f97d7; font-weight: bold;">union</span> <span style="color: #ce537a; font-weight: bold;">sigval</span><span style="color: #bc6ec5;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">notify function</span>
        <span style="color: #ce537a; font-weight: bold;">pthread_attr_t</span> *<span style="color: #7590db;">sigev_notify_attributes</span>;     <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">notify attrs</span>
<span style="color: #4f97d7;">}</span>;
</pre>
</div>
<p>
<code>sigev_notify</code> taks one of three values:
</p>
<ul class="org-ul">
<li>SIGEV_NONE    The process is not notified when the asynchronous I/O request completes.</li>
<li>SIGEV_SIGNAL  The signal specified by the <code>sigev_signo</code> field is generated when the asynchronous I/O request completes.</li>
<li>SIGEV_THREAD  The function specified by the <code>sigev_notify_function</code> field is called when the asynchronous I/O request completes.</li>
</ul>

<p>
AIO related functions:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">aio.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">aio_read</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">aiocb</span> *<span style="color: #7590db;">aiocb</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">aio_write</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">aiocb</span> *<span style="color: #7590db;">aiocb</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return 0 if OK, -1 on error</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">When the functions return success, the asynchronous I/O request has been queued for processing by the operating system.</span>

<span style="color: #2aa1ae; background-color: #292e34;">/// </span><span style="color: #2aa1ae; background-color: #292e34;">@brief force write all pending asynchronous</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">aio_fsync</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">op</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">aiocb</span> *<span style="color: #7590db;">aiocb</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, -1 on error</span>

<span style="color: #2aa1ae; background-color: #292e34;">/// </span><span style="color: #2aa1ae; background-color: #292e34;">@brief determine the completion status of beyond operations</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">air_error</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">aiocb</span>* <span style="color: #7590db;">aiocb</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0             if SUCCESS (need to cal aio_return)</span>
<span style="color: #2aa1ae; background-color: #292e34;">//         </span><span style="color: #2aa1ae; background-color: #292e34;">-1            on ERROR (errno for details)</span>
<span style="color: #2aa1ae; background-color: #292e34;">//         </span><span style="color: #2aa1ae; background-color: #292e34;">EINPROGRESS   still pending</span>

<span style="color: #2aa1ae; background-color: #292e34;">/// </span><span style="color: #2aa1ae; background-color: #292e34;">@brief get return value if succeeded</span>
<span style="color: #ce537a; font-weight: bold;">ssize_t</span> <span style="color: #bc6ec5; font-weight: bold;">aio_return</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">aiocb</span> *<span style="color: #7590db;">aiocb</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: return results if OK, -1 and set errno on error</span>

<span style="color: #2aa1ae; background-color: #292e34;">/// </span><span style="color: #2aa1ae; background-color: #292e34;">@brief block operation until an operation completes</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">aio_suspend</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">aiocb</span> *<span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #7590db;">list</span><span style="color: #bc6ec5;">[]</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">ncnt</span>,
                <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span> *<span style="color: #7590db;">timeout</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, -1 on error</span>

<span style="color: #2aa1ae; background-color: #292e34;">/// </span><span style="color: #2aa1ae; background-color: #292e34;">@brief cancel pending asynchronous I/O operations</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">aio_cancel</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">aiocb</span> *<span style="color: #7590db;">aiocb</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: AIO_ALLDONE      all of the operations completed before the attempt to cancel</span>
<span style="color: #2aa1ae; background-color: #292e34;">//          </span><span style="color: #2aa1ae; background-color: #292e34;">AIO_CANCELED     all of the requested operations have been canceled</span>
<span style="color: #2aa1ae; background-color: #292e34;">//          </span><span style="color: #2aa1ae; background-color: #292e34;">AIO_NOTCANCELED  at least one of the requested operations could not be canceled</span>
<span style="color: #2aa1ae; background-color: #292e34;">//          </span><span style="color: #2aa1ae; background-color: #292e34;">-1               failed.</span>
</pre>
</div>

<p>
additional function submits a set of I/O requests described by a list of AIO control blocks
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">aio.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">lio_listio</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">mode</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">aiocb</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #7590db;">list</span><span style="color: #bc6ec5;">[</span><span style="color: #4f97d7; font-weight: bold;">restrict</span><span style="color: #bc6ec5;">]</span>,
               <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">ncnt</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sigevent</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">sigev</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, -1 on error</span>
</pre>
</div>

<p>
mode: <code>LIO_WAIT</code> / <code>LIO_NOWAIT</code>
list: points to a list of AIO control blocks specifying the I/O operations to perform (LIO_READ, LIO_WRITE in <code>aio_lio_opcode</code>)
ncnt: count of list
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 22:</span> Figure 14.19 POSIX.1 runtime invariant values for asynchronous I/O</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Name</th>
<th scope="col" class="org-left">Description</th>
<th scope="col" class="org-left">Minimum acceptable values</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">AIO_LISTIO_MAX</td>
<td class="org-left">maximum number of I/O operations in a single list I/O call</td>
<td class="org-left">_POSIX_AIO_LISTIO_MAX</td>
</tr>

<tr>
<td class="org-left">AIO_MAX</td>
<td class="org-left">maximum number of outstanding asynchronous I/O operations</td>
<td class="org-left">_POSIX_AIO_MAX</td>
</tr>

<tr>
<td class="org-left">AIO_PRIO_DELTA_MAX</td>
<td class="org-left">maximum amount by which a process can decrease its asynchronous I/O priority level</td>
<td class="org-left">0</td>
</tr>
</tbody>
</table>
<p>
<code>AIO_LISTIO_MAX</code>      = sysconf(_SC_IO_LISTIO_MAX)
<code>AIO_MAX</code>             = sysconf(_SC_AIO_MAX)
<code>AIO_PRIO_DELTA_MAX</code>  = sysconf(_SC_AIO_PRIO_DELTA_MAX)
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 116: </span>Figure 14.20 Translate a file using ROT-13</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     14fig20.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-12-26</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    translate a file using ROT-13</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> *   block mode</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">ctype.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">__progname</span>;

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">BSZ</span> <span style="color: #a45bad;">4096</span>

<span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">buf</span><span style="color: #4f97d7;">[</span>BSZ<span style="color: #4f97d7;">]</span>;

<span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #bc6ec5; font-weight: bold;">translate</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">c</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>isalpha<span style="color: #2d9574;">(</span>c<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>c &gt;= <span style="color: #2d9574;">'n'</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            c -= <span style="color: #a45bad;">13</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>c &gt;= <span style="color: #2d9574;">'a'</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            c += <span style="color: #a45bad;">13</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>c &gt;= <span style="color: #2d9574;">'N'</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            c -= <span style="color: #a45bad;">13</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            c += <span style="color: #a45bad;">13</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> c;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">ifd</span>, <span style="color: #7590db;">ofd</span>, <span style="color: #7590db;">i</span>, <span style="color: #7590db;">n</span>, <span style="color: #7590db;">nw</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc != <span style="color: #a45bad;">3</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"usage: %s infile outfile"</span>, __progname<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>ifd = open<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span>, O_RDONLY<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"can't open %s"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>ofd = open<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #a45bad;">2</span><span style="color: #b1951d;">]</span>, O_RDWR | O_CREAT | O_TRUNC, FILE_MODE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"can't open %s"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #a45bad;">2</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>n = read<span style="color: #67b11d;">(</span>ifd, buf, BSZ<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #2d9574;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; n; ++i<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            buf<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span> = translate<span style="color: #67b11d;">(</span>buf<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>nw = write<span style="color: #b1951d;">(</span>ofd, buf, n<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> != n<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>nw &lt; <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"write failed"</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #67b11d;">{</span>
                err_quit<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"short write (%d/%d)"</span>, nw, n<span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    fsync<span style="color: #bc6ec5;">(</span>ofd<span style="color: #bc6ec5;">)</span>;
    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 117: </span>Figure 14.21 Translate a file using ROT-13 and asynchronous I/O</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     14fig21.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-12-26</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    translate a file using ROT-13</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> *   block mode</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">aio.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">ctype.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">__progname</span>;

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">BSZ</span>  <span style="color: #a45bad;">4096</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">NBUF</span> <span style="color: #a45bad;">8</span>

<span style="color: #4f97d7; font-weight: bold;">enum</span> <span style="color: #ce537a; font-weight: bold;">rwop</span> <span style="color: #4f97d7;">{</span> <span style="color: #7590db;">UNUSED</span> = <span style="color: #a45bad;">0</span>, <span style="color: #7590db;">READ_PENDING</span> = <span style="color: #a45bad;">1</span>, <span style="color: #7590db;">WRITE_PENDING</span> = <span style="color: #a45bad;">2</span> <span style="color: #4f97d7;">}</span>;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">buf</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">enum</span> <span style="color: #ce537a; font-weight: bold;">rwop</span>     <span style="color: #7590db;">op</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>           <span style="color: #7590db;">last</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">aiocb</span>  <span style="color: #7590db;">aiocb</span>;
    <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">data</span><span style="color: #bc6ec5;">[</span>BSZ<span style="color: #bc6ec5;">]</span>;
<span style="color: #4f97d7;">}</span>;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">buf</span> <span style="color: #7590db;">bufs</span><span style="color: #4f97d7;">[</span>NBUF<span style="color: #4f97d7;">]</span>;

<span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #bc6ec5; font-weight: bold;">translate</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">c</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>isalpha<span style="color: #2d9574;">(</span>c<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>c &gt;= <span style="color: #2d9574;">'n'</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            c -= <span style="color: #a45bad;">13</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>c &gt;= <span style="color: #2d9574;">'a'</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            c += <span style="color: #a45bad;">13</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>c &gt;= <span style="color: #2d9574;">'N'</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            c -= <span style="color: #a45bad;">13</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            c += <span style="color: #a45bad;">13</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> c;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> **<span style="color: #7590db;">argv</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>                 <span style="color: #7590db;">ifd</span>, <span style="color: #7590db;">ofd</span>, <span style="color: #7590db;">i</span>, <span style="color: #7590db;">j</span>, <span style="color: #7590db;">n</span>, <span style="color: #7590db;">err</span>, <span style="color: #7590db;">numop</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">stat</span>         <span style="color: #7590db;">sbuf</span>;
    <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">aiocb</span> *<span style="color: #7590db;">aiolist</span><span style="color: #bc6ec5;">[</span>NBUF<span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">off_t</span>               <span style="color: #7590db;">off</span> = <span style="color: #a45bad;">0</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc != <span style="color: #a45bad;">3</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"usage: %s infile outfile"</span>, __progname<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>ifd = open<span style="color: #67b11d;">(</span>STDIN_FILENO, O_RDONLY<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"can't open %s"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>ofd = open<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #a45bad;">2</span><span style="color: #b1951d;">]</span>, O_RDWR | O_CREAT | O_TRUNC, FILE_MODE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"can't open %s"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #a45bad;">2</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; NBUF; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        bufs<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>.op                              = UNUSED;
        bufs<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>.aiocb.aio_buf                   = bufs<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>.data;
        bufs<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>.aiocb.aio_sigevent.sigev_notify = SIGEV_NONE;
        aiolist<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>                              = <span style="color: #a45bad;">NULL</span>;
    <span style="color: #bc6ec5;">}</span>

    numop = <span style="color: #a45bad;">0</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>;;<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #2d9574;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; NBUF; ++i<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">switch</span> <span style="color: #67b11d;">(</span>bufs<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span>.op<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                <span style="color: #4f97d7; font-weight: bold;">case</span> UNUSED: <span style="color: #b1951d;">{</span>
                    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">(</span>off &lt; sbuf.st_size<span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
                        bufs<span style="color: #bc6ec5;">[</span>i<span style="color: #bc6ec5;">]</span>.op               = READ_PENDING;
                        bufs<span style="color: #bc6ec5;">[</span>i<span style="color: #bc6ec5;">]</span>.aiocb.aio_fildes = ifd;
                        bufs<span style="color: #bc6ec5;">[</span>i<span style="color: #bc6ec5;">]</span>.aiocb.aio_offset = off;
                        off += BSZ;
                        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>off &gt;= sbuf.st_size<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
                            bufs<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>.last = <span style="color: #a45bad;">1</span>;
                        <span style="color: #bc6ec5;">}</span>
                        bufs<span style="color: #bc6ec5;">[</span>i<span style="color: #bc6ec5;">]</span>.aiocb.aio_nbytes = BSZ;
                        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>aio_read<span style="color: #2d9574;">(</span>&amp;bufs<span style="color: #9cb6ad;">[</span>i<span style="color: #9cb6ad;">]</span>.aiocb<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
                            err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"aio_read failed"</span><span style="color: #2d9574;">)</span>;
                        <span style="color: #bc6ec5;">}</span>
                        aiolist<span style="color: #bc6ec5;">[</span>i<span style="color: #bc6ec5;">]</span> = &amp;bufs<span style="color: #bc6ec5;">[</span>i<span style="color: #bc6ec5;">]</span>.aiocb;
                        numop++;
                    <span style="color: #4f97d7;">}</span>
                    <span style="color: #4f97d7; font-weight: bold;">break</span>;
                <span style="color: #b1951d;">}</span>

                <span style="color: #4f97d7; font-weight: bold;">case</span> READ_PENDING: <span style="color: #b1951d;">{</span>
                    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span>err = aio_error<span style="color: #2d9574;">(</span>&amp;bufs<span style="color: #9cb6ad;">[</span>i<span style="color: #9cb6ad;">]</span>.aiocb<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> == EINPROGRESS<span style="color: #4f97d7;">)</span>
                        <span style="color: #4f97d7; font-weight: bold;">continue</span>;

                    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
                        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err == -<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
                            err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"aio_error failed"</span><span style="color: #2d9574;">)</span>;
                        <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
                            err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"read failed"</span><span style="color: #2d9574;">)</span>;
                        <span style="color: #bc6ec5;">}</span>
                    <span style="color: #4f97d7;">}</span>

                    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span>n = aio_return<span style="color: #2d9574;">(</span>&amp;bufs<span style="color: #9cb6ad;">[</span>i<span style="color: #9cb6ad;">]</span>.aiocb<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
                        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"aio_return failed"</span><span style="color: #bc6ec5;">)</span>;
                    <span style="color: #4f97d7;">}</span>
                    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">(</span>n != BSZ &amp;&amp; <span style="color: #a45bad;">!</span>bufs<span style="color: #bc6ec5;">[</span>i<span style="color: #bc6ec5;">]</span>.last<span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
                        err_quit<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"short read (%d/%d)"</span>, n, BSZ<span style="color: #bc6ec5;">)</span>;
                    <span style="color: #4f97d7;">}</span>
                    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #4f97d7;">(</span>j = <span style="color: #a45bad;">0</span>; j &lt; n; ++j<span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
                        bufs<span style="color: #bc6ec5;">[</span>i<span style="color: #bc6ec5;">]</span>.data<span style="color: #bc6ec5;">[</span>j<span style="color: #bc6ec5;">]</span> = translate<span style="color: #bc6ec5;">(</span>bufs<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>.data<span style="color: #2d9574;">[</span>j<span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span>;
                    <span style="color: #4f97d7;">}</span>

                    bufs<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span>.op               = WRITE_PENDING;
                    bufs<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span>.aiocb.aio_fildes = ofd;
                    bufs<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span>.aiocb.aio_nbytes = n;
                    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">(</span>aio_write<span style="color: #bc6ec5;">(</span>&amp;bufs<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>.aiocb<span style="color: #bc6ec5;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
                        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"aio_write failed"</span><span style="color: #bc6ec5;">)</span>;
                    <span style="color: #4f97d7;">}</span>

                    <span style="color: #4f97d7; font-weight: bold;">break</span>;
                <span style="color: #b1951d;">}</span>

                <span style="color: #4f97d7; font-weight: bold;">case</span> WRITE_PENDING: <span style="color: #b1951d;">{</span>
                    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span>err = aio_error<span style="color: #2d9574;">(</span>&amp;bufs<span style="color: #9cb6ad;">[</span>i<span style="color: #9cb6ad;">]</span>.aiocb<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> == EINPROGRESS<span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
                        <span style="color: #4f97d7; font-weight: bold;">continue</span>;
                    <span style="color: #4f97d7;">}</span>
                    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
                        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err == -<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
                            err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"aio_error failed"</span><span style="color: #2d9574;">)</span>;
                        <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
                            err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"write failed"</span><span style="color: #2d9574;">)</span>;
                        <span style="color: #bc6ec5;">}</span>
                    <span style="color: #4f97d7;">}</span>

                    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span>n = aio_return<span style="color: #2d9574;">(</span>&amp;bufs<span style="color: #9cb6ad;">[</span>i<span style="color: #9cb6ad;">]</span>.aiocb<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
                        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"aio_return failed"</span><span style="color: #bc6ec5;">)</span>;
                    <span style="color: #4f97d7;">}</span>
                    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">(</span>n != bufs<span style="color: #bc6ec5;">[</span>i<span style="color: #bc6ec5;">]</span>.aiocb.aio_nbytes<span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
                        err_quit<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"short write (%d/%d)"</span>, n,
                                 bufs<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>.aiocb.aio_nbytes<span style="color: #bc6ec5;">)</span>;
                    <span style="color: #4f97d7;">}</span>

                    aiolist<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span> = <span style="color: #a45bad;">NULL</span>;
                    bufs<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span>.op = UNUSED;
                    numop--;
                    <span style="color: #4f97d7; font-weight: bold;">break</span>;
                <span style="color: #b1951d;">}</span>

                <span style="color: #4f97d7; font-weight: bold;">default</span>:
                    <span style="color: #4f97d7; font-weight: bold;">break</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>numop == <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>off &gt;= sbuf.st_size<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                <span style="color: #4f97d7; font-weight: bold;">break</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>aio_suspend<span style="color: #b1951d;">(</span>aiolist, NBUF, <span style="color: #a45bad;">NULL</span><span style="color: #b1951d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"aio_suspend failed"</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    bufs<span style="color: #bc6ec5;">[</span>i<span style="color: #bc6ec5;">]</span>.aiocb.aio_fildes = ofd;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>aio_fsync<span style="color: #2d9574;">(</span>O_SYNC, &amp;bufs<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span>.aiocb<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"aio_fsync failed"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    exit<span style="color: #bc6ec5;">(</span>EXIT_SUCCESS<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<blockquote>
<p>
this might actually reduce performance—if the reads are presented to the ﬁle system out of order, it can defeat the operating system's read-ahead algorithm.
</p>
</blockquote>
</div>
</li>
</ul>
</div>

<div id="outline-container-org5e48300" class="outline-4">
<h4 id="org5e48300"><span class="done DONE">DONE</span> 14.6 <code>readv</code> and <code>writev</code> Functions</h4>
<div class="outline-text-4" id="text-org5e48300">
<p>
<i>scatter read</i> and <i>gather write</i>.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/uio.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">ssize_t</span> <span style="color: #bc6ec5; font-weight: bold;">readv</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">iovec</span> *<span style="color: #7590db;">iov</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">iovcnt</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">ssize_t</span> <span style="color: #bc6ec5; font-weight: bold;">writev</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">iovec</span> *<span style="color: #7590db;">iov</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">iovcnt</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: number of bytes read or written, -1 on error</span>

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">iovec</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #ce537a; font-weight: bold;">void</span>   *<span style="color: #7590db;">ivo_base</span>;                 <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">starting address of buffer</span>
        <span style="color: #ce537a; font-weight: bold;">size_t</span>  <span style="color: #7590db;">iov_len</span>;                  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">sizeof of buffer</span>
<span style="color: #4f97d7;">}</span>;
</pre>
</div>


<div id="orga4a2a9b" class="figure">
<p><img src="Chapter14/14fig22.jpg" alt="14fig22.jpg" />
</p>
<p><span class="figure-number">Figure 28: </span>Figure 14.22 The iovec structure for readv and writev</p>
</div>

<p>
Three ways to write two buffers consecutively to a file:
</p>
<ol class="org-ol">
<li>Call <code>write</code> twice, once for each buffer</li>
<li>allocate a buffer, merge two buffers into the allocated buffer, then call <code>write</code></li>
<li>call <code>writev</code> to both buffers</li>
</ol>


<div id="orgf04869d" class="figure">
<p><img src="Chapter14/14fig23.jpg" alt="14fig23.jpg" />
</p>
<p><span class="figure-number">Figure 29: </span>Figure 14.23 Timing results comparing writev and other techniques</p>
</div>
</div>
</div>

<div id="outline-container-org9970b43" class="outline-4">
<h4 id="org9970b43"><span class="done DONE">DONE</span> 14.7 <code>readn</code> and <code>writen</code> Functions</h4>
<div class="outline-text-4" id="text-org9970b43">
<p>
impletations for reading/writing only <i>n</i> bytes
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>
<span style="color: #ce537a; font-weight: bold;">ssize_t</span> <span style="color: #bc6ec5; font-weight: bold;">readn</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>, <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">buf</span>, <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">nbytes</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">ssize_t</span> <span style="color: #bc6ec5; font-weight: bold;">writen</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>, <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">buf</span>, <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">nbyts</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both Returns: number of bytes read or write, -1 on error</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 118: </span>Figure 14.24 The <code>readn</code> and <code>writen</code> functions</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     14fig24.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-12-28</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    implementations of readn and writen</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">ssize_t</span> <span style="color: #bc6ec5; font-weight: bold;">readn</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>, <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">ptr</span>, <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">n</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">size_t</span>  <span style="color: #7590db;">nleft</span>;
    <span style="color: #ce537a; font-weight: bold;">ssize_t</span> <span style="color: #7590db;">nread</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>nleft = n; nleft &gt; <span style="color: #a45bad;">0</span>; nleft -= nread<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>nread = read<span style="color: #b1951d;">(</span>fd, ptr, nleft<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">error occured</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>nleft == n<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">no read</span>
                <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
            <span style="color: #67b11d;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #67b11d;">{</span>
                <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">return read amount</span>
                <span style="color: #4f97d7; font-weight: bold;">break</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>nread == <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">break</span>;
        <span style="color: #2d9574;">}</span>
        ptr += nread;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> n - nleft;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">ssize_t</span> <span style="color: #bc6ec5; font-weight: bold;">writen</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">ptr</span>, <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">n</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">size_t</span>  <span style="color: #7590db;">nleft</span>;
    <span style="color: #ce537a; font-weight: bold;">ssize_t</span> <span style="color: #7590db;">nwritten</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>nleft = n; nleft &gt; <span style="color: #a45bad;">0</span>; nleft -= nwritten<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>nwritten = write<span style="color: #b1951d;">(</span>fd, ptr, nleft<span style="color: #b1951d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">error occured</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>nleft == n<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">no written</span>
                <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
            <span style="color: #67b11d;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #67b11d;">{</span>
                <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">return written amount</span>
                <span style="color: #4f97d7; font-weight: bold;">break</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>nwritten == <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">break</span>;
        <span style="color: #2d9574;">}</span>
        ptr += nwritten;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> n - nleft;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1675acd" class="outline-4">
<h4 id="org1675acd"><span class="done DONE">DONE</span> 14.8 Memory-Mapped I/O</h4>
<div class="outline-text-4" id="text-org1675acd">
<p>
map a file on disk into a buffer in memory so that, when we fetch bytes from the buffer, the corresponding bytes of the file are read.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/mman.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      map a file on disk into a buffer in memory</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     starting address of mapped region if OK, MAP_FAILED on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">mmap</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">addr</span>, <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">len</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">prot</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">flag</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>, <span style="color: #ce537a; font-weight: bold;">off_t</span> <span style="color: #7590db;">off</span><span style="color: #4f97d7;">)</span>;

<span style="color: #2aa1ae; background-color: #292e34;">/// </span><span style="color: #2aa1ae; background-color: #292e34;">@brief unmap a memory-mapped region</span>
<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      unmap a memory-mapped region</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     0 if OK, -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">munmap</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">addr</span>, <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">len</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 23:</span> Figure 14.25 Protection of memory-mapped region</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">prot</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">PROT_READ</td>
<td class="org-left">Region can be read</td>
</tr>

<tr>
<td class="org-left">PROT_WRITE</td>
<td class="org-left">Region can be written</td>
</tr>

<tr>
<td class="org-left">PROT_EXEC</td>
<td class="org-left">Region can be executed</td>
</tr>

<tr>
<td class="org-left">PROT_NONE</td>
<td class="org-left">Region cannot be accessed</td>
</tr>
</tbody>
</table>


<div id="org31f92c5" class="figure">
<p><img src="Chapter14/14fig26.jpg" alt="14fig26.jpg" />
</p>
<p><span class="figure-number">Figure 30: </span>Figure 14.26 Example of a memory-mapped file</p>
</div>

<p>
<i>flag</i> argument:
</p>

<ul class="org-ul">
<li>MAP_FIXED: The return value must equal <i>addr</i>.</li>

<li>MAP_SHARED: describe the disposition of store operations into the mapped region by this process.</li>

<li>MAP_PRIVATE: store operations into the mapped region cause a private copy of the mapped file to be created.</li>

<li>MAP_xxx: check <code>mmap(2)</code> for additional flag values</li>

<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 119: </span>Figure 14.27 Copy a file using memory-mapped I/O</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     14fig27.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-12-28</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Coapy a file using memory-mapped I/O</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/mman.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">COPYINCR</span> <span style="color: #4f97d7;">(</span><span style="color: #a45bad;">1024</span> * <span style="color: #a45bad;">1024</span> * <span style="color: #a45bad;">1024</span><span style="color: #4f97d7;">)</span>  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">1GB</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>         <span style="color: #7590db;">fdin</span>, <span style="color: #7590db;">fdout</span>;
    <span style="color: #ce537a; font-weight: bold;">void</span> *      <span style="color: #7590db;">src</span>, *<span style="color: #7590db;">dst</span>;
    <span style="color: #ce537a; font-weight: bold;">size_t</span>      <span style="color: #7590db;">copysz</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">stat</span> <span style="color: #7590db;">sbuf</span>;
    <span style="color: #ce537a; font-weight: bold;">off_t</span>       <span style="color: #7590db;">fsz</span> = <span style="color: #a45bad;">0</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc != <span style="color: #a45bad;">3</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"usage: %s &lt;from-file&gt; &lt;to-file&gt;"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fdin = open<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span>, O_RDONLY<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"can't open %s for reading"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fdout = open<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #a45bad;">2</span><span style="color: #b1951d;">]</span>, O_RDWR | O_CREAT | O_TRUNC, FILE_MODE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"can't create %s for writting"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #a45bad;">2</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>fstat<span style="color: #2d9574;">(</span>fdin, &amp;sbuf<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fstat error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">If we don&#8217;t set the output file&#8217;s size, the call to mmap for the output</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">file is successful, but the first reference to the associated memory</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">region generates a SIGBUS signal.</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ftruncate<span style="color: #2d9574;">(</span>fdout, sbuf.st_size<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"ftruncate error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span>fsz &lt; sbuf.st_size<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>sbuf.st_size - fsz<span style="color: #67b11d;">)</span> &gt; COPYINCR<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            copysz = COPYINCR;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            copysz = sbuf.st_size - fsz;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>src = mmap<span style="color: #b1951d;">(</span><span style="color: #a45bad;">0</span>, copysz, PROT_READ, MAP_SHARED, fdin, fsz<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> ==
            MAP_FAILED<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"mmap error for input"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>dst = mmap<span style="color: #b1951d;">(</span><span style="color: #a45bad;">0</span>, copysz, PROT_READ | PROT_WRITE, MAP_SHARED, fdout,
                        fsz<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> == MAP_FAILED<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"mmap error for output"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        memcpy<span style="color: #2d9574;">(</span>dst, src, copysz<span style="color: #2d9574;">)</span>;

        munmap<span style="color: #2d9574;">(</span>src, copysz<span style="color: #2d9574;">)</span>;
        munmap<span style="color: #2d9574;">(</span>dst, copysz<span style="color: #2d9574;">)</span>;
        fsz += copysz;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/mman.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;"> change the permissions on an existing mmaping</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@retval</span><span style="color: #9f8766;"> 0     OK</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@retval</span><span style="color: #9f8766;"> -1    error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">mprotect</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">addr</span>, <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">len</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">prot</span><span style="color: #4f97d7;">)</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;"> flush the changes to the file that backs the mapping</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">  flags   MS_ASYNC: schedule the page to be written</span>
<span style="color: #9f8766;"> *                 MS_SYNC:  wait for the writes to be cmoplete before turning</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@warning</span><span style="color: #9f8766;"> either MS_ASYNC or MS_SYNC must be specified</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@retval</span><span style="color: #9f8766;"> 0     OK</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@retval</span><span style="color: #9f8766;"> -1    error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">msync</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">addr</span>, <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">len</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">flags</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>


<div id="org65e318c" class="figure">
<p><img src="Chapter14/14fig28.jpg" alt="14fig28.jpg" />
</p>
<p><span class="figure-number">Figure 31: </span>Figure 14.29 Timing results comparing read/write versus mmap/memcpy</p>
</div>
</div>
</div>

<div id="outline-container-orga782c1c" class="outline-4">
<h4 id="orga782c1c"><span class="done DONE">DONE</span> 14.9 Summary</h4>
<div class="outline-text-4" id="text-orga782c1c">
<ul class="org-ul">
<li>Exercises

<ul class="org-ul">
<li><p>
14.1
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     14ex01.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-12-28</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    test write lock</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/select.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">fd_set</span> <span style="color: #7590db;">set</span>;

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sigint</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{}</span>

<span style="color: #ce537a; font-weight: bold;">int</span>  <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid1</span>, <span style="color: #7590db;">pid2</span>, <span style="color: #7590db;">pid3</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">fd</span>;

    setbuf<span style="color: #bc6ec5;">(</span>stdout, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    signal_intr<span style="color: #bc6ec5;">(</span>SIGINT, sigint<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fd = open<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"lockfile"</span>, O_RDWR | O_CREAT, FILE_MODE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"can't create lockfile"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">switch</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid1 = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">case</span> -<span style="color: #a45bad;">1</span>:
            err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork failed"</span><span style="color: #2d9574;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">break</span>;
        <span style="color: #4f97d7; font-weight: bold;">case</span> <span style="color: #a45bad;">0</span>: <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>read_lock<span style="color: #b1951d;">(</span>fd, <span style="color: #a45bad;">0</span>, SEEK_SET, <span style="color: #a45bad;">0</span><span style="color: #b1951d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"child 1: can't set RD-LOCK on file"</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"child 1: read lock on file.\n"</span><span style="color: #67b11d;">)</span>;
            pause<span style="color: #67b11d;">()</span>;
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"child 1: exit.\n"</span><span style="color: #67b11d;">)</span>;
            exit<span style="color: #67b11d;">(</span>EXIT_SUCCESS<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">default</span>:
            sleep<span style="color: #2d9574;">(</span><span style="color: #a45bad;">2</span><span style="color: #2d9574;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">break</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">switch</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid2 = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">case</span> -<span style="color: #a45bad;">1</span>:
            err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork failed"</span><span style="color: #2d9574;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">break</span>;
        <span style="color: #4f97d7; font-weight: bold;">case</span> <span style="color: #a45bad;">0</span>: <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>read_lock<span style="color: #b1951d;">(</span>fd, <span style="color: #a45bad;">0</span>, SEEK_SET, <span style="color: #a45bad;">0</span><span style="color: #b1951d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"child 2: can't set RD-LOCK on file"</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"child 2: read lock on file.\n"</span><span style="color: #67b11d;">)</span>;
            pause<span style="color: #67b11d;">()</span>;
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"child 2: exit.\n"</span><span style="color: #67b11d;">)</span>;
            exit<span style="color: #67b11d;">(</span>EXIT_SUCCESS<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">default</span>:
            sleep<span style="color: #2d9574;">(</span><span style="color: #a45bad;">2</span><span style="color: #2d9574;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">break</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">switch</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid3 = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">case</span> -<span style="color: #a45bad;">1</span>:
            err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork failed"</span><span style="color: #2d9574;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">break</span>;
        <span style="color: #4f97d7; font-weight: bold;">case</span> <span style="color: #a45bad;">0</span>: <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>write_lock<span style="color: #b1951d;">(</span>fd, <span style="color: #a45bad;">0</span>, SEEK_SET, <span style="color: #a45bad;">0</span><span style="color: #b1951d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                printf<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"child 3: can't set WR-LOCK on file.\n"</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"child 3: wait to set WR_LOCK.\n"</span><span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>writew_lock<span style="color: #b1951d;">(</span>fd, <span style="color: #a45bad;">0</span>, SEEK_SET, <span style="color: #a45bad;">0</span><span style="color: #b1951d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"child 3: can't WR-LOCK on file"</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"child 3: obtained write lock on file.\n"</span><span style="color: #67b11d;">)</span>;
            pause<span style="color: #67b11d;">()</span>;
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"child 3: exit.\n"</span><span style="color: #67b11d;">)</span>;
            exit<span style="color: #67b11d;">(</span>EXIT_SUCCESS<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">default</span>:
            sleep<span style="color: #2d9574;">(</span><span style="color: #a45bad;">2</span><span style="color: #2d9574;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">break</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>read_lock<span style="color: #2d9574;">(</span>fd, <span style="color: #a45bad;">0</span>, SEEK_SET, <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"parent: can't set RD-LOCK on file: %s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span>
            <span style="color: #2d9574;">"parent: set RD-LOCK on file success while WR-LOCK is pending.\n"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"killing child 1...\n"</span><span style="color: #bc6ec5;">)</span>;
    kill<span style="color: #bc6ec5;">(</span>pid1, SIGINT<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"killing child 2...\n"</span><span style="color: #bc6ec5;">)</span>;
    kill<span style="color: #bc6ec5;">(</span>pid2, SIGINT<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"killing child 3...\n"</span><span style="color: #bc6ec5;">)</span>;
    kill<span style="color: #bc6ec5;">(</span>pid3, SIGINT<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
14.2
</p>

<blockquote>
<p>
Most systems define the fd_set data type to be a structure that contains a single member: an array of long integers. One bit in this array corresponds to each descriptor. The four FD_ macros then manipulate this array of longs, turning specific bits on and off and testing specific bits.
</p>

<p>
One reason that the data type is defined to be a structure containing an array and not simply an array is to allow variables of type fd_set to be assigned to one another with the C assignment statement.
</p>
</blockquote></li>

<li><p>
14.3
</p>

<p>
define or redefine(undefine first) the macro <code>FD_SETSIZE</code> (or <code>__FD_SETSIZE</code>)
</p></li>

<li><p>
14.4
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">file descriptor sets</th>
<th scope="col" class="org-left">signal sets</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">FD_ZERO</td>
<td class="org-left">sigemptyset</td>
</tr>

<tr>
<td class="org-left">FD_SET</td>
<td class="org-left">sigaddset</td>
</tr>

<tr>
<td class="org-left">FD_CLR</td>
<td class="org-left">sigdelset</td>
</tr>

<tr>
<td class="org-left">FD_ISSET</td>
<td class="org-left">sigismember</td>
</tr>
</tbody>
</table></li>

<li><p>
14.5
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     14ex05.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-12-29</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    wait for specified number of microseconds via select</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/poll.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/select.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sleep_us_select</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">nusecs</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timeval</span> <span style="color: #7590db;">tval</span>;

    tval.tv_sec  = nusecs / <span style="color: #a45bad;">10e6</span>;
    tval.tv_usec = nusecs % <span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #bc6ec5;">)</span><span style="color: #a45bad;">10e6</span>;
    select<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span>, <span style="color: #a45bad;">NULL</span>, <span style="color: #a45bad;">NULL</span>, <span style="color: #a45bad;">NULL</span>, &amp;tval<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sleep_us_poll</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">nusecs</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">pollfd</span> <span style="color: #7590db;">fds</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>           <span style="color: #7590db;">timeout</span>;

    timeout = nusecs / <span style="color: #a45bad;">10e3</span>;
    timeout = timeout &lt;= <span style="color: #a45bad;">0</span> ? <span style="color: #a45bad;">1</span> : timeout;

    poll<span style="color: #bc6ec5;">(</span>&amp;fds, <span style="color: #a45bad;">0</span>, timeout<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    setbuf<span style="color: #bc6ec5;">(</span>stdout, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"before select sleep\n"</span><span style="color: #bc6ec5;">)</span>;
    sleep_us_select<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">2</span> * <span style="color: #a45bad;">10e6</span><span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"after select sleep\n"</span><span style="color: #bc6ec5;">)</span>;

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"before poll sleep\n"</span><span style="color: #bc6ec5;">)</span>;
    sleep_us_poll<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">2</span> * <span style="color: #a45bad;">10e6</span><span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"after poll sleep\n"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
14.6
</p>

<p>
No. <b>call <code>fork</code> releases all the locks in the child, so the child can't start off with any locks of its own</b>
</p></li>

<li><p>
14.7
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     14ex07.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-12-29</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    pipe using nonblocking writes.</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">limits.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pipe<span style="color: #2d9574;">(</span>fd<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"pipe error."</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    set_fl<span style="color: #bc6ec5;">(</span>fd<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>, O_NONBLOCK<span style="color: #bc6ec5;">)</span>;

    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">capacity</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>capacity = <span style="color: #a45bad;">0</span>;; capacity++<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">nwritten</span> = <span style="color: #a45bad;">0</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>nwritten = write<span style="color: #b1951d;">(</span>fd<span style="color: #4f97d7;">[</span><span style="color: #a45bad;">1</span><span style="color: #4f97d7;">]</span>, <span style="color: #2d9574;">"a"</span>, <span style="color: #a45bad;">1</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> != <span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"nwritten = %d\n"</span>, nwritten<span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">break</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"capacity = %d\n"</span>, capacity<span style="color: #bc6ec5;">)</span>;

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"PIPE_BUF = %d\n"</span>, PIPE_BUF<span style="color: #bc6ec5;">)</span>;

    exit<span style="color: #bc6ec5;">(</span>EXIT_SUCCESS<span style="color: #bc6ec5;">)</span>;

<span style="color: #4f97d7;">}</span>
</pre>
</div>
<blockquote>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Platform</th>
<th scope="col" class="org-right">Pipe Capacity(bytes)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">FreeBSD 8.0</td>
<td class="org-right">65536</td>
</tr>

<tr>
<td class="org-left"><b>Linux 4.1.0</b></td>
<td class="org-right">65536</td>
</tr>

<tr>
<td class="org-left"><b>Mac OS X 10.15.2</b></td>
<td class="org-right">65536</td>
</tr>

<tr>
<td class="org-left">Solaris 10</td>
<td class="org-right">16384</td>
</tr>
</tbody>
</table>

<p>
These values can differ from the corresponding <code>PIPE_BUF</code> values, because PIPE_BUF is defined to be the maximum amount of data that <b>can be written</b> to a pipe atomically. Here, we calculate the amount of data that a pipe <b>can hold</b> independent of any atomicity constraints.
</p>
</blockquote></li>

<li><p>
14.8
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     14ex08.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-12-26</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    rewrite 14fig21.c</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> *   block mode</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">aio.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">ctype.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">__progname</span>;

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">BSZ</span>  <span style="color: #a45bad;">4096</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">NBUF</span> <span style="color: #a45bad;">8</span>

<span style="color: #4f97d7; font-weight: bold;">enum</span> <span style="color: #ce537a; font-weight: bold;">rwop</span> <span style="color: #4f97d7;">{</span> <span style="color: #7590db;">UNUSED</span> = <span style="color: #a45bad;">0</span>, <span style="color: #7590db;">READ_PENDING</span> = <span style="color: #a45bad;">1</span>, <span style="color: #7590db;">WRITE_PENDING</span> = <span style="color: #a45bad;">2</span> <span style="color: #4f97d7;">}</span>;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">buf</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">enum</span> <span style="color: #ce537a; font-weight: bold;">rwop</span>     <span style="color: #7590db;">op</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>           <span style="color: #7590db;">last</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">aiocb</span>  <span style="color: #7590db;">aiocb</span>;
    <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">data</span><span style="color: #bc6ec5;">[</span>BSZ<span style="color: #bc6ec5;">]</span>;
<span style="color: #4f97d7;">}</span>;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">buf</span> <span style="color: #7590db;">bufs</span><span style="color: #4f97d7;">[</span>NBUF<span style="color: #4f97d7;">]</span>;

<span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #bc6ec5; font-weight: bold;">translate</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">c</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>isalpha<span style="color: #2d9574;">(</span>c<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>c &gt;= <span style="color: #2d9574;">'n'</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            c -= <span style="color: #a45bad;">13</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>c &gt;= <span style="color: #2d9574;">'a'</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            c += <span style="color: #a45bad;">13</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>c &gt;= <span style="color: #2d9574;">'N'</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            c -= <span style="color: #a45bad;">13</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            c += <span style="color: #a45bad;">13</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> c;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> **<span style="color: #7590db;">argv</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>                 <span style="color: #7590db;">ifd</span>, <span style="color: #7590db;">ofd</span>, <span style="color: #7590db;">i</span>, <span style="color: #7590db;">j</span>, <span style="color: #7590db;">n</span>, <span style="color: #7590db;">err</span>, <span style="color: #7590db;">numop</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">stat</span>         <span style="color: #7590db;">sbuf</span>;
    <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">aiocb</span> *<span style="color: #7590db;">aiolist</span><span style="color: #bc6ec5;">[</span>NBUF<span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">off_t</span>               <span style="color: #7590db;">off</span> = <span style="color: #a45bad;">0</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">if (argc != 3) {</span>
    <span style="color: #2aa1ae; background-color: #292e34;">//     </span><span style="color: #2aa1ae; background-color: #292e34;">err_quit("usage: %s infile outfile", __progname);</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">if ((ifd = open(argv[1], O_RDONLY)) &lt; 0) {</span>
    <span style="color: #2aa1ae; background-color: #292e34;">//     </span><span style="color: #2aa1ae; background-color: #292e34;">err_sys("can't open %s", argv[1]);</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">if ((ofd = open(argv[2], O_RDWR | O_CREAT | O_TRUNC, FILE_MODE)) &lt; 0) {</span>
    <span style="color: #2aa1ae; background-color: #292e34;">//     </span><span style="color: #2aa1ae; background-color: #292e34;">err_sys("can't open %s", argv[2]);</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">}</span>

    ifd = STDIN_FILENO;         <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">for pipe: ifd = pfd[0]?</span>
    ofd = STDOUT_FILENO;        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">for pipe: ofd = pfd[1]?</span>

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; NBUF; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        bufs<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>.op                              = UNUSED;
        bufs<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>.aiocb.aio_buf                   = bufs<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>.data;
        bufs<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>.aiocb.aio_sigevent.sigev_notify = SIGEV_NONE;
        aiolist<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>                              = <span style="color: #a45bad;">NULL</span>;
    <span style="color: #bc6ec5;">}</span>

    numop = <span style="color: #a45bad;">0</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>;;<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #2d9574;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; NBUF; ++i<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">switch</span> <span style="color: #67b11d;">(</span>bufs<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span>.op<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                <span style="color: #4f97d7; font-weight: bold;">case</span> UNUSED: <span style="color: #b1951d;">{</span>
                    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">(</span>off &lt; sbuf.st_size<span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
                        bufs<span style="color: #bc6ec5;">[</span>i<span style="color: #bc6ec5;">]</span>.op               = READ_PENDING;
                        bufs<span style="color: #bc6ec5;">[</span>i<span style="color: #bc6ec5;">]</span>.aiocb.aio_fildes = ifd;
                        bufs<span style="color: #bc6ec5;">[</span>i<span style="color: #bc6ec5;">]</span>.aiocb.aio_offset = off;
                        off += BSZ;
                        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>off &gt;= sbuf.st_size<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
                            bufs<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>.last = <span style="color: #a45bad;">1</span>;
                        <span style="color: #bc6ec5;">}</span>
                        bufs<span style="color: #bc6ec5;">[</span>i<span style="color: #bc6ec5;">]</span>.aiocb.aio_nbytes = BSZ;
                        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>aio_read<span style="color: #2d9574;">(</span>&amp;bufs<span style="color: #9cb6ad;">[</span>i<span style="color: #9cb6ad;">]</span>.aiocb<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
                            err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"aio_read failed"</span><span style="color: #2d9574;">)</span>;
                        <span style="color: #bc6ec5;">}</span>
                        aiolist<span style="color: #bc6ec5;">[</span>i<span style="color: #bc6ec5;">]</span> = &amp;bufs<span style="color: #bc6ec5;">[</span>i<span style="color: #bc6ec5;">]</span>.aiocb;
                        numop++;
                    <span style="color: #4f97d7;">}</span>
                    <span style="color: #4f97d7; font-weight: bold;">break</span>;
                <span style="color: #b1951d;">}</span>

                <span style="color: #4f97d7; font-weight: bold;">case</span> READ_PENDING: <span style="color: #b1951d;">{</span>
                    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span>err = aio_error<span style="color: #2d9574;">(</span>&amp;bufs<span style="color: #9cb6ad;">[</span>i<span style="color: #9cb6ad;">]</span>.aiocb<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> == EINPROGRESS<span style="color: #4f97d7;">)</span>
                        <span style="color: #4f97d7; font-weight: bold;">continue</span>;

                    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
                        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err == -<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
                            err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"aio_error failed"</span><span style="color: #2d9574;">)</span>;
                        <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
                            err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"read failed"</span><span style="color: #2d9574;">)</span>;
                        <span style="color: #bc6ec5;">}</span>
                    <span style="color: #4f97d7;">}</span>

                    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span>n = aio_return<span style="color: #2d9574;">(</span>&amp;bufs<span style="color: #9cb6ad;">[</span>i<span style="color: #9cb6ad;">]</span>.aiocb<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
                        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"aio_return failed"</span><span style="color: #bc6ec5;">)</span>;
                    <span style="color: #4f97d7;">}</span>
                    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">(</span>n != BSZ &amp;&amp; <span style="color: #a45bad;">!</span>bufs<span style="color: #bc6ec5;">[</span>i<span style="color: #bc6ec5;">]</span>.last<span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
                        err_quit<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"short read (%d/%d)"</span>, n, BSZ<span style="color: #bc6ec5;">)</span>;
                    <span style="color: #4f97d7;">}</span>
                    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #4f97d7;">(</span>j = <span style="color: #a45bad;">0</span>; j &lt; n; ++j<span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
                        bufs<span style="color: #bc6ec5;">[</span>i<span style="color: #bc6ec5;">]</span>.data<span style="color: #bc6ec5;">[</span>j<span style="color: #bc6ec5;">]</span> = translate<span style="color: #bc6ec5;">(</span>bufs<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>.data<span style="color: #2d9574;">[</span>j<span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span>;
                    <span style="color: #4f97d7;">}</span>

                    bufs<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span>.op               = WRITE_PENDING;
                    bufs<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span>.aiocb.aio_fildes = ofd;
                    bufs<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span>.aiocb.aio_nbytes = n;
                    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">(</span>aio_write<span style="color: #bc6ec5;">(</span>&amp;bufs<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>.aiocb<span style="color: #bc6ec5;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
                        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"aio_write failed"</span><span style="color: #bc6ec5;">)</span>;
                    <span style="color: #4f97d7;">}</span>

                    <span style="color: #4f97d7; font-weight: bold;">break</span>;
                <span style="color: #b1951d;">}</span>

                <span style="color: #4f97d7; font-weight: bold;">case</span> WRITE_PENDING: <span style="color: #b1951d;">{</span>
                    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span>err = aio_error<span style="color: #2d9574;">(</span>&amp;bufs<span style="color: #9cb6ad;">[</span>i<span style="color: #9cb6ad;">]</span>.aiocb<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> == EINPROGRESS<span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
                        <span style="color: #4f97d7; font-weight: bold;">continue</span>;
                    <span style="color: #4f97d7;">}</span>
                    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
                        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err == -<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
                            err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"aio_error failed"</span><span style="color: #2d9574;">)</span>;
                        <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
                            err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"write failed"</span><span style="color: #2d9574;">)</span>;
                        <span style="color: #bc6ec5;">}</span>
                    <span style="color: #4f97d7;">}</span>

                    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span>n = aio_return<span style="color: #2d9574;">(</span>&amp;bufs<span style="color: #9cb6ad;">[</span>i<span style="color: #9cb6ad;">]</span>.aiocb<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
                        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"aio_return failed"</span><span style="color: #bc6ec5;">)</span>;
                    <span style="color: #4f97d7;">}</span>
                    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">(</span>n != bufs<span style="color: #bc6ec5;">[</span>i<span style="color: #bc6ec5;">]</span>.aiocb.aio_nbytes<span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
                        err_quit<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"short write (%d/%d)"</span>, n,
                                 bufs<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>.aiocb.aio_nbytes<span style="color: #bc6ec5;">)</span>;
                    <span style="color: #4f97d7;">}</span>

                    aiolist<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span> = <span style="color: #a45bad;">NULL</span>;
                    bufs<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span>.op = UNUSED;
                    numop--;
                    <span style="color: #4f97d7; font-weight: bold;">break</span>;
                <span style="color: #b1951d;">}</span>

                <span style="color: #4f97d7; font-weight: bold;">default</span>:
                    <span style="color: #4f97d7; font-weight: bold;">break</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>numop == <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>off &gt;= sbuf.st_size<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                <span style="color: #4f97d7; font-weight: bold;">break</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>aio_suspend<span style="color: #b1951d;">(</span>aiolist, NBUF, <span style="color: #a45bad;">NULL</span><span style="color: #b1951d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"aio_suspend failed"</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    bufs<span style="color: #bc6ec5;">[</span>i<span style="color: #bc6ec5;">]</span>.aiocb.aio_fildes = ofd;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>aio_fsync<span style="color: #2d9574;">(</span>O_SYNC, &amp;bufs<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span>.aiocb<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"aio_fsync failed"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    exit<span style="color: #bc6ec5;">(</span>EXIT_SUCCESS<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
14.9
</p>

<p>
just try to execute the program with a very large file
</p></li>

<li><p>
14.10
</p>

<p>
Not changed
</p></li>

<li><p>
14.11
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     14ex11.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2019-12-29</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    rewrite 14fig27</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> *  close fd after calling mmap</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/mman.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/select.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">COPYINCR</span> <span style="color: #4f97d7;">(</span><span style="color: #a45bad;">1024</span> * <span style="color: #a45bad;">1024</span> * <span style="color: #a45bad;">1024</span><span style="color: #4f97d7;">)</span>  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">1GB</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>         <span style="color: #7590db;">fdin</span>, <span style="color: #7590db;">fdout</span>;
    <span style="color: #ce537a; font-weight: bold;">void</span> *      <span style="color: #7590db;">src</span>, *<span style="color: #7590db;">dst</span>;
    <span style="color: #ce537a; font-weight: bold;">size_t</span>      <span style="color: #7590db;">copysz</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">stat</span> <span style="color: #7590db;">sbuf</span>;
    <span style="color: #ce537a; font-weight: bold;">off_t</span>       <span style="color: #7590db;">fsz</span> = <span style="color: #a45bad;">0</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc != <span style="color: #a45bad;">3</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"usage: %s &lt;from-file&gt; &lt;to-file&gt;"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fdin = open<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span>, O_RDONLY<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"can't open %s for reading"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fdout = open<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #a45bad;">2</span><span style="color: #b1951d;">]</span>, O_RDWR | O_CREAT | O_TRUNC, FILE_MODE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"can't create %s for writting"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #a45bad;">2</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>fstat<span style="color: #2d9574;">(</span>fdin, &amp;sbuf<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fstat error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">If we don&#8217;t set the output file&#8217;s size, the call to mmap for the output</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">file is successful, but the first reference to the associated memory</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">region generates a SIGBUS signal.</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ftruncate<span style="color: #2d9574;">(</span>fdout, sbuf.st_size<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"ftruncate error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span>fsz &lt; sbuf.st_size<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>sbuf.st_size - fsz<span style="color: #67b11d;">)</span> &gt; COPYINCR<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            copysz = COPYINCR;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            copysz = sbuf.st_size - fsz;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>src = mmap<span style="color: #b1951d;">(</span><span style="color: #a45bad;">0</span>, copysz, PROT_READ, MAP_SHARED, fdin, fsz<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> ==
            MAP_FAILED<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"mmap error for input"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">calling close fd to verify</span>
        close<span style="color: #2d9574;">(</span>fdin<span style="color: #2d9574;">)</span>;


        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>dst = mmap<span style="color: #b1951d;">(</span><span style="color: #a45bad;">0</span>, copysz, PROT_READ | PROT_WRITE, MAP_SHARED, fdout,
                        fsz<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> == MAP_FAILED<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"mmap error for output"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        close<span style="color: #2d9574;">(</span>fdout<span style="color: #2d9574;">)</span>;

        memcpy<span style="color: #2d9574;">(</span>dst, src, copysz<span style="color: #2d9574;">)</span>;

        munmap<span style="color: #2d9574;">(</span>src, copysz<span style="color: #2d9574;">)</span>;
        munmap<span style="color: #2d9574;">(</span>dst, copysz<span style="color: #2d9574;">)</span>;
        fsz += copysz;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgea8ee03" class="outline-3">
<h3 id="orgea8ee03"><span class="done DONE">DONE</span> Chapter 15. Interprocess Communication <code>[12/12]</code></h3>
<div class="outline-text-3" id="text-orgea8ee03">
</div>

<div id="outline-container-orgec103dc" class="outline-4">
<h4 id="orgec103dc"><span class="done DONE">DONE</span> 15.1 Introduction</h4>
<div class="outline-text-4" id="text-orgec103dc">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 24:</span> Figure 15.1 Summary of UNIX System IPC</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">IPC type</th>
<th scope="col" class="org-left">SUS</th>
<th scope="col" class="org-left">FreeBSD 8.0</th>
<th scope="col" class="org-left">Linux 3.2.0</th>
<th scope="col" class="org-left">Mac OS X 10.6.8</th>
<th scope="col" class="org-left">Solaris 10</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">half-duplex pipes</td>
<td class="org-left">*</td>
<td class="org-left">(full)</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">(full)</td>
</tr>

<tr>
<td class="org-left">FIFOs</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">full-duplex pipes</td>
<td class="org-left">allowed</td>
<td class="org-left">*, UDS</td>
<td class="org-left">UDS</td>
<td class="org-left">UDS</td>
<td class="org-left">*, UDS</td>
</tr>

<tr>
<td class="org-left">named full-duplex pipes</td>
<td class="org-left">obsolescent</td>
<td class="org-left">UDS</td>
<td class="org-left">UDS</td>
<td class="org-left">UDS</td>
<td class="org-left">*, UDS</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">XSI message queues</td>
<td class="org-left">XSI</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>

<tr>
<td class="org-left">XSI semaphores</td>
<td class="org-left">XSI</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>

<tr>
<td class="org-left">XSI shared memory</td>
<td class="org-left">XSI</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">message queues (real-time)</td>
<td class="org-left">MSG option</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
</tr>

<tr>
<td class="org-left">semaphores</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>

<tr>
<td class="org-left">shared memory  (real-time)</td>
<td class="org-left">SHM option</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">sockets</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>

<tr>
<td class="org-left">STREAMS</td>
<td class="org-left">obsolescent</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org18ea212" class="outline-4">
<h4 id="org18ea212"><span class="done DONE">DONE</span> 15.2 Pipes</h4>
<div class="outline-text-4" id="text-org18ea212">
<p>
Limitations:
</p>
<ol class="org-ol">
<li>for maximum protability, we should never assume that ful-duplex pipes is the case</li>
<li>pipes can be used only between proesses that have a common ancestor.</li>
</ol>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h.</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;"> create pipe</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">  fd[0]  open for reading</span>
<span style="color: #9f8766;"> *         fd[1]  open for writing</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@retval</span><span style="color: #9f8766;"> 0     OK</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@retval</span><span style="color: #9f8766;"> -1    error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pipe</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>


<div id="org11c9dbb" class="figure">
<p><img src="Chapter15/15fig02.jpg" alt="15fig02.jpg" />
</p>
<p><span class="figure-number">Figure 32: </span>Figure 15.2 Two ways to view a half-duplex pipe</p>
</div>


<div id="org11ccbc2" class="figure">
<p><img src="Chapter15/15fig03.jpg" alt="15fig03.jpg" />
</p>
<p><span class="figure-number">Figure 33: </span>Figure 15.3 Half-duplex pipe after a fork</p>
</div>


<div id="org1178751" class="figure">
<p><img src="Chapter15/15fig04.jpg" alt="15fig04.jpg" />
</p>
<p><span class="figure-number">Figure 34: </span>Figure 15.4 Pipe from parent to child</p>
</div>

<p>
the parent closes fd[1], and the child closes fd[0].
</p>

<blockquote>
<p>
When one end of a pipe is closed, two rules apply.
</p>
<ol class="org-ol">
<li>If we read from a pipe whose write end has been closed, read returns 0 to indicate an EOF <b>after</b> all data has been read.</li>
<li>If we write to a pipe whose read end has been closed, the signal SIGPIPE is generated. If we either ignore the signal or catch it and return from the signal handler, write returns -1 with errno set to EPIPE.</li>
</ol>
</blockquote>

<p>
the constant <code>PIPE_BUF</code> specifies the kernel's pipe buffer size.
</p>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 120: </span>Figure 15.5 Send data from parent to child over a pipe</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     15fig05.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-01-04</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Figure 15.5 send data from parent to child over a pipe</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">n</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">fd</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>  <span style="color: #7590db;">line</span><span style="color: #bc6ec5;">[</span>MAXLINE<span style="color: #bc6ec5;">]</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pipe<span style="color: #67b11d;">(</span>fd<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"pipe error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        close<span style="color: #2d9574;">(</span>fd<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
        write<span style="color: #2d9574;">(</span>fd<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span>, <span style="color: #2d9574;">"hello world\n"</span>, <span style="color: #a45bad;">12</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        close<span style="color: #2d9574;">(</span>fd<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
        n = read<span style="color: #2d9574;">(</span>fd<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span>, line, MAXLINE<span style="color: #2d9574;">)</span>;
        write<span style="color: #2d9574;">(</span>STDOUT_FILENO, line, n<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 121: </span>Figure 15.6 Copy file to pager program</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     15fig06.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-01-04</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    copy file to pager program</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">__progname</span>;

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">DEF_PAGER</span> <span style="color: #2d9574;">"/bin/more"</span>  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">default pager program</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">n</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">fd</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">pager</span>, *<span style="color: #7590db;">argv0</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>  <span style="color: #7590db;">line</span><span style="color: #bc6ec5;">[</span>MAXLINE<span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc != <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"usage: %s &lt;pathname&gt;"</span>, __progname<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fp = fopen<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span>, <span style="color: #2d9574;">"r"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"can't open %s"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pipe<span style="color: #2d9574;">(</span>fd<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"pipe error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;

    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">child</span>
        close<span style="color: #2d9574;">(</span>fd<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">close write end</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>fd<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span> != STDIN_FILENO<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>dup2<span style="color: #b1951d;">(</span>fd<span style="color: #4f97d7;">[</span><span style="color: #a45bad;">0</span><span style="color: #4f97d7;">]</span>, STDIN_FILENO<span style="color: #b1951d;">)</span> != STDIN_FILENO<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"dup2 error"</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
            close<span style="color: #67b11d;">(</span>fd<span style="color: #b1951d;">[</span><span style="color: #a45bad;">0</span><span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>pager = getenv<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"PAGER"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            pager = DEF_PAGER;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>argv0 = strchr<span style="color: #b1951d;">(</span>pager, <span style="color: #2d9574;">'/'</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> != <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            argv0++;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            argv0 = pager;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>execl<span style="color: #67b11d;">(</span>pager, argv0, <span style="color: #b1951d;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #b1951d;">)</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"execl error for %s"</span>, pager<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">parent</span>
        close<span style="color: #2d9574;">(</span>fd<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">close read end</span>

        <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #2d9574;">(</span>fgets<span style="color: #67b11d;">(</span>line, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #b1951d;">(</span>line<span style="color: #b1951d;">)</span>, fp<span style="color: #67b11d;">)</span> != <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            n = strlen<span style="color: #67b11d;">(</span>line<span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>write<span style="color: #b1951d;">(</span>fd<span style="color: #4f97d7;">[</span><span style="color: #a45bad;">1</span><span style="color: #4f97d7;">]</span>, line, n<span style="color: #b1951d;">)</span> != n<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"write to pipe error"</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>ferror<span style="color: #67b11d;">(</span>fp<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"fgets error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        close<span style="color: #2d9574;">(</span>fd<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>waitpid<span style="color: #67b11d;">(</span>pid, <span style="color: #a45bad;">NULL</span>, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"waitpid error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 122: </span>Figure 15.7 Routine to let a parent and child synchronized</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     15fig07.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-01-07</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Routines to let a parent and child synchronize</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">pfd1</span><span style="color: #4f97d7;">[</span><span style="color: #a45bad;">2</span><span style="color: #4f97d7;">]</span>, <span style="color: #7590db;">pfd2</span><span style="color: #4f97d7;">[</span><span style="color: #a45bad;">2</span><span style="color: #4f97d7;">]</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">TELL_WAIT</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pipe<span style="color: #2d9574;">(</span>pfd1<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span> || pipe<span style="color: #2d9574;">(</span>pfd2<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"pipe error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">TELL_PARENT</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>write<span style="color: #2d9574;">(</span>pfd2<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span>, <span style="color: #2d9574;">"c"</span>, <span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"write error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">WAIT_PARENT</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">c</span> ;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>read<span style="color: #2d9574;">(</span>pfd1<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span>, &amp;c, <span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"read error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>c != <span style="color: #2d9574;">'p'</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"WAIT_PARENT: incorrect data"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">TELL_CHILD</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>write<span style="color: #2d9574;">(</span>pfd2<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span>, <span style="color: #2d9574;">"p"</span>, <span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"write error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">WAIT_CHILD</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">c</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span><span style="color: #bc6ec5;">(</span>read<span style="color: #2d9574;">(</span>pfd2<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span>, &amp;c, <span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"read error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>c != <span style="color: #2d9574;">'c'</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"WAIT_CHILD: incorrect data"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>


<div id="org27fa059" class="figure">
<p><img src="Chapter15/15fig08.jpg" alt="15fig08.jpg" />
</p>
<p><span class="figure-number">Figure 35: </span>Figure 15.8 Using two pipes for parent-child synchronization</p>
</div>
</div>
</div>

<div id="outline-container-org03a8937" class="outline-4">
<h4 id="org03a8937"><span class="done DONE">DONE</span> 15.3 <code>popen</code> and <code>pclose</code> Functions</h4>
<div class="outline-text-4" id="text-org03a8937">
<blockquote>
<p>
creating a pipe, forking a child, closing the unused ends of the pipe, executing a shell to run the command, and waiting for the command to terminate.
</p>
</blockquote>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">        </span><span style="color: #a45bad;">fork()</span><span style="color: #9f8766;">, then </span><span style="color: #a45bad;">exec()</span><span style="color: #9f8766;"> the cmdstring,</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@details</span><span style="color: #9f8766;">      and returns a stdio pointer.</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">[in]    cmdstring    cmd to execute</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">[in]    type         "r", connect to stdout</span>
<span style="color: #9f8766;"> *                             "w", connect to stdin</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">       file pointer if OK, NULL on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #bc6ec5; font-weight: bold;">popen</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">cmdstring</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">type</span><span style="color: #4f97d7;">)</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      close the stdio stream,</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@details</span><span style="color: #9f8766;">    waits for the cmd to terminate, and</span>
<span style="color: #9f8766;"> *             returns termination status of the shell</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">      fp             returned by popen</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     termination status of cmdstring, or -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pclose</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
<p>
<code>type == "r"</code>:
</p>
<p>
<img src="Chapter15/15fig09.jpg" alt="15fig09.jpg" />
<code>type == "w"</code>:
</p>

<div id="orga5cf630" class="figure">
<p><img src="Chapter15/15fig10.jpg" alt="15fig10.jpg" />
</p>
<p><span class="figure-number">Figure 36: </span>Figure 15.10 Result of fp = popen(cmdstring, "w");</p>
</div>

<p>
The <i>cmdstring</i> is executed by bash, as in
</p>
<div class="org-src-container">
<pre class="src src-bash">sh -c cmdstring
</pre>
</div>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 123: </span>Figure 15.11 Copy file to pager program using <code>popen</code></label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     15fig11.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-01-07</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    copy file to pager program using popen</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">PAGER</span> <span style="color: #2d9574;">"${PAGER:-more}"</span>  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">environment variable, or default</span>

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">__progname</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span>  <span style="color: #7590db;">line</span><span style="color: #bc6ec5;">[</span>MAXLINE<span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fpin</span>, *<span style="color: #7590db;">fpout</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc != <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"usage: %s &lt;pathname&gt;"</span>, __progname<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fpin = fopen<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span>, <span style="color: #2d9574;">"r"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"open %s error"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fpout = popen<span style="color: #67b11d;">(</span>PAGER, <span style="color: #2d9574;">"w"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"popen error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span>fgets<span style="color: #2d9574;">(</span>line, MAXLINE, fpin<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>fputs<span style="color: #67b11d;">(</span>line, fpout<span style="color: #67b11d;">)</span> == EOF<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"fputs error to pipe"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ferror<span style="color: #2d9574;">(</span>fpin<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fgets error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>fclose<span style="color: #2d9574;">(</span>fpin<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fclose error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pclose<span style="color: #2d9574;">(</span>fpout<span style="color: #2d9574;">)</span> == -<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"pclose error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 124: </span>Figure 15.12 The <code>popen</code> and <code>pclose</code> functions</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     15fig12.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-01-07</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    shows our version of popen and pclose</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Pointer to array allocated at run-time</span>
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">pid_t</span> *<span style="color: #7590db;">childpid</span> = <span style="color: #a45bad;">NULL</span>;

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">From our open_max(), Figure 2.17</span>
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">maxfd</span>;

<span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #bc6ec5; font-weight: bold;">popen</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">cmdstring</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">type</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">i</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">pfd</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;
    <span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">only allow "r" or "w"</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>type<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span> != <span style="color: #2d9574;">'r'</span> &amp;&amp; type<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span> != <span style="color: #2d9574;">'w'</span><span style="color: #2d9574;">)</span> || type<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        errno = EINVAL;
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">NULL</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">for more than once we called popen, store pid</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>childpid == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        maxfd = open_max<span style="color: #2d9574;">()</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>childpid = calloc<span style="color: #b1951d;">(</span>maxfd, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #4f97d7;">(</span>pid_t<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">NULL</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pipe<span style="color: #2d9574;">(</span>pfd<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">NULL</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pfd<span style="color: #2d9574;">[</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">]</span> &gt;= maxfd || pfd<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span> &gt;= maxfd<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        close<span style="color: #2d9574;">(</span>pfd<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
        close<span style="color: #2d9574;">(</span>pfd<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
        errno = EMFILE;
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">NULL</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">NULL</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>*type == <span style="color: #2d9574;">'r'</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            close<span style="color: #67b11d;">(</span>pfd<span style="color: #b1951d;">[</span><span style="color: #a45bad;">0</span><span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>pfd<span style="color: #b1951d;">[</span><span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span> != STDOUT_FILENO<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                dup2<span style="color: #b1951d;">(</span>pfd<span style="color: #4f97d7;">[</span><span style="color: #a45bad;">1</span><span style="color: #4f97d7;">]</span>, STDOUT_FILENO<span style="color: #b1951d;">)</span>;
                close<span style="color: #b1951d;">(</span>pfd<span style="color: #4f97d7;">[</span><span style="color: #a45bad;">1</span><span style="color: #4f97d7;">]</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            close<span style="color: #67b11d;">(</span>pfd<span style="color: #b1951d;">[</span><span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>pfd<span style="color: #b1951d;">[</span><span style="color: #a45bad;">0</span><span style="color: #b1951d;">]</span> != STDIN_FILENO<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                dup2<span style="color: #b1951d;">(</span>pfd<span style="color: #4f97d7;">[</span><span style="color: #a45bad;">0</span><span style="color: #4f97d7;">]</span>, STDIN_FILENO<span style="color: #b1951d;">)</span>;
                close<span style="color: #b1951d;">(</span>pfd<span style="color: #4f97d7;">[</span><span style="color: #a45bad;">0</span><span style="color: #4f97d7;">]</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>

        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">close all descriptors in childpid</span>
        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #2d9574;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; maxfd; ++i<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>childpid<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span> &gt; <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                close<span style="color: #b1951d;">(</span>i<span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>

        execl<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"/bin/sh"</span>, <span style="color: #2d9574;">"sh"</span>, <span style="color: #2d9574;">"-c"</span>, cmdstring, <span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #67b11d;">)</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>;
        _exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">127</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">parent continues ...</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>*type == <span style="color: #2d9574;">'r'</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        close<span style="color: #2d9574;">(</span>pfd<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>fp = fdopen<span style="color: #b1951d;">(</span>pfd<span style="color: #4f97d7;">[</span><span style="color: #a45bad;">0</span><span style="color: #4f97d7;">]</span>, type<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">NULL</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            close<span style="color: #67b11d;">(</span>pfd<span style="color: #b1951d;">[</span><span style="color: #a45bad;">0</span><span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>fp = fdopen<span style="color: #4f97d7;">(</span>pfd<span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span>, type<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">NULL</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    childpid<span style="color: #bc6ec5;">[</span>fileno<span style="color: #2d9574;">(</span>fp<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">]</span> = pid;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">remember child pid for this fd;</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fp<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pclose</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">fd</span>, <span style="color: #7590db;">stat</span>;
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>childpid == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        errno = EINVAL;
        <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">popen has never been called</span>
    <span style="color: #bc6ec5;">}</span>

    fd = fileno<span style="color: #bc6ec5;">(</span>fp<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>fd &gt; maxfd<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        errno = EINVAL;
        <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = childpid<span style="color: #67b11d;">[</span>fd<span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        errno = EINVAL;
        <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
    <span style="color: #bc6ec5;">}</span>

    childpid<span style="color: #bc6ec5;">[</span>fd<span style="color: #bc6ec5;">]</span> = <span style="color: #a45bad;">0</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>fclose<span style="color: #2d9574;">(</span>fp<span style="color: #2d9574;">)</span> == EOF<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">fp wasn't opened by popen()</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span>waitpid<span style="color: #2d9574;">(</span>pid, &amp;stat, <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>errno != EINTR<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">error other than EINTR from waitpid();</span>
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>stat<span style="color: #bc6ec5;">)</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">return child's termination status</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>


<div id="org23753d0" class="figure">
<p><img src="Chapter15/15fig13.jpg" alt="15fig13.jpg" />
</p>
<p><span class="figure-number">Figure 37: </span>Figure 15.13 Transforming input using <code>popen</code></p>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 125: </span>Figure 15.14 Filter to convert uppercase characters to lowercase</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     15fig14.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-01-07</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    filter to convert uppercase characters to lowercase</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">ctype.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">c</span>;

    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>c = getchar<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> != EOF<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>isupper<span style="color: #67b11d;">(</span>c<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            c = tolower<span style="color: #67b11d;">(</span>c<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>putchar<span style="color: #67b11d;">(</span>c<span style="color: #67b11d;">)</span> != EOF<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"output error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>c == <span style="color: #2d9574;">'\n'</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            fflush<span style="color: #67b11d;">(</span>stdout<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
    exit<span style="color: #bc6ec5;">(</span>EXIT_SUCCESS<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 126: </span>Figure 15.15 Invoke uppercase/lowercase filter to read commands</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     15fig15.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-01-07</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Invoke uppercase/lowercase filter to read commands</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span>  <span style="color: #7590db;">line</span><span style="color: #bc6ec5;">[</span>MAXLINE<span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fpin</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fpin = popen<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"../bin/15fig14"</span>, <span style="color: #2d9574;">"r"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"popen error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>;;<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        fputs<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"prompt&gt; "</span>, stdout<span style="color: #2d9574;">)</span>;
        fflush<span style="color: #2d9574;">(</span>stdout<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>fgets<span style="color: #67b11d;">(</span>line, MAXLINE, fpin<span style="color: #67b11d;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">break</span>;
        <span style="color: #2d9574;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>fputs<span style="color: #67b11d;">(</span>line, stdout<span style="color: #67b11d;">)</span> == EOF<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"fputs error to pipe"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pclose<span style="color: #2d9574;">(</span>fpin<span style="color: #2d9574;">)</span> == -<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"pclose error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    putchar<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'\n'</span><span style="color: #bc6ec5;">)</span>;
    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-orge6f53c8" class="outline-4">
<h4 id="orge6f53c8"><span class="done DONE">DONE</span> 15.4 Coprocesses</h4>
<div class="outline-text-4" id="text-orge6f53c8">
<blockquote>
<p>
A filter becomes a <i>coprocess</i> when the same program generates the filter's input and reads the filter's output.
</p>
</blockquote>

<ul class="org-ul">
<li><p>
Example
</p>


<div id="orgfd2b633" class="figure">
<p><img src="Chapter15/15fig16.jpg" alt="15fig16.jpg" />
</p>
<p><span class="figure-number">Figure 38: </span>Figure 15.16 Driving a coprocess by writing its standard input and reading its standard output.</p>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 127: </span>Figure 15.17 Simple filter to add two numbers</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     15fig17.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-01-08</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Simple filter to add two numbers</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>  <span style="color: #7590db;">n</span>, <span style="color: #7590db;">int1</span>, <span style="color: #7590db;">int2</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">line</span><span style="color: #bc6ec5;">[</span>MAXLINE<span style="color: #bc6ec5;">]</span>;

    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>n = read<span style="color: #67b11d;">(</span>STDIN_FILENO, line, MAXLINE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        line<span style="color: #2d9574;">[</span>n<span style="color: #2d9574;">]</span> = <span style="color: #a45bad;">0</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>sscanf<span style="color: #67b11d;">(</span>line, <span style="color: #2d9574;">"%d%d"</span>, &amp;int1, &amp;int2<span style="color: #67b11d;">)</span> == <span style="color: #a45bad;">2</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            sprintf<span style="color: #67b11d;">(</span>line, <span style="color: #2d9574;">"%d\n"</span>, int1 + int2<span style="color: #67b11d;">)</span>;
            n = strlen<span style="color: #67b11d;">(</span>line<span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>write<span style="color: #b1951d;">(</span>STDOUT_FILENO, line, n<span style="color: #b1951d;">)</span> != n<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"write error"</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>write<span style="color: #b1951d;">(</span>STDOUT_FILENO, <span style="color: #2d9574;">"invalid args\n"</span>, <span style="color: #a45bad;">13</span><span style="color: #b1951d;">)</span> != <span style="color: #a45bad;">13</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"write error"</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 128: </span>Figure 15.18 Program to drive the 15fig17 filter</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     15fig18.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-01-08</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Program to drive the add2 filter</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_pipe</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">our signal handler</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">n</span>, <span style="color: #7590db;">fd1</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span>, <span style="color: #7590db;">fd2</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>  <span style="color: #7590db;">line</span><span style="color: #bc6ec5;">[</span>MAXLINE<span style="color: #bc6ec5;">]</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGPIPE, sig_pipe<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"signal error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pipe<span style="color: #2d9574;">(</span>fd1<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span> || pipe<span style="color: #2d9574;">(</span>fd2<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"pipe error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">parent process</span>
        close<span style="color: #2d9574;">(</span>fd1<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
        close<span style="color: #2d9574;">(</span>fd2<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;

        <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #2d9574;">(</span>fgets<span style="color: #67b11d;">(</span>line, MAXLINE, stdin<span style="color: #67b11d;">)</span> != <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            n = strlen<span style="color: #67b11d;">(</span>line<span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>write<span style="color: #b1951d;">(</span>fd1<span style="color: #4f97d7;">[</span><span style="color: #a45bad;">1</span><span style="color: #4f97d7;">]</span>, line, n<span style="color: #b1951d;">)</span> != n<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"write error"</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>n = read<span style="color: #4f97d7;">(</span>fd2<span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span>, line, MAXLINE<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"read error"</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>n == <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_msg<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"child closed pipe"</span><span style="color: #b1951d;">)</span>;
                <span style="color: #4f97d7; font-weight: bold;">break</span>;
            <span style="color: #67b11d;">}</span>
            line<span style="color: #67b11d;">[</span>n<span style="color: #67b11d;">]</span> = <span style="color: #a45bad;">0</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>fputs<span style="color: #b1951d;">(</span>line, stdout<span style="color: #b1951d;">)</span> == EOF<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"fputs error"</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>ferror<span style="color: #67b11d;">(</span>stdin<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"fgets error on stdin"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        exit<span style="color: #2d9574;">(</span>EXIT_SUCCESS<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">child process</span>
        close<span style="color: #2d9574;">(</span>fd1<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
        close<span style="color: #2d9574;">(</span>fd2<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>fd1<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span> != STDIN_FILENO<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>dup2<span style="color: #b1951d;">(</span>fd1<span style="color: #4f97d7;">[</span><span style="color: #a45bad;">0</span><span style="color: #4f97d7;">]</span>, STDIN_FILENO<span style="color: #b1951d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"dup2 error to stdin"</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
            close<span style="color: #67b11d;">(</span>fd1<span style="color: #b1951d;">[</span><span style="color: #a45bad;">0</span><span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>fd2<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span> != STDOUT_FILENO<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>dup2<span style="color: #b1951d;">(</span>fd2<span style="color: #4f97d7;">[</span><span style="color: #a45bad;">1</span><span style="color: #4f97d7;">]</span>, STDOUT_FILENO<span style="color: #b1951d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"dup2 error to stdout"</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
            close<span style="color: #67b11d;">(</span>fd2<span style="color: #b1951d;">[</span><span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">if (execl("../bin/15fig17", "15fig17", (char*)0) &lt; 0) {</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>execl<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"../bin/15fig19"</span>, <span style="color: #2d9574;">"15fig19"</span>, <span style="color: #b1951d;">(</span><span style="color: #ce537a; font-weight: bold;">char</span>*<span style="color: #b1951d;">)</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"excel error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        exit<span style="color: #2d9574;">(</span>EXIT_SUCCESS<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_pipe</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"SIGPIPE caught\n"</span><span style="color: #bc6ec5;">)</span>;
    exit<span style="color: #bc6ec5;">(</span>EXIT_FAILURE<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 129: </span>Figure 15.19 Filter to add two numbers, using standard I/O</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     15fig19.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-01-08</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    filter to add two numbers, using standard I/O</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>  <span style="color: #7590db;">int1</span>, <span style="color: #7590db;">int2</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">line</span><span style="color: #bc6ec5;">[</span>MAXLINE<span style="color: #bc6ec5;">]</span>;

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">since the stdin is a pipe, defaults to fully buffered</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">it is blocked reading from stdin</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">15fig18 is blocked reading from pipe</span>
<span style="color: #bc6ec5;">#if</span> <span style="color: #a45bad;">0</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">method 1: no buffer to fix blocking</span>
    setbuf<span style="color: #bc6ec5;">(</span>stdin, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    setbuf<span style="color: #bc6ec5;">(</span>stdout, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">OR method 2: line buffer to fix blocking</span>
    setvbuf<span style="color: #bc6ec5;">(</span>stdin, <span style="color: #a45bad;">NULL</span>, _IOLBF, <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
    setvbuf<span style="color: #bc6ec5;">(</span>stdout, <span style="color: #a45bad;">NULL</span>, _IOLBF, <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>

    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span>fgets<span style="color: #2d9574;">(</span>line, MAXLINE, stdin<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>sscanf<span style="color: #67b11d;">(</span>line, <span style="color: #2d9574;">"%d%d"</span>, &amp;int1, &amp;int2<span style="color: #67b11d;">)</span> == <span style="color: #a45bad;">2</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>printf<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"%d\n"</span>, int1 + int2<span style="color: #b1951d;">)</span> == EOF<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"printf error"</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>printf<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"invalid args\n"</span><span style="color: #b1951d;">)</span> == EOF<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"printf error"</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org44e9a90" class="outline-4">
<h4 id="org44e9a90"><span class="done DONE">DONE</span> 15.5 FIFOs</h4>
<div class="outline-text-4" id="text-org44e9a90">
<p>
named pipe. with FIFOs, unrelated processes can exchange data.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/stat.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">mkfifo</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">path</span>, <span style="color: #ce537a; font-weight: bold;">mode_t</span> <span style="color: #7590db;">mode</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">mkfifoat</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">path</span>, <span style="color: #ce537a; font-weight: bold;">mode_t</span> <span style="color: #7590db;">mode</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, -1 on error</span>
</pre>
</div>
<p>
three case for mkfifoat;
</p>
<ol class="org-ol">
<li>If the <i>path</i> parameter specifies an absolute pathname, then the <i>fd</i> parameter is ignored and the <code>mkfifoat</code> function behaves like the mkfifo function.</li>
<li>If the <i>path</i> parameter specifies a relative pathname and the <i>fd</i> parameter is a valid file descriptor for an open directory, the pathname is evaluated relative to this directory.</li>
<li>If the <i>path</i> parameter specifies a relative pathname and the <i>fd</i> parameter has the special value with AT_FDCWD, the pathname is evaluated starting in the current working directory, and the <code>mkfifoat</code> behaves like <code>mkfifo</code>.</li>
</ol>

<p>
When we <code>open</code> a FIFO, the nonblocking flag (<code>O_NONBLOCK</code>) affects what happens.
</p>
<ul class="org-ul">
<li>In the normal case (without <code>O_NONBLOCK</code>), an <code>open</code> for read-only blocks until some other processes opens the FIFO for writing .</li>
<li>If <code>O_NONBLOCK</code> is specified, an <code>open</code> for read-only returns immediately. But an <code>open</code> for write-only returns -1 with errno set to <code>ENXIO</code> if no process has the FIFO open for reading.</li>

<li><p>
Example - Using FIFOs to Duplicate Output Streams
</p>


<div id="org8a9eee7" class="figure">
<p><img src="Chapter15/15fig20.jpg" alt="15fig20.jpg" />
</p>
<p><span class="figure-number">Figure 39: </span>Figure 15.20 Procedure that preocesses a filtered input stream twice</p>
</div></li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">mkfifo fifo1
prog3 &lt; fifo1 &amp;
prog1 &lt; infile | tee fifo1 | prog2
</pre>
</div>

<div id="org5209121" class="figure">
<p><img src="Chapter15/15fig21.jpg" alt="15fig21.jpg" />
</p>
<p><span class="figure-number">Figure 40: </span>Figure 15.21 Using a FIFO and tee to send a stream to two different processes</p>
</div>

<ul class="org-ul">
<li><p>
Example - Clent-Server Communication Using a FIFO
</p>


<div id="org60ae5f7" class="figure">
<p><img src="Chapter15/15fig22.jpg" alt="15fig22.jpg" />
</p>
<p><span class="figure-number">Figure 41: </span>Figure 15.22 Clients sending requests to a server using a FIFO</p>
</div>


<div id="org91190e3" class="figure">
<p><img src="Chapter15/15fig23.jpg" alt="15fig23.jpg" />
</p>
<p><span class="figure-number">Figure 42: </span>Figure 15.23 Client-server communication using FIFOs</p>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org1281744" class="outline-4">
<h4 id="org1281744"><span class="done DONE">DONE</span> 15.6 XSI IPC <code>[4/4]</code></h4>
<div class="outline-text-4" id="text-org1281744">
</div>

<ul class="org-ul">
<li><a id="org758b7b1"></a><span class="done DONE">DONE</span> 15.6.1 Identifiers and Keys<br />
<div class="outline-text-5" id="text-org758b7b1">
<p>
The identifier is an internal name for an IPC object. an IPC object is associated with a <i>key</i> that acts as an external name for cooperating processes to be able to rendezvous using the same IPC object.
</p>

<p>
<b>Whenever an IPC structure is being created, a key (&lt;sys/types.h&gt;::key_st) must be specified.</b>
</p>

<p>
ways for a client and a server to rendezvous at the same IPC structure.
</p>
<ol class="org-ol">
<li>The server can create a new IPC structure by specifying a key of <code>IPC_PRIVATE</code> and store the returned identifier somewhere (such as a file) for the client to obtain.</li>
<li>The client and the server can agree on a key by defining the key in a common header.</li>
<li>The client and the server can agree on a pathname and project ID (the project ID is a character value between 0 and 255) and call the function <code>ftok</code> to convert these two values into a key.</li>
</ol>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/ipc.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #2aa1ae; background-color: #292e34;">/// </span><span style="color: #2aa1ae; background-color: #292e34;">@brief generating a key from a pathname and project ID</span>
<span style="color: #2aa1ae; background-color: #292e34;">///</span>
<span style="color: #2aa1ae; background-color: #292e34;">/// </span><span style="color: #2aa1ae; background-color: #292e34;">@param path        refer to an existing file</span>
<span style="color: #2aa1ae; background-color: #292e34;">/// </span><span style="color: #2aa1ae; background-color: #292e34;">@param id          only lower 8 bits used</span>
<span style="color: #2aa1ae; background-color: #292e34;">///</span>
<span style="color: #2aa1ae; background-color: #292e34;">/// </span><span style="color: #2aa1ae; background-color: #292e34;">@note              usually formed by taking part of st_dev and st_ino fields in stat structure</span>
<span style="color: #ce537a; font-weight: bold;">key_t</span> <span style="color: #bc6ec5; font-weight: bold;">ftok</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">path</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">id</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: key if OK, (key_t)-1 on error</span>
</pre>
</div>

<blockquote>
<p>
If we want to create a new IPC structure, making sure that we don't reference an existing one with the same identifier, we must specify a <i>flag</i> with both the <code>IPC_CREAT</code> and <code>IPC_EXCL</code> bits set. Doing this causes an error returned of EEXIST if the IPC structure already exists.
</p>
</blockquote>
</div>
</li>

<li><a id="org1063400"></a><span class="done DONE">DONE</span> 15.6.2 Permission Structure<br />
<div class="outline-text-5" id="text-org1063400">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">ipc_perm</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #ce537a; font-weight: bold;">uid_t</span>           <span style="color: #7590db;">uid</span>;            <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">[XSI] Owner's user ID</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        <span style="color: #ce537a; font-weight: bold;">gid_t</span>           <span style="color: #7590db;">gid</span>;            <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">[XSI] Owner's group ID</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        <span style="color: #ce537a; font-weight: bold;">uid_t</span>           <span style="color: #7590db;">cuid</span>;           <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">[XSI] Creator's user ID</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        <span style="color: #ce537a; font-weight: bold;">gid_t</span>           <span style="color: #7590db;">cgid</span>;           <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">[XSI] Creator's group ID</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        <span style="color: #ce537a; font-weight: bold;">mode_t</span>          <span style="color: #7590db;">mode</span>;           <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">[XSI] Read/write permission</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">... more additional members depends on system</span>
<span style="color: #4f97d7;">}</span>;
</pre>
</div>


<div id="org464b738" class="figure">
<p><img src="Chapter15/15fig24.jpg" alt="15fig24.jpg" />
</p>
<p><span class="figure-number">Figure 43: </span>Figure 15.24 XSI IPC permissions</p>
</div>
</div>
</li>

<li><a id="org370086f"></a><span class="done DONE">DONE</span> 15.6.3 Configuration Limits<br />
<div class="outline-text-5" id="text-org370086f">
<p>
modify kernel configuration parameters:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">system</th>
<th scope="col" class="org-left">cmd</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">FreeBSD</td>
<td class="org-left">sysctl</td>
</tr>

<tr>
<td class="org-left">Linux</td>
<td class="org-left">sysctl</td>
</tr>

<tr>
<td class="org-left">Mac OS X</td>
<td class="org-left">sysctl</td>
</tr>

<tr>
<td class="org-left">Solaris 10</td>
<td class="org-left">prctl</td>
</tr>
</tbody>
</table>

<p>
display the IPC-related limits:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">system</th>
<th scope="col" class="org-left">cmd</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Linux</td>
<td class="org-left"><code>ipcs -l</code></td>
</tr>

<tr>
<td class="org-left">Mac OS X</td>
<td class="org-left"><code>ipcs -T</code></td>
</tr>

<tr>
<td class="org-left">FreeBSD</td>
<td class="org-left"><code>icps -T</code></td>
</tr>

<tr>
<td class="org-left">Solaris</td>
<td class="org-left"><code>sysdef -i</code></td>
</tr>
</tbody>
</table>
</div>
</li>

<li><a id="org7d5cc38"></a><span class="done DONE">DONE</span> 15.6.4 Advantages and Disadvantages<br />
<div class="outline-text-5" id="text-org7d5cc38">
<ul class="org-ul">
<li>all forms of XSI IPC remain in existence even when no process is using them.</li>
<li>we can't see the IPC objects with an <code>ls</code> command, can't remove them with the <code>rm</code> command, can't change their permissions with <code>chmod</code> command. use <code>ipcs</code> and <code>ipcrm</code> instead.</li>
<li>since they don't use file descriptors, we can't use multiplexed I/O functions(<code>select</code>, <code>poll</code>, <code>epoll</code>) with them.</li>
</ul>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 25:</span> Figure 15.25 Comparison of features of various forms of IPC</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">IPC type</th>
<th scope="col" class="org-left">Connectionless?</th>
<th scope="col" class="org-left">Reliable?</th>
<th scope="col" class="org-left">Flow control?</th>
<th scope="col" class="org-left">Records?</th>
<th scope="col" class="org-left">Message types or priorties?</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">message queues</td>
<td class="org-left">no</td>
<td class="org-left">yes</td>
<td class="org-left">yes</td>
<td class="org-left">yes</td>
<td class="org-left">yes</td>
</tr>

<tr>
<td class="org-left">STREAMS</td>
<td class="org-left">no</td>
<td class="org-left">yes</td>
<td class="org-left">yes</td>
<td class="org-left">yes</td>
<td class="org-left">yes</td>
</tr>

<tr>
<td class="org-left">UNIX domain stream socket</td>
<td class="org-left">no</td>
<td class="org-left">yes</td>
<td class="org-left">yes</td>
<td class="org-left">no</td>
<td class="org-left">no</td>
</tr>

<tr>
<td class="org-left">UNIX domain datagram socket</td>
<td class="org-left">yes</td>
<td class="org-left">yes</td>
<td class="org-left">no</td>
<td class="org-left">yes</td>
<td class="org-left">no</td>
</tr>

<tr>
<td class="org-left">FIFOs (non-STREAMS)</td>
<td class="org-left">no</td>
<td class="org-left">yes</td>
<td class="org-left">yes</td>
<td class="org-left">no</td>
<td class="org-left">no</td>
</tr>
</tbody>
</table>
</div>
</li>
</ul>
</div>

<div id="outline-container-org6425c9b" class="outline-4">
<h4 id="org6425c9b"><span class="done DONE">DONE</span> 15.7 Message Queues</h4>
<div class="outline-text-4" id="text-org6425c9b">
<p>
A message queue is a linked list of messages stored within the kernel and identified by a message queue identifer.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">msqid_ds</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">ipc_perm</span>  <span style="color: #7590db;">msg_perm</span>;     <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">see Section 15.6.2</span><span style="color: #2aa1ae; background-color: #292e34;">      */</span>
        <span style="color: #ce537a; font-weight: bold;">msgqnum_t</span>        <span style="color: #7590db;">msg_qnum</span>;     <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;"># of messages on queue</span><span style="color: #2aa1ae; background-color: #292e34;">  */</span>
        <span style="color: #ce537a; font-weight: bold;">msglen_t</span>         <span style="color: #7590db;">msg_qbytes</span>;   <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">max # of bytes on queue</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        <span style="color: #ce537a; font-weight: bold;">pid_t</span>            <span style="color: #7590db;">msg_lspid</span>;    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">pid of last msgsnd()</span><span style="color: #2aa1ae; background-color: #292e34;">    */</span>
        <span style="color: #ce537a; font-weight: bold;">pid_t</span>            <span style="color: #7590db;">msg_lrpid</span>;    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">pid of last msgrcv()</span><span style="color: #2aa1ae; background-color: #292e34;">    */</span>
        <span style="color: #ce537a; font-weight: bold;">time_t</span>           <span style="color: #7590db;">msg_stime</span>;    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">last-msgsnd() time</span><span style="color: #2aa1ae; background-color: #292e34;">      */</span>
        <span style="color: #ce537a; font-weight: bold;">time_t</span>           <span style="color: #7590db;">msg_rtime</span>;    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">last-msgrcv() time</span><span style="color: #2aa1ae; background-color: #292e34;">      */</span>
        <span style="color: #ce537a; font-weight: bold;">time_t</span>           <span style="color: #7590db;">msg_ctime</span>;    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">last-change time</span><span style="color: #2aa1ae; background-color: #292e34;">        */</span>
        .
        .
        .
<span style="color: #4f97d7;">}</span>;
</pre>
</div>


<div id="orgfa0e7db" class="figure">
<p><img src="Chapter15/15fig26.jpg" alt="15fig26.jpg" />
</p>
<p><span class="figure-number">Figure 44: </span>Figure 15.26 System limits that affect message queues</p>
</div>

<p>
message queue related functions:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/msg.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;"> either open an existing queue or create a new queue</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * * The ipc_perm structure is initialized .</span>
<span style="color: #9f8766;"> * * msg_qnum,msg_lspid,msg_lrpid,msg_stime, and msg_rtime set to 0</span>
<span style="color: #9f8766;"> * * msg_ctime is set to the current time</span>
<span style="color: #9f8766;"> * * msg_qbytes is set to the system limit</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@retval</span><span style="color: #9f8766;"> msqID  OK</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@retval</span><span style="color: #9f8766;"> -1     error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">msgget</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">key_t</span> <span style="color: #7590db;">key</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">flag</span><span style="color: #4f97d7;">)</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;"> ioctl-like functions for XSI IPC</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * * IPC_STAT fetch the msqid_ds structure for this queue</span>
<span style="color: #9f8766;"> * * IPC_SET copy the following fields from the structure pointed to by buf to</span>
<span style="color: #9f8766;"> * the msqid_ds</span>
<span style="color: #9f8766;"> * * IPC_RMID remove the message queue from the system and any data still on the</span>
<span style="color: #9f8766;"> * queue.</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@retval</span><span style="color: #9f8766;"> 0     OK</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@retval</span><span style="color: #9f8766;"> -1    error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">msgctl</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">msqid</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">cmd</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">msqid_ds</span> *<span style="color: #7590db;">buf</span><span style="color: #4f97d7;">)</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;"> data is placed on a message queue by calling msgsnd.</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * messages are always placed at the end of the queue.</span>
<span style="color: #9f8766;"> * * IPC_NOWAIT can be specified, this is similar to the nonblocking I/O flag</span>
<span style="color: #9f8766;"> * for file I/O.</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@retval</span><span style="color: #9f8766;"> 0 OK</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@retval</span><span style="color: #9f8766;"> -1 error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">msgsnd</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">msqid</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">ptr</span>, <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">nbytes</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">flag</span><span style="color: #4f97d7;">)</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;"> messages are retrieved from a queue by msgrcv.</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * * type == 0 the first message on the queue is returned</span>
<span style="color: #9f8766;"> * * type &gt; 0  the first message on the queue whose message type equals type is</span>
<span style="color: #9f8766;"> * returned.</span>
<span style="color: #9f8766;"> * * type &lt; 0  the fire message on the queue whose message type is the lowest</span>
<span style="color: #9f8766;"> * values less than or equal to the absolute value of type is returned.</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;"> sizeof data portion of message if OK, -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">ssize_t</span> <span style="color: #bc6ec5; font-weight: bold;">msgrcv</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">msqid</span>, <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">ptr</span>, <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">nbytes</span>, <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">type</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">flag</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>

<ul class="org-ul">
<li><p>
Example - Timing Comparison of Message Queues and Full-Duplex Pipes.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 26:</span> Figure 15.27 Timing comparison of IPC alternatives on Solaris</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Operation</th>
<th scope="col" class="org-right">User</th>
<th scope="col" class="org-right">Systems</th>
<th scope="col" class="org-right">Clock</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">message queue</td>
<td class="org-right">0.58</td>
<td class="org-right">4.16</td>
<td class="org-right">5.09</td>
</tr>

<tr>
<td class="org-left">full-duplex pipe</td>
<td class="org-right">0.61</td>
<td class="org-right">4.30</td>
<td class="org-right">5.24</td>
</tr>

<tr>
<td class="org-left">UNIX domain socket</td>
<td class="org-right">0.59</td>
<td class="org-right">5.58</td>
<td class="org-right">7.49</td>
</tr>
</tbody>
</table></li>
</ul>
</div>
</div>

<div id="outline-container-orgac96d8d" class="outline-4">
<h4 id="orgac96d8d"><span class="done DONE">DONE</span> 15.8 Semaphores</h4>
<div class="outline-text-4" id="text-orgac96d8d">
<p>
A semaphore is a counter used to provide access to a shared data object for multiple processes.
obtain a shared resource:
</p>
<ol class="org-ol">
<li>Test the semaphore that controls the resource.</li>
<li>If the value of the semaphore is positive, the process can use the resource.</li>
<li>Otherwise, if the value of the semaphore is 0, the process goes to sleep until the semaphore value is greater than 0.</li>
</ol>

<p>
XSI semaphores :
</p>
<ol class="org-ol">
<li>A semaphore is not simply a single non-negative value.</li>
<li>The creation of a semaphore (<code>semget</code>) is independent of its initialization (<code>semctl</code>).</li>
<li>Since all forms of XSI IPC remain in existence even when no process is using them, we have to worry about a program that terminates without releasing the semaphores it has been allocated.</li>
</ol>

<p>
The kernel maintains a <code>semid_ds</code> structure for each semaphore set:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">semid_ds</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">ipc_perm</span> <span style="color: #7590db;">sem_perm</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">see Section 15.6.2</span>
        <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">short</span>  <span style="color: #7590db;">sem_nsems</span>; <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;"># of semaphores in set</span>
        <span style="color: #ce537a; font-weight: bold;">time_t</span>          <span style="color: #7590db;">sem_otime</span>; <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">last-semop time</span>
        <span style="color: #ce537a; font-weight: bold;">time_t</span>          <span style="color: #7590db;">sem_ctime</span>; <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">last-change time</span>
        .
        .
        .
<span style="color: #4f97d7;">}</span>;
</pre>
</div>

<p>
Each semaphore is represented by an anonymous structure containing at least the following members:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">short</span> <span style="color: #7590db;">semval</span>;          <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">semaphore value, alwyas &gt;= 0</span>
        <span style="color: #ce537a; font-weight: bold;">pid_t</span>          <span style="color: #7590db;">sempid</span>;          <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">pid for last operation</span>
        <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">short</span> <span style="color: #7590db;">semncnt</span>;         <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;"># processes awaiting semval &gt; curval</span>
        <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">short</span> <span style="color: #7590db;">semzcnt</span>;         <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;"># processes awaiting semval == 0</span>
        .
        .
        .
<span style="color: #4f97d7;">}</span>;
</pre>
</div>


<div id="orga387985" class="figure">
<p><img src="Chapter15/15fig28.jpg" alt="15fig28.jpg" />
</p>
<p><span class="figure-number">Figure 45: </span>Figure 15.28 System limits that affect semaphores</p>
</div>

<p>
XSI semaphores using:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/sem.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;"> obtain a semaphore ID</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * * ipc_perm structure is initialized, the mode member depends on perssion bits of flag.</span>
<span style="color: #9f8766;"> * * sem_otime is set to 0.</span>
<span style="color: #9f8766;"> * * sem_ctime is set to the current time.</span>
<span style="color: #9f8766;"> * * sem_nsems is set to the nsems.</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">    nsems      the number of semaphores</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">   semaphore ID if OK, -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">semget</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">key_t</span> <span style="color: #7590db;">key</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">nsems</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">flag</span><span style="color: #4f97d7;">)</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;"> catchall for various semaphore operations</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * A union of various command-specific arguments.</span>
<span style="color: #9f8766;"> * union semun {</span>
<span style="color: #9f8766;"> *    int              val;     // for SETVAL</span>
<span style="color: #9f8766;"> *    struct semid_ds *buf;     // for IPC_STAT and IPC_SET</span>
<span style="color: #9f8766;"> *    unsigned short  *array;   // for GETALL and SETALL</span>
<span style="color: #9f8766;"> * };</span>
<span style="color: #9f8766;"> * The optional argument is the actual union, not a pointer to the union.</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">   semid   set specified semaphore</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">   cmd     specifies one of the following ten commands to be performed</span>
<span style="color: #9f8766;"> *                  IPC_STAT    fetch semid_ds structure for this set</span>
<span style="color: #9f8766;"> *                  IPC_SET     set the sem_perm.uid,sem_perm.gid, and sem_perm.mode</span>
<span style="color: #9f8766;"> *                  IPC_RMID    remove the semaphore from the system.</span>
<span style="color: #9f8766;"> *                  GETVAL      return the value of semval for the member semnum;</span>
<span style="color: #9f8766;"> *                  SETVAL      set the value of semval for the member semnum.</span>
<span style="color: #9f8766;"> *                  GETPID      get the value of sempid</span>
<span style="color: #9f8766;"> *                  GETNCNT     return the value of semncnt for the member semnum.</span>
<span style="color: #9f8766;"> *                  GETZCNT     return the value of semzcnt for the member semnum.</span>
<span style="color: #9f8766;"> *                  GETALL      fetch all the semaphore values in the set.</span>
<span style="color: #9f8766;"> *                  SETALL      set all the semaphore values in the set to the values pointed to by arg array.</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">   for all the GET commands other than GETALL, see above for details,</span>
<span style="color: #9f8766;"> *          otherwise, 0 if OK, -1 on error and set errno</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">semctl</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">semid</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">semnum</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">cmd</span>, ... <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">union semun arg</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span><span style="color: #4f97d7;">)</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;"> atomically performs an array of operations on a semaphore set</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * struct sembuf {</span>
<span style="color: #9f8766;"> *     unsigned short sem_num;  // member # in set (0, 1, ... nsems-1);</span>
<span style="color: #9f8766;"> *     short          sem_op;   // operation(negative, 0, or positive);</span>
<span style="color: #9f8766;"> *     short          sem_flg;  // IPC_NOWAIT, SEM_UNDO</span>
<span style="color: #9f8766;"> * };</span>
<span style="color: #9f8766;"> * see following for details</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;"> 0 if OK, -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">semop</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">semid</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sembuf</span> <span style="color: #7590db;">semoparray</span><span style="color: #bc6ec5;">[]</span>, <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">nops</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>

<p>
sem_op value effects:
</p>
<blockquote>
<ol class="org-ol">
<li>The easiest case is when sem_op is positive. This case corresponds to the returning of resources by the process. The value of sem_op is added to the semaphore’s value. If the undo flag is specified, sem_op is also subtracted from the semaphore’s adjustment value for this process.</li>

<li><p>
If sem_op is negative, we want to obtain resources that the semaphore controls.
</p>

<p>
If the semaphore’s value is greater than or equal to the absolute value of sem_op (the resources are available), the absolute value of sem_op is subtracted from the semaphore’s value. This guarantees the resulting semaphore value is greater than or equal to 0. If the undo flag is specified, the absolute value of sem_op is also added to the semaphore’s adjustment value for this process.
</p>

<p>
If the semaphore’s value is less than the absolute value of sem_op (the resources are not available), the following conditions apply.
</p>

<ul class="org-ul">
<li>If IPC_NOWAIT is specified, semop returns with an error of EAGAIN.</li>

<li>If IPC_NOWAIT is not specified, the semncnt value for this semaphore is incremented (since the caller is about to go to sleep), and the calling process is suspended until one of the following occurs.

<ul class="org-ul">
<li>The semaphore’s value becomes greater than or equal to the absolute value of sem_op (i.e., some other process has released some resources). The value of semncnt for this semaphore is decremented (since the calling process is done waiting), and the absolute value of sem_op is subtracted from the semaphore’s value. If the undo flag is specified, the absolute value of sem_op is also added to the semaphore’s adjustment value for this process.</li>

<li>The semaphore is removed from the system. In this case, the function returns an error of EIDRM.</li>

<li>A signal is caught by the process, and the signal handler returns. In this case, the value of semncnt for this semaphore is decremented (since the calling process is no longer waiting), and the function returns an error of EINTR.</li>
</ul></li>
</ul></li>

<li><p>
If sem_op is 0, this means that the calling process wants to wait until the semaphore’s value becomes 0.
</p>

<p>
If the semaphore’s value is currently 0, the function returns immediately.
</p>

<p>
If the semaphore’s value is nonzero, the following conditions apply.
</p>

<ul class="org-ul">
<li>If IPC_NOWAIT is specified, return is made with an error of EAGAIN.</li>

<li>If IPC_NOWAIT is not specified, the semzcnt value for this semaphore is incremented (since the caller is about to go to sleep), and the calling process is suspended until one of the following occurs.

<ul class="org-ul">
<li>The semaphore’s value becomes 0. The value of semzcnt for this semaphore is decremented (since the calling process is done waiting).</li>

<li>The semaphore is removed from the system. In this case, the function returns an error of EIDRM.</li>

<li>A signal is caught by the process, and the signal handler returns. In this case, the value of semzcnt for this semaphore is decremented (since the calling process is no longer waiting), and the function returns an error of EINTR.</li>
</ul></li>
</ul></li>
</ol>
</blockquote>

<ul class="org-ul">
<li><p>
Semaphore Adjustment on exit
</p>

<p>
using <code>semctl</code> with either <code>SETVAL</code> or <code>SETALL</code> commands, the adjustment value for that semaphore in all processes is set to 0
</p>

<ul class="org-ul">
<li><p>
Example - Timing Comparison of Semaphores, Record Locking, and Mutexes
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 27:</span> Figure 15.29 Timing comparison of locking alternatives on Linux</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Operation</th>
<th scope="col" class="org-right">User</th>
<th scope="col" class="org-right">System</th>
<th scope="col" class="org-right">Clock</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">semaphores with undo</td>
<td class="org-right">0.50</td>
<td class="org-right">6.08</td>
<td class="org-right">7.55</td>
</tr>

<tr>
<td class="org-left">advisory record locking</td>
<td class="org-right">0.51</td>
<td class="org-right">9.06</td>
<td class="org-right">4.38</td>
</tr>

<tr>
<td class="org-left">mutex in shared memory</td>
<td class="org-right">0.21</td>
<td class="org-right">0.40</td>
<td class="org-right">0.25</td>
</tr>
</tbody>
</table>

<p>
with locking single resource and don't need all the features of XSI semaphores, record locking is preferable, cause that is much simpler to use and system take care of any lingering locks when process terminates.
unless performance is the primary concerned, record locking is still more preferable than mutex (1. easier to use, 2. cross-platform support)
</p></li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-orge08048d" class="outline-4">
<h4 id="orge08048d"><span class="done DONE">DONE</span> 15.9 Shared Memory</h4>
<div class="outline-text-4" id="text-orge08048d">
<p>
Shared memory allows two or more processes to share a given region of memory. This is the <b>fastest</b> form of IPC.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">shmid_ds</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">ipc_perm</span> <span style="color: #7590db;">shm_per</span>;     <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">see Section 15.6.2</span>
        <span style="color: #ce537a; font-weight: bold;">size_t</span>          <span style="color: #7590db;">shm_segsz</span>;   <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">sizeof segment in bytes</span>
        <span style="color: #ce537a; font-weight: bold;">pid_t</span>           <span style="color: #7590db;">shm_lpid</span>;    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">pid of last shmop()</span>
        <span style="color: #ce537a; font-weight: bold;">pid_t</span>           <span style="color: #7590db;">shm_cpid</span>;    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">pid of creator</span>
        <span style="color: #ce537a; font-weight: bold;">shmatt_t</span>        <span style="color: #7590db;">shm_nattch</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">number of current attaches, shmatt_t is defined to be an unsigned short</span>
        <span style="color: #ce537a; font-weight: bold;">time_t</span>          <span style="color: #7590db;">shm_atime</span>;   <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">last-attach time</span>
        <span style="color: #ce537a; font-weight: bold;">time_t</span>          <span style="color: #7590db;">shm_dtime</span>;   <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">last-detach time</span>
        <span style="color: #ce537a; font-weight: bold;">time_t</span>          <span style="color: #7590db;">shm_ctime</span>;   <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">last-change time</span>
        ...
<span style="color: #4f97d7;">}</span>;
</pre>
</div>


<div id="orgce77461" class="figure">
<p><img src="Chapter15/15fig30.jpg" alt="15fig30.jpg" />
</p>
<p><span class="figure-number">Figure 46: </span>Figure 15.30 System limits that affect shared memory</p>
</div>

<p>
Shared memory API:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/shm.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      obtain a shared memory identifier</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@details</span><span style="color: #9f8766;">    the following members of shmid_ds structure are initialized.</span>
<span style="color: #9f8766;"> *             * ipc_perm</span>
<span style="color: #9f8766;"> *             * shm_lpid,shm_nattch,shm_atime, and shm_dtime are all set to 0</span>
<span style="color: #9f8766;"> *             * shm_ctime is set to the current time</span>
<span style="color: #9f8766;"> *             * shm_segsz is set to the size requested</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">[in]  key    for converting into an identifier</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">[in]  size   the size of the shared memory segment in bytes</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">[in]  flag   for ipc_perm's permission bits set</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     shared memory ID if OK, -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">shmget</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">key_t</span> <span style="color: #7590db;">key</span>, <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">size</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">flag</span><span style="color: #4f97d7;">)</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      catchall for various shared memory operations</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">[in]  shmid      speicify which shared memory to operate</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">[in]  cmd        IPC_STAT    fetch the shmid_ds structure for this segment, storing to buf</span>
<span style="color: #9f8766;"> *                        IPC_SET     set the following three fields from buf</span>
<span style="color: #9f8766;"> *                                    shm_perm.uid,shm_perm.gid,shm_perm.mode</span>
<span style="color: #9f8766;"> *                                    can be only executed by UID == shm_perm.cuid or shm_perm.uid or root</span>
<span style="color: #9f8766;"> *                        IPC_RMID    remove the shared memory segment set from the system</span>
<span style="color: #9f8766;"> *                                    actually it is attachment count decrease 1</span>
<span style="color: #9f8766;"> *                                    be removed until the last process using the segment terminates or detaches it .</span>
<span style="color: #9f8766;"> *                                    regardless of whether the segment is still in use</span>
<span style="color: #9f8766;"> *                                    can be only executed by UID == shm_perm.cuid or shm_perm.uid or root.</span>
<span style="color: #9f8766;"> *                        additional commands for Linux and Solaris only</span>
<span style="color: #9f8766;"> *                        SHM_LOCK    lock the shared memory</span>
<span style="color: #9f8766;"> *                        SHM_UNLOCK  unlock the shared memory</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">[in,out] buf     read or write, depends on cmd specified</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     0 if OK, -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">shmctl</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">shmid</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">cmd</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">shmid_ds</span> *<span style="color: #7590db;">buf</span><span style="color: #4f97d7;">)</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      a process attach a existing shared memory segment.</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@details</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">[in]  shmid      specify which shared memory segment to attach</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">[in]  addr       is 0, the segment is attached at the first available address selected by the kernel.</span>
<span style="color: #9f8766;"> *                        is nonzero and SHM_RND is not specified, the segment is attached at addr</span>
<span style="color: #9f8766;"> *                        is nonzero and SHM_RND is specified, attached at (addr - (addr modulus SHMLBA)),</span>
<span style="color: #9f8766;"> *                          SHMLBA stands for "low boundary address multiple" and is always a power of 2.</span>
<span style="color: #9f8766;"> *                          round the address down to the next multiple of SHMLBA.</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     0 if OK, -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">shmat</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">shmid</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">addr</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">flag</span><span style="color: #4f97d7;">)</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      detach a shared memory segment.</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@details</span><span style="color: #9f8766;">    this DOES NOT removed the identifier and associated data structure</span>
<span style="color: #9f8766;"> *             the identifier remains in existence until removes by calling shmctl with IPC_RMID.</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">      addr to detach</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     0 if OK, -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">shmdt</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">addr</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 130: </span>Figure 15.31 Print where various types of data are stored</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     15fig31.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-01-10</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    print where various type of data are stored</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> *  prints some information on where one particular system</span>
<span style="color: #9f8766;"> *  places various types of data.</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/shm.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">ARRAY_SIZE</span>  <span style="color: #a45bad;">40000</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">MALLOC_SIZE</span> <span style="color: #a45bad;">100000</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">SHM_SIZE</span>    <span style="color: #a45bad;">100000</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">SHM_MODE</span>    <span style="color: #a45bad;">0600</span>  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">user read/write</span>


<span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">array</span><span style="color: #4f97d7;">[</span>ARRAY_SIZE<span style="color: #4f97d7;">]</span>;         <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">uninitialized data = bss</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">shmid</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">ptr</span>, *<span style="color: #7590db;">shmptr</span>;

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"array[] from %p to %p\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span>*<span style="color: #2d9574;">)</span>&amp;array<span style="color: #2d9574;">[</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">]</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span>*<span style="color: #2d9574;">)</span>&amp;array<span style="color: #2d9574;">[</span>ARRAY_SIZE<span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"stack around %p\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span>*<span style="color: #2d9574;">)</span>&amp;shmid<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>ptr = malloc<span style="color: #67b11d;">(</span>MALLOC_SIZE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"malloc errro"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"malloced from %p to %p\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span>*<span style="color: #2d9574;">)</span>ptr, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span>*<span style="color: #2d9574;">)</span>ptr + MALLOC_SIZE<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>shmid = shmget<span style="color: #67b11d;">(</span>IPC_PRIVATE, SHM_SIZE, SHM_MODE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"shmget error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>shmptr = shmat<span style="color: #67b11d;">(</span>shmid, <span style="color: #a45bad;">0</span> , <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span>*<span style="color: #2d9574;">)</span>-<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"shmat error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"shared memory attached from %p to %p\n"</span>, shmptr, shmptr + SHM_SIZE<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>shmctl<span style="color: #2d9574;">(</span>shmid, IPC_RMID, <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"shmctl error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
<blockquote>
<p>
Results on Linux:
</p>

<p>
array[] from 0x602540 to 0x60c180
</p>

<p>
stack around 0x7ffdaff9121c
</p>

<p>
malloced from 0xd2c010 to 0xd446b0
</p>

<p>
shared memory attached from 0x7f40d9097000 to 0x7f40d90af6a0
</p>
</blockquote>
<blockquote>
<p>
Results on Mac OS X
</p>

<p>
array[] from 0x102d40090 to 0x102d49cd0
</p>

<p>
stack around 0x7ffeecec2438
</p>

<p>
malloced from 0x102d60000 to 0x102d786a0
</p>

<p>
shared memory attached from 0x102d7a000 to 0x102d926a0
</p>
</blockquote>

<div id="orgbdb2e2e" class="figure">
<p><img src="Chapter15/15fig32.jpg" alt="15fig32.jpg" />
</p>
<p><span class="figure-number">Figure 47: </span>Figure 15.32 Memory layout on an Intel-based Linux system.</p>
</div>

<ul class="org-ul">
<li><p>
Example - Memory Mapping of /dev/zero
</p>

<p>
techinque for related processes
</p>
<ul class="org-ul">
<li>An unnamed memory region is created whose size is the second argument to mmap, rounded up to the nearest page size on the system.</li>
<li>The memory region is initialized to 0.</li>
<li>Multiple processes can share this region if a common ancestor specifies the MAP_SHARED flag to mmap.</li>
</ul>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 131: </span>Figure 15.33 IPC between parent and child using memory mapped I/O of /dev/zero</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     15fig33.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-01-10</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    IPC between parent and child using memory mapped I/O of /dev/zero</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/mman.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">NLOOPS</span> <span style="color: #a45bad;">1000</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">SIZE</span>   <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #4f97d7;">)</span>  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">size of shared memory area</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">update</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">long</span> *<span style="color: #7590db;">ptr</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>*ptr<span style="color: #2d9574;">)</span>++<span style="color: #bc6ec5;">)</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">return value before increment</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">fd</span>, <span style="color: #7590db;">i</span>, <span style="color: #7590db;">counter</span>;
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;
    <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">area</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fd = open<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"/dev/zero"</span>, O_RDWR<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"open error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>area = mmap<span style="color: #67b11d;">(</span><span style="color: #a45bad;">0</span>, SIZE, PROT_READ | PROT_WRITE, MAP_SHARED, fd, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> ==
        MAP_FAILED<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"mmap error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    close<span style="color: #bc6ec5;">(</span>fd<span style="color: #bc6ec5;">)</span>;

    TELL_WAIT<span style="color: #bc6ec5;">()</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">parent</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #2d9574;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; NLOOPS; i += <span style="color: #a45bad;">2</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>counter = update<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">long</span> *<span style="color: #bc6ec5;">)</span>area<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span> != i<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_quit<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"parent: expected %d, got %d"</span>, i, counter<span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"parent: %d\n"</span>, counter<span style="color: #67b11d;">)</span>;
            TELL_CHILD<span style="color: #67b11d;">(</span>pid<span style="color: #67b11d;">)</span>;
            WAIT_CHILD<span style="color: #67b11d;">()</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">child</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #2d9574;">(</span>i = <span style="color: #a45bad;">1</span>; i &lt; NLOOPS + <span style="color: #a45bad;">1</span>; i += <span style="color: #a45bad;">2</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            WAIT_PARENT<span style="color: #67b11d;">()</span>;

            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>counter = update<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">long</span> *<span style="color: #bc6ec5;">)</span>area<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span> != i<span style="color: #67b11d;">)</span>
                err_quit<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"child: expected %d, got %d"</span>, i, counter<span style="color: #67b11d;">)</span>;

            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"child: %d\n"</span>, counter<span style="color: #67b11d;">)</span>;
            TELL_PARENT<span style="color: #67b11d;">(</span>getppid<span style="color: #b1951d;">()</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
Example - Anonymous Memory Mapping
</p>

<p>
To use this facility, specify <code>MAP_ANONYMOUS</code> (<code>MAP_ANON</code> deprecated on Linux) flag to <code>mmap</code> and specify the fd to -1.
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 132: </span>modify <a href="Chapter15/15fig33.c#MissingReference">Figure 15.33</a> to use this facility</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     15fig33a.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-01-10</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    IPC between parent and child using memory mapped I/O of /dev/zero</span>
<span style="color: #9f8766;"> *            use anoynymous facility</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/mman.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">NLOOPS</span> <span style="color: #a45bad;">1000</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">SIZE</span>   <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #4f97d7;">)</span>  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">size of shared memory area</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">update</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">long</span> *<span style="color: #7590db;">ptr</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>*ptr<span style="color: #2d9574;">)</span>++<span style="color: #bc6ec5;">)</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">return value before increment</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">fd</span>, <span style="color: #7590db;">i</span>, <span style="color: #7590db;">counter</span>;
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;
    <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">area</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">if ((fd = open("/dev/zero", O_RDWR)) &lt; 0) {</span>
    <span style="color: #2aa1ae; background-color: #292e34;">//     </span><span style="color: #2aa1ae; background-color: #292e34;">err_sys("open error");</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">}</span>
    fd = -<span style="color: #a45bad;">1</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">if ((area = mmap(0, SIZE, PROT_READ | PROT_WRITE, MAP_SHARED, fd, 0)) ==</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">MAP_FAILED) {</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>area = mmap<span style="color: #67b11d;">(</span><span style="color: #a45bad;">0</span>, SIZE, PROT_READ | PROT_WRITE, MAP_ANON | MAP_SHARED, fd,
                     <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == MAP_FAILED<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"mmap error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">close(fd);</span>

    TELL_WAIT<span style="color: #bc6ec5;">()</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">parent</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #2d9574;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; NLOOPS; i += <span style="color: #a45bad;">2</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>counter = update<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">long</span> *<span style="color: #bc6ec5;">)</span>area<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span> != i<span style="color: #67b11d;">)</span>
                err_quit<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"parent: expected %d, got %d"</span>, i, counter<span style="color: #67b11d;">)</span>;

            TELL_CHILD<span style="color: #67b11d;">(</span>pid<span style="color: #67b11d;">)</span>;
            WAIT_CHILD<span style="color: #67b11d;">()</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">child</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #2d9574;">(</span>i = <span style="color: #a45bad;">1</span>; i &lt; NLOOPS + <span style="color: #a45bad;">1</span>; i += <span style="color: #a45bad;">2</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            WAIT_PARENT<span style="color: #67b11d;">()</span>;

            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>counter = update<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">long</span> *<span style="color: #bc6ec5;">)</span>area<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span> != i<span style="color: #67b11d;">)</span>
                err_quit<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"child: expected %d, got %d"</span>, i, counter<span style="color: #67b11d;">)</span>;

            TELL_PARENT<span style="color: #67b11d;">(</span>getppid<span style="color: #b1951d;">()</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org379ea6c" class="outline-4">
<h4 id="org379ea6c"><span class="done DONE">DONE</span> 15.10 POSIX Semaphores</h4>
<div class="outline-text-4" id="text-org379ea6c">
<p>
The POSIX semaphore mechanism is one of three IPC mechanisms that originated with the real-time extensions to POSIX.1.
</p>

<p>
The POSIX semaphore interfaces were meant to address several deficiencies with the XSI semaphore interfaces:
</p>
<ul class="org-ul">
<li>The POSIX semaphore interfaces allow for higher-performance implementations compared to XSI semaphores.</li>
<li>The POSIX semaphore interfaces are simpler to use: no semaphore sets, and several of the interfaces are patterned after familiar file system operations.</li>
<li>The POSIX semaphores behave more gracefully when removed.</li>
</ul>

<p>
APIs:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">semaphore.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      create a new named semaphore or use an existing one</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     Pointer to semaphore if OK, SEM_FAILED on error</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@note</span><span style="color: #9f8766;">       To promote portability</span>
<span style="color: #9f8766;"> * * The first character in the name should be a slash</span>
<span style="color: #9f8766;"> * * The name should contain no other slashes to avoid implementation-defined</span>
<span style="color: #9f8766;"> * behavior.</span>
<span style="color: #9f8766;"> * * The maximum length of the semaphore name is implementation defined.</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">sem_t</span> *<span style="color: #bc6ec5; font-weight: bold;">sem_open</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">oflag</span>,
                ... <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">mode_t mode, unsigned int value</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span><span style="color: #4f97d7;">)</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      release any resources associated with the semaphore</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     0 if OK, -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sem_close</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">sem_t</span> *<span style="color: #7590db;">sem</span><span style="color: #4f97d7;">)</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      remove the name of the semaphore.</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     0 if OK, -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sem_unlink</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span><span style="color: #4f97d7;">)</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      decrement the value of a semaphore</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     0 if OK, -1 on error</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@note</span><span style="color: #9f8766;">       avoids blocking if the semaphore count is 0</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sem_trywait</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">sem_t</span> *<span style="color: #7590db;">sem</span><span style="color: #4f97d7;">)</span>;
<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      decrement the value of a semaphore</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     0 if OK, -1 on error</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@note</span><span style="color: #9f8766;">       blocks if the semaphore count is 0.</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sem_wait</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">sem_t</span> *<span style="color: #7590db;">sem</span><span style="color: #4f97d7;">)</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      block for a bounded amount of time</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     0 if OK, -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">time.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sem_timedwait</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">sem_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">sem</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">tsptr</span><span style="color: #4f97d7;">)</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      increment the value of a semaphore</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     0 if OK, -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sem_post</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">sem_t</span> *<span style="color: #7590db;">sem</span><span style="color: #4f97d7;">)</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      create an unnamed semaphore</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     0 if OK, -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sem_init</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">sem_t</span> *<span style="color: #7590db;">sem</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">pshared</span>, <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">value</span><span style="color: #4f97d7;">)</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      discard an unnamed semaphore</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     0 if OK, -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sem_destroy</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">sem_t</span> *<span style="color: #7590db;">sem</span><span style="color: #4f97d7;">)</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      retrieve the value of a semaphore</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     0 if OK, -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sem_getvalue</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">sem_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">sem</span>, <span style="color: #ce537a; font-weight: bold;">int</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">valp</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>

<ul class="org-ul">
<li><p>
Example
</p>


<div id="orgd5cd49f" class="figure">
<p><img src="Chapter15/15fig34.jpg" alt="15fig34.jpg" />
</p>
<p><span class="figure-number">Figure 48: </span>Figure 15.34 Timing comparison of semaphore implementation</p>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 133: </span>Figure 15.35 Mutual exclusion using a POSIX semaphore</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     15fig35.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-01-11</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Mutual exclusion using a POSIX semaphore</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"slock.h"</span>

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">slock</span> *<span style="color: #bc6ec5; font-weight: bold;">s_alloc</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">slock</span> *<span style="color: #7590db;">sp</span>;
    <span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span>    <span style="color: #7590db;">cnt</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>sp = malloc<span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #b1951d;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">slock</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">NULL</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">do</span> <span style="color: #bc6ec5;">{</span>
        snprintf<span style="color: #2d9574;">(</span>sp-&gt;name, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span>sp-&gt;name<span style="color: #67b11d;">)</span>, <span style="color: #2d9574;">"/%ld.%d"</span>, <span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #67b11d;">)</span>getpid<span style="color: #67b11d;">()</span>, cnt++<span style="color: #2d9574;">)</span>;
        sp-&gt;semp = sem_open<span style="color: #2d9574;">(</span>sp-&gt;name, O_CREAT | O_EXCL, S_IRWXU, <span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>sp-&gt;semp == SEM_FAILED<span style="color: #2d9574;">)</span> &amp;&amp; <span style="color: #2d9574;">(</span>errno == EEXIST<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sp-&gt;semp == SEM_FAILED<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        free<span style="color: #2d9574;">(</span>sp<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">NULL</span>;
    <span style="color: #bc6ec5;">}</span>

    sem_unlink<span style="color: #bc6ec5;">(</span>sp-&gt;name<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> sp;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">s_free</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">slock</span> *<span style="color: #7590db;">sp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    sem_close<span style="color: #bc6ec5;">(</span>sp-&gt;semp<span style="color: #bc6ec5;">)</span>;
    free<span style="color: #bc6ec5;">(</span>sp<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">s_lock</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">slock</span> *<span style="color: #7590db;">sp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> <span style="color: #4f97d7; font-weight: bold;">return</span> sem_wait<span style="color: #bc6ec5;">(</span>sp-&gt;semp<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">s_trylock</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">slock</span> *<span style="color: #7590db;">sp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> <span style="color: #4f97d7; font-weight: bold;">return</span> sem_trywait<span style="color: #bc6ec5;">(</span>sp-&gt;semp<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">s_unlock</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">slock</span> *<span style="color: #7590db;">sp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> <span style="color: #4f97d7; font-weight: bold;">return</span> sem_post<span style="color: #bc6ec5;">(</span>sp-&gt;semp<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org1a47e50" class="outline-4">
<h4 id="org1a47e50"><span class="done DONE">DONE</span> 15.11 Client-Server Properties</h4>
<div class="outline-text-4" id="text-org1a47e50">
<p>
<b>A child cannot pass a descriptor back to the parent (unless special programming techniques are used, which we cover in Chapter 17).</b>
</p>

<p>
Message queue(Either of these two techniques using message queue can be implemented using shared memory and a synchronization method) :
</p>
<ol class="org-ol">
<li>A single queue can be used between the srever and all the clients, using the type field of each mesage to indicate the message recipient.</li>
<li>Alternatively, an individual message queue can be used for each client.</li>
</ol>
</div>
</div>

<div id="outline-container-orgae01e72" class="outline-4">
<h4 id="orgae01e72"><span class="done DONE">DONE</span> 15.12 Summary</h4>
<div class="outline-text-4" id="text-orgae01e72">
<ul class="org-ul">
<li>Exercises

<ul class="org-ul">
<li><p>
15.1 pager program blocks
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     15ex01.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-01-04</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    copy file to pager program</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">__progname</span>;

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">DEF_PAGER</span> <span style="color: #2d9574;">"/bin/more"</span>  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">default pager program</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">n</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">fd</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">pager</span>, *<span style="color: #7590db;">argv0</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>  <span style="color: #7590db;">line</span><span style="color: #bc6ec5;">[</span>MAXLINE<span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc != <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"usage: %s &lt;pathname&gt;"</span>, __progname<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fp = fopen<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span>, <span style="color: #2d9574;">"r"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"can't open %s"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pipe<span style="color: #2d9574;">(</span>fd<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"pipe error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;

    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">child</span>
        close<span style="color: #2d9574;">(</span>fd<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">close write end</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>fd<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span> != STDIN_FILENO<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>dup2<span style="color: #b1951d;">(</span>fd<span style="color: #4f97d7;">[</span><span style="color: #a45bad;">0</span><span style="color: #4f97d7;">]</span>, STDIN_FILENO<span style="color: #b1951d;">)</span> != STDIN_FILENO<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"dup2 error"</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
            close<span style="color: #67b11d;">(</span>fd<span style="color: #b1951d;">[</span><span style="color: #a45bad;">0</span><span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>pager = getenv<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"PAGER"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            pager = DEF_PAGER;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>argv0 = strchr<span style="color: #b1951d;">(</span>pager, <span style="color: #2d9574;">'/'</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> != <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            argv0++;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            argv0 = pager;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>execl<span style="color: #67b11d;">(</span>pager, argv0, <span style="color: #b1951d;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #b1951d;">)</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"execl error for %s"</span>, pager<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">parent</span>
        close<span style="color: #2d9574;">(</span>fd<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">close read end</span>

        <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #2d9574;">(</span>fgets<span style="color: #67b11d;">(</span>line, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #b1951d;">(</span>line<span style="color: #b1951d;">)</span>, fp<span style="color: #67b11d;">)</span> != <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            n = strlen<span style="color: #67b11d;">(</span>line<span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>write<span style="color: #b1951d;">(</span>fd<span style="color: #4f97d7;">[</span><span style="color: #a45bad;">1</span><span style="color: #4f97d7;">]</span>, line, n<span style="color: #b1951d;">)</span> != n<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"write to pipe error"</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>ferror<span style="color: #67b11d;">(</span>fp<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"fgets error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">close(fd[1]);</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>waitpid<span style="color: #67b11d;">(</span>pid, <span style="color: #a45bad;">NULL</span>, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"waitpid error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
15.2
</p>

<blockquote>
<p>
The parent terminates right after writing the last line to the pipe. The read end of the pipe is automatically closed when the parent terminates. But the parent is probably running ahead of the child by one pipe buffer, since the child (the pager program) is waiting for us to look at a page of output. If we’re running a shell, such as the Korn shell, with interactive command-line editing enabled, the shell probably changes the terminal mode when our parent terminates and the shell prints a prompt. This undoubtedly interferes with the pager program, which has also modified the terminal mode. (Most pager programs set the terminal to noncanonical mode when awaiting input to proceed to the next page.)
</p>
</blockquote>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     15ex02.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-01-04</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    copy file to pager program</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">__progname</span>;

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">DEF_PAGER</span> <span style="color: #2d9574;">"/bin/more"</span>  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">default pager program</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">n</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">fd</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">pager</span>, *<span style="color: #7590db;">argv0</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>  <span style="color: #7590db;">line</span><span style="color: #bc6ec5;">[</span>MAXLINE<span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc != <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"usage: %s &lt;pathname&gt;"</span>, __progname<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fp = fopen<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span>, <span style="color: #2d9574;">"r"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"can't open %s"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pipe<span style="color: #2d9574;">(</span>fd<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"pipe error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;

    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">child</span>
        close<span style="color: #2d9574;">(</span>fd<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">close write end</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>fd<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span> != STDIN_FILENO<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>dup2<span style="color: #b1951d;">(</span>fd<span style="color: #4f97d7;">[</span><span style="color: #a45bad;">0</span><span style="color: #4f97d7;">]</span>, STDIN_FILENO<span style="color: #b1951d;">)</span> != STDIN_FILENO<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"dup2 error"</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
            close<span style="color: #67b11d;">(</span>fd<span style="color: #b1951d;">[</span><span style="color: #a45bad;">0</span><span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>pager = getenv<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"PAGER"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            pager = DEF_PAGER;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>argv0 = strchr<span style="color: #b1951d;">(</span>pager, <span style="color: #2d9574;">'/'</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> != <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            argv0++;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            argv0 = pager;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>execl<span style="color: #67b11d;">(</span>pager, argv0, <span style="color: #b1951d;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #b1951d;">)</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"execl error for %s"</span>, pager<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">parent</span>
        close<span style="color: #2d9574;">(</span>fd<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">close read end</span>

        <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #2d9574;">(</span>fgets<span style="color: #67b11d;">(</span>line, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #b1951d;">(</span>line<span style="color: #b1951d;">)</span>, fp<span style="color: #67b11d;">)</span> != <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            n = strlen<span style="color: #67b11d;">(</span>line<span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>write<span style="color: #b1951d;">(</span>fd<span style="color: #4f97d7;">[</span><span style="color: #a45bad;">1</span><span style="color: #4f97d7;">]</span>, line, n<span style="color: #b1951d;">)</span> != n<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"write to pipe error"</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>ferror<span style="color: #67b11d;">(</span>fp<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"fgets error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        close<span style="color: #2d9574;">(</span>fd<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">if (waitpid(pid, NULL, 0) &lt; 0) {</span>
        <span style="color: #2aa1ae; background-color: #292e34;">//     </span><span style="color: #2aa1ae; background-color: #292e34;">err_sys("waitpid error");</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">}</span>
        exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
15.3 cannot execute the non-existent command
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     15ex03.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-01-15</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    test popen for non-existent command</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>


<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">pret</span> = <span style="color: #a45bad;">NULL</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pret = popen<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"./a.out"</span>, <span style="color: #2d9574;">"r"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        perror<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"popen"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
sh: ./a.out: No such file or directory
</p>
<blockquote>
<p>
pclose returns the termination status of the command as it is returned by waitpid.
</p>
</blockquote></li>

<li><p>
15.4
</p>

<blockquote>
<p>
When the parent terminates, look at its termination status with the shell. For the Bourne shell, Bourne-again shell, and Korn shell, the command is echo $?. The number printed is 128 plus the signal number.
</p>
</blockquote>
<p>
➜   echo $?
141
</p></li>

<li><p>
15.5
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     15ex05.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-01-08</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Program to drive the add2 filter</span>
<span style="color: #9f8766;"> *          use standard I/O library instead</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_pipe</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">our signal handler</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">n</span>, <span style="color: #7590db;">fd1</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span>, <span style="color: #7590db;">fd2</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fpr</span>, *<span style="color: #7590db;">fpw</span>;
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>  <span style="color: #7590db;">line</span><span style="color: #bc6ec5;">[</span>MAXLINE<span style="color: #bc6ec5;">]</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGPIPE, sig_pipe<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"signal error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pipe<span style="color: #2d9574;">(</span>fd1<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span> || pipe<span style="color: #2d9574;">(</span>fd2<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"pipe error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fpr = fdopen<span style="color: #67b11d;">(</span>fd2<span style="color: #b1951d;">[</span><span style="color: #a45bad;">0</span><span style="color: #b1951d;">]</span>, <span style="color: #2d9574;">"r"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fdopen error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>setvbuf<span style="color: #2d9574;">(</span>fpr, <span style="color: #a45bad;">NULL</span>, _IOLBF, <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"setvbuf error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fpw = fdopen<span style="color: #67b11d;">(</span>fd1<span style="color: #b1951d;">[</span><span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span>, <span style="color: #2d9574;">"w"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fdopen error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>setvbuf<span style="color: #2d9574;">(</span>fpw, <span style="color: #a45bad;">NULL</span>, _IOLBF, <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"setvbuf error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">parent process</span>
        close<span style="color: #2d9574;">(</span>fd1<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
        close<span style="color: #2d9574;">(</span>fd2<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;

        <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #2d9574;">(</span>fgets<span style="color: #67b11d;">(</span>line, MAXLINE, stdin<span style="color: #67b11d;">)</span> != <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            n = strlen<span style="color: #67b11d;">(</span>line<span style="color: #67b11d;">)</span>;
<span style="color: #bc6ec5;">#if</span> <span style="color: #a45bad;">0</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>write<span style="color: #b1951d;">(</span>fd1<span style="color: #4f97d7;">[</span><span style="color: #a45bad;">1</span><span style="color: #4f97d7;">]</span>, line, n<span style="color: #b1951d;">)</span> != n<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"write error"</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>n = read<span style="color: #4f97d7;">(</span>fd2<span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span>, line, MAXLINE<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"read error"</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>n == <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_msg<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"child closed pipe"</span><span style="color: #b1951d;">)</span>;
                <span style="color: #4f97d7; font-weight: bold;">break</span>;
            <span style="color: #67b11d;">}</span>
<span style="color: #bc6ec5;">#endif</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>fputs<span style="color: #b1951d;">(</span>line, fpw<span style="color: #b1951d;">)</span> == EOF<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"fputs error"</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>fgets<span style="color: #b1951d;">(</span>line, MAXLINE, fpr<span style="color: #b1951d;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_msg<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"fgets error"</span><span style="color: #b1951d;">)</span>;
                <span style="color: #4f97d7; font-weight: bold;">break</span>;
            <span style="color: #67b11d;">}</span>
            line<span style="color: #67b11d;">[</span>n<span style="color: #67b11d;">]</span> = <span style="color: #a45bad;">0</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>fputs<span style="color: #b1951d;">(</span>line, stdout<span style="color: #b1951d;">)</span> == EOF<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"fputs error"</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>ferror<span style="color: #67b11d;">(</span>stdin<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"fgets error on stdin"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        exit<span style="color: #2d9574;">(</span>EXIT_SUCCESS<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">child process</span>
        close<span style="color: #2d9574;">(</span>fd1<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
        close<span style="color: #2d9574;">(</span>fd2<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>fd1<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span> != STDIN_FILENO<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>dup2<span style="color: #b1951d;">(</span>fd1<span style="color: #4f97d7;">[</span><span style="color: #a45bad;">0</span><span style="color: #4f97d7;">]</span>, STDIN_FILENO<span style="color: #b1951d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"dup2 error to stdin"</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
            close<span style="color: #67b11d;">(</span>fd1<span style="color: #b1951d;">[</span><span style="color: #a45bad;">0</span><span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>fd2<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span> != STDOUT_FILENO<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>dup2<span style="color: #b1951d;">(</span>fd2<span style="color: #4f97d7;">[</span><span style="color: #a45bad;">1</span><span style="color: #4f97d7;">]</span>, STDOUT_FILENO<span style="color: #b1951d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"dup2 error to stdout"</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
            close<span style="color: #67b11d;">(</span>fd2<span style="color: #b1951d;">[</span><span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">if (execl("../bin/15fig17", "15fig17", (char*)0) &lt; 0) {</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>execl<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"../bin/15fig19"</span>, <span style="color: #2d9574;">"15fig19"</span>, <span style="color: #b1951d;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #b1951d;">)</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"excel error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        exit<span style="color: #2d9574;">(</span>EXIT_SUCCESS<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_pipe</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"SIGPIPE caught\n"</span><span style="color: #bc6ec5;">)</span>;
    exit<span style="color: #bc6ec5;">(</span>EXIT_FAILURE<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
15.6
</p>

<p>
The wait function catch the child that popen function generated because we can't distinguish which is the child we want.
</p>
<blockquote>
<p>
The system function calls wait, and the first child to terminate is the child generated by popen. Since that’s not the child that system created, it calls wait again and blocks until the sleep is done. Then system returns. When pclose calls wait, an error is returned, since there are no more children to wait for. Then pclose returns an error.
</p>
</blockquote></li>

<li><p>
15.7
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     15ex07.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-01-15</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    select/poll a pipe</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/poll.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/select.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">test_select_closew</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>            <span style="color: #7590db;">fd</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">fd_set</span>         <span style="color: #7590db;">rfds</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timeval</span> <span style="color: #7590db;">tv</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>            <span style="color: #7590db;">ret</span>;
    <span style="color: #ce537a; font-weight: bold;">pid_t</span>          <span style="color: #7590db;">pid</span>;

    puts<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"test select: close write end"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pipe<span style="color: #2d9574;">(</span>fd<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"pipe error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    FD_ZERO<span style="color: #bc6ec5;">(</span>&amp;rfds<span style="color: #bc6ec5;">)</span>;
    FD_SET<span style="color: #bc6ec5;">(</span>fd<span style="color: #2d9574;">[</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">]</span>, &amp;rfds<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        sleep<span style="color: #2d9574;">(</span><span style="color: #a45bad;">5</span><span style="color: #2d9574;">)</span>;
        close<span style="color: #2d9574;">(</span>fd<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"child: write end closed"</span><span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span>EXIT_SUCCESS<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #2d9574;">(</span>;;<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            tv.tv_sec  = <span style="color: #a45bad;">1</span>;
            tv.tv_usec = <span style="color: #a45bad;">0</span>;

            write<span style="color: #67b11d;">(</span>fd<span style="color: #b1951d;">[</span><span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span>, <span style="color: #2d9574;">"hello, world\n"</span>, <span style="color: #a45bad;">13</span><span style="color: #67b11d;">)</span>;
            ret = select<span style="color: #67b11d;">(</span>fd<span style="color: #b1951d;">[</span><span style="color: #a45bad;">0</span><span style="color: #b1951d;">]</span> + <span style="color: #a45bad;">1</span>, &amp;rfds, <span style="color: #a45bad;">NULL</span>, <span style="color: #a45bad;">NULL</span>, &amp;tv<span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>ret == -<span style="color: #a45bad;">1</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"select error"</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>ret &gt; <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                printf<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"data ready\n"</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #67b11d;">{</span>
                printf<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"time expired\n"</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>
        waitpid<span style="color: #2d9574;">(</span>pid, <span style="color: #a45bad;">NULL</span>, <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span>EXIT_SUCCESS<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">test_select_closer</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>            <span style="color: #7590db;">fd</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">fd_set</span>         <span style="color: #7590db;">rfds</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timeval</span> <span style="color: #7590db;">tv</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>            <span style="color: #7590db;">ret</span>;
    <span style="color: #ce537a; font-weight: bold;">pid_t</span>          <span style="color: #7590db;">pid</span>;

    puts<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"test select: close read end"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pipe<span style="color: #2d9574;">(</span>fd<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"pipe error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    FD_ZERO<span style="color: #bc6ec5;">(</span>&amp;rfds<span style="color: #bc6ec5;">)</span>;
    FD_SET<span style="color: #bc6ec5;">(</span>fd<span style="color: #2d9574;">[</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">]</span>, &amp;rfds<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        write<span style="color: #2d9574;">(</span>fd<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span>, <span style="color: #2d9574;">"hello, world\n"</span>, <span style="color: #a45bad;">13</span><span style="color: #2d9574;">)</span>;
        sleep<span style="color: #2d9574;">(</span><span style="color: #a45bad;">5</span><span style="color: #2d9574;">)</span>;
        close<span style="color: #2d9574;">(</span>fd<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"child: read end closed"</span><span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span>EXIT_SUCCESS<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #2d9574;">(</span>;;<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            tv.tv_sec  = <span style="color: #a45bad;">1</span>;
            tv.tv_usec = <span style="color: #a45bad;">0</span>;

            ret = select<span style="color: #67b11d;">(</span>fd<span style="color: #b1951d;">[</span><span style="color: #a45bad;">0</span><span style="color: #b1951d;">]</span> + <span style="color: #a45bad;">1</span>, &amp;rfds, <span style="color: #a45bad;">NULL</span>, <span style="color: #a45bad;">NULL</span>, &amp;tv<span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>ret == -<span style="color: #a45bad;">1</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"select error"</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>ret &gt; <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                printf<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"\rdata ready\n"</span><span style="color: #b1951d;">)</span>;
                <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #b1951d;">(</span>FD_ISSET<span style="color: #4f97d7;">(</span>fd<span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span>, &amp;rfds<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span> <span style="color: #b1951d;">{</span>
                    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">buff</span><span style="color: #4f97d7;">[</span>MAXLINE<span style="color: #4f97d7;">]</span> = <span style="color: #4f97d7;">{</span><span style="color: #a45bad;">0</span><span style="color: #4f97d7;">}</span>;
                    read<span style="color: #4f97d7;">(</span>fd<span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span>, buff, MAXLINE<span style="color: #4f97d7;">)</span>;
                    printf<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"data read: %s"</span>, buff<span style="color: #4f97d7;">)</span>;
                    write<span style="color: #4f97d7;">(</span>fd<span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span>, buff, strlen<span style="color: #bc6ec5;">(</span>buff<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>;
                <span style="color: #b1951d;">}</span>
            <span style="color: #67b11d;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #67b11d;">{</span>
                printf<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"time expired\n"</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>
        waitpid<span style="color: #2d9574;">(</span>pid, <span style="color: #a45bad;">NULL</span>, <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span>EXIT_SUCCESS<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">test_poll</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span> test_select_closer<span style="color: #bc6ec5;">()</span>; <span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
The answer gives the following table about various behaviors on different systems, but when I test, it seems different
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 28:</span> Figure C.19 Pipe behavior with select and poll</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Operation</th>
<th scope="col" class="org-left">FreeBSD 8.0</th>
<th scope="col" class="org-left">Linux 3.2.0</th>
<th scope="col" class="org-left">Mac OS X 10.6.8</th>
<th scope="col" class="org-left">Solaris</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">select on read end of pipe with write end closed</td>
<td class="org-left">R/W/E</td>
<td class="org-left">R</td>
<td class="org-left">R/W</td>
<td class="org-left">R/W/E</td>
</tr>

<tr>
<td class="org-left">poll on read end of pipe with write end closed</td>
<td class="org-left">R/HUP</td>
<td class="org-left">HUP</td>
<td class="org-left">INV</td>
<td class="org-left">HUP</td>
</tr>

<tr>
<td class="org-left">select on write end of pipe with read end closed</td>
<td class="org-left">R/W/E</td>
<td class="org-left">R/W</td>
<td class="org-left">R/W</td>
<td class="org-left">R/W</td>
</tr>

<tr>
<td class="org-left">poll on write end of pipe with read end closed</td>
<td class="org-left">R/HUP</td>
<td class="org-left">W/ERR</td>
<td class="org-left">INV</td>
<td class="org-left">HUP</td>
</tr>
</tbody>
</table>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 29:</span> tested answer</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Operation</th>
<th scope="col" class="org-left">Linux 3.2.0</th>
<th scope="col" class="org-left">Mac OS X 10.6.8</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">select on read end of pipe with write end closed</td>
<td class="org-left">R/W</td>
<td class="org-left">R/W</td>
</tr>

<tr>
<td class="org-left">select on write end of pipe with read end closed</td>
<td class="org-left">HUP</td>
<td class="org-left">HUP</td>
</tr>
</tbody>
</table></li>

<li><p>
15.8
</p>

<p>
parent's standard error appears.
</p></li>

<li><p>
15.9
</p>

<p>
<code>fork</code>, then <code>exec</code>, <code>waitpid</code>, <code>exit</code>
</p>
<blockquote>
<p>
The popen function forks a child, and the child executes the shell. The shell in turn calls fork, and the child of the shell executes the command string. When cmdstring terminates, the shell is waiting for this to happen. The shell then exits, which is what the waitpid in pclose is waiting for.
</p>
</blockquote></li>

<li><p>
15.10 open twice, and using O_NONBLOCK for reading mode
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     15ex10.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-01-17</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    read and write a FIFO</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">TMPFIFO</span> <span style="color: #2d9574;">"/tmp/tmp.fifo"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fr</span>, <span style="color: #7590db;">fw</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>mkfifo<span style="color: #2d9574;">(</span>TMPFIFO, FILE_MODE<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"mkfifo error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fr = open<span style="color: #67b11d;">(</span>TMPFIFO, O_RDONLY | O_NONBLOCK<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">non-block for avoiding deadlock</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"open error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fw = open<span style="color: #67b11d;">(</span>TMPFIFO, O_WRONLY<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"open error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    clr_fl<span style="color: #bc6ec5;">(</span>fr, O_NONBLOCK<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
15.11
</p>

<blockquote>
<p>
The identifier of the message queue. The queue would have to allow the appropriate level of access (probably world-read, for a random malicious process). It would interfere with the running of the server/clients though, because each would probably be expecting messages to exist on the queue that aren't there.
</p>
</blockquote></li>

<li><p>
15.12
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     15ex12.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-01-17</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    practice a message queue</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/ipc.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/msg.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/types.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">MSG_KEY</span> <span style="color: #a45bad;">5</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">MSG_LEN</span> <span style="color: #a45bad;">32</span>

<span style="color: #4f97d7; font-weight: bold;">typedef</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">mtype</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">mtext</span><span style="color: #bc6ec5;">[</span>MSG_LEN<span style="color: #bc6ec5;">]</span>;
<span style="color: #4f97d7;">}</span> <span style="color: #ce537a; font-weight: bold;">msgbuf</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>    <span style="color: #7590db;">msqid</span>;
    <span style="color: #ce537a; font-weight: bold;">msgbuf</span> <span style="color: #7590db;">msg</span> = <span style="color: #bc6ec5;">{</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">}</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">i</span> = <span style="color: #a45bad;">0</span>; i &lt; <span style="color: #a45bad;">5</span>; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>msqid = msgget<span style="color: #b1951d;">(</span>MSG_KEY, IPC_CREAT<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> == -<span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_msg<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"msgget error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"id: %d\n"</span>, msqid<span style="color: #67b11d;">)</span>;
            msgctl<span style="color: #67b11d;">(</span>msqid, IPC_RMID, <span style="color: #a45bad;">NULL</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    getchar<span style="color: #bc6ec5;">()</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">i</span> = <span style="color: #a45bad;">0</span>; i &lt; <span style="color: #a45bad;">5</span>; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>msqid = msgget<span style="color: #b1951d;">(</span>IPC_PRIVATE, IPC_CREAT | <span style="color: #a45bad;">0600</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> == -<span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_msg<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"msgget error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        msg.mtype = <span style="color: #a45bad;">1</span>;
        snprintf<span style="color: #2d9574;">(</span>msg.mtext, MSG_LEN, <span style="color: #2d9574;">"hello world"</span><span style="color: #2d9574;">)</span>;

        <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">msgsz</span> = strlen<span style="color: #2d9574;">(</span>msg.mtext<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>msgsnd<span style="color: #b1951d;">(</span>msqid, &amp;msg, msgsz, <span style="color: #a45bad;">0</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> == -<span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            perror<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"msgsnd error: "</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        memset<span style="color: #2d9574;">(</span>msg.mtext, <span style="color: #a45bad;">0</span>, MSG_LEN<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>msgrcv<span style="color: #67b11d;">(</span>msqid, &amp;msg, MSG_LEN, <span style="color: #a45bad;">0</span>, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> == -<span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            perror<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"msgrcv error: "</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"mtext: %s\n"</span>, msg.mtext<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
15.13 The actual addresses are different for different processes, so we need to store offsets instead.
</p>

<blockquote>
<p>
We never store actual addresses in a shared memory segment, since it’s possible for the server and all the clients to attach the segment at different addresses. Instead, when a linked list is built in a shared memory segment, the list pointers should be stored as offsets to other objects in the shared memory segment. These offsets are formed by subtracting the start of the shared memory segment from the actual address of the object.
</p>
</blockquote></li>

<li><p>
15.14
</p>


<div id="orgd08518e" class="figure">
<p><img src="Chapter15/15ex14.jpg" alt="15ex14.jpg" />
</p>
</div></li>

<li><p>
15.15
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     15ex15.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-02-03</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Redo the 15fig33 using XSI shared memory functions</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/ipc.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/shm.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">NLOOPS</span> <span style="color: #a45bad;">10</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">SIZE</span>   <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #4f97d7;">)</span>  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">size of shared memory area</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">update</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">long</span> *<span style="color: #7590db;">ptr</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>*ptr<span style="color: #2d9574;">)</span>++<span style="color: #bc6ec5;">)</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">return value before increment</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">i</span>, <span style="color: #7590db;">counter</span>, <span style="color: #7590db;">shmid</span>;
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;
    <span style="color: #ce537a; font-weight: bold;">long</span> *<span style="color: #7590db;">area</span>;
    <span style="color: #ce537a; font-weight: bold;">key_t</span> <span style="color: #7590db;">key</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>key = ftok<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"/dev/zero"</span>, <span style="color: #a45bad;">1</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"ftok error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    TELL_WAIT<span style="color: #bc6ec5;">()</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>shmid = shmget<span style="color: #b1951d;">(</span>key, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #4f97d7;">)</span>, IPC_EXCL | IPC_CREAT | <span style="color: #a45bad;">0600</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &lt;
            <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"shmget error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        area = shmat<span style="color: #2d9574;">(</span>shmid, <span style="color: #a45bad;">NULL</span>, IPC_NOWAIT<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>area == <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"shmat error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #2d9574;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; NLOOPS; i += <span style="color: #a45bad;">2</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>counter = update<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">long</span> *<span style="color: #bc6ec5;">)</span>area<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span> != i<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_quit<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"parent: expected %d, got %d"</span>, i, counter<span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"parent: %d\n"</span>, counter<span style="color: #67b11d;">)</span>;
            TELL_CHILD<span style="color: #67b11d;">(</span>pid<span style="color: #67b11d;">)</span>;
            WAIT_CHILD<span style="color: #67b11d;">()</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>shmid = shmget<span style="color: #b1951d;">(</span>key, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #4f97d7;">)</span>, IPC_CREAT | <span style="color: #a45bad;">0600</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"shmget error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        area = shmat<span style="color: #2d9574;">(</span>shmid, <span style="color: #a45bad;">NULL</span>, IPC_NOWAIT<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>area == <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"shmat error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">child</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #2d9574;">(</span>i = <span style="color: #a45bad;">1</span>; i &lt; NLOOPS + <span style="color: #a45bad;">1</span>; i += <span style="color: #a45bad;">2</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            WAIT_PARENT<span style="color: #67b11d;">()</span>;

            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>counter = update<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">long</span> *<span style="color: #bc6ec5;">)</span>area<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span> != i<span style="color: #67b11d;">)</span>
                err_quit<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"child: expected %d, got %d"</span>, i, counter<span style="color: #67b11d;">)</span>;

            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"child: %d\n"</span>, counter<span style="color: #67b11d;">)</span>;
            TELL_PARENT<span style="color: #67b11d;">(</span>getppid<span style="color: #b1951d;">()</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    shmctl<span style="color: #bc6ec5;">(</span>shmid, IPC_RMID, <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;

    TELL_WAIT<span style="color: #bc6ec5;">()</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
15.16 it's not shared memory
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     15ex16.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-02-03</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Redo the 15fig33 using XSI semaphore functions</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/ipc.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/sem.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/types.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">NLOOPS</span> <span style="color: #a45bad;">10</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">SIZE</span>   <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #4f97d7;">)</span>  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">size of shared memory area</span>

<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>__linux__<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">union</span> <span style="color: #ce537a; font-weight: bold;">semun</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>              <span style="color: #7590db;">val</span>;   <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">Value for SETVAL</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">semid_ds</span> *<span style="color: #7590db;">buf</span>;   <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">Buffer for IPC_STAT, IPC_SET</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">short</span> * <span style="color: #7590db;">array</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">Array for GETALL, SETALL</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">seminfo</span> * <span style="color: #7590db;">__buf</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">Buffer for IPC_INFO</span>
<span style="color: #2aa1ae; background-color: #292e34;">                               (Linux-specific)</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #4f97d7;">}</span>;
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">update</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> *<span style="color: #7590db;">ptr</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">ret</span> = <span style="color: #bc6ec5;">(</span>*ptr<span style="color: #bc6ec5;">)</span>++;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%d: area: %d, counter = %d\n"</span>, getpid<span style="color: #2d9574;">()</span>, *ptr, ret<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> ret;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">return value before increment</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sem_doit</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">semid</span>, <span style="color: #ce537a; font-weight: bold;">short</span> <span style="color: #7590db;">op</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sembuf</span> <span style="color: #7590db;">sbuf</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>           <span style="color: #7590db;">ret</span>;

    sbuf<span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span>.sem_num = <span style="color: #a45bad;">0</span>;
    sbuf<span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span>.sem_op  = op;
    sbuf<span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span>.sem_flg = SEM_UNDO;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>semop<span style="color: #2d9574;">(</span>semid, sbuf, <span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        perror<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"semop: "</span><span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span>EXIT_FAILURE<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">_P</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">semid</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> sem_doit<span style="color: #bc6ec5;">(</span>semid, -<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">_V</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">semid</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> sem_doit<span style="color: #bc6ec5;">(</span>semid, <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sem_set</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> *<span style="color: #7590db;">semid</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">key_t</span>       <span style="color: #7590db;">key</span>;
    <span style="color: #4f97d7; font-weight: bold;">union</span> <span style="color: #ce537a; font-weight: bold;">semun</span> <span style="color: #7590db;">un</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>key = ftok<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"/dev/zero"</span>, <span style="color: #a45bad;">1</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"ftok error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>*semid = semget<span style="color: #67b11d;">(</span>key, <span style="color: #a45bad;">1</span>, IPC_EXCL | IPC_CREAT | <span style="color: #a45bad;">0600</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"semget error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    un.val = <span style="color: #a45bad;">1</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>semctl<span style="color: #2d9574;">(</span>*semid, <span style="color: #a45bad;">0</span>, SETVAL, un<span style="color: #2d9574;">)</span> == -<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"semctl error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> *semid;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sem_rm</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">semid</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> <span style="color: #4f97d7; font-weight: bold;">return</span> semctl<span style="color: #bc6ec5;">(</span>semid, IPC_RMID, <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">semid</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">exit_func</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> sem_rm<span style="color: #bc6ec5;">(</span>semid<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">i</span>, <span style="color: #7590db;">counter</span>;
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">area</span>;

    sem_set<span style="color: #bc6ec5;">(</span>&amp;semid<span style="color: #bc6ec5;">)</span>;
    atexit<span style="color: #bc6ec5;">(</span>exit_func<span style="color: #bc6ec5;">)</span>;

    TELL_WAIT<span style="color: #bc6ec5;">()</span>;

<span style="color: #bc6ec5;">#if</span> <span style="color: #a45bad;">1</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #2d9574;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; NLOOPS; i += <span style="color: #a45bad;">2</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            _P<span style="color: #67b11d;">(</span>semid<span style="color: #67b11d;">)</span>;

            area += <span style="color: #a45bad;">2</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>area - <span style="color: #a45bad;">2</span> != i<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"parent excepted %d got %d"</span>, i, area - <span style="color: #a45bad;">2</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"parent: &lt;%p&gt; %d\n"</span>, &amp;area, area - <span style="color: #a45bad;">2</span><span style="color: #67b11d;">)</span>;

            _V<span style="color: #67b11d;">(</span>semid<span style="color: #67b11d;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">+1</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
            TELL_CHILD<span style="color: #67b11d;">(</span>pid<span style="color: #67b11d;">)</span>;
            WAIT_CHILD<span style="color: #67b11d;">()</span>;
        <span style="color: #2d9574;">}</span>

    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">child</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        area = <span style="color: #a45bad;">1</span>;
        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #2d9574;">(</span>i = <span style="color: #a45bad;">1</span>; i &lt; NLOOPS + <span style="color: #a45bad;">1</span>; i += <span style="color: #a45bad;">2</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            WAIT_PARENT<span style="color: #67b11d;">()</span>;
            _P<span style="color: #67b11d;">(</span>semid<span style="color: #67b11d;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">-1</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>

            area += <span style="color: #a45bad;">2</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>area - <span style="color: #a45bad;">2</span> != i<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"parent excepted %d got %d"</span>, i, area - <span style="color: #a45bad;">2</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"child: &lt;%p&gt; %d\n"</span>, &amp;area, area - <span style="color: #a45bad;">2</span><span style="color: #67b11d;">)</span>;

            _V<span style="color: #67b11d;">(</span>semid<span style="color: #67b11d;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">+1</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
            TELL_PARENT<span style="color: #67b11d;">(</span>getppid<span style="color: #b1951d;">()</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
15.17 it's not shared memory
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     15ex17.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-02-03</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Redo the 15fig33 using advisory record lock</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">NLOOPS</span> <span style="color: #a45bad;">10</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">SIZE</span>   <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #4f97d7;">)</span>  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">size of shared memory area</span>

<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>__linux__<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">union</span> <span style="color: #ce537a; font-weight: bold;">semun</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>              <span style="color: #7590db;">val</span>;   <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">Value for SETVAL</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">semid_ds</span> *<span style="color: #7590db;">buf</span>;   <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">Buffer for IPC_STAT, IPC_SET</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">short</span> * <span style="color: #7590db;">array</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">Array for GETALL, SETALL</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">seminfo</span> * <span style="color: #7590db;">__buf</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">Buffer for IPC_INFO</span>
<span style="color: #2aa1ae; background-color: #292e34;">                               (Linux-specific)</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #4f97d7;">}</span>;
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">update</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> *<span style="color: #7590db;">ptr</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">ret</span> = <span style="color: #bc6ec5;">(</span>*ptr<span style="color: #bc6ec5;">)</span>++;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%d: area: %d, counter = %d\n"</span>, getpid<span style="color: #2d9574;">()</span>, *ptr, ret<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> ret;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">return value before increment</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">i</span>, <span style="color: #7590db;">counter</span>;
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">area</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">fd</span>;

    fd = open<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"/dev/zero"</span>, O_RDONLY<span style="color: #bc6ec5;">)</span>;

    TELL_WAIT<span style="color: #bc6ec5;">()</span>;

<span style="color: #bc6ec5;">#if</span> <span style="color: #a45bad;">1</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #2d9574;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; NLOOPS; i += <span style="color: #a45bad;">2</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            flock<span style="color: #67b11d;">(</span>fd, LOCK_SH<span style="color: #67b11d;">)</span>;

            area += <span style="color: #a45bad;">2</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>area - <span style="color: #a45bad;">2</span> != i<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"parent excepted %d got %d"</span>, i, area - <span style="color: #a45bad;">2</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"parent: &lt;%p&gt; %d\n"</span>, &amp;area, area - <span style="color: #a45bad;">2</span><span style="color: #67b11d;">)</span>;

            flock<span style="color: #67b11d;">(</span>fd, LOCK_UN<span style="color: #67b11d;">)</span>;

            TELL_CHILD<span style="color: #67b11d;">(</span>pid<span style="color: #67b11d;">)</span>;
            WAIT_CHILD<span style="color: #67b11d;">()</span>;
        <span style="color: #2d9574;">}</span>

    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">child</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        area = <span style="color: #a45bad;">1</span>;
        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #2d9574;">(</span>i = <span style="color: #a45bad;">1</span>; i &lt; NLOOPS + <span style="color: #a45bad;">1</span>; i += <span style="color: #a45bad;">2</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            WAIT_PARENT<span style="color: #67b11d;">()</span>;

            flock<span style="color: #67b11d;">(</span>fd, LOCK_SH<span style="color: #67b11d;">)</span>;

            area += <span style="color: #a45bad;">2</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>area - <span style="color: #a45bad;">2</span> != i<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"parent excepted %d got %d"</span>, i, area - <span style="color: #a45bad;">2</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"child: &lt;%p&gt; %d\n"</span>, &amp;area, area - <span style="color: #a45bad;">2</span><span style="color: #67b11d;">)</span>;

            flock<span style="color: #67b11d;">(</span>fd, LOCK_UN<span style="color: #67b11d;">)</span>;

            TELL_PARENT<span style="color: #67b11d;">(</span>getppid<span style="color: #b1951d;">()</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
15.18 it's not shared memory
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     15ex18.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-02-03</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Redo the 15fig33 using POSIX semaphore functions</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">semaphore.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"slock.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">NLOOPS</span> <span style="color: #a45bad;">10</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">SIZE</span>   <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #4f97d7;">)</span>  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">size of shared memory area</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">update</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> *<span style="color: #7590db;">ptr</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">ret</span> = <span style="color: #bc6ec5;">(</span>*ptr<span style="color: #bc6ec5;">)</span>++;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%d: area: %d, counter = %d\n"</span>, getpid<span style="color: #2d9574;">()</span>, *ptr, ret<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> ret;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">return value before increment</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">slock</span> *<span style="color: #7590db;">sp</span> = <span style="color: #a45bad;">NULL</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">exit_func</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> s_free<span style="color: #bc6ec5;">(</span>sp<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">i</span>, <span style="color: #7590db;">counter</span>;
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">area</span>;

    atexit<span style="color: #bc6ec5;">(</span>exit_func<span style="color: #bc6ec5;">)</span>;

    sp = s_alloc<span style="color: #bc6ec5;">()</span>;

    TELL_WAIT<span style="color: #bc6ec5;">()</span>;

<span style="color: #bc6ec5;">#if</span> <span style="color: #a45bad;">1</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #2d9574;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; NLOOPS; i += <span style="color: #a45bad;">2</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            s_lock<span style="color: #67b11d;">(</span>sp<span style="color: #67b11d;">)</span>;

            area += <span style="color: #a45bad;">2</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>area - <span style="color: #a45bad;">2</span> != i<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"parent excepted %d got %d"</span>, i, area - <span style="color: #a45bad;">2</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"parent: &lt;%p&gt; %d\n"</span>, &amp;area, area - <span style="color: #a45bad;">2</span><span style="color: #67b11d;">)</span>;

            s_unlock<span style="color: #67b11d;">(</span>sp<span style="color: #67b11d;">)</span>;
            TELL_CHILD<span style="color: #67b11d;">(</span>pid<span style="color: #67b11d;">)</span>;
            WAIT_CHILD<span style="color: #67b11d;">()</span>;
        <span style="color: #2d9574;">}</span>

    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">child</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        area = <span style="color: #a45bad;">1</span>;
        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #2d9574;">(</span>i = <span style="color: #a45bad;">1</span>; i &lt; NLOOPS + <span style="color: #a45bad;">1</span>; i += <span style="color: #a45bad;">2</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            WAIT_PARENT<span style="color: #67b11d;">()</span>;
            s_lock<span style="color: #67b11d;">(</span>sp<span style="color: #67b11d;">)</span>;

            area += <span style="color: #a45bad;">2</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>area - <span style="color: #a45bad;">2</span> != i<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"parent excepted %d got %d"</span>, i, area - <span style="color: #a45bad;">2</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"child: &lt;%p&gt; %d\n"</span>, &amp;area, area - <span style="color: #a45bad;">2</span><span style="color: #67b11d;">)</span>;

            s_unlock<span style="color: #67b11d;">(</span>sp<span style="color: #67b11d;">)</span>;
            TELL_PARENT<span style="color: #67b11d;">(</span>getppid<span style="color: #b1951d;">()</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">slock</span> *<span style="color: #bc6ec5; font-weight: bold;">s_alloc</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">slock</span> *<span style="color: #7590db;">sp</span>;
    <span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span>    <span style="color: #7590db;">cnt</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>sp = malloc<span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #b1951d;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">slock</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">do</span> <span style="color: #bc6ec5;">{</span>
        snprintf<span style="color: #2d9574;">(</span>sp-&gt;name, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span>sp-&gt;name<span style="color: #67b11d;">)</span>, <span style="color: #2d9574;">"/%ld.%d"</span>, <span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #67b11d;">)</span>getpid<span style="color: #67b11d;">()</span>, cnt++<span style="color: #2d9574;">)</span>;
        sp-&gt;semp = sem_open<span style="color: #2d9574;">(</span>sp-&gt;name, O_CREAT | O_EXCL, <span style="color: #a45bad;">0666</span>, <span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>sp-&gt;semp == SEM_FAILED<span style="color: #2d9574;">)</span> &amp;&amp; <span style="color: #2d9574;">(</span>errno == EEXIST<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sp-&gt;semp == SEM_FAILED<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        free<span style="color: #2d9574;">(</span>sp<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span><span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    sem_unlink<span style="color: #bc6ec5;">(</span>sp-&gt;name<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>sp<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">s_free</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">slock</span> *<span style="color: #7590db;">sp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    sem_close<span style="color: #bc6ec5;">(</span>sp-&gt;semp<span style="color: #bc6ec5;">)</span>;
    free<span style="color: #bc6ec5;">(</span>sp<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">s_lock</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">slock</span> *<span style="color: #7590db;">sp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> <span style="color: #4f97d7; font-weight: bold;">return</span> sem_wait<span style="color: #bc6ec5;">(</span>sp-&gt;semp<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">s_trylock</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">slock</span> *<span style="color: #7590db;">sp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> <span style="color: #4f97d7; font-weight: bold;">return</span> sem_trywait<span style="color: #bc6ec5;">(</span>sp-&gt;semp<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">s_unlock</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">slock</span> *<span style="color: #7590db;">sp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> <span style="color: #4f97d7; font-weight: bold;">return</span> sem_post<span style="color: #bc6ec5;">(</span>sp-&gt;semp<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org8c16c77" class="outline-3">
<h3 id="org8c16c77"><span class="done DONE">DONE</span> Chapter 16. Network IPC: Sockets <code>[9/9]</code></h3>
<div class="outline-text-3" id="text-org8c16c77">
</div>

<div id="outline-container-orge366d64" class="outline-4">
<h4 id="orge366d64"><span class="done DONE">DONE</span> 16.1 Introduction</h4>
<div class="outline-text-4" id="text-orge366d64">
<p>
<b>only an overview of the socket API</b>
</p>
</div>
</div>

<div id="outline-container-orgb297d64" class="outline-4">
<h4 id="orgb297d64"><span class="done DONE">DONE</span> 16.2 Socket Descriptors</h4>
<div class="outline-text-4" id="text-orgb297d64">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/socket..h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;"> create socket</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> domain   determines the nature of the communication, includes the</span>
<span style="color: #9f8766;"> *                  address format</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> type     determines the type of the socket, which further determine</span>
<span style="color: #9f8766;"> *                  the communication characteristics</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> protocol usually 0, to select the default protocol for the given</span>
<span style="color: #9f8766;"> *                  domain and socket type. but can select a particular protocol</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;"> file (socket) descriptor if OK, -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">socket</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">domain</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">type</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">protocol</span><span style="color: #4f97d7;">)</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;"> diasable I/O on a socket</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> sockfd     socket's return value</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;"> how        SHUT_RD,   reading is disabled</span>
<span style="color: #9f8766;"> *                    SHUT_WR,   writing is disabled</span>
<span style="color: #9f8766;"> *                    SHUT_RDWR, disable both data transmission and reception</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;"> 0 if OK, -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">shutdown</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">sockfd</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">how</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 30:</span> Figure 16.1 Socket communication domains</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Domain</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">AF_INET</td>
<td class="org-left">IPv4 Internet domain</td>
</tr>

<tr>
<td class="org-left">AF_INET6</td>
<td class="org-left">IPv6 Internet domain (optional in POSIX.1)</td>
</tr>

<tr>
<td class="org-left">AF_UNIX</td>
<td class="org-left">UNIX domain</td>
</tr>

<tr>
<td class="org-left">AF_UNSPEC</td>
<td class="org-left">unspecified</td>
</tr>
</tbody>
</table>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 31:</span> Figure 16.2 Socket types</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">SOCK_DGRAM</td>
<td class="org-left">fix-length, connectionless, unreliable messages</td>
</tr>

<tr>
<td class="org-left">SOCK_RAW</td>
<td class="org-left">datagram interface to IP (optional in POSIX.1)</td>
</tr>

<tr>
<td class="org-left">SOCK_SEQPACKET</td>
<td class="org-left">fix-length, sequenced, reliable, connection-oriented message</td>
</tr>

<tr>
<td class="org-left">SOCK_STREAMS</td>
<td class="org-left">sequenced, reliable, bidirectional, connection-oriented byte streams</td>
</tr>
</tbody>
</table>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 32:</span> Figure 16.3 Protocols defined for Internet domain socks</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Protocol</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">IPPROTO_IP</td>
<td class="org-left">IPv4 Internet Protocol</td>
</tr>

<tr>
<td class="org-left">IPPROTO_IPV6</td>
<td class="org-left">IPv6 Internet Protocol (optional in POSIX.1)</td>
</tr>

<tr>
<td class="org-left">IPPROTO_ICMP</td>
<td class="org-left">Internet Control message Protocol</td>
</tr>

<tr>
<td class="org-left">IPPROTO_RAW</td>
<td class="org-left">Raw IP packets protocol (optional in POSIX.1)</td>
</tr>

<tr>
<td class="org-left">IPPROTO_TCP</td>
<td class="org-left">Transmission Control Protocol</td>
</tr>

<tr>
<td class="org-left">IPPROTO_UDP</td>
<td class="org-left">User Datagram Protocol</td>
</tr>
</tbody>
</table>

<p>
A <code>SOCK_SEQPACKET</code> is just like a <code>SOCK_STREAM</code> socket except that we get a message-based service instead of a byte-stream service.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 33:</span> Figure 16.4 How file descriptor functions act with sockets</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Function</th>
<th scope="col" class="org-left">Behavior with socket</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">close(Section 3.3)</td>
<td class="org-left">deallocates the socket</td>
</tr>

<tr>
<td class="org-left">dup, dup2(Section 3.12)</td>
<td class="org-left">duplicates the file descriptor as normal</td>
</tr>

<tr>
<td class="org-left">fchdir (Section 4.23)</td>
<td class="org-left">fails with errno set to ENOTDIR</td>
</tr>

<tr>
<td class="org-left">fchmod (Section 4.9)</td>
<td class="org-left">unspecified</td>
</tr>

<tr>
<td class="org-left">fchown (Section 4.11)</td>
<td class="org-left">implementation defined</td>
</tr>

<tr>
<td class="org-left">fcntl (Section 3.14)</td>
<td class="org-left">some commands supported, including F_DUPFD, F_DUPFD_CLOEXEC, F_GETFD, F_GETFL, F_GETOWN, F_SETFD, F_SETFL, and F_SETOWN</td>
</tr>

<tr>
<td class="org-left">fdatasync, fsync (Section 3.13)</td>
<td class="org-left">implementation defined</td>
</tr>

<tr>
<td class="org-left">fstat (Section 4.2)</td>
<td class="org-left">some status structure members supported, but left up to the implementation</td>
</tr>

<tr>
<td class="org-left">ftruncate (Section 4.13)</td>
<td class="org-left">unspecified</td>
</tr>

<tr>
<td class="org-left">ioctl (Section 3.15)</td>
<td class="org-left">some commands work, depending on underlying device driver</td>
</tr>

<tr>
<td class="org-left">lseek (Section 3.6)</td>
<td class="org-left">implementation defined (usually fails with errno set to ESPIPE)</td>
</tr>

<tr>
<td class="org-left">mmap (Section 14.8)</td>
<td class="org-left">unspecified</td>
</tr>

<tr>
<td class="org-left">poll (Section 14.4.2)</td>
<td class="org-left">works as expected</td>
</tr>

<tr>
<td class="org-left">pread and pwrite (Section 3.11)</td>
<td class="org-left">fails with errno set to ESPIPE</td>
</tr>

<tr>
<td class="org-left">read (Section 3.7) and readv (Section 14.6)</td>
<td class="org-left">equivalent to recv (Section 16.5) without any flags</td>
</tr>

<tr>
<td class="org-left">select (Section 14.4.1)</td>
<td class="org-left">works as expected</td>
</tr>

<tr>
<td class="org-left">write (Section 3.8) and writev (Section 14.6)</td>
<td class="org-left">equivalent to send (Section 16.5) without any flags</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orgf14455e" class="outline-4">
<h4 id="orgf14455e"><span class="done DONE">DONE</span> 16.3 Addressing <code>[4/4]</code></h4>
<div class="outline-text-4" id="text-orgf14455e">
</div>

<ul class="org-ul">
<li><a id="org6c89f40"></a><span class="done DONE">DONE</span> 16.3.1 Byte Ordering<br />
<div class="outline-text-5" id="text-org6c89f40">

<div id="orgb7e6aaf" class="figure">
<p><img src="Chapter16/16fig05.jpg" alt="16fig05.jpg" />
</p>
<p><span class="figure-number">Figure 49: </span>Figure 16.5 Byte order in a 32-bit integer</p>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 34:</span> Figure 16.6 Byte order for test platforms</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Operating system</th>
<th scope="col" class="org-left">Processor architecture</th>
<th scope="col" class="org-left">Byte order</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">FreeBSD 8.0</td>
<td class="org-left">Intel Pentium</td>
<td class="org-left">little-endian</td>
</tr>

<tr>
<td class="org-left">Linux 3.2.0</td>
<td class="org-left">Intel Core i5</td>
<td class="org-left">little-endian</td>
</tr>

<tr>
<td class="org-left">Mac OS X 10.6.8</td>
<td class="org-left">Intel Core 2 Duo</td>
<td class="org-left">little-endian</td>
</tr>

<tr>
<td class="org-left">Solaris 10</td>
<td class="org-left">Sun SPARC</td>
<td class="org-left">big-endian</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * functions to convert between the processor byte order</span>
<span style="color: #9f8766;"> * and the network byte order for TCP/IP applications</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">arpa/inet.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #2aa1ae; background-color: #292e34;">/// </span><span style="color: #2aa1ae; background-color: #292e34;">@return 32-bit integer in network byte order</span>
<span style="color: #ce537a; font-weight: bold;">uint32_t</span> <span style="color: #bc6ec5; font-weight: bold;">htonl</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">uint32_t</span> <span style="color: #7590db;">hostint32</span><span style="color: #4f97d7;">)</span>;

<span style="color: #2aa1ae; background-color: #292e34;">/// </span><span style="color: #2aa1ae; background-color: #292e34;">@return 16-bit integer in network byte order</span>
<span style="color: #ce537a; font-weight: bold;">uint16_t</span> <span style="color: #bc6ec5; font-weight: bold;">htons</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">uint16_t</span> <span style="color: #7590db;">hostint16</span><span style="color: #4f97d7;">)</span>;

<span style="color: #2aa1ae; background-color: #292e34;">/// </span><span style="color: #2aa1ae; background-color: #292e34;">@return 32-bit integer in host byte order</span>
<span style="color: #ce537a; font-weight: bold;">uint32_t</span> <span style="color: #bc6ec5; font-weight: bold;">ntohl</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">uint32_t</span> <span style="color: #7590db;">netint32</span><span style="color: #4f97d7;">)</span>;

<span style="color: #2aa1ae; background-color: #292e34;">/// </span><span style="color: #2aa1ae; background-color: #292e34;">@return 16-bit integer in host byte order</span>
<span style="color: #ce537a; font-weight: bold;">uint16_t</span> <span style="color: #bc6ec5; font-weight: bold;">ntohs</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">uint16_t</span> <span style="color: #7590db;">netint16</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
</div>
</li>

<li><a id="org7559394"></a><span class="done DONE">DONE</span> 16.3.2 Address Formats<br />
<div class="outline-text-5" id="text-org7559394">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">generic sockaddr address structure</span>
<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #ce537a; font-weight: bold;">sa_family_t</span> <span style="color: #7590db;">sa_family</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">address family</span>
        <span style="color: #ce537a; font-weight: bold;">char</span>        <span style="color: #7590db;">sa_data</span><span style="color: #bc6ec5;">[]</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">variable-length address</span>
        ...  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">free to add more members and define a size for the sa_data member</span>
<span style="color: #4f97d7;">}</span>;

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">on Linux</span>
<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #ce537a; font-weight: bold;">sa_family_t</span> <span style="color: #7590db;">sa_family</span>;
        <span style="color: #ce537a; font-weight: bold;">char</span>        <span style="color: #7590db;">sa_data</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">14</span><span style="color: #bc6ec5;">]</span>;
<span style="color: #4f97d7;">}</span>;

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">on FreeBSD</span>
<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">sa_len</span>;       <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">total length</span>
        <span style="color: #ce537a; font-weight: bold;">sa_family_t</span>   <span style="color: #7590db;">sa_family</span>;    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">address family</span>
        <span style="color: #ce537a; font-weight: bold;">char</span>          <span style="color: #7590db;">sa_data</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">14</span><span style="color: #bc6ec5;">]</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">variable-length address</span>
<span style="color: #4f97d7;">}</span>;
</pre>
</div>

<p>
Internet addresses
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">netinet/in.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">#include &lt;stdint.h&gt; defined uintxx_t</span>
<span style="color: #4f97d7; font-weight: bold;">typedef</span> <span style="color: #ce537a; font-weight: bold;">uint16_t</span> <span style="color: #ce537a; font-weight: bold;">in_port_t</span>;
<span style="color: #4f97d7; font-weight: bold;">typedef</span> <span style="color: #ce537a; font-weight: bold;">uint32_t</span> <span style="color: #ce537a; font-weight: bold;">in_addr_t</span>;

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">In the IPv4 Internet domain (AF_INET),</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">a socket address is represented by a sockaddr_in structure</span>

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">in_addr</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #ce537a; font-weight: bold;">in_addr_t</span> <span style="color: #7590db;">s_addr</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">IPv4 address</span>
<span style="color: #4f97d7;">}</span>;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr_in</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #ce537a; font-weight: bold;">sa_family_t</span>    <span style="color: #7590db;">sin_family</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">address family</span>
        <span style="color: #ce537a; font-weight: bold;">in_port_t</span>      <span style="color: #7590db;">sin_port</span>;    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">port number</span>
        <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">in_addr</span> <span style="color: #7590db;">sin_addr</span>;    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">IPv4 address</span>
<span style="color: #4f97d7;">}</span>;

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">In the IPv6 Internet domain (AF_INET6)</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">represented by a sockaddr_in6 structure</span>
<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">in6_addr</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #ce537a; font-weight: bold;">uint8_t</span> <span style="color: #7590db;">s6_addr</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">16</span><span style="color: #bc6ec5;">]</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">IPv6 address</span>
<span style="color: #4f97d7;">}</span>;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr_in6</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #ce537a; font-weight: bold;">sa_family_t</span>     <span style="color: #7590db;">sin6_family</span>;    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">address family</span>
        <span style="color: #ce537a; font-weight: bold;">in_port_t</span>       <span style="color: #7590db;">sin6_port</span>;      <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">port number</span>
        <span style="color: #ce537a; font-weight: bold;">uint32_t</span>        <span style="color: #7590db;">sin6_flowinfo</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">traffic class and flow info</span>
        <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">in6_addr</span> <span style="color: #7590db;">sin6_addr</span>;      <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">IPv6 address</span>
        <span style="color: #ce537a; font-weight: bold;">uint32_t</span>        <span style="color: #7590db;">sin6_scope_id</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">set of interfaces for scope</span>
<span style="color: #4f97d7;">}</span>;

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">on Linux</span>
<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr_in</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #ce537a; font-weight: bold;">sa_family_t</span>    <span style="color: #7590db;">sin_family</span>;   <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">address family</span>
        <span style="color: #ce537a; font-weight: bold;">in_port_t</span>      <span style="color: #7590db;">sin_port</span>;     <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">port number</span>
        <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">in_addr</span> <span style="color: #7590db;">sin_addr</span>;     <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">IPv4 address</span>
        <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">char</span>  <span style="color: #7590db;">sin_zero</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">8</span><span style="color: #bc6ec5;">]</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">filler</span>
<span style="color: #4f97d7;">}</span>;
</pre>
</div>

<p>
convert between the binary address format and a string in dotted-decimal notation.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">arpa/inet.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">  domain    AF_INET/AF_INET6 only</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;"> pointer to address string on success, NULL on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #bc6ec5; font-weight: bold;">inet_ntop</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">domain</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">addr</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">str</span>,
                      <span style="color: #ce537a; font-weight: bold;">socklen_t</span> <span style="color: #7590db;">size</span><span style="color: #4f97d7;">)</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;"> string addr to binary</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">  domain   AF_INET/AF_INET6 only</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;"> 1 on success, 0 if the format is invalid, or -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">inet_pton</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">domain</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">str</span>, <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">addr</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
</div>
</li>

<li><a id="org4aef0b0"></a><span class="done DONE">DONE</span> 16.3.3 Address Lookup<br />
<div class="outline-text-5" id="text-org4aef0b0">
<p>
get hosts
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">netdb.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;"> get hosts</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;"> pointer if OK, NULL on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">hostent</span>* <span style="color: #bc6ec5; font-weight: bold;">gethostent</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sethostent</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">stayopen</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">endhostent</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">hostent</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #ce537a; font-weight: bold;">char</span>*  <span style="color: #7590db;">h_name</span>;       <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">name of host</span>
        <span style="color: #ce537a; font-weight: bold;">char</span>** <span style="color: #7590db;">h_aliases</span>;    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">pointer to alternate host name array</span>
        <span style="color: #ce537a; font-weight: bold;">int</span>    <span style="color: #7590db;">h_addrtype</span>;   <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">address type</span>
        <span style="color: #ce537a; font-weight: bold;">int</span>    <span style="color: #7590db;">h_length</span>;     <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">length in bytes of address</span>
        <span style="color: #ce537a; font-weight: bold;">char</span>** <span style="color: #7590db;">h_addr_list</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">pointer to array of network addresses</span>
        ...
<span style="color: #4f97d7;">}</span>;

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">netdb.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;"> get network info</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> *  a set of interfaces</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;"> pointer if OK, NULL on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">netent</span>* <span style="color: #bc6ec5; font-weight: bold;">getnetbyaddr</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">uint32_t</span> <span style="color: #7590db;">net</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">type</span><span style="color: #4f97d7;">)</span>;
<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">netent</span>* <span style="color: #bc6ec5; font-weight: bold;">getnetbyname</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">name</span><span style="color: #4f97d7;">)</span>;
<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">netent</span>* <span style="color: #bc6ec5; font-weight: bold;">getnetent</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">setnetent</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">stayopen</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">endnetent</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">netent</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #ce537a; font-weight: bold;">char</span>*    <span style="color: #7590db;">n_name</span>;      <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">network name</span>
        <span style="color: #ce537a; font-weight: bold;">char</span>**   <span style="color: #7590db;">n_aliases</span>;   <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">alternate network name array pointer</span>
        <span style="color: #ce537a; font-weight: bold;">int</span>      <span style="color: #7590db;">n_addrtype</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">address type</span>
        <span style="color: #ce537a; font-weight: bold;">uint32_t</span> <span style="color: #7590db;">n_net</span>;       <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">network number</span>
        ...
<span style="color: #4f97d7;">}</span>;

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">netdb.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      map between protol names and numbers</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     pointer if OK, NULL on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">protoent</span>* <span style="color: #bc6ec5; font-weight: bold;">getprotobyname</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">name</span><span style="color: #4f97d7;">)</span>;
<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">protoent</span>* <span style="color: #bc6ec5; font-weight: bold;">getprotobynumber</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">proto</span><span style="color: #4f97d7;">)</span>;
<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">protoent</span>* <span style="color: #bc6ec5; font-weight: bold;">getprotoent</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">setprotoent</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">stayopen</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">endprotoent</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">protoent</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #ce537a; font-weight: bold;">char</span>*  <span style="color: #7590db;">p_name</span>;     <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">protocol name</span>
        <span style="color: #ce537a; font-weight: bold;">char</span>** <span style="color: #7590db;">p_aliases</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">pointer to alternate protocol name array</span>
        <span style="color: #ce537a; font-weight: bold;">int</span>    <span style="color: #7590db;">p_proto</span>;    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">proto number</span>
        ...
<span style="color: #4f97d7;">}</span>;

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">netdb.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      a set of services' interfaces</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     pointer if OK, NULL on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">servent</span>* <span style="color: #bc6ec5; font-weight: bold;">getservbyname</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">name</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">proto</span><span style="color: #4f97d7;">)</span>;
<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">servent</span>* <span style="color: #bc6ec5; font-weight: bold;">getservbyport</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">port</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">proto</span><span style="color: #4f97d7;">)</span>;
<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">servent</span>* <span style="color: #bc6ec5; font-weight: bold;">getservent</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">setservent</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">stayopen</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">endservent</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">servent</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #ce537a; font-weight: bold;">char</span>*  <span style="color: #7590db;">s_name</span>;     <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">service name</span>
        <span style="color: #ce537a; font-weight: bold;">char</span>** <span style="color: #7590db;">s_aliases</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">pointer to alternate srevice name array</span>
        <span style="color: #ce537a; font-weight: bold;">int</span>    <span style="color: #7590db;">s_port</span>;     <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">port number</span>
        <span style="color: #ce537a; font-weight: bold;">char</span>*  <span style="color: #7590db;">s_proto</span>;    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">name of proto</span>
        ...
<span style="color: #4f97d7;">}</span>;

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">netdb.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      get address info</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     0 if OK, nonzero error code on error</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">getaddrinfo</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">host</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">service</span>,
                <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">addrinfo</span>* <span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">hint</span>,
                <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">addrinfo</span>** <span style="color: #4f97d7; font-weight: bold;">restrict</span>      <span style="color: #7590db;">res</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">freeaddrinfo</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">addrinfo</span>* <span style="color: #7590db;">ai</span><span style="color: #4f97d7;">)</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      convert the error code into error message</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@details</span><span style="color: #9f8766;">    can't use perror or strerror to generate an error message</span>
<span style="color: #9f8766;"> * but, need to call gai_strerror instead</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">      error code returned by getaddrinfo</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     a pointer to a string describing the error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #bc6ec5; font-weight: bold;">gai_strerror</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">error</span><span style="color: #4f97d7;">)</span>;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">addrinfo</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #ce537a; font-weight: bold;">int</span>              <span style="color: #7590db;">ai_flags</span>;      <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">customize behavior</span>
        <span style="color: #ce537a; font-weight: bold;">int</span>              <span style="color: #7590db;">ai_family</span>;     <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">address family</span>
        <span style="color: #ce537a; font-weight: bold;">int</span>              <span style="color: #7590db;">ai_socktype</span>;   <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">socket type</span>
        <span style="color: #ce537a; font-weight: bold;">int</span>              <span style="color: #7590db;">ai_protocol</span>;   <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">protocol</span>
        <span style="color: #ce537a; font-weight: bold;">socklen_t</span>        <span style="color: #7590db;">ai_addrlen</span>;    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">length in bytes of address</span>
        <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr</span>* <span style="color: #7590db;">ai_addr</span>;       <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">address</span>
        <span style="color: #ce537a; font-weight: bold;">char</span>*            <span style="color: #7590db;">ai_canonname</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">canonical name of host</span>
        <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">addrinfo</span>* <span style="color: #7590db;">ai_next</span>;       <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">next in list</span>
        ...
<span style="color: #4f97d7;">}</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      convert an address into host and service name</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     0 if OK, nonzero on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">netdb.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">getnameinfo</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr</span>* <span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">addr</span>, <span style="color: #ce537a; font-weight: bold;">socklen_t</span> <span style="color: #7590db;">alen</span>,
                <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">host</span>, <span style="color: #ce537a; font-weight: bold;">socklen_t</span> <span style="color: #7590db;">hostlen</span>, <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">service</span>,
                <span style="color: #ce537a; font-weight: bold;">socklen_t</span> <span style="color: #7590db;">servlen</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">flags</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 35:</span> Figure 16.7 Flags for addrinfo structure</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Flags</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">AI_ADDRCONFIG</td>
<td class="org-left">Query for whichever address type (IPv4 or IPv6) is configured.</td>
</tr>

<tr>
<td class="org-left">AI_ALL</td>
<td class="org-left">Look for both IPv4 and IPv6 addresses (used only with AI_V4MAPPED).</td>
</tr>

<tr>
<td class="org-left">AI_CANONNAME</td>
<td class="org-left">Request a canonical name (as opposed to an alias).</td>
</tr>

<tr>
<td class="org-left">AI_NUMERICHOST</td>
<td class="org-left">The host address is specified in numeric format; don't try to translate it.</td>
</tr>

<tr>
<td class="org-left">AI_NUMERICSERV</td>
<td class="org-left">The service is specified as a numeric port number, don't try to translate it.</td>
</tr>

<tr>
<td class="org-left">AI_PASSIVE</td>
<td class="org-left">Socket address is intended to be bound for listening.</td>
</tr>

<tr>
<td class="org-left">AI_V4MAPPED</td>
<td class="org-left">If no IPv6 addreses are found, return IPv4 addresses mapped in IPv6 format.</td>
</tr>
</tbody>
</table>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 36:</span> Figure 16.8 Flags for the ~getnameinfo ~function</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Flags</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">NI_DGRAM</td>
<td class="org-left">The service is datagram based instead of stream based.</td>
</tr>

<tr>
<td class="org-left">NI_NAMEREQD</td>
<td class="org-left">If the host name can't be found, treat this as an error.</td>
</tr>

<tr>
<td class="org-left">NI_NOFQDN</td>
<td class="org-left">Return only the node name portion of the fulling qualified domain name for local hosts.</td>
</tr>

<tr>
<td class="org-left">NI_NUMERICHOST</td>
<td class="org-left">Return the numeric form of the host address instead of the name.</td>
</tr>

<tr>
<td class="org-left">NI_NUMERICSCOPE</td>
<td class="org-left">For IPv6, return the numeric form of the scope ID instead of the name.</td>
</tr>

<tr>
<td class="org-left">NI_NUMERICSERV</td>
<td class="org-left">Return the numeric form of the service address (i.e., the port number)</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 134: </span>Figure 16.9 Print host and service information</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     16fig09.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-01-22</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Print host and service info</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>SOLARIS<span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">netinet/in.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">arpa/inet.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">netdb.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>BSD<span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">netinet/in.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">print_family</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">addrinfo</span> *<span style="color: #7590db;">aip</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">" family "</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">switch</span> <span style="color: #bc6ec5;">(</span>aip-&gt;ai_family<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">case</span> AF_INET:   printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"inet"</span><span style="color: #2d9574;">)</span>;        <span style="color: #4f97d7; font-weight: bold;">break</span>;
    <span style="color: #4f97d7; font-weight: bold;">case</span> AF_INET6:  printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"inet6"</span><span style="color: #2d9574;">)</span>;       <span style="color: #4f97d7; font-weight: bold;">break</span>;
    <span style="color: #4f97d7; font-weight: bold;">case</span> AF_UNIX:   printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"unix"</span><span style="color: #2d9574;">)</span>;        <span style="color: #4f97d7; font-weight: bold;">break</span>;
    <span style="color: #4f97d7; font-weight: bold;">case</span> AF_UNSPEC: printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"unspecified"</span><span style="color: #2d9574;">)</span>; <span style="color: #4f97d7; font-weight: bold;">break</span>;
    <span style="color: #4f97d7; font-weight: bold;">default</span>:        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"unknown"</span><span style="color: #2d9574;">)</span>;     <span style="color: #4f97d7; font-weight: bold;">break</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">print_type</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">addrinfo</span> *<span style="color: #7590db;">aip</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">" type "</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">switch</span> <span style="color: #bc6ec5;">(</span>aip-&gt;ai_socktype<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">case</span> SOCK_STREAM:    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"stream"</span><span style="color: #2d9574;">)</span>;                         <span style="color: #4f97d7; font-weight: bold;">break</span>;
    <span style="color: #4f97d7; font-weight: bold;">case</span> SOCK_DGRAM:     printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"datagram"</span><span style="color: #2d9574;">)</span>;                       <span style="color: #4f97d7; font-weight: bold;">break</span>;
    <span style="color: #4f97d7; font-weight: bold;">case</span> SOCK_SEQPACKET: printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"seqpacket"</span><span style="color: #2d9574;">)</span>;                      <span style="color: #4f97d7; font-weight: bold;">break</span>;
    <span style="color: #4f97d7; font-weight: bold;">case</span> SOCK_RAW:       printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"raw"</span><span style="color: #2d9574;">)</span>;                            <span style="color: #4f97d7; font-weight: bold;">break</span>;
    <span style="color: #4f97d7; font-weight: bold;">default</span>:             printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"unknown (%d)"</span>, aip-&gt;ai_socktype<span style="color: #2d9574;">)</span>; <span style="color: #4f97d7; font-weight: bold;">break</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">print_protocol</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">addrinfo</span> *<span style="color: #7590db;">aip</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">" protocol "</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">switch</span> <span style="color: #bc6ec5;">(</span>aip-&gt;ai_protocol<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">case</span> <span style="color: #a45bad;">0</span>:           printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"default"</span><span style="color: #2d9574;">)</span>;                        <span style="color: #4f97d7; font-weight: bold;">break</span>;
    <span style="color: #4f97d7; font-weight: bold;">case</span> IPPROTO_TCP: printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"TCP"</span><span style="color: #2d9574;">)</span>;                            <span style="color: #4f97d7; font-weight: bold;">break</span>;
    <span style="color: #4f97d7; font-weight: bold;">case</span> IPPROTO_UDP: printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"UDP"</span><span style="color: #2d9574;">)</span>;                            <span style="color: #4f97d7; font-weight: bold;">break</span>;
    <span style="color: #4f97d7; font-weight: bold;">case</span> IPPROTO_RAW: printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"raw"</span><span style="color: #2d9574;">)</span>;                            <span style="color: #4f97d7; font-weight: bold;">break</span>;
    <span style="color: #4f97d7; font-weight: bold;">default</span>:          printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"unknown (%d)"</span>, aip-&gt;ai_protocol<span style="color: #2d9574;">)</span>; <span style="color: #4f97d7; font-weight: bold;">break</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">print_flags</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">addrinfo</span> *<span style="color: #7590db;">aip</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"flags:"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>aip-&gt;ai_flags == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">" 0"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>aip-&gt;ai_flags &amp; AI_PASSIVE<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">" passive"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>aip-&gt;ai_flags &amp; AI_CANONNAME<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">" canonname"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>aip-&gt;ai_flags &amp; AI_NUMERICHOST<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">" numerichost"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>aip-&gt;ai_flags &amp; AI_NUMERICSERV<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">" numericserv"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>aip-&gt;ai_flags &amp; AI_V4MAPPED<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">" v4mapped"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>aip-&gt;ai_flags &amp; AI_ALL<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">" all"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>


<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">addrinfo</span> *    <span style="color: #7590db;">ailist</span>, *<span style="color: #7590db;">aip</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">addrinfo</span>      <span style="color: #7590db;">hint</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr_in</span> * <span style="color: #7590db;">sinp</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr_in6</span> *<span style="color: #7590db;">sinp6</span>;
    <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *         <span style="color: #7590db;">addr</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>                  <span style="color: #7590db;">err</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>                 <span style="color: #7590db;">abuf</span><span style="color: #bc6ec5;">[</span>INET_ADDRSTRLEN<span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>                 <span style="color: #7590db;">abuf6</span><span style="color: #bc6ec5;">[</span>INET6_ADDRSTRLEN<span style="color: #bc6ec5;">]</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc != <span style="color: #a45bad;">3</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"usage: %s nodename(host) service"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    hint.ai_flags     = AI_CANONNAME;
    hint.ai_family    = <span style="color: #a45bad;">0</span>;
    hint.ai_socktype  = <span style="color: #a45bad;">0</span>;
    hint.ai_protocol  = <span style="color: #a45bad;">0</span>;
    hint.ai_addrlen   = <span style="color: #a45bad;">0</span>;
    hint.ai_canonname = <span style="color: #a45bad;">NULL</span>;
    hint.ai_addr      = <span style="color: #a45bad;">NULL</span>;
    hint.ai_next      = <span style="color: #a45bad;">NULL</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = getaddrinfo<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span>, argv<span style="color: #b1951d;">[</span><span style="color: #a45bad;">2</span><span style="color: #b1951d;">]</span>, &amp;hint, &amp;ailist<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"getaddrinfo error: %s"</span>, gai_strerror<span style="color: #67b11d;">(</span>err<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>aip = ailist; aip != <span style="color: #a45bad;">NULL</span>; aip = aip-&gt;ai_next<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        print_flags<span style="color: #2d9574;">(</span>aip<span style="color: #2d9574;">)</span>;
        print_family<span style="color: #2d9574;">(</span>aip<span style="color: #2d9574;">)</span>;
        print_type<span style="color: #2d9574;">(</span>aip<span style="color: #2d9574;">)</span>;
        print_protocol<span style="color: #2d9574;">(</span>aip<span style="color: #2d9574;">)</span>;
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\n\thost %s"</span>, aip-&gt;ai_canonname ? aip-&gt;ai_canonname : <span style="color: #2d9574;">"-"</span><span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>aip-&gt;ai_family == AF_INET<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            sinp = <span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr_in</span> *<span style="color: #67b11d;">)</span>aip-&gt;ai_addr;
            addr = inet_ntop<span style="color: #67b11d;">(</span>AF_INET, &amp;sinp-&gt;sin_addr, abuf, INET_ADDRSTRLEN<span style="color: #67b11d;">)</span>;
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">" address %s"</span>, addr ? addr : <span style="color: #2d9574;">"unknown"</span><span style="color: #67b11d;">)</span>;
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">" port %d"</span>, ntohs<span style="color: #b1951d;">(</span>sinp-&gt;sin_port<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>aip-&gt;ai_family == AF_INET6<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            sinp6 = <span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr_in6</span> *<span style="color: #67b11d;">)</span>aip-&gt;ai_addr;
            addr =
                inet_ntop<span style="color: #67b11d;">(</span>AF_INET6, &amp;sinp6-&gt;sin6_addr, abuf6, INET6_ADDRSTRLEN<span style="color: #67b11d;">)</span>;
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">" address %s"</span>, addr ? addr : <span style="color: #2d9574;">"unknown"</span><span style="color: #67b11d;">)</span>;
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">" port %d"</span>, ntohs<span style="color: #b1951d;">(</span>sinp6-&gt;sin6_port<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\n"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</li>

<li><a id="orgb7dfb28"></a><span class="done DONE">DONE</span> 16.3.4 Associating Addresses with Sockets<br />
<div class="outline-text-5" id="text-orgb7dfb28">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      associate an address with a socket</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">      addr     restrictions:</span>
<span style="color: #9f8766;"> *                      * The address we specify must be valid for the</span>
<span style="color: #9f8766;"> * machine on which the process is running; we can't specify an address</span>
<span style="color: #9f8766;"> * belonging to some other machine</span>
<span style="color: #9f8766;"> *                      * The address must match the format supported by the</span>
<span style="color: #9f8766;"> * address family we used to create the socket</span>
<span style="color: #9f8766;"> *                      * The port number in the address cannot be less than</span>
<span style="color: #9f8766;"> * 1024 unless the process has the appropriate privilege</span>
<span style="color: #9f8766;"> *                      * Usually, ony one socket endpoint can be bound to a</span>
<span style="color: #9f8766;"> * given address, although some protocols allow duplicate bindings.</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     0 if OK, -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">bind</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">sockfd</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaaddr</span> *<span style="color: #7590db;">addr</span>, <span style="color: #ce537a; font-weight: bold;">socklen_t</span> <span style="color: #7590db;">len</span><span style="color: #4f97d7;">)</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      discover the address bound to a socket</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     0 if OK, -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">getsockname</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">sockfd</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">addr</span>,
                <span style="color: #ce537a; font-weight: bold;">socklen_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">alenp</span><span style="color: #4f97d7;">)</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      find out the peer's address</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     0 if OK, -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">getpeername</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">sockfd</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">addr</span>,
                <span style="color: #ce537a; font-weight: bold;">socklen_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">alenp</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
</div>
</li>
</ul>
</div>

<div id="outline-container-orgc5f0d75" class="outline-4">
<h4 id="orgc5f0d75"><span class="done DONE">DONE</span> 16.4 Connection Establishment</h4>
<div class="outline-text-4" id="text-orgc5f0d75">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      create a connection</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     0 if OK, -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">connect</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">sockfd</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr</span> *<span style="color: #7590db;">addr</span>, <span style="color: #ce537a; font-weight: bold;">socklen_t</span> <span style="color: #7590db;">len</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 135: </span>Figure 16.10 Connect with retry</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     16fig10.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-01-22</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    connect with retry</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">MAXSLEEP</span> <span style="color: #a45bad;">128</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">connect_retry</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">sockfd</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr</span> *<span style="color: #7590db;">addr</span>, <span style="color: #ce537a; font-weight: bold;">socklen_t</span> <span style="color: #7590db;">alen</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">numsec</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Try to connect with exponential backoff.</span>
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>numsec = <span style="color: #a45bad;">1</span>; numsec &lt;= MAXSLEEP; numsec &lt;&lt;= <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>connect<span style="color: #67b11d;">(</span>sockfd, addr, alen<span style="color: #67b11d;">)</span> == <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>numsec &lt;= MAXSLEEP / <span style="color: #a45bad;">2</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            sleep<span style="color: #67b11d;">(</span>numsec<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 136: </span>Figure 16.11 Portable connect with retry</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     16fig11.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-01-22</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    portable connect with retry</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">MAXSLEEP</span> <span style="color: #a45bad;">128</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">connect_retry</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">domain</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">type</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">protocol</span>,
                  <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr</span> *<span style="color: #7590db;">addr</span>, <span style="color: #ce537a; font-weight: bold;">socklen_t</span> <span style="color: #7590db;">alen</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">numsec</span>, <span style="color: #7590db;">fd</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Try to connect with expotential backoff.</span>
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>numsec = <span style="color: #a45bad;">1</span>; numsec &lt;= MAXSLEEP; numsec &lt;&lt;= <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>fd = socket<span style="color: #b1951d;">(</span>domain, type, protocol<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>connect<span style="color: #67b11d;">(</span>fd, addr, alen<span style="color: #67b11d;">)</span> == <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">connection accepted</span>
            <span style="color: #4f97d7; font-weight: bold;">return</span> fd;
        <span style="color: #2d9574;">}</span>
        close<span style="color: #2d9574;">(</span>fd<span style="color: #2d9574;">)</span>;

        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">delay before trying again.</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>numsec &lt;= MAXSLEEP / <span style="color: #a45bad;">2</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            sleep<span style="color: #67b11d;">(</span>numsec<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      be willing to accept connect requests</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">      backlog    a hint to the system regarding the number of</span>
<span style="color: #9f8766;"> *                        outstanding connect requests that it should</span>
<span style="color: #9f8766;"> *                        enqueue on behalf of the process.</span>
<span style="color: #9f8766;"> *                        is determined by the system,</span>
<span style="color: #9f8766;"> *                        upper limit SOMAXCONN</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     0 if OK, -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">listen</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">sockfd</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">backlog</span><span style="color: #4f97d7;">)</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      retrieve a connect request and convert it into a connection</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@details</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">      addr       set to NULL when don't care, otherwise, set a buffer</span>
<span style="color: #9f8766;"> *                        large enough to hold the address will be returned</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">      len        set to NULL when don't care, otherwise, set a integer</span>
<span style="color: #9f8766;"> *                        pointed by len and to the size of the buffer.</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     file (socket) descriptor if OK, -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">accept</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">sockfd</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">addr</span>, <span style="color: #ce537a; font-weight: bold;">socklen_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">len</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 137: </span>Figure 16.12 Initialize a socket endpoint for use by a server</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     16fig12.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-01-22</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    initialize a socket endpoint for use by a server</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">initserver</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">type</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr</span> *<span style="color: #7590db;">addr</span>, <span style="color: #ce537a; font-weight: bold;">socklen_t</span> <span style="color: #7590db;">alen</span>,
               <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">qlen</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">err</span> = <span style="color: #a45bad;">0</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fd = socket<span style="color: #67b11d;">(</span>addr-&gt;sa_family, type, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>bind<span style="color: #2d9574;">(</span>fd, addr, alen<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">goto</span> <span style="color: #a45bad;">errout</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>type == SOCK_STREAM || type == SOCK_SEQPACKET<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>listen<span style="color: #67b11d;">(</span>fd, qlen<span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">goto</span> <span style="color: #a45bad;">errout</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> fd;

<span style="color: #a45bad;">errout</span>:
    err = errno;
    close<span style="color: #bc6ec5;">(</span>fd<span style="color: #bc6ec5;">)</span>;
    errno = err;
    <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org4a9bdde" class="outline-4">
<h4 id="org4a9bdde"><span class="done DONE">DONE</span> 16.5 Data Transfer</h4>
<div class="outline-text-4" id="text-org4a9bdde">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      similar to send</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@details</span><span style="color: #9f8766;">    allows us to specify flags to change how the data we want to</span>
<span style="color: #9f8766;"> * transmit is treated</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">      flags        see below</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     number of bytes sent if OK, -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">ssize_t</span> <span style="color: #bc6ec5; font-weight: bold;">send</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">sockfd</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">buf</span>, <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">nbytes</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">flags</span><span style="color: #4f97d7;">)</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      similar to send</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@details</span><span style="color: #9f8766;">    allows us to specify a destination address to be used with</span>
<span style="color: #9f8766;"> * connectionless sockets</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     number of bytes sent if OK, -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">ssize_t</span> <span style="color: #bc6ec5; font-weight: bold;">sendto</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">sockfd</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">buf</span>, <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">nytes</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">flags</span>,
               <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr</span> *<span style="color: #7590db;">destaddr</span>, <span style="color: #ce537a; font-weight: bold;">socklen_t</span> <span style="color: #7590db;">destlen</span><span style="color: #4f97d7;">)</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      similar to writev</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@details</span><span style="color: #9f8766;">    send multiple buffers</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">      msghdr       specify multiple buffers from which to transmit data</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     number of bytes sent if OK, -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">msghdr</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #ce537a; font-weight: bold;">void</span> *        <span style="color: #7590db;">msg_name</span>;        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">optional address</span>
        <span style="color: #ce537a; font-weight: bold;">socklen_t</span>     <span style="color: #7590db;">msg_namelen</span>;     <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">address size in bytes</span>
        <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">iovec</span> *<span style="color: #7590db;">msg_iov</span>;         <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">array of I/O buffers</span>
        <span style="color: #ce537a; font-weight: bold;">int</span>           <span style="color: #7590db;">msg_iovlen</span>;      <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">number of elements in array</span>
        <span style="color: #ce537a; font-weight: bold;">void</span> *        <span style="color: #7590db;">msg_control</span>;     <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">ancillary data</span>
        <span style="color: #ce537a; font-weight: bold;">socklen_t</span>     <span style="color: #7590db;">msg_controllen</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">number of ancillary bytes</span>
        <span style="color: #ce537a; font-weight: bold;">int</span>           <span style="color: #7590db;">msg_flags</span>;       <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">flags for received message</span>
        ...
<span style="color: #4f97d7;">}</span>;
<span style="color: #ce537a; font-weight: bold;">ssize_t</span> <span style="color: #bc6ec5; font-weight: bold;">sendmsg</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">sockfd</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">msghdr</span> *<span style="color: #7590db;">msg</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">flags</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 37:</span> Figure 16.13 Flags used with <code>send</code> socket calls</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Flags</th>
<th scope="col" class="org-left">Description</th>
<th scope="col" class="org-left">POSIX.1</th>
<th scope="col" class="org-left">FreeBSD</th>
<th scope="col" class="org-left">Linux</th>
<th scope="col" class="org-left">Mac OS X</th>
<th scope="col" class="org-left">Solaris</th>
</tr>

<tr>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">8.0</th>
<th scope="col" class="org-left">3.2.0</th>
<th scope="col" class="org-left">10.6.8</th>
<th scope="col" class="org-left">10</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">MSG_CONFIRM</td>
<td class="org-left">Provide feedback to the link layer to keep address mapping valid</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">MSG_DONTROUTE</td>
<td class="org-left">Don't route packet outside of local network</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>

<tr>
<td class="org-left">MSG_DONTWAIT</td>
<td class="org-left">Enable nonblocking operation (equivalent to using O_NONBLOCK)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>

<tr>
<td class="org-left">MSG_EOF</td>
<td class="org-left">Shut the sender side of the socket down after sending data</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">MSG_EOR</td>
<td class="org-left">Mark the end of the record if supported by protocol</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>

<tr>
<td class="org-left">MSG_MORE</td>
<td class="org-left">Delay sending the packet to allow more data to be written</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">MSG_NOSIGNAL</td>
<td class="org-left">Don't generate SIGPIPE when writing to an unconnected socket</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">MSG_OOB</td>
<td class="org-left">Send out-of-band data if supported by protocol (see Section 16.7)</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      similar to send, but fetch data</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     length of message in bytes, 0 if no messages are available and</span>
<span style="color: #9f8766;"> *             peer has done an olderly shutdown or -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">ssize_t</span> <span style="color: #bc6ec5; font-weight: bold;">recv</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">sockfd</span>, <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">buf</span>, <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">nbytes</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">flags</span><span style="color: #4f97d7;">)</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      similar to sendto, but fetch data</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     length of message in bytes, 0 if no messages are available and</span>
<span style="color: #9f8766;"> *             peer has done an olderly shutdown or -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">ssize_t</span> <span style="color: #bc6ec5; font-weight: bold;">recvfrom</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">sockfd</span>, <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">buf</span>, <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">len</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">flags</span>,
                 <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">addr</span>, <span style="color: #ce537a; font-weight: bold;">socklen_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">addrlen</span><span style="color: #4f97d7;">)</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      similar to sendmsg, but fetch data</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">      flags    see below</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     length of message in bytes, 0 if no messages are available and</span>
<span style="color: #9f8766;"> *             peer has done an olderly shutdown or -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">ssize_t</span> <span style="color: #bc6ec5; font-weight: bold;">recvmsg</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">sockfd</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">msghdr</span> *<span style="color: #7590db;">msg</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">flags</span><span style="color: #4f97d7;">)</span>;

</pre>
</div>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 38:</span> Figure 16.13 Flags used with recv socket calls</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Flag</th>
<th scope="col" class="org-left">Description</th>
<th scope="col" class="org-left">POSIX.1</th>
<th scope="col" class="org-left">FreeBSD 8.0</th>
<th scope="col" class="org-left">Linux 3.2.0</th>
<th scope="col" class="org-left">Mac OS X 10.6.8</th>
<th scope="col" class="org-left">Solaris</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">MSG_CMSG_CLOEXEC</td>
<td class="org-left">Set the close-on-exec flag for file</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">descriptors received over a</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">UNIX domain socket</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">(see Section 17.4)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">MSG_DONTWAIT</td>
<td class="org-left">Enable nonblocking operation</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">(equivalent to using <code>O_NONBLOCK</code>)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">MSG_ERRQUEUE</td>
<td class="org-left">Receive error information as</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">ancillary data</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">MSG_OOB</td>
<td class="org-left">Retrieve out-of-band data if</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">supported by protocol</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">(see Section 16.7)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">MSG_PEEK</td>
<td class="org-left">Return pack contents without</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">consuming the packet</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">MSG_TRUNC</td>
<td class="org-left">Request that the real length of</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">the packet be returned, even if</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">it was truncated</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">MSG_WAITALL</td>
<td class="org-left">Wait until all data is available</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">(SOCK_STREM only)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 39:</span> Figure 16.15 Flags returned in msg_flags by recvmsg</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Flags</th>
<th scope="col" class="org-left">Description</th>
<th scope="col" class="org-left">POSIX.1</th>
<th scope="col" class="org-left">FreeBSD 8.0</th>
<th scope="col" class="org-left">Linux 3.2.0</th>
<th scope="col" class="org-left">Mac OS X 10.6.8</th>
<th scope="col" class="org-left">Solaris 10</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">MSG_CTRUNC</td>
<td class="org-left">Control data was truncated</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>

<tr>
<td class="org-left">MSG_EOR</td>
<td class="org-left">End of record was received</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>

<tr>
<td class="org-left">MSG_ERRQUEUE</td>
<td class="org-left">Error information was received as ancillary data</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">MSG_OOB</td>
<td class="org-left">Out-of-band data was received</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>

<tr>
<td class="org-left">MSG_TRUNC</td>
<td class="org-left">Normal data was truncated</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li><p>
Example &#x2013; Connection-Oriented Client
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 138: </span>Figure 16.16 Client command to get uptime from server</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     16fig16.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-01-22</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    client command to get uptime from server</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">netdb.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">BUFLEN</span> <span style="color: #a45bad;">128</span>

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">connect_retry</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span>, <span style="color: #ce537a; font-weight: bold;">int</span>, <span style="color: #ce537a; font-weight: bold;">int</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr</span> *, <span style="color: #ce537a; font-weight: bold;">socklen_t</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">print_uptime</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">sockfd</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>  <span style="color: #7590db;">n</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span>BUFLEN<span style="color: #bc6ec5;">]</span>;

    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>n = recv<span style="color: #67b11d;">(</span>sockfd, buf, BUFLEN, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        write<span style="color: #2d9574;">(</span>STDOUT_FILENO, buf, n<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>n &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"recv error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">addrinfo</span> *<span style="color: #7590db;">ailist</span>, *<span style="color: #7590db;">aip</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">addrinfo</span>  <span style="color: #7590db;">hint</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>              <span style="color: #7590db;">sockfd</span>, <span style="color: #7590db;">err</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc != <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"usage: ruptime hostname"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    memset<span style="color: #bc6ec5;">(</span>&amp;hint, <span style="color: #a45bad;">0</span>, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>hint<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    hint.ai_socktype  = SOCK_STREAM;
    hint.ai_canonname = <span style="color: #a45bad;">NULL</span>;
    hint.ai_addr      = <span style="color: #a45bad;">NULL</span>;
    hint.ai_next      = <span style="color: #a45bad;">NULL</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = getaddrinfo<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span>, <span style="color: #2d9574;">"4000"</span>, &amp;hint, &amp;ailist<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"getaddrinfo error: %s"</span>, gai_strerror<span style="color: #67b11d;">(</span>err<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>aip = ailist; aip != <span style="color: #a45bad;">NULL</span>; aip = aip-&gt;ai_next<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>sockfd = connect_retry<span style="color: #b1951d;">(</span>aip-&gt;ai_family, SOCK_STREAM, <span style="color: #a45bad;">0</span>,
                                    aip-&gt;ai_addr, aip-&gt;ai_addrlen<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err = errno;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            print_uptime<span style="color: #67b11d;">(</span>sockfd<span style="color: #67b11d;">)</span>;
            exit<span style="color: #67b11d;">(</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    err_exit<span style="color: #bc6ec5;">(</span>err, <span style="color: #2d9574;">"can't connect to %s"</span>, argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
Example &#x2013; Connection-Oriented Server
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 139: </span>Figure 16.17 Server program to provide system uptime</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     16fig17.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-01-22</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    server program to provide system uptime</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">netdb.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">syslog.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">BUFLEN</span> <span style="color: #a45bad;">128</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">QLEN</span>   <span style="color: #a45bad;">10</span>

<span style="color: #bc6ec5;">#if</span><span style="color: #bc6ec5;">n</span><span style="color: #bc6ec5;">def</span> HOST_NAME_MAX
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">HOST_NAME_MAX</span> <span style="color: #a45bad;">256</span>
<span style="color: #bc6ec5;">#endif</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">HOST_NAME_MAX</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">initserver</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr</span> *, <span style="color: #ce537a; font-weight: bold;">socklen_t</span>, <span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">serve</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">sockfd</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">clfd</span>;
    <span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>  <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span>BUFLEN<span style="color: #bc6ec5;">]</span>;

    set_cloexec<span style="color: #bc6ec5;">(</span>sockfd<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>;;<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>clfd = accept<span style="color: #b1951d;">(</span>sockfd, <span style="color: #a45bad;">NULL</span>, <span style="color: #a45bad;">NULL</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            syslog<span style="color: #67b11d;">(</span>LOG_ERR, <span style="color: #2d9574;">"ruptimed: accept error: %s"</span>, strerror<span style="color: #b1951d;">(</span>errno<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>;
            exit<span style="color: #67b11d;">(</span>EXIT_FAILURE<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        set_cloexec<span style="color: #2d9574;">(</span>clfd<span style="color: #2d9574;">)</span>;

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>fp = popen<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"/usr/bin/uptime"</span>, <span style="color: #2d9574;">"r"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            sprintf<span style="color: #67b11d;">(</span>buf, <span style="color: #2d9574;">"error: %s\n"</span>, strerror<span style="color: #b1951d;">(</span>errno<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>;
            send<span style="color: #67b11d;">(</span>clfd, buf, strlen<span style="color: #b1951d;">(</span>buf<span style="color: #b1951d;">)</span>, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #67b11d;">(</span>fgets<span style="color: #b1951d;">(</span>buf, BUFLEN, fp<span style="color: #b1951d;">)</span> != <span style="color: #a45bad;">NULL</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                send<span style="color: #b1951d;">(</span>clfd, buf, strlen<span style="color: #4f97d7;">(</span>buf<span style="color: #4f97d7;">)</span>, <span style="color: #a45bad;">0</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
            pclose<span style="color: #67b11d;">(</span>fp<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        close<span style="color: #2d9574;">(</span>clfd<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">addrinfo</span> *<span style="color: #7590db;">ailist</span>, *<span style="color: #7590db;">aip</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">addrinfo</span>  <span style="color: #7590db;">hint</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>              <span style="color: #7590db;">sockfd</span>, <span style="color: #7590db;">err</span>, <span style="color: #7590db;">n</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>            *<span style="color: #7590db;">host</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc != <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"usage: ruptimed"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>n = sysconf<span style="color: #67b11d;">(</span>_SC_HOST_NAME_MAX<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        n = HOST_NAME_MAX;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>host = malloc<span style="color: #67b11d;">(</span>n<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"malloc error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>gethostname<span style="color: #2d9574;">(</span>host, n<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"gethostname error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"hostname: %s\n"</span>, host<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    daemonize<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"ruptimed"</span><span style="color: #bc6ec5;">)</span>;

    memset<span style="color: #bc6ec5;">(</span>&amp;hint, <span style="color: #a45bad;">0</span>, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>hint<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    hint.ai_flags     = AI_CANONNAME;
    hint.ai_socktype  = SOCK_STREAM;
    hint.ai_canonname = <span style="color: #a45bad;">NULL</span>;
    hint.ai_addr      = <span style="color: #a45bad;">NULL</span>;
    hint.ai_next      = <span style="color: #a45bad;">NULL</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = getaddrinfo<span style="color: #67b11d;">(</span>host, <span style="color: #2d9574;">"4000"</span>, &amp;hint, &amp;ailist<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        syslog<span style="color: #2d9574;">(</span>LOG_ERR, <span style="color: #2d9574;">"ruptimed: getaddrinfo error: %s"</span>, gai_strerror<span style="color: #67b11d;">(</span>err<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span>EXIT_FAILURE<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>aip = ailist; aip; aip = aip-&gt;ai_next<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>sockfd = initserver<span style="color: #b1951d;">(</span>SOCK_STREAM, aip-&gt;ai_addr, aip-&gt;ai_addrlen,
                                 QLEN<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &gt;= <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            serve<span style="color: #67b11d;">(</span>sockfd<span style="color: #67b11d;">)</span>;
            exit<span style="color: #67b11d;">(</span>EXIT_SUCCESS<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    exit<span style="color: #bc6ec5;">(</span>EXIT_SUCCESS<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
Example &#x2013; Alternative Connection-Oriented Server
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org64ada3f" class="outline-4">
<h4 id="org64ada3f"><span class="done DONE">DONE</span> 16.6 Socket Options</h4>
<div class="outline-text-4" id="text-org64ada3f">
<blockquote>
<p>
three kinds of options:
</p>
<ol class="org-ol">
<li>Generic options that work with all socket types.</li>
<li>Options that are managed at the socket leve, but depend on the underlying protocols for support</li>
<li>Protocol-specific options unique to each individual protocol</li>
</ol>
</blockquote>

<div class="org-src-container">
<pre class="src src-c">
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      set a socket option</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">      option     see below</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     0 if OK, -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">setsockopt</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">sockfd</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">level</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">option</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">val</span>,
               <span style="color: #ce537a; font-weight: bold;">socklen_t</span> <span style="color: #7590db;">len</span><span style="color: #4f97d7;">)</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      get a socket option</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">      option     see below</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     0 if OK, -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">getsockopt</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">sockfd</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">level</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">option</span>, <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">val</span>,
               <span style="color: #ce537a; font-weight: bold;">socklen_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">lenp</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 40:</span> Figure 16.21 Socket options</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Option</th>
<th scope="col" class="org-left">Type of val argument</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">SO_ACCEPTCONN</td>
<td class="org-left">int</td>
<td class="org-left">Return whether a socket is enabled for listening (getsockopt only).</td>
</tr>

<tr>
<td class="org-left">SO_BROADCAST</td>
<td class="org-left">int</td>
<td class="org-left">Broadcast datagrams if *val is nonzero.</td>
</tr>

<tr>
<td class="org-left">SO_DEBUG</td>
<td class="org-left">int</td>
<td class="org-left">Debugging in network drivers enabled if *val is nonzero.</td>
</tr>

<tr>
<td class="org-left">SO_DONTROUTE</td>
<td class="org-left">int</td>
<td class="org-left">Bypass normal routing if *val is nonzero.</td>
</tr>

<tr>
<td class="org-left">SO_ERROR</td>
<td class="org-left">int</td>
<td class="org-left">Return and clear pending socket eror (getsockopt only).</td>
</tr>

<tr>
<td class="org-left">SO_KEEPALIVE</td>
<td class="org-left">int</td>
<td class="org-left">Periordic keep-alive messages enabled if *val is nonzero.</td>
</tr>

<tr>
<td class="org-left">SO_LINGER</td>
<td class="org-left">struct linger</td>
<td class="org-left">Delay time when unsent messages exist and socket is closed.</td>
</tr>

<tr>
<td class="org-left">SO_OOBINLINE</td>
<td class="org-left">int</td>
<td class="org-left">Out-of-band data placed inline with normal data if *val is nonzero.</td>
</tr>

<tr>
<td class="org-left">SO_RCVBUF</td>
<td class="org-left">int</td>
<td class="org-left">The size in bytes of the receive buffer.</td>
</tr>

<tr>
<td class="org-left">SO_RCVLOWAT</td>
<td class="org-left">int</td>
<td class="org-left">The minimum amount of data in bytes to return on a receive call.</td>
</tr>

<tr>
<td class="org-left">SO_RCVTIMEO</td>
<td class="org-left">struct timeval</td>
<td class="org-left">The timeout value for a socket receive call.</td>
</tr>

<tr>
<td class="org-left">SO_REUSEADDR</td>
<td class="org-left">int</td>
<td class="org-left">Reuse addresses in bind if *val is nonzero.</td>
</tr>

<tr>
<td class="org-left">SO_SNDBUF</td>
<td class="org-left">int</td>
<td class="org-left">The size in bytes of the send buffre.</td>
</tr>

<tr>
<td class="org-left">SO_SNDLOWAT</td>
<td class="org-left">int</td>
<td class="org-left">The minium amount of data in bytes to transmit in a send call.</td>
</tr>

<tr>
<td class="org-left">SO_SNDTIMEO</td>
<td class="org-left">struct timeval</td>
<td class="org-left">The timeout value for a socket send call.</td>
</tr>

<tr>
<td class="org-left">SO_TYPE</td>
<td class="org-left">int</td>
<td class="org-left">Identify the socket type (getsockopt only).</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 140: </span>Figure 16.22 Initialize a socket endpoint for use by a server with address reuse</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     16fig22.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-01-23</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    initialize a socket endpoint for use by a server</span>
<span style="color: #9f8766;"> *              with address reuse</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">initserver</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">type</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr</span> *<span style="color: #7590db;">addr</span>, <span style="color: #ce537a; font-weight: bold;">socklen_t</span> <span style="color: #7590db;">alen</span>,
               <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">qlen</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>, <span style="color: #7590db;">err</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">reuse</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fd = socket<span style="color: #67b11d;">(</span>addr-&gt;sa_family, type, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>setsockopt<span style="color: #2d9574;">(</span>fd, SOL_SOCKET, SO_REUSEADDR, &amp;reuse, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">goto</span> <span style="color: #a45bad;">errout</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>bind<span style="color: #2d9574;">(</span>fd, addr, alen<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">goto</span> <span style="color: #a45bad;">errout</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>type == SOCK_STREAM || type == SOCK_SEQPACKET<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>listen<span style="color: #67b11d;">(</span>fd, qlen<span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">goto</span> <span style="color: #a45bad;">errout</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> fd;

<span style="color: #a45bad;">errout</span>:
    err = errno;
    close<span style="color: #bc6ec5;">(</span>fd<span style="color: #bc6ec5;">)</span>;
    errno = err;
    <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-orgcab5af7" class="outline-4">
<h4 id="orgcab5af7"><span class="done DONE">DONE</span> 16.7 Out-of-Band Data</h4>
<div class="outline-text-4" id="text-orgcab5af7">
<p>
allowing higher-priority delivery of data than normal.
is sent ahead of any data that is already queued for transmission.
</p>

<p>
TCP refers to out-of-band data as "urgent" data. TCP supports only a single byte of urgent data,
but allows urgent data to be delivered out of band from the normal data delivery mechanisms.
specify <code>MSG_OOB</code> flag to <code>send</code> functions.
with more than one byte with <code>MSG_OOB</code> flag, the last byte will be treated as the urgent-data byte.
</p>

<p>
sent <code>SIGURG</code> signal when urgent data is received and we have arranged for signal generation by the socket.
</p>

<p>
receive signals from a socket by calling
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      receive signals from a socket</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@details</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">      F_SETOWN   be used to retrieve the current socket ownership</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@parm</span><span style="color: #9f8766;">       pid        a positive value represents a process ID</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">pid</span> = fcntl<span style="color: #4f97d7;">(</span>sockfd, F_GETOWN, <span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span>;
<span style="color: #bc6ec5; font-weight: bold;">fcntl</span><span style="color: #4f97d7;">(</span>sockfd, F_SETOWN, pid<span style="color: #4f97d7;">)</span>;
</pre>
</div>

<p>
<i>urgent mark</i>: the point in the normal data stream where the urgent data would go.
</p>

<p>
receive the urgent data inline with the normal data: <code>SO_OOBINLINE</code>
</p>

<p>
identify when we have reached the urgent mark
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      identify the urgent mark</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     1 if at mark, 0 if not at mark, -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sockatmark</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">sockfd</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org5cb94fa" class="outline-4">
<h4 id="org5cb94fa"><span class="done DONE">DONE</span> 16.8 Nonblocking and Asynchronous I/O</h4>
<div class="outline-text-4" id="text-org5cb94fa">
<p>
normally, I/O functions will block when it is not immediately available.
</p>

<p>
when the socket is in nonblocking mode, these function failes instead of blocking, setting <code>errno</code> to either <code>EWOULDBLOCK</code> or <code>EAGAIN</code>. we can use either <code>poll</code> or <code>select</code> to determine when we can receive or transmit data.
</p>

<p>
with socket-based asynchronous I/O, sent <code>SIGIO</code> signal when it's available.
</p>

<p>
Enabling asynchronous I/O:
</p>
<ol class="org-ol">
<li>Establish socket ownership so signals can be delivered to the proper progresses.

<ul class="org-ul">
<li>Use the <code>F_SETOWN</code> command with <code>fcntl</code>.</li>

<li>Use the <code>FIOSETOWN</code> command with <code>ioctl</code>.</li>

<li>Use the <code>SIOCSPGRP</code> command with <code>ioctl</code>.</li>
</ul></li>

<li>Inform the socket that we want it to signal us when I/O operations won't block.

<ul class="org-ul">
<li>Use the <code>F_SETFL</code> command with <code>fcntl</code> and enable the <code>O_ASYNC</code> file flag.</li>

<li>Use the <code>FIOASYNC</code> command with <code>ioctl</code>.</li>
</ul></li>
</ol>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 41:</span> Figure 16.23 Socket asynchronous I/O management commands</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Mechanism</th>
<th scope="col" class="org-left">POSIX.1</th>
<th scope="col" class="org-left">FreeBSD 8.0</th>
<th scope="col" class="org-left">Linux 3.2.0</th>
<th scope="col" class="org-left">Mac OS X 10.6.8</th>
<th scope="col" class="org-left">Solaris 10</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">fcntl(fd, F_SETOWN, pid)</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>

<tr>
<td class="org-left">ioctl(fd, FIOSETOWN, pid)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>

<tr>
<td class="org-left">ioctl(fd, SIOCSPGRP, pid)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">fcntl(fd, F_SETFL, flags &vert; O_ASYNC)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">ioctl(fd, FIOASYNC, &amp;n);</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orge58cf2a" class="outline-4">
<h4 id="orge58cf2a"><span class="done DONE">DONE</span> 16.9 Summary</h4>
<div class="outline-text-4" id="text-orge58cf2a">
<ul class="org-ul">
<li>Example

<ul class="org-ul">
<li><p>
16.1 see below
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     16ex01.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-01-23</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    determine system's byte ordering</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">iostream</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #4f97d7; font-weight: bold;">using</span> <span style="color: #4f97d7; font-weight: bold;">namespace</span> <span style="color: #a45bad;">std</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">n</span> = <span style="color: #a45bad;">1</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>*<span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">char</span>*<span style="color: #2d9574;">)</span>&amp;n == <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        cout &lt;&lt; <span style="color: #2d9574;">"little-endian"</span> &lt;&lt; endl;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        cout &lt;&lt; <span style="color: #2d9574;">"end-endian"</span> &lt;&lt; endl;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
16.2 see below
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Fields</th>
<th scope="col" class="org-right">Mac OS X 10.15.2</th>
<th scope="col" class="org-right">Linux 3.10</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">ID of device containing file</td>
<td class="org-right">0</td>
<td class="org-right">7</td>
</tr>

<tr>
<td class="org-left">Mode of file (see below)</td>
<td class="org-right">49590</td>
<td class="org-right">49663</td>
</tr>

<tr>
<td class="org-left">Number of hard links</td>
<td class="org-right">0</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-left">File serial number</td>
<td class="org-right">0</td>
<td class="org-right">58400</td>
</tr>

<tr>
<td class="org-left">User ID of the file</td>
<td class="org-right">501</td>
<td class="org-right">0(root)</td>
</tr>

<tr>
<td class="org-left">Group ID of the file</td>
<td class="org-right">20</td>
<td class="org-right">0(root)</td>
</tr>

<tr>
<td class="org-left">Device ID</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-left">time of last access</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-left">time of last data modification</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-left">time of last status change</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-left">time of file creation(birth)</td>
<td class="org-right">0</td>
<td class="org-right">&#xa0;</td>
</tr>

<tr>
<td class="org-left">user defined flags for file</td>
<td class="org-right">0</td>
<td class="org-right">&#xa0;</td>
</tr>

<tr>
<td class="org-left">file generation number</td>
<td class="org-right">0</td>
<td class="org-right">&#xa0;</td>
</tr>

<tr>
<td class="org-left">file size, in bytes</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-left">blocks allocated for file</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-left">optimal blocksize for I/O</td>
<td class="org-right">131072</td>
<td class="org-right">4096</td>
</tr>
</tbody>
</table>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">arpa/inet.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">netdb.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/stat.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">time.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">cstdlib</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">cstring</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">iostream</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #4f97d7; font-weight: bold;">using</span> <span style="color: #4f97d7; font-weight: bold;">namespace</span> <span style="color: #a45bad;">std</span>;

<span style="color: #bc6ec5;">#if</span><span style="color: #bc6ec5;">n</span><span style="color: #bc6ec5;">def</span> HOST_NAME_MAX
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">HOST_NAME_MAX</span> <span style="color: #a45bad;">256</span>
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">print_stat_info</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">stat</span> *<span style="color: #7590db;">s</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    cout &lt;&lt; <span style="color: #2d9574;">"ID of device containing file: "</span> &lt;&lt; s-&gt;st_dev &lt;&lt; endl;
    cout &lt;&lt; <span style="color: #2d9574;">"Mode of file (see below): "</span> &lt;&lt; s-&gt;st_mode &lt;&lt; endl;
    cout &lt;&lt; <span style="color: #2d9574;">"Number of hard links: "</span> &lt;&lt; s-&gt;st_nlink &lt;&lt; endl;
    cout &lt;&lt; <span style="color: #2d9574;">"File serial number: "</span> &lt;&lt; s-&gt;st_ino &lt;&lt; endl;
    cout &lt;&lt; <span style="color: #2d9574;">"User ID of the file: "</span> &lt;&lt; s-&gt;st_uid &lt;&lt; endl;
    cout &lt;&lt; <span style="color: #2d9574;">"Group ID of the file: "</span> &lt;&lt; s-&gt;st_gid &lt;&lt; endl;
    cout &lt;&lt; <span style="color: #2d9574;">"Device ID: "</span> &lt;&lt; s-&gt;st_rdev &lt;&lt; endl;

<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #bc6ec5;">(</span>__APPLE__<span style="color: #bc6ec5;">)</span>
    cout &lt;&lt; <span style="color: #2d9574;">"time of last access: "</span> &lt;&lt; s-&gt;st_atimespec.tv_sec &lt;&lt; endl;
    cout &lt;&lt; <span style="color: #2d9574;">"time of last data modification: "</span> &lt;&lt; s-&gt;st_mtimespec.tv_sec
         &lt;&lt; endl;
    cout &lt;&lt; <span style="color: #2d9574;">"time of last status change: "</span> &lt;&lt; s-&gt;st_ctimespec.tv_sec &lt;&lt; endl;
    cout &lt;&lt; <span style="color: #2d9574;">"time of file creation(birth): "</span> &lt;&lt; s-&gt;st_birthtimespec.tv_sec
         &lt;&lt; endl;
    cout &lt;&lt; <span style="color: #2d9574;">"user defined flags for file: "</span> &lt;&lt; s-&gt;st_flags &lt;&lt; endl;
    cout &lt;&lt; <span style="color: #2d9574;">"file generation number: "</span> &lt;&lt; s-&gt;st_gen &lt;&lt; endl;
<span style="color: #bc6ec5;">#elif</span> <span style="color: #bc6ec5;">defined</span><span style="color: #bc6ec5;">(</span>__linux__<span style="color: #bc6ec5;">)</span>
    cout &lt;&lt; <span style="color: #2d9574;">"time of last access: "</span> &lt;&lt; s-&gt;st_atime &lt;&lt; endl;
    cout &lt;&lt; <span style="color: #2d9574;">"time of last data modification: "</span> &lt;&lt; s-&gt;st_mtime &lt;&lt; endl;
    cout &lt;&lt; <span style="color: #2d9574;">"time of last status change: "</span> &lt;&lt; s-&gt;st_ctime &lt;&lt; endl;
<span style="color: #bc6ec5;">#endif</span>
    cout &lt;&lt; <span style="color: #2d9574;">"file size, in bytes: "</span> &lt;&lt; s-&gt;st_size &lt;&lt; endl;
    cout &lt;&lt; <span style="color: #2d9574;">"blocks allocated for file: "</span> &lt;&lt; s-&gt;st_blocks &lt;&lt; endl;
    cout &lt;&lt; <span style="color: #2d9574;">"optimal blocksize for I/O: "</span> &lt;&lt; s-&gt;st_blksize &lt;&lt; endl;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">stat</span>      <span style="color: #7590db;">s</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>              <span style="color: #7590db;">fd</span>, <span style="color: #7590db;">err</span>, <span style="color: #7590db;">n</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">addrinfo</span> *<span style="color: #7590db;">ailist</span>, *<span style="color: #7590db;">aip</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">addrinfo</span>  <span style="color: #7590db;">hint</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> *           <span style="color: #7590db;">host</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sysconf<span style="color: #2d9574;">(</span>_SC_HOST_NAME_MAX<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        n = HOST_NAME_MAX;
    <span style="color: #bc6ec5;">}</span>

    host = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">char</span><span style="color: #bc6ec5;">[</span>n<span style="color: #bc6ec5;">]</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>gethostname<span style="color: #2d9574;">(</span>host, n<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        cerr &lt;&lt; <span style="color: #2d9574;">"gethostname: "</span> &lt;&lt; strerror<span style="color: #2d9574;">(</span>errno<span style="color: #2d9574;">)</span> &lt;&lt; endl;
    <span style="color: #bc6ec5;">}</span>

    memset<span style="color: #bc6ec5;">(</span>&amp;hint, <span style="color: #a45bad;">0</span>, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>hint<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    hint.ai_flags     = AI_CANONNAME;
    hint.ai_socktype  = SOCK_STREAM;
    hint.ai_addr      = <span style="color: #a45bad;">NULL</span>;
    hint.ai_canonname = <span style="color: #a45bad;">NULL</span>;
    hint.ai_next      = <span style="color: #a45bad;">NULL</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = getaddrinfo<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"localhost"</span>, <span style="color: #2d9574;">"ftp"</span>, &amp;hint, &amp;ailist<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        cerr &lt;&lt; <span style="color: #2d9574;">"getaddrinfo: "</span> &lt;&lt; gai_strerror<span style="color: #2d9574;">(</span>err<span style="color: #2d9574;">)</span> &lt;&lt; endl;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>aip = ailist; aip; aip = aip-&gt;ai_next<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>fd = socket<span style="color: #b1951d;">(</span>aip-&gt;ai_family, SOCK_STREAM, <span style="color: #a45bad;">0</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            cerr &lt;&lt; <span style="color: #2d9574;">"socket: "</span> &lt;&lt; strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span> &lt;&lt; endl;
        <span style="color: #2d9574;">}</span>

        bind<span style="color: #2d9574;">(</span>fd, aip-&gt;ai_addr, aip-&gt;ai_addrlen<span style="color: #2d9574;">)</span>;

        listen<span style="color: #2d9574;">(</span>fd, <span style="color: #a45bad;">10</span><span style="color: #2d9574;">)</span>;

        <span style="color: #4f97d7; font-weight: bold;">goto</span> <span style="color: #a45bad;">end</span>;
    <span style="color: #bc6ec5;">}</span>

<span style="color: #a45bad;">end</span>:
    fstat<span style="color: #bc6ec5;">(</span>fd, &amp;s<span style="color: #bc6ec5;">)</span>;
    print_stat_info<span style="color: #bc6ec5;">(</span>&amp;s<span style="color: #bc6ec5;">)</span>;
    close<span style="color: #bc6ec5;">(</span>fd<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">delete</span> <span style="color: #bc6ec5;">(</span>host<span style="color: #bc6ec5;">)</span>;

    exit<span style="color: #bc6ec5;">(</span>EXIT_SUCCESS<span style="color: #bc6ec5;">)</span>;

<span style="color: #a45bad;">errout</span>:
    close<span style="color: #bc6ec5;">(</span>fd<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">delete</span> <span style="color: #bc6ec5;">(</span>host<span style="color: #bc6ec5;">)</span>;
    exit<span style="color: #bc6ec5;">(</span>EXIT_FAILURE<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
16.3 <b>NEED TO BE TESTED</b>
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     16ex03.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-01-27</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    amend 16fig17.c for multiple services</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">netdb.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/select.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">syslog.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">BUFLEN</span> <span style="color: #a45bad;">128</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">QLEN</span>   <span style="color: #a45bad;">10</span>

<span style="color: #bc6ec5;">#if</span><span style="color: #bc6ec5;">n</span><span style="color: #bc6ec5;">def</span> HOST_NAME_MAX
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">HOST_NAME_MAX</span> <span style="color: #a45bad;">256</span>
<span style="color: #bc6ec5;">#endif</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">HOST_NAME_MAX</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">initserver</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr</span> *, <span style="color: #ce537a; font-weight: bold;">socklen_t</span>, <span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">serve</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">sockfd</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">clfd</span>;
    <span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>  <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span>BUFLEN<span style="color: #bc6ec5;">]</span>;

    set_cloexec<span style="color: #bc6ec5;">(</span>sockfd<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>;;<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>clfd = accept<span style="color: #b1951d;">(</span>sockfd, <span style="color: #a45bad;">NULL</span>, <span style="color: #a45bad;">NULL</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            syslog<span style="color: #67b11d;">(</span>LOG_ERR, <span style="color: #2d9574;">"ruptimed: accept error: %s"</span>, strerror<span style="color: #b1951d;">(</span>errno<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>;
            exit<span style="color: #67b11d;">(</span>EXIT_FAILURE<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        set_cloexec<span style="color: #2d9574;">(</span>clfd<span style="color: #2d9574;">)</span>;

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>fp = popen<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"/usr/bin/uptime"</span>, <span style="color: #2d9574;">"r"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            sprintf<span style="color: #67b11d;">(</span>buf, <span style="color: #2d9574;">"error: %s\n"</span>, strerror<span style="color: #b1951d;">(</span>errno<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>;
            send<span style="color: #67b11d;">(</span>clfd, buf, strlen<span style="color: #b1951d;">(</span>buf<span style="color: #b1951d;">)</span>, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #67b11d;">(</span>fgets<span style="color: #b1951d;">(</span>buf, BUFLEN, fp<span style="color: #b1951d;">)</span> != <span style="color: #a45bad;">NULL</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                send<span style="color: #b1951d;">(</span>clfd, buf, strlen<span style="color: #4f97d7;">(</span>buf<span style="color: #4f97d7;">)</span>, <span style="color: #a45bad;">0</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
            pclose<span style="color: #67b11d;">(</span>fp<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        close<span style="color: #2d9574;">(</span>clfd<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">addrinfo</span> *<span style="color: #7590db;">ailist</span>, *<span style="color: #7590db;">aip</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">addrinfo</span>  <span style="color: #7590db;">hint</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>              <span style="color: #7590db;">sockfd</span>, <span style="color: #7590db;">err</span>, <span style="color: #7590db;">n</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> *           <span style="color: #7590db;">host</span>;
    <span style="color: #ce537a; font-weight: bold;">fd_set</span>           <span style="color: #7590db;">allset</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc != <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"usage: ruptimed"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>n = sysconf<span style="color: #67b11d;">(</span>_SC_HOST_NAME_MAX<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        n = HOST_NAME_MAX;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>host = <span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #67b11d;">)</span>malloc<span style="color: #67b11d;">(</span>n<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"malloc error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>gethostname<span style="color: #2d9574;">(</span>host, n<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"gethostname error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"hostname: %s\n"</span>, host<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    daemonize<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"ruptimed"</span><span style="color: #bc6ec5;">)</span>;

    memset<span style="color: #bc6ec5;">(</span>&amp;hint, <span style="color: #a45bad;">0</span>, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>hint<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    hint.ai_flags     = AI_CANONNAME;
    hint.ai_socktype  = SOCK_STREAM;
    hint.ai_canonname = <span style="color: #a45bad;">NULL</span>;
    hint.ai_addr      = <span style="color: #a45bad;">NULL</span>;
    hint.ai_next      = <span style="color: #a45bad;">NULL</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = getaddrinfo<span style="color: #67b11d;">(</span>host, <span style="color: #2d9574;">"4000"</span>, &amp;hint, &amp;ailist<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        syslog<span style="color: #2d9574;">(</span>LOG_ERR, <span style="color: #2d9574;">"ruptimed: getaddrinfo error: %s"</span>, gai_strerror<span style="color: #67b11d;">(</span>err<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span>EXIT_FAILURE<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    FD_ZERO<span style="color: #bc6ec5;">(</span>&amp;allset<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>aip = ailist; aip; aip = aip-&gt;ai_next<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>fork<span style="color: #67b11d;">()</span> == <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>sockfd = initserver<span style="color: #4f97d7;">(</span>SOCK_STREAM, aip-&gt;ai_addr, aip-&gt;ai_addrlen,
                                     QLEN<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span> &gt;= <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                serve<span style="color: #b1951d;">(</span>sockfd<span style="color: #b1951d;">)</span>;
                exit<span style="color: #b1951d;">(</span>EXIT_SUCCESS<span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    exit<span style="color: #bc6ec5;">(</span>EXIT_SUCCESS<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
16.4 see below for server program
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     16ex04s.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-01-30</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    server program for returning processes number</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">arpa/inet.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">netdb.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#if</span><span style="color: #bc6ec5;">n</span><span style="color: #bc6ec5;">def</span> HOST_NAME_MAX
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">HOST_NAME_MAX</span> <span style="color: #a45bad;">256</span>
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">print_addrinfo</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">addrinfo</span> *<span style="color: #7590db;">aip</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span>                 <span style="color: #7590db;">abuf</span><span style="color: #bc6ec5;">[</span>INET_ADDRSTRLEN<span style="color: #bc6ec5;">]</span>, <span style="color: #7590db;">abuf6</span><span style="color: #bc6ec5;">[</span>INET6_ADDRSTRLEN<span style="color: #bc6ec5;">]</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr_in</span>  *<span style="color: #7590db;">sinp</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr_in6</span> *<span style="color: #7590db;">sinp6</span>;
    <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span>          *<span style="color: #7590db;">addr</span>;
    <span style="color: #ce537a; font-weight: bold;">short</span>                <span style="color: #7590db;">port</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>aip-&gt;ai_family == AF_INET<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        sinp = <span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr_in</span> *<span style="color: #2d9574;">)</span>aip-&gt;ai_addr;
        addr = inet_ntop<span style="color: #2d9574;">(</span>aip-&gt;ai_family, &amp;sinp-&gt;sin_addr, abuf, aip-&gt;ai_addrlen<span style="color: #2d9574;">)</span>;
        port = ntohs<span style="color: #2d9574;">(</span>sinp-&gt;sin_port<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>aip-&gt;ai_family == AF_INET6<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        sinp6 = <span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr_in6</span>*<span style="color: #2d9574;">)</span>aip-&gt;ai_addr;
        addr  = inet_ntop<span style="color: #2d9574;">(</span>aip-&gt;ai_family, &amp;sinp6-&gt;sin6_addr, abuf, aip-&gt;ai_addrlen<span style="color: #2d9574;">)</span>;
        port  = ntohs<span style="color: #2d9574;">(</span>sinp6-&gt;sin6_port<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    log_msg<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"address: %s"</span>, addr<span style="color: #bc6ec5;">)</span>;
    log_msg<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"port: %d"</span>, port<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">serve</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">addrinfo</span> *<span style="color: #7590db;">aip</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">s</span>, <span style="color: #7590db;">c</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>  <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span>BUFSIZ<span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span>;

    socket<span style="color: #bc6ec5;">(</span>aip-&gt;ai_family, aip-&gt;ai_socktype, <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;

    s = socket<span style="color: #bc6ec5;">(</span>aip-&gt;ai_family, aip-&gt;ai_socktype, <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>s &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        log_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"socket error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>bind<span style="color: #2d9574;">(</span>s, aip-&gt;ai_addr, aip-&gt;ai_addrlen<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        log_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"bind error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>listen<span style="color: #2d9574;">(</span>s, <span style="color: #a45bad;">10</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        log_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"listen error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>;;<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        c = accept<span style="color: #2d9574;">(</span>s, <span style="color: #a45bad;">NULL</span>, <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>c &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            log_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"accept error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>fcntl<span style="color: #67b11d;">(</span>c, F_SETFD, fcntl<span style="color: #b1951d;">(</span>c, F_GETFD, <span style="color: #a45bad;">0</span><span style="color: #b1951d;">)</span> | FD_CLOEXEC<span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            log_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"fcntl error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>fp = popen<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"ps -ef | wc -l "</span>, <span style="color: #2d9574;">"r"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            snprintf<span style="color: #67b11d;">(</span>buf, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #b1951d;">(</span>buf<span style="color: #b1951d;">)</span>, <span style="color: #2d9574;">"%s"</span>, strerror<span style="color: #b1951d;">(</span>errno<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>;
            err_msg<span style="color: #67b11d;">(</span>buf<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            fgets<span style="color: #67b11d;">(</span>buf, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #b1951d;">(</span>buf<span style="color: #b1951d;">)</span>, fp<span style="color: #67b11d;">)</span>;
            send<span style="color: #67b11d;">(</span>c, buf, strlen<span style="color: #b1951d;">(</span>buf<span style="color: #b1951d;">)</span>, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        pclose<span style="color: #2d9574;">(</span>fp<span style="color: #2d9574;">)</span>;
        close<span style="color: #2d9574;">(</span>c<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">addrinfo</span>     *<span style="color: #7590db;">ailist</span>, *<span style="color: #7590db;">aip</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">addrinfo</span>      <span style="color: #7590db;">hint</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>                *<span style="color: #7590db;">host</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>                  <span style="color: #7590db;">err</span>;
    <span style="color: #ce537a; font-weight: bold;">size_t</span>               <span style="color: #7590db;">n</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>n = sysconf<span style="color: #67b11d;">(</span>_SC_HOST_NAME_MAX<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        n = HOST_NAME_MAX;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>host = <span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #67b11d;">)</span>malloc<span style="color: #67b11d;">(</span>n<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"malloc error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>gethostname<span style="color: #2d9574;">(</span>host, n<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"gethostname error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    daemonize<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"PS Number"</span><span style="color: #bc6ec5;">)</span>;

    log_msg<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"service started"</span><span style="color: #bc6ec5;">)</span>;

    memset<span style="color: #bc6ec5;">(</span>&amp;hint, <span style="color: #a45bad;">0</span>, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>hint<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    hint.ai_flags     = AI_CANONNAME;
    hint.ai_socktype  = SOCK_STREAM;
    hint.ai_addr      = <span style="color: #a45bad;">NULL</span>;
    hint.ai_canonname = <span style="color: #a45bad;">NULL</span>;
    hint.ai_next      = <span style="color: #a45bad;">NULL</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = getaddrinfo<span style="color: #67b11d;">(</span>host, <span style="color: #2d9574;">"4000"</span>, &amp;hint, &amp;ailist<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        log_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"getaddrinfo error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>aip = ailist; aip; aip = aip-&gt;ai_next<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>fork<span style="color: #67b11d;">()</span> == <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            print_addrinfo<span style="color: #67b11d;">(</span>aip<span style="color: #67b11d;">)</span>;
            serve<span style="color: #67b11d;">(</span>aip<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
16.5
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     16ex05.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-01-22</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  2.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    server program illustrating command wrting directly to socket</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> *   redesign for no-delay processing</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">netdb.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">syslog.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">QLEN</span> <span style="color: #a45bad;">10</span>

<span style="color: #bc6ec5;">#if</span><span style="color: #bc6ec5;">n</span><span style="color: #bc6ec5;">def</span> HOST_NAME_MAX
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">HOST_NAME_MAX</span> <span style="color: #a45bad;">256</span>
<span style="color: #bc6ec5;">#endif</span>  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">HOST_NAME_MAX</span>

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">initserver</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr</span> *, <span style="color: #ce537a; font-weight: bold;">socklen_t</span>, <span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">serve</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">sockfd</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">clfd</span>, <span style="color: #7590db;">status</span>;
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;

    set_cloexec<span style="color: #bc6ec5;">(</span>sockfd<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>;;<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>clfd = accept<span style="color: #b1951d;">(</span>sockfd, <span style="color: #a45bad;">NULL</span>, <span style="color: #a45bad;">NULL</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            syslog<span style="color: #67b11d;">(</span>LOG_ERR, <span style="color: #2d9574;">"ruptimed: accept error: %s"</span>, strerror<span style="color: #b1951d;">(</span>errno<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>;
            exit<span style="color: #67b11d;">(</span>EXIT_FAILURE<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>pid = fork<span style="color: #b1951d;">()</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            syslog<span style="color: #67b11d;">(</span>LOG_ERR, <span style="color: #2d9574;">"ruptimed: fork error: %s"</span>, strerror<span style="color: #b1951d;">(</span>errno<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>;
            exit<span style="color: #67b11d;">(</span>EXIT_FAILURE<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">child</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>dup2<span style="color: #b1951d;">(</span>clfd, STDOUT_FILENO<span style="color: #b1951d;">)</span> != STDOUT_FILENO ||
                dup2<span style="color: #b1951d;">(</span>clfd, STDERR_FILENO<span style="color: #b1951d;">)</span> != STDERR_FILENO<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                syslog<span style="color: #b1951d;">(</span>LOG_ERR, <span style="color: #2d9574;">"ruptimed: unexpected error"</span><span style="color: #b1951d;">)</span>;
                exit<span style="color: #b1951d;">(</span>EXIT_FAILURE<span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
            close<span style="color: #67b11d;">(</span>clfd<span style="color: #67b11d;">)</span>;
            execl<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"/usr/bin/uptime"</span>, <span style="color: #2d9574;">"uptime"</span>, <span style="color: #b1951d;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #b1951d;">)</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span>;
            syslog<span style="color: #67b11d;">(</span>LOG_ERR, <span style="color: #2d9574;">"ruptimed: unexpected return from exec: %s"</span>,
                   strerror<span style="color: #b1951d;">(</span>errno<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            close<span style="color: #67b11d;">(</span>clfd<span style="color: #67b11d;">)</span>;
            waitpid<span style="color: #67b11d;">(</span>pid, &amp;status, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">addrinfo</span> *<span style="color: #7590db;">ailist</span>, *<span style="color: #7590db;">aip</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">addrinfo</span>  <span style="color: #7590db;">hint</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>              <span style="color: #7590db;">sockfd</span>, <span style="color: #7590db;">err</span>, <span style="color: #7590db;">n</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> *           <span style="color: #7590db;">host</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc != <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"usage: ruptimed"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>n = sysconf<span style="color: #67b11d;">(</span>_SC_HOST_NAME_MAX<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        n = HOST_NAME_MAX;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>host = malloc<span style="color: #67b11d;">(</span>n<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"malloc error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>gethostname<span style="color: #2d9574;">(</span>host, n<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"gethostname error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    daemonize<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"ruptimed"</span><span style="color: #bc6ec5;">)</span>;

    memset<span style="color: #bc6ec5;">(</span>&amp;hint, <span style="color: #a45bad;">0</span>, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>hint<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    hint.ai_flags     = AI_CANONNAME;
    hint.ai_socktype  = SOCK_STREAM;
    hint.ai_canonname = <span style="color: #a45bad;">NULL</span>;
    hint.ai_addr      = <span style="color: #a45bad;">NULL</span>;
    hint.ai_next      = <span style="color: #a45bad;">NULL</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = getaddrinfo<span style="color: #67b11d;">(</span>host, <span style="color: #2d9574;">"4000"</span>, &amp;hint, &amp;ailist<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        syslog<span style="color: #2d9574;">(</span>LOG_ERR, <span style="color: #2d9574;">"ruptimed: getaddrinfo error: %s"</span>, gai_strerror<span style="color: #67b11d;">(</span>err<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span>EXIT_FAILURE<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>aip = ailist; aip != <span style="color: #a45bad;">NULL</span>; aip = aip-&gt;ai_next<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>fork<span style="color: #67b11d;">()</span> == <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>sockfd = initserver<span style="color: #4f97d7;">(</span>SOCK_STREAM, aip-&gt;ai_addr, aip-&gt;ai_addrlen,
                                     QLEN<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span> &gt;= <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                serve<span style="color: #b1951d;">(</span>sockfd<span style="color: #b1951d;">)</span>;
                exit<span style="color: #b1951d;">(</span>EXIT_SUCCESS<span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #67b11d;">{</span>
                close <span style="color: #b1951d;">(</span>sockfd<span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
    exit<span style="color: #bc6ec5;">(</span>EXIT_FAILURE<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
16.6
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     16ex06.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-01-31</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    routines to set/unset socket asynchronous</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> *  Detailed description</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">setasync</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">sockfd</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">n</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>fcntl<span style="color: #2d9574;">(</span>sockfd, F_SETOWN, getpid<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
    <span style="color: #bc6ec5;">}</span>

    n = <span style="color: #a45bad;">1</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ioctl<span style="color: #2d9574;">(</span>sockfd, FIOASYNC, &amp;n<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">unsetasync</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">sockfd</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">n</span> = <span style="color: #a45bad;">0</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ioctl<span style="color: #2d9574;">(</span>sockfd, FIOASYNC, &amp;n<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org70c72ba" class="outline-3">
<h3 id="org70c72ba"><span class="todo TODO">TODO</span> Chapter 17. Advanced IPC <code>[3/7]</code></h3>
<div class="outline-text-3" id="text-org70c72ba">
</div>
<div id="outline-container-org3ec8f15" class="outline-4">
<h4 id="org3ec8f15"><span class="done DONE">DONE</span> 17.1 Introduction</h4>
<div class="outline-text-4" id="text-org3ec8f15">
</div>
</div>

<div id="outline-container-orga84e8c2" class="outline-4">
<h4 id="orga84e8c2"><span class="done DONE">DONE</span> 17.2 UNIX Domain Sockets</h4>
<div class="outline-text-4" id="text-orga84e8c2">
<p>
UNIX domain sockts are used to communicate with processes running on the same machines.
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;"> create a pair of unamed, connected, UNIX domain sockets.</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;"> 0 if OK, -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">socketpair</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">domain</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">type</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">protocol</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">sockfd</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>


<div id="org1d560b9" class="figure">
<p><img src="Chapter17/17fig01.jpg" alt="17fig01.jpg" />
</p>
<p><span class="figure-number">Figure 50: </span>Figure 17.1 A socket pair</p>
</div>

<ul class="org-ul">
<li><p>
Example &#x2013; fd_pipe Functions
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 141: </span>Figure 17.2 Creating a full-duplex pipe</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     17fig02.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-01-31</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    create a full-duplex pipe by socketpair</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;"> returns a full-duplex pipe (a UNIX domain socket)</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> *  with the two file descriptors returned in fd[0] and fd[1].</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">fd_pipe</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>socketpair<span style="color: #2d9574;">(</span>AF_UNIX, SOCK_STREAM, <span style="color: #a45bad;">0</span>, fd<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
Example &#x2013; Polling XSI Message Queues with the Help of UNIX Domain Sockets
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 142: </span>Figure 17.3 Poll for XSI Messsages using UNIX domain sockets</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     pollmsg.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-01-31</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Poll for XSI message using UNIX domain sockets</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">poll.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/msg.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">NQ</span>     <span style="color: #a45bad;">3</span>      <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">number of queues</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">MAXMSZ</span> <span style="color: #a45bad;">512</span>    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">maximum message size</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">KEY</span>    <span style="color: #a45bad;">0x123</span>  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">key for first message queus</span>

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">threadinfo</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">qid</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>;
<span style="color: #4f97d7;">}</span>;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">mymesg</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">mtype</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">mtext</span><span style="color: #bc6ec5;">[</span>MAXMSZ<span style="color: #bc6ec5;">]</span>;
<span style="color: #4f97d7;">}</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">helper</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>                <span style="color: #7590db;">n</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">mymesg</span>      <span style="color: #7590db;">m</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">threadinfo</span> *<span style="color: #7590db;">tip</span> = arg;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>;;<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        memset<span style="color: #2d9574;">(</span>&amp;m, <span style="color: #a45bad;">0</span>, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span>m<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>n = msgrcv<span style="color: #b1951d;">(</span>tip-&gt;qid, &amp;m, MAXMSZ, <span style="color: #a45bad;">0</span>, MSG_NOERROR<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"msgrcv error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>write<span style="color: #b1951d;">(</span>tip-&gt;fd, m.mtext, n<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"write error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>               <span style="color: #7590db;">i</span>, <span style="color: #7590db;">n</span>, <span style="color: #7590db;">err</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>               <span style="color: #7590db;">fd</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>               <span style="color: #7590db;">qid</span><span style="color: #bc6ec5;">[</span>NQ<span style="color: #bc6ec5;">]</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">pollfd</span>     <span style="color: #7590db;">pfd</span><span style="color: #bc6ec5;">[</span>NQ<span style="color: #bc6ec5;">]</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">threadinfo</span> <span style="color: #7590db;">ti</span><span style="color: #bc6ec5;">[</span>NQ<span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_t</span>         <span style="color: #7590db;">tid</span><span style="color: #bc6ec5;">[</span>NQ<span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>              <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span>MAXMSZ<span style="color: #bc6ec5;">]</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; NQ; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>qid<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span> = msgget<span style="color: #b1951d;">(</span><span style="color: #4f97d7;">(</span>KEY + i<span style="color: #4f97d7;">)</span>, IPC_CREAT | <span style="color: #a45bad;">0666</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"msgget error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"queue-%d &lt; %d &gt; \n"</span>, i, qid<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>socketpair<span style="color: #b1951d;">(</span>AF_UNIX, SOCK_DGRAM, <span style="color: #a45bad;">0</span>, fd<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"socketpair error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        pfd<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>.fd     = fd<span style="color: #2d9574;">[</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">]</span>;
        pfd<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>.events = POLLIN;
        ti<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>.qid     = qid<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>;
        ti<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>.fd      = fd<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>;

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>err = pthread_create<span style="color: #b1951d;">(</span>&amp;tid<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span>, <span style="color: #a45bad;">NULL</span>, helper, &amp;ti<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_exit<span style="color: #67b11d;">(</span>err, <span style="color: #2d9574;">"pthread_create error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>;;<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>poll<span style="color: #67b11d;">(</span>pfd, NQ, -<span style="color: #a45bad;">1</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"poll error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #2d9574;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; NQ; ++i<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>pfd<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span>.revents &amp; POLLIN<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #b1951d;">(</span><span style="color: #4f97d7;">(</span>n = read<span style="color: #bc6ec5;">(</span>pfd<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>.fd, buf, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>buf<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #b1951d;">)</span> <span style="color: #b1951d;">{</span>
                    err_sys<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"read error"</span><span style="color: #4f97d7;">)</span>;
                <span style="color: #b1951d;">}</span>

                buf<span style="color: #b1951d;">[</span>n<span style="color: #b1951d;">]</span> = <span style="color: #a45bad;">0</span>;
                printf<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"queue &lt;%d&gt;: %s\n"</span>, qid<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span>, buf<span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 143: </span>Figure 17.4 Post a message to XSI message queue</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     17fig04.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-02-01</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Post a message to an XSI message queue</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/msg.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">MAXMSZ</span> <span style="color: #a45bad;">512</span>

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">__progname</span>;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">mymesg</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">mtype</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">mtext</span><span style="color: #bc6ec5;">[</span>MAXMSZ<span style="color: #bc6ec5;">]</span>;
<span style="color: #4f97d7;">}</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">key_t</span>         <span style="color: #7590db;">key</span>;
    <span style="color: #ce537a; font-weight: bold;">long</span>          <span style="color: #7590db;">qid</span>;
    <span style="color: #ce537a; font-weight: bold;">size_t</span>        <span style="color: #7590db;">nbytes</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">mymesg</span> <span style="color: #7590db;">m</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc != <span style="color: #a45bad;">3</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        fprintf<span style="color: #2d9574;">(</span>stderr, <span style="color: #2d9574;">"usage: %s KEY message\n"</span>, __progname<span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span>EXIT_FAILURE<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    key = strtol<span style="color: #bc6ec5;">(</span>argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>, <span style="color: #a45bad;">NULL</span>, <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>qid = msgget<span style="color: #67b11d;">(</span>key, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"can't open queue key %s"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    memset<span style="color: #bc6ec5;">(</span>&amp;m, <span style="color: #a45bad;">0</span>, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>m<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    snprintf<span style="color: #bc6ec5;">(</span>m.mtext, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>m.mtext<span style="color: #2d9574;">)</span>, <span style="color: #2d9574;">"%s"</span>, argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">2</span><span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span>;
    nbytes  = strlen<span style="color: #bc6ec5;">(</span>m.mtext<span style="color: #bc6ec5;">)</span>;
    m.mtype = <span style="color: #a45bad;">1</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>msgsnd<span style="color: #2d9574;">(</span>qid, &amp;m, nbytes, <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"can't send message"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    exit<span style="color: #bc6ec5;">(</span>EXIT_FAILURE<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>

<ul class="org-ul">
<li><a id="org821a88c"></a><span class="done DONE">DONE</span> 17.2.1 Naming UNIX Domain Sockets<br />
<div class="outline-text-5" id="text-org821a88c">
<p>
Unamed socket pairs can't be addressed by unrelated processes.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      UNIX domain socket on Linux 3.2.0 and Solaris 10,</span>
<span style="color: #9f8766;"> *  *             defined in &lt;sys/un.h&gt;</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr_un</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #ce537a; font-weight: bold;">sa_family_t</span> <span style="color: #7590db;">sun_family</span>;     <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">AF_UNIX</span>
        <span style="color: #ce537a; font-weight: bold;">char</span>        <span style="color: #7590db;">sun_path</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">108</span><span style="color: #bc6ec5;">]</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">pathname</span>
<span style="color: #4f97d7;">}</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      UNIX domain socket on FreeBSD 8.0 and Mac OS X 10.6.8</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr_un</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">sun_len</span>;        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">sockaddr length</span>
        <span style="color: #ce537a; font-weight: bold;">sa_family_t</span>   <span style="color: #7590db;">sun_family</span>;     <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">AF_UNIX</span>
        <span style="color: #ce537a; font-weight: bold;">char</span>          <span style="color: #7590db;">sun_path</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">104</span><span style="color: #bc6ec5;">]</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">pathname</span>
<span style="color: #4f97d7;">}</span>;
</pre>
</div>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 144: </span>Figure 17.5 Binding an address to a UNIX domain socket</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     17fig05.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-02-01</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    Binding an address to a UNIX domain socket</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/un.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>                <span style="color: #7590db;">fd</span>, <span style="color: #7590db;">size</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr_un</span> <span style="color: #7590db;">un</span>;

    un.sun_family = AF_UNIX;
    snprintf<span style="color: #bc6ec5;">(</span>un.sun_path, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>un.sun_path<span style="color: #2d9574;">)</span>, <span style="color: #2d9574;">"%s"</span>, <span style="color: #2d9574;">"foo.socket"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fd = socket<span style="color: #67b11d;">(</span>un.sun_family, SOCK_STREAM, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"socket error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    size = offsetof<span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr_un</span>, sun_path<span style="color: #bc6ec5;">)</span> + strlen<span style="color: #bc6ec5;">(</span>un.sun_path<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>bind<span style="color: #2d9574;">(</span>fd, <span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr</span> *<span style="color: #67b11d;">)</span>&amp;un, size<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"bind error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"UNIX domain socket bound\n"</span><span style="color: #bc6ec5;">)</span>;
    exit<span style="color: #bc6ec5;">(</span>EXIT_SUCCESS<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>
</ul>
</div>

<div id="outline-container-org8344e04" class="outline-4">
<h4 id="org8344e04"><span class="done DONE">DONE</span> 17.3 Unique Connections</h4>
<div class="outline-text-4" id="text-org8344e04">

<div id="org5b11a4d" class="figure">
<p><img src="Chapter17/17fig06.jpg" alt="17fig06.jpg" />
</p>
<p><span class="figure-number">Figure 51: </span>Figure 17.6 Client and server sockets before a <code>connect</code></p>
</div>


<div id="orgeb0fec2" class="figure">
<p><img src="Chapter17/17fig07.jpg" alt="17fig07.jpg" />
</p>
<p><span class="figure-number">Figure 52: </span>Figure 17.7 Client and server sockets after a <code>connect</code></p>
</div>

<p>
develop three functions can be used to create unique connections between unrelated processes running on same machine:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">@return: file descriptor to listen on if OK, negative value on error</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">serv_listen</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">@return: new file descriptor if OK, negative value on Error</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">serv_accept</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">listenfd</span>, <span style="color: #ce537a; font-weight: bold;">uid_t</span> *<span style="color: #7590db;">uidptr</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">@return: file descriptor if OK, negative value on error</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">cli_conn</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 145: </span>Figure 17.8 The <code>serv_listen</code> function</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     17fig08.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-02-01</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    The serv-listen function</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/un.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">QLEN</span> <span style="color: #a45bad;">10</span>

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">  create a server endpoint of a connection,</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;"> fd if all OK, &lt; 0 on error</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">serv_listen</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>                <span style="color: #7590db;">fd</span>, <span style="color: #7590db;">err</span>, <span style="color: #7590db;">val</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr_un</span> <span style="color: #7590db;">un</span>;
    <span style="color: #ce537a; font-weight: bold;">socklen_t</span>          <span style="color: #7590db;">len</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>strlen<span style="color: #2d9574;">(</span>name<span style="color: #2d9574;">)</span> &gt;= <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>un.sun_path<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        errno = ENAMETOOLONG;
        <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">create a UNIX domain socket</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fd = socket<span style="color: #67b11d;">(</span>AF_UNIX, SOCK_STREAM, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">2</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">in case it already existss</span>
    unlink<span style="color: #bc6ec5;">(</span>name<span style="color: #bc6ec5;">)</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">fill in socket adress structure</span>
    memset<span style="color: #bc6ec5;">(</span>&amp;un, <span style="color: #a45bad;">0</span>, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>un<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    un.sun_family = AF_UNIX;
    snprintf<span style="color: #bc6ec5;">(</span>un.sun_path, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>un.sun_path<span style="color: #2d9574;">)</span>, <span style="color: #2d9574;">"%s"</span>, name<span style="color: #bc6ec5;">)</span>;
    len = offsetof<span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr_un</span>, sun_path<span style="color: #bc6ec5;">)</span> + strlen<span style="color: #bc6ec5;">(</span>un.sun_path<span style="color: #bc6ec5;">)</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">bind the name to the descriptor</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>bind<span style="color: #2d9574;">(</span>fd, <span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr</span> *<span style="color: #67b11d;">)</span>&amp;un, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span>un<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">3</span>;
        <span style="color: #4f97d7; font-weight: bold;">goto</span> <span style="color: #a45bad;">errout</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>listen<span style="color: #2d9574;">(</span>fd, QLEN<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">4</span>;
        <span style="color: #4f97d7; font-weight: bold;">goto</span> <span style="color: #a45bad;">errout</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> fd;

<span style="color: #a45bad;">errout</span>:
    err = errno;
    close<span style="color: #bc6ec5;">(</span>fd<span style="color: #bc6ec5;">)</span>;
    errno = err;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>val<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 146: </span>Figure 17.9 The <code>serv_accept</code> function</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     17fig09.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-02-01</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    The serv_accept function</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/un.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">time.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">client's name can't be older than this (sec)</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">STALE</span> <span style="color: #a45bad;">30</span>

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;"> wait for client connection to arrive and accept it</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> *  We also obtain the client's user ID from the pathname</span>
<span style="color: #9f8766;"> *  that it must bind before calling us.</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> *  </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;"> new fd if all OK, &lt;0 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">serv_accept</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">listenfd</span>, <span style="color: #ce537a; font-weight: bold;">uid_t</span> *<span style="color: #7590db;">uidptr</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span> *             <span style="color: #7590db;">name</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>                <span style="color: #7590db;">c</span>, <span style="color: #7590db;">err</span>, <span style="color: #7590db;">ret</span>;
    <span style="color: #ce537a; font-weight: bold;">time_t</span>             <span style="color: #7590db;">staletime</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr_un</span> <span style="color: #7590db;">un</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">stat</span>        <span style="color: #7590db;">statbuf</span>;
    <span style="color: #ce537a; font-weight: bold;">socklen_t</span>          <span style="color: #7590db;">len</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">allocate enough space for longest name plus terminating null</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>name = malloc<span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #b1951d;">(</span>un.sun_path<span style="color: #b1951d;">)</span> + <span style="color: #a45bad;">1</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
    <span style="color: #bc6ec5;">}</span>

    len = <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #bc6ec5;">(</span>un<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>c = accept<span style="color: #67b11d;">(</span>listenfd, <span style="color: #b1951d;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr</span> *<span style="color: #b1951d;">)</span>&amp;un, &amp;len<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        free<span style="color: #2d9574;">(</span>name<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">2</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">obtain the client's uid from its calling address</span>
    len -= offsetof<span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr_un</span>, sun_path<span style="color: #bc6ec5;">)</span>;
    memcpy<span style="color: #bc6ec5;">(</span>name, un.sun_path, len<span style="color: #bc6ec5;">)</span>;
    name<span style="color: #bc6ec5;">[</span>len<span style="color: #bc6ec5;">]</span> = <span style="color: #a45bad;">0</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>stat<span style="color: #2d9574;">(</span>name, &amp;statbuf<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        ret = -<span style="color: #a45bad;">3</span>;
        <span style="color: #4f97d7; font-weight: bold;">goto</span> <span style="color: #a45bad;">errout</span>;
    <span style="color: #bc6ec5;">}</span>

<span style="color: #bc6ec5;">#ifdef</span> S_ISSOCK

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>S_ISSOCK<span style="color: #2d9574;">(</span>statbuf.st_mode<span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">not a socket</span>
        ret = -<span style="color: #a45bad;">4</span>;
        <span style="color: #4f97d7; font-weight: bold;">goto</span> <span style="color: #a45bad;">errout</span>;
    <span style="color: #bc6ec5;">}</span>

<span style="color: #bc6ec5;">#endif</span>  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">S_ISSOCK</span>

    staletime = time<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> - STALE;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>statbuf.st_mode &amp; <span style="color: #67b11d;">(</span>S_IRWXG | S_IRWXO<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> ||
<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #2d9574;">(</span>__APPLE__<span style="color: #2d9574;">)</span>
        <span style="color: #2d9574;">(</span>statbuf.st_atimespec.tv_sec &lt; staletime<span style="color: #2d9574;">)</span> ||
        <span style="color: #2d9574;">(</span>statbuf.st_ctimespec.tv_sec &lt; staletime<span style="color: #2d9574;">)</span> ||
        <span style="color: #2d9574;">(</span>statbuf.st_mtimespec.tv_sec &lt; staletime<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
<span style="color: #bc6ec5;">#elif</span> <span style="color: #bc6ec5;">defined</span><span style="color: #2d9574;">(</span>__linux__<span style="color: #2d9574;">)</span>
        <span style="color: #2d9574;">(</span>statbuf.st_atime &lt; staletime<span style="color: #2d9574;">)</span> || <span style="color: #2d9574;">(</span>statbuf.st_ctime &lt; staletime<span style="color: #2d9574;">)</span> ||
        <span style="color: #2d9574;">(</span>statbuf.st_mtime &lt; staletime<span style="color: #2d9574;">)</span><span style="color: #e0211d; text-decoration: overline;">)</span> <span style="color: #bc6ec5;">{</span>
<span style="color: #bc6ec5;">#endif</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">i-node is too old</span>
        ret = -<span style="color: #a45bad;">6</span>;
        <span style="color: #4f97d7; font-weight: bold;">goto</span> <span style="color: #a45bad;">errout</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>uidptr != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        *uidptr = statbuf.st_uid;
    <span style="color: #bc6ec5;">}</span>

    unlink<span style="color: #bc6ec5;">(</span>name<span style="color: #bc6ec5;">)</span>;
    free<span style="color: #bc6ec5;">(</span>name<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> c;

<span style="color: #a45bad;">errout</span>:
    err = errno;
    close<span style="color: #bc6ec5;">(</span>c<span style="color: #bc6ec5;">)</span>;
    free<span style="color: #bc6ec5;">(</span>name<span style="color: #bc6ec5;">)</span>;
    errno = err;
    <span style="color: #4f97d7; font-weight: bold;">return</span> ret;
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 147: </span>Figure 17.10 The <code>cli_conn</code> function</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     17fig10.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-02-01</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    The cli_conn function</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/un.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">CLI_PATH</span> <span style="color: #2d9574;">"/var/tmp"</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">CLI_PERM</span> S_IRWXU <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">rwx for user only</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>

<span style="color: #2aa1ae; background-color: #292e34;">/*</span>
<span style="color: #2aa1ae; background-color: #292e34;"> * @brief        Create a client endpoint and connect to a server.</span>
<span style="color: #2aa1ae; background-color: #292e34;"> * @return       fd if all OK, &lt;0 on error.</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">cli_conn</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>                <span style="color: #7590db;">fd</span>, <span style="color: #7590db;">err</span>, <span style="color: #7590db;">ret</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr_un</span> <span style="color: #7590db;">un</span>, <span style="color: #7590db;">sun</span>;
    <span style="color: #ce537a; font-weight: bold;">socklen_t</span>          <span style="color: #7590db;">len</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>                <span style="color: #7590db;">do_unlink</span> = <span style="color: #a45bad;">0</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>strlen<span style="color: #2d9574;">(</span>name<span style="color: #2d9574;">)</span> &gt;= <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>un.sun_path<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        errno = ENAMETOOLONG;
        <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">create a UNIX domain socket</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fd = socket<span style="color: #67b11d;">(</span>AF_UNIX, SOCK_STREAM, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">fill socket address structure with our address</span>
    memset<span style="color: #bc6ec5;">(</span>&amp;un, <span style="color: #a45bad;">0</span>, sizoef<span style="color: #2d9574;">(</span>un<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    un.sun_family = AF_UNIX;
    len           = <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #bc6ec5;">(</span>un.sun_path<span style="color: #bc6ec5;">)</span>;
    snprintf<span style="color: #bc6ec5;">(</span>un.sun_path, len, <span style="color: #2d9574;">"%s%05ld"</span>, CLI_PATH, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>getpid<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">incase it already exists</span>
    unlink<span style="color: #bc6ec5;">(</span>un.sun_path<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>bind<span style="color: #2d9574;">(</span>fd, <span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr</span> *<span style="color: #67b11d;">)</span>&amp;un, len<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        ret = -<span style="color: #a45bad;">2</span>;
        <span style="color: #4f97d7; font-weight: bold;">goto</span> <span style="color: #a45bad;">errout</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>chmod<span style="color: #2d9574;">(</span>un.sun_path, CLI_PERM<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        ret       = -<span style="color: #a45bad;">3</span>;
        do_unlink = <span style="color: #a45bad;">1</span>;
        <span style="color: #4f97d7; font-weight: bold;">goto</span> <span style="color: #a45bad;">errout</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">fill socket address structure with server's address</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
    memset<span style="color: #bc6ec5;">(</span>&amp;sun, <span style="color: #a45bad;">0</span>, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>sun<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    sun.sun_family = AF_UNIX;
    len            = <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #bc6ec5;">(</span>sun.sun_path<span style="color: #bc6ec5;">)</span>;
    snprintf<span style="color: #bc6ec5;">(</span>sun.sun_path, len, <span style="color: #2d9574;">"%s"</span>, name<span style="color: #bc6ec5;">)</span>;
    len = offsetof<span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr_un</span>, sun_path<span style="color: #bc6ec5;">)</span> + strlen<span style="color: #bc6ec5;">(</span>un.sun_path<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>connect<span style="color: #2d9574;">(</span>fd, <span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr</span> *<span style="color: #67b11d;">)</span>&amp;sun, len<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        ret       = -<span style="color: #a45bad;">4</span>;
        do_unlink = <span style="color: #a45bad;">1</span>;
        <span style="color: #4f97d7; font-weight: bold;">goto</span> <span style="color: #a45bad;">errout</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> fd;

<span style="color: #a45bad;">errout</span>:
    err = errno;
    close<span style="color: #bc6ec5;">(</span>fd<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>do_unlink<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        unlink<span style="color: #2d9574;">(</span>un.sun_path<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    errno = err;
    <span style="color: #4f97d7; font-weight: bold;">return</span> ret;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org38c0476" class="outline-4">
<h4 id="org38c0476"><span class="todo TODO">TODO</span> 17.4 Passing File Descriptors</h4>
<div class="outline-text-4" id="text-org38c0476">
<blockquote>
<p>
It can lead to different ways of designing client-server applications.
It allows one process (typically a server) to do everything that is required to open a file
(involving such details as translating a network name to a network address, dialing a modem, and neogiating
locks for the file) and simply pass back to the calling process a descriptor that can be used with all the I/O functions.
</p>
</blockquote>


<div id="org902c5f4" class="figure">
<p><img src="Chapter17/17fig11.jpg" alt="17fig11.jpg" />
</p>
<p><span class="figure-number">Figure 53: </span>Figure 17.11 Passing an open file from the top process to the bottom process</p>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">       send file descriptor</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@detail</span><span style="color: #9f8766;">      sends the descriptor fd_to_send across</span>
<span style="color: #9f8766;"> * using the UNIX domain socket represented by fd.</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">      0 if OK, -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">send_fd</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd_to_send</span><span style="color: #4f97d7;">)</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">      send file descriptor</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@detail</span><span style="color: #9f8766;">     sends the errmsg using fd, followed by</span>
<span style="color: #9f8766;"> * the status byte. The value of status must be in the</span>
<span style="color: #9f8766;"> * range -1 through -255.</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">     0 if OK, -1 on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">send_err</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">status</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">errmsg</span><span style="color: #4f97d7;">)</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">     receive file descriptor</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@detail</span><span style="color: #9f8766;">    if error, the value returned is the status</span>
<span style="color: #9f8766;"> * that was sent by send_err (a negative value in the range -1 through -255).</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">     userfunc  process the message (often was write)</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">     1st     STDERR_FILENO</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">     2nd     a pointer to the e rror message</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@param</span><span style="color: #9f8766;">     3st     length of message</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">    number of bytes written or a negative number on error.</span>
<span style="color: #9f8766;"> *</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">    the file descriptor if OK, negative value on error</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">recv_fd</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>, <span style="color: #ce537a; font-weight: bold;">sszie_t</span> <span style="color: #bc6ec5;">(</span>*<span style="color: #bc6ec5; font-weight: bold;">userfunc</span><span style="color: #bc6ec5;">)(</span><span style="color: #ce537a; font-weight: bold;">int</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">void</span> *, <span style="color: #ce537a; font-weight: bold;">size_t</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 148: </span>Figure 17.12 The <code>send_err</code> function</label><pre class="src src-c"><span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@file</span><span style="color: #9f8766;">     17fig12.c</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@date</span><span style="color: #9f8766;">     2020-02-02</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@author</span><span style="color: #9f8766;">   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81</a></span><span style="color: #a45bad;"><a href="mailto:whiothes81%40gmail.com">@gmail</a></span><span style="color: #9f8766;"><a href="mailto:whiothes81%40gmail.com">.com&gt;</a></span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@version</span><span style="color: #9f8766;">  1.0</span>
<span style="color: #9f8766;"> *   </span><span style="color: #a45bad;">@brief</span><span style="color: #9f8766;">    The send_err function</span>
<span style="color: #9f8766;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #2aa1ae; background-color: #292e34;">/*</span>
<span style="color: #2aa1ae; background-color: #292e34;"> * Used when we had planned to send an fd using send_fd(),</span>
<span style="color: #2aa1ae; background-color: #292e34;"> * but encountered an error instead. We send the error back</span>
<span style="color: #2aa1ae; background-color: #292e34;"> * using the send_fd()/recv_fd() protocol.</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">send_err</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">errcode</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">msg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">n</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>n = strlen<span style="color: #67b11d;">(</span>msg<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>write<span style="color: #67b11d;">(</span>fd, msg, strlen<span style="color: #b1951d;">(</span>msg<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> != n<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">send the error message</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
            <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>errcode &gt;= <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">must be negative</span><span style="color: #2aa1ae; background-color: #292e34;"> */</span>
        errcode = -<span style="color: #a45bad;">1</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>send_fd<span style="color: #2d9574;">(</span>fd, errcode<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<p>
call sendmsg and recvmsg functions to take a pointer to <code>msghdr</code> strcture to exchange file descriptors using UNIX domain sockets
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">msghdr</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #ce537a; font-weight: bold;">void</span> *        <span style="color: #7590db;">msg_name</span>;     <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">optional address</span>
        <span style="color: #ce537a; font-weight: bold;">socklen_t</span>     <span style="color: #7590db;">msg_namelen</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">address size in bytes</span>
        <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">iovec</span> *<span style="color: #7590db;">msg_iov</span>;      <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">array of I/O buffers</span>
        <span style="color: #ce537a; font-weight: bold;">int</span>           <span style="color: #7590db;">msg_iovlen</span>;   <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">number of elements in array</span>
        <span style="color: #ce537a; font-weight: bold;">void</span> *        <span style="color: #7590db;">msg_control</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">ancillary adata</span>
        <span style="color: #ce537a; font-weight: bold;">int</span>           <span style="color: #7590db;">msg_flags</span>;    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">flags for received message</span>
<span style="color: #4f97d7;">}</span>;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">cmsghdr</span> <span style="color: #4f97d7;">{</span>
        <span style="color: #ce537a; font-weight: bold;">socklen_t</span> <span style="color: #7590db;">cmsg_len</span>;    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">data byte count, including header</span>
        <span style="color: #ce537a; font-weight: bold;">int</span>       <span style="color: #7590db;">cmsg_level</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">originating protocol</span>
        <span style="color: #ce537a; font-weight: bold;">int</span>       <span style="color: #7590db;">cmsg_type</span>;   <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">protocol-specific type</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">followed by the actual control message data</span>
<span style="color: #4f97d7;">}</span>;

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * access the control data</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">  pointer to data associated with cmsghdr structure</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #bc6ec5; font-weight: bold;">CMSG_DATA</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">cmsghdr</span> *<span style="color: #7590db;">cp</span><span style="color: #4f97d7;">)</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;"> pointer to first cmsghdr structure associated with</span>
<span style="color: #9f8766;"> *         the msghdr structure, or NULL if none exists</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">cmsghdr</span> *<span style="color: #bc6ec5; font-weight: bold;">CMSG_FIRSTHDR</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">msghdr</span> *<span style="color: #7590db;">mp</span><span style="color: #4f97d7;">)</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;"> pointer to next cmsghdr structure assocaited with</span>
<span style="color: #9f8766;"> *         the msghdr structure given the current cmsghdr</span>
<span style="color: #9f8766;"> *         structure, or NULL if we're at the last one</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">cmsghdr</span> *<span style="color: #bc6ec5; font-weight: bold;">CMSG_NXTHDR</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">msghdr</span> *<span style="color: #7590db;">mp</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">cmsghdr</span> *<span style="color: #7590db;">cp</span><span style="color: #4f97d7;">)</span>;

<span style="color: #9f8766;">/**</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@breif</span><span style="color: #9f8766;">     get the value to be used</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@return</span><span style="color: #9f8766;">    size to allocate for data object nbytes large</span>
<span style="color: #9f8766;"> * </span><span style="color: #a45bad;">@note</span><span style="color: #9f8766;">      The Single UNIX Specification defines the first three macros, but</span>
<span style="color: #9f8766;"> * omits CMSG_LEN.</span>
<span style="color: #9f8766;"> */</span>
<span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">CMSG_LEN</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">nbytes</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org86e71c4" class="outline-4">
<h4 id="org86e71c4"><span class="todo TODO">TODO</span> 17.5 An Open Server, Version 1</h4>
</div>
<div id="outline-container-org2eb2454" class="outline-4">
<h4 id="org2eb2454"><span class="todo TODO">TODO</span> 17.6 An Open Server, Version 2</h4>
</div>
<div id="outline-container-org890b236" class="outline-4">
<h4 id="org890b236"><span class="todo TODO">TODO</span> 17.7 Summary</h4>
</div>
</div>
<div id="outline-container-org749f15c" class="outline-3">
<h3 id="org749f15c"><span class="todo TODO">TODO</span> Chapter 18. Terminal I/O <code>[0/0]</code></h3>
<div class="outline-text-3" id="text-org749f15c">
</div>
<div id="outline-container-orge392956" class="outline-4">
<h4 id="orge392956">18.1 Introduction</h4>
</div>
<div id="outline-container-org910f419" class="outline-4">
<h4 id="org910f419">18.2</h4>
</div>
</div>
<div id="outline-container-orgaa79de7" class="outline-3">
<h3 id="orgaa79de7"><span class="todo TODO">TODO</span> Chapter 19. Pseudo Terminals <code>[0/0]</code></h3>
</div>
<div id="outline-container-org8729047" class="outline-3">
<h3 id="org8729047"><span class="todo TODO">TODO</span> Chapter 20. A Database Library <code>[0/0]</code></h3>
</div>
<div id="outline-container-orga089da9" class="outline-3">
<h3 id="orga089da9"><span class="todo TODO">TODO</span> Chapter 21. Communication with a Network Printer <code>[0/0]</code></h3>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">
<code>signalstack</code>
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<p class="author">Author: whiothes</p>
<p class="date">Created: 2021-12-16 Thu 17:36</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
